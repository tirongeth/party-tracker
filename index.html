<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSG Party Tracker üéâ | Live BAC Monitor</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-gradient: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460);
            --accent-gradient: linear-gradient(45deg, #00ff88, #00d4ff, #ff00ff);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Animated background */
        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            z-index: -2;
            animation: gradient 15s ease infinite;
            background-size: 400% 400%;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Floating particles */
        .particles {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }
        
        @keyframes float {
            from {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            to {
                transform: translateY(-100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* Navigation Menu */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            z-index: 1000;
            padding: 15px 0;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .logo {
            font-size: 1.5em;
            font-weight: bold;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-menu {
            display: flex;
            gap: 30px;
            list-style: none;
        }
        
        .nav-item {
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--accent-gradient);
            transition: left 0.3s ease;
            z-index: -1;
        }
        
        .nav-item:hover::before {
            left: 0;
        }
        
        .nav-item:hover {
            color: #000;
            transform: translateY(-2px);
        }
        
        .nav-item.active {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
        }
        
        /* Mobile menu toggle - make it visible */
        .mobile-menu-toggle {
            display: none;
            font-size: 1.5em;
            cursor: pointer;
            color: white;
        }
        
        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 10px 20px;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            z-index: 100;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ff88;
        }
        
        /* Alert Banner */
        .alert-banner {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            background: rgba(255, 68, 68, 0.9);
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 999;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        
        .alert-banner.show {
            transform: translateY(0);
        }
        
        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 20px 20px;
        }
        
        /* Header */
        header {
            text-align: center;
            padding: 40px 0;
            position: relative;
        }
        
        h1 {
            font-size: 4em;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: glow 2s ease-in-out infinite alternate;
            margin-bottom: 10px;
        }
        
        @keyframes glow {
            from { filter: drop-shadow(0 0 20px rgba(0, 255, 136, 0.5)); }
            to { filter: drop-shadow(0 0 30px rgba(0, 212, 255, 0.8)); }
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.8;
            margin-bottom: 30px;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 40px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 30px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #00ff88, #00d4ff);
            color: #000;
            font-weight: bold;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff4444, #ff0088);
        }
        
        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        /* Cards */
        .card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 255, 136, 0.5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--accent-gradient);
            border-radius: 20px;
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s ease;
        }
        
        .card:hover::before {
            opacity: 0.3;
        }
        
        /* Friend Cards with Animation */
        .friend-card {
            cursor: pointer;
            position: relative;
        }
        
        .friend-card.pulse {
            animation: cardPulse 0.5s ease;
        }
        
        @keyframes cardPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .friend-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            margin-bottom: 15px;
        }
        
        .friend-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .bac-value {
            font-size: 3em;
            font-weight: bold;
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
            display: flex;
            align-items: baseline;
            gap: 10px;
        }
        
        .bac-trend {
            font-size: 0.5em;
        }
        
        .trend-up { color: #ff4444; }
        .trend-down { color: #00ff88; }
        
        .bac-safe { color: #00ff88; }
        .bac-caution { color: #ffcc00; }
        .bac-danger { color: #ff4444; }
        .bac-critical { 
            color: #ff0088;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            50% { opacity: 0.5; }
        }
        
        .friend-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .location-tag {
            font-size: 0.9em;
            opacity: 0.7;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Party Stats */
        .party-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .stat-card {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .stat-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        /* Games Section */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .game-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .game-card:hover {
            transform: translateY(-10px) rotateZ(-2deg);
            box-shadow: 0 20px 40px rgba(0, 255, 136, 0.3);
        }
        
        .game-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .game-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .game-players {
            opacity: 0.7;
            font-size: 0.9em;
        }
        
        /* Achievements */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 40px 0;
        }
        
        .achievement {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .achievement.unlocked {
            background: rgba(0, 255, 136, 0.1);
            border-color: rgba(0, 255, 136, 0.5);
            animation: achievementUnlock 0.5s ease;
        }
        
        @keyframes achievementUnlock {
            0% { transform: scale(0) rotate(180deg); }
            50% { transform: scale(1.2) rotate(360deg); }
            100% { transform: scale(1) rotate(360deg); }
        }
        
        .achievement-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            filter: grayscale(1);
            transition: filter 0.3s ease;
        }
        
        .achievement.unlocked .achievement-icon {
            filter: grayscale(0);
        }
        
        .achievement-name {
            font-size: 0.9em;
            font-weight: bold;
        }
        
        /* Music Visualizer */
        .visualizer {
            height: 200px;
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            gap: 5px;
        }
        
        .bar {
            width: 100%;
            background: var(--accent-gradient);
            border-radius: 5px 5px 0 0;
            transition: height 0.1s ease;
        }
        
        /* Chat Section */
        .chat-container {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 20px;
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
        }
        
        .chat-message {
            margin-bottom: 15px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            animation: slideIn 0.3s ease;
        }
        
        .chat-message.own {
            background: rgba(0, 255, 136, 0.2);
            text-align: right;
        }
        
        .chat-author {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .chat-input {
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1em;
        }
        
        /* Emergency Section */
        .emergency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .emergency-card {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .emergency-card:hover {
            transform: scale(1.05);
            background: rgba(255, 68, 68, 0.2);
            box-shadow: 0 10px 30px rgba(255, 68, 68, 0.3);
        }
        
        .emergency-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        /* Leaderboard */
        .leaderboard {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
        }
        
        .leaderboard h2 {
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(10px);
        }
        
        .rank {
            font-size: 1.5em;
            font-weight: bold;
            width: 50px;
        }
        
        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            animation: modalIn 0.3s ease;
        }
        
        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(0, 255, 136, 0.9);
            color: #000;
            padding: 15px 25px;
            border-radius: 10px;
            animation: slideInRight 0.3s ease;
            z-index: 3000;
            cursor: pointer;
            max-width: 300px;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }
        
        /* Mobile-First Responsive Design */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
            
            .nav-menu {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: rgba(0, 0, 0, 0.95);
                flex-direction: column;
                padding: 20px;
                gap: 10px;
                border-radius: 0 0 20px 20px;
            }
            
            .nav-menu.show {
                display: flex;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .party-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .games-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .achievements-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .emergency-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .friend-card {
                padding: 20px;
            }
            
            .bac-value {
                font-size: 2em;
            }
            
            .stat-value {
                font-size: 1.5em;
            }
            
            .weather-widget {
                position: static;
                margin: 20px auto;
                width: fit-content;
            }
            
            .voice-indicator {
                bottom: 80px;
                right: 20px;
            }
            
            .modal-content {
                margin: 20px;
                padding: 20px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .game-container {
                padding: 20px;
            }
            
            .timer-display {
                font-size: 3em;
            }
            
            .question-card {
                font-size: 1.2em;
                padding: 20px;
            }
            
            .leaderboard h2 {
                font-size: 1.5em;
            }
            
            .playlist-track {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            /* Fix drink section on mobile */
            #drinks .card {
                padding: 15px;
            }
            
            #drinkType, #drinkAmount, #alcoholPercent {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .container {
                padding: 80px 10px 20px;
            }
            
            /* Fix overlapping elements */
            .connection-status {
                bottom: 80px;
                font-size: 0.8em;
            }
            
            /* Better touch targets */
            .nav-item, .btn, .card {
                min-height: 44px;
                display: flex;
                align-items: center;
            }
        }
        
        /* Tablet adjustments */
        @media (min-width: 769px) and (max-width: 1024px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .games-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* Prevent horizontal scroll on mobile */
        html, body {
            overflow-x: hidden;
            max-width: 100%;
        }
        
        /* Fix iOS button styles */
        input, select, button {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        /* Better mobile form inputs */
        input[type="number"],
        input[type="text"],
        input[type="tel"],
        select {
            font-size: 16px;
            padding: 12px;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Loading state */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Error state */
        .error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            color: #ff4444;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00ff88;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Party Mode */
        body.party-mode {
            animation: partyColors 2s linear infinite;
        }
        
        @keyframes partyColors {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Game Overlay */
        .game-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .game-overlay.show {
            display: flex;
        }
        
        .game-container {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: gameIn 0.5s ease;
        }
        
        @keyframes gameIn {
            from {
                opacity: 0;
                transform: scale(0.8) rotateX(30deg);
            }
            to {
                opacity: 1;
                transform: scale(1) rotateX(0);
            }
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .game-title {
            font-size: 2em;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .close-game {
            font-size: 2em;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s ease;
        }
        
        .close-game:hover {
            opacity: 1;
            transform: rotate(90deg);
        }
        
        /* Timer Display */
        .timer-display {
            font-size: 4em;
            font-weight: bold;
            text-align: center;
            margin: 30px 0;
            font-variant-numeric: tabular-nums;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Score Display */
        .score-display {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
        }
        
        .team-score {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            min-width: 150px;
        }
        
        .team-name {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.8;
        }
        
        .team-points {
            font-size: 3em;
            font-weight: bold;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Question Card */
        .question-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            margin: 30px 0;
            text-align: center;
            font-size: 1.5em;
            line-height: 1.6;
            animation: questionIn 0.5s ease;
        }
        
        @keyframes questionIn {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Location Map */
        .location-map {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            height: 300px;
            position: relative;
            overflow: hidden;
        }
        
        .location-dot {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--accent-gradient);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        /* First Aid Card */
        .first-aid-card {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
        }
        
        .first-aid-step {
            margin: 15px 0;
            padding-left: 30px;
            position: relative;
        }
        
        .first-aid-step::before {
            content: attr(data-step);
            position: absolute;
            left: 0;
            top: 0;
            width: 25px;
            height: 25px;
            background: var(--accent-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
        }
        
        /* Buddy System */
        .buddy-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .buddy-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .buddy-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 255, 136, 0.5);
        }
        
        .buddy-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .buddy-status.online {
            background: #00ff88;
            animation: pulse 2s infinite;
        }
        
        .buddy-status.offline {
            background: #666;
        }
        
        /* Settings Saved Animation */
        @keyframes settingsSaved {
            0% {
                transform: scale(0) rotate(180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(360deg);
                opacity: 1;
            }
            100% {
                transform: scale(1) rotate(360deg);
                opacity: 1;
            }
        }
        
        .settings-saved {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5em;
            animation: settingsSaved 0.5s ease;
            z-index: 4000;
        }
        
        /* Advanced Stats */
        .advanced-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .stat-chart {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            height: 250px;
        }
        
        /* Prediction Engine */
        .prediction-card {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 212, 255, 0.1));
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
        }
        
        .prediction-value {
            font-size: 2em;
            font-weight: bold;
            margin: 20px 0;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Voice Commands */
        .voice-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            background: var(--accent-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .voice-indicator:hover {
            transform: scale(1.1);
        }
        
        .voice-indicator.listening {
            animation: voicePulse 1s infinite;
        }
        
        @keyframes voicePulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7);
            }
            50% {
                box-shadow: 0 0 0 20px rgba(0, 255, 136, 0);
            }
        }
        
        /* Weather Widget */
        .weather-widget {
            position: fixed;
            top: 100px;
            left: 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            backdrop-filter: blur(10px);
            text-align: center;
            min-width: 150px;
        }
        
        .weather-temp {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .weather-condition {
            opacity: 0.8;
            font-size: 0.9em;
        }
        
        /* Party Playlist */
        .playlist-container {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .playlist-track {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .playlist-track:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(10px);
        }
        
        .track-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .track-playing {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: space-around;
        }
        
        .track-playing span {
            width: 3px;
            height: 100%;
            background: var(--accent-gradient);
            animation: musicBar 0.5s ease infinite alternate;
        }
        
        .track-playing span:nth-child(2) {
            animation-delay: 0.1s;
        }
        
        .track-playing span:nth-child(3) {
            animation-delay: 0.2s;
        }
        
        @keyframes musicBar {
            to {
                height: 50%;
            }
        }
    </style>
</head>
<body>
    <div class="background"></div>
    <div class="particles" id="particles"></div>
    
    <!-- Alert Banner -->
    <div class="alert-banner" id="alertBanner">
        <span id="alertText"></span>
    </div>
    
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-beer"></i>
                HSG Party Tracker
            </div>
            <ul class="nav-menu" id="navMenu">
                <li class="nav-item active" onclick="switchSection('dashboard')">
                    <i class="fas fa-home"></i> Dashboard
                </li>
                <li class="nav-item" onclick="switchSection('games')">
                    <i class="fas fa-gamepad"></i> Games
                </li>
                <li class="nav-item" onclick="switchSection('achievements')">
                    <i class="fas fa-trophy"></i> Achievements
                </li>
                <li class="nav-item" onclick="switchSection('drinks')">
                    <i class="fas fa-beer"></i> Drinks
                </li>
                <li class="nav-item" onclick="switchSection('emergency')">
                    <i class="fas fa-ambulance"></i> Emergency
                </li>
                <li class="nav-item" onclick="switchSection('settings')">
                    <i class="fas fa-cog"></i> Settings
                </li>
            </ul>
            <div class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </nav>
    
    <!-- Connection Status -->
    <div class="connection-status">
        <span class="status-dot"></span>
        <span id="connectionStatus">Connecting...</span>
    </div>
    
    <div class="container">
        <header>
            <h1>üéâ HSG Party Central üéâ</h1>
            <p class="subtitle">Where memories are made and safety comes first!</p>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="startPartyMode()">
                    <i class="fas fa-music"></i> Party Mode
                </button>
                <button class="btn" onclick="showModal('checkin')">
                    <i class="fas fa-location-dot"></i> Check In
                </button>
                <button class="btn" onclick="callUber()">
                    <i class="fas fa-taxi"></i> Call Uber
                </button>
                <button class="btn btn-danger" onclick="showModal('emergency')">
                    <i class="fas fa-exclamation-triangle"></i> Emergency
                </button>
            </div>
        </header>
        
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <div class="party-stats">
                <div class="stat-card" onclick="showNotification('Party started 3 hours ago!')">
                    <div class="stat-icon">üéä</div>
                    <div class="stat-value" id="partyAverage">0.00‚Ä∞</div>
                    <div class="stat-label">Party Average</div>
                </div>
                <div class="stat-card" onclick="showModal('safe-friends')">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value" id="safeFriends">0</div>
                    <div class="stat-label">Safe to Drive</div>
                </div>
                <div class="stat-card" onclick="showModal('locations')">
                    <div class="stat-icon">üìç</div>
                    <div class="stat-value" id="activeLocations">3</div>
                    <div class="stat-label">Party Spots</div>
                </div>
                <div class="stat-card" onclick="showHydrationReminder()">
                    <div class="stat-icon">üíß</div>
                    <div class="stat-value" id="hydrationTime">15m</div>
                    <div class="stat-label">Until Water Break</div>
                </div>
            </div>
            
            <div class="visualizer" id="visualizer">
                <!-- Music visualizer bars will be generated here -->
            </div>
            
            <div class="dashboard" id="friendsGrid">
                <!-- Friend cards will be dynamically inserted here -->
            </div>
            
            <div class="leaderboard">
                <h2>üèÜ Tonight's Champions üèÜ</h2>
                <div id="leaderboardList">
                    <!-- Leaderboard items will be inserted here -->
                </div>
            </div>
            
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message">
                        <div class="chat-author">System</div>
                        <div>Welcome to HSG Party Chat! Stay safe and have fun! üéâ</div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="handleChatEnter(event)">
                    <button class="btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Games Section -->
        <section id="games" class="section">
            <h2>üéÆ Party Games üéÆ</h2>
            <div class="games-grid">
                <div class="game-card" onclick="startGame('never-have-i-ever')">
                    <div class="game-icon">üôä</div>
                    <div class="game-title">Never Have I Ever</div>
                    <div class="game-players">2-20 players</div>
                </div>
                <div class="game-card" onclick="startGame('truth-or-dare')">
                    <div class="game-icon">üéØ</div>
                    <div class="game-title">Truth or Dare</div>
                    <div class="game-players">3-10 players</div>
                </div>
                <div class="game-card" onclick="startGame('kings-cup')">
                    <div class="game-icon">üëë</div>
                    <div class="game-title">King's Cup</div>
                    <div class="game-players">4-12 players</div>
                </div>
                <div class="game-card" onclick="startGame('beer-pong')">
                    <div class="game-icon">üèì</div>
                    <div class="game-title">Beer Pong Tracker</div>
                    <div class="game-players">2v2</div>
                </div>
                <div class="game-card" onclick="startGame('flip-cup')">
                    <div class="game-icon">ü•§</div>
                    <div class="game-title">Flip Cup Timer</div>
                    <div class="game-players">Teams</div>
                </div>
                <div class="game-card" onclick="startGame('trivia')">
                    <div class="game-icon">üß†</div>
                    <div class="game-title">HSG Trivia</div>
                    <div class="game-players">Unlimited</div>
                </div>
            </div>
        </section>
        
        <!-- Achievements Section -->
        <section id="achievements" class="section">
            <h2>üèÖ Party Achievements üèÖ</h2>
            <div class="achievements-grid">
                <div class="achievement unlocked" title="Joined your first party!">
                    <div class="achievement-icon">üéâ</div>
                    <div class="achievement-name">First Timer</div>
                </div>
                <div class="achievement unlocked" title="Stayed safe all night">
                    <div class="achievement-icon">üòá</div>
                    <div class="achievement-name">Responsible</div>
                </div>
                <div class="achievement" title="Win 5 party games">
                    <div class="achievement-icon">üèÜ</div>
                    <div class="achievement-name">Game Master</div>
                </div>
                <div class="achievement" title="Check in at 10 parties">
                    <div class="achievement-icon">üìç</div>
                    <div class="achievement-name">Party Animal</div>
                </div>
                <div class="achievement" title="Help a friend get home safe">
                    <div class="achievement-icon">ü¶∏</div>
                    <div class="achievement-name">Guardian Angel</div>
                </div>
                <div class="achievement" title="Stay hydrated for 3 hours">
                    <div class="achievement-icon">üíß</div>
                    <div class="achievement-name">Hydro Homie</div>
                </div>
                <div class="achievement" title="Dance for 30 minutes straight">
                    <div class="achievement-icon">üï∫</div>
                    <div class="achievement-name">Dance Machine</div>
                </div>
                <div class="achievement" title="Make it to sunrise">
                    <div class="achievement-icon">üåÖ</div>
                    <div class="achievement-name">Sunrise Warrior</div>
                </div>
            </div>
        </section>
        
        <!-- Drinks Section -->
        <section id="drinks" class="section">
            <h2>üçª Drink Tracker üçª</h2>
            
            <div class="card" style="margin-bottom: 30px;">
                <h3>Log a Drink</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div>
                        <label style="display: block; margin-bottom: 10px;">Drink Type:</label>
                        <select id="drinkType" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white;">
                            <option value="beer">üç∫ Beer</option>
                            <option value="wine">üç∑ Wine</option>
                            <option value="shot">ü•É Shot</option>
                            <option value="cocktail">üç∏ Cocktail</option>
                            <option value="mixed">ü•§ Mixed Drink</option>
                            <option value="champagne">ü•Ç Champagne</option>
                            <option value="water">üíß Water</option>
                            <option value="other">üçπ Other</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 10px;">Amount (ml):</label>
                        <input type="number" id="drinkAmount" placeholder="330" value="330" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 10px;">Alcohol %:</label>
                        <input type="number" id="alcoholPercent" placeholder="5" value="5" step="0.1" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white;">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="logDrink()">
                    <i class="fas fa-plus"></i> Add Drink
                </button>
            </div>
            
            <div class="party-stats">
                <div class="stat-card">
                    <div class="stat-icon">üç∫</div>
                    <div class="stat-value" id="totalDrinks">0</div>
                    <div class="stat-label">Total Drinks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ü•É</div>
                    <div class="stat-value" id="totalAlcohol">0ml</div>
                    <div class="stat-label">Pure Alcohol</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üíß</div>
                    <div class="stat-value" id="totalWater">0</div>
                    <div class="stat-label">Waters</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-value" id="drinkRate">0</div>
                    <div class="stat-label">Drinks/Hour</div>
                </div>
            </div>
            
            <div class="card">
                <h3>üìä Drink Distribution</h3>
                <canvas id="drinkChart" width="400" height="200"></canvas>
            </div>
            
            <div class="card">
                <h3>üìú Drink History</h3>
                <div id="drinkHistory" style="max-height: 400px; overflow-y: auto;">
                    <!-- Drink history will be populated here -->
                </div>
            </div>
            
            <div class="card" style="background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.3);">
                <h3>üö® Emergency Information</h3>
                <div id="emergencyDrinkInfo" style="margin: 20px 0;">
                    <p><strong>For First Responders:</strong></p>
                    <div id="emergencySummary">
                        <!-- Emergency summary will be populated here -->
                    </div>
                </div>
                <button class="btn btn-danger" onclick="showEmergencyReport()">
                    <i class="fas fa-file-medical"></i> Generate Emergency Report
                </button>
            </div>
        </section>
        
        <!-- Emergency Section -->
        <section id="emergency" class="section">
            <h2>üö® Emergency Services üö®</h2>
            <div class="emergency-grid">
                <div class="emergency-card" onclick="callEmergency('ambulance')">
                    <div class="emergency-icon">üöë</div>
                    <div class="game-title">Call Ambulance</div>
                    <div class="game-players">Emergency: 112</div>
                </div>
                <div class="emergency-card" onclick="callEmergency('campus-security')">
                    <div class="emergency-icon">üëÆ</div>
                    <div class="game-title">Campus Security</div>
                    <div class="game-players">HSG: +41 71 224 2424</div>
                </div>
                <div class="emergency-card" onclick="callEmergency('taxi')">
                    <div class="emergency-icon">üöï</div>
                    <div class="game-title">Safe Ride Home</div>
                    <div class="game-players">Multiple Options</div>
                </div>
                <div class="emergency-card" onclick="showModal('first-aid')">
                    <div class="emergency-icon">üè•</div>
                    <div class="game-title">First Aid Guide</div>
                    <div class="game-players">Quick Help</div>
                </div>
                <div class="emergency-card" onclick="showModal('buddy-system')">
                    <div class="emergency-icon">üë•</div>
                    <div class="game-title">Find My Buddy</div>
                    <div class="game-players">Location Sharing</div>
                </div>
                <div class="emergency-card" onclick="showModal('sober-friend')">
                    <div class="emergency-icon">ü§ù</div>
                    <div class="game-title">Call Sober Friend</div>
                    <div class="game-players">Designated Helpers</div>
                </div>
            </div>
        </section>
        
        <!-- Settings Section -->
        <section id="settings" class="section">
            <h2>‚öôÔ∏è Settings ‚öôÔ∏è</h2>
            <div class="card">
                <h3>Profile Settings</h3>
                <div style="margin: 20px 0;">
                    <label>Your Name:</label>
                    <input type="text" id="userName" placeholder="Enter your name" style="width: 100%; padding: 10px; margin: 10px 0; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white;">
                </div>
                <div style="margin: 20px 0;">
                    <label>Emergency Contact:</label>
                    <input type="tel" id="emergencyContact" placeholder="+41 XX XXX XX XX" style="width: 100%; padding: 10px; margin: 10px 0; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white;">
                </div>
                <div style="margin: 20px 0;">
                    <label>
                        <input type="checkbox" id="shareLocation"> Share location with friends
                    </label>
                </div>
                <div style="margin: 20px 0;">
                    <label>
                        <input type="checkbox" id="notifications" checked> Enable notifications
                    </label>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </section>
    </div>
    
    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div id="modalBody"></div>
        </div>
    </div>
    
    <script>
        // ========================================
        // FIREBASE CONFIGURATION - YOUR REAL CONFIG
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCuOjiHa8C0jgAte40E774CRJROTWTUdmg",
            authDomain: "hsg-party-tracker.firebaseapp.com",
            databaseURL: "https://hsg-party-tracker-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "hsg-party-tracker",
            storageBucket: "hsg-party-tracker.firebasestorage.app",
            messagingSenderId: "1047483086606",
            appId: "1:1047483086606:web:a02d77baacd21166fb095f",
            measurementId: "G-VFS4W30Z7P"
        };
        
        // Change this to false to use real Firebase data
        const DEMO_MODE = true; // Set to false when ready to use real data!
        
        // ========================================
        // GLOBAL VARIABLES AND DATA
        // ========================================
        let partyData = {};
        let currentUser = localStorage.getItem('userName') || 'You';
        let partyMode = false;
        let currentGame = null;
        let gameScores = { team1: 0, team2: 0 };
        let voiceRecognition = null;
        let partyStartTime = Date.now();
        let achievements = {
            firstTimer: true,
            responsible: false,
            gameMaster: false,
            partyAnimal: false,
            guardianAngel: false,
            hydroHomie: false,
            danceMachine: false,
            sunriseWarrior: false
        };
        let locationHistory = [];
        let playlist = [
            { title: "Summer Vibes", artist: "DJ Party", playing: false },
            { title: "Dance All Night", artist: "Beat Masters", playing: true },
            { title: "HSG Anthem", artist: "Student Union", playing: false },
            { title: "Chill Zone", artist: "Lounge Mix", playing: false }
        ];
        let drinkHistory = [];
        let drinkChart = null;
        
        // Drink presets
        const drinkPresets = {
            beer: { amount: 330, alcohol: 5, emoji: 'üç∫' },
            wine: { amount: 150, alcohol: 12, emoji: 'üç∑' },
            shot: { amount: 40, alcohol: 40, emoji: 'ü•É' },
            cocktail: { amount: 200, alcohol: 15, emoji: 'üç∏' },
            mixed: { amount: 250, alcohol: 10, emoji: 'ü•§' },
            champagne: { amount: 150, alcohol: 12, emoji: 'ü•Ç' },
            water: { amount: 250, alcohol: 0, emoji: 'üíß' },
            other: { amount: 200, alcohol: 5, emoji: 'üçπ' }
        };

        // Update connection status
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const dotElement = document.querySelector('.status-dot');
    
            if (statusElement && dotElement) {
                if (connected) {
                    statusElement.textContent = 'Connected';
                    dotElement.style.background = '#00ff88';
                } else {
                    statusElement.textContent = 'Offline';
                    dotElement.style.background = '#ff4444';
                }
            }
        }
        
        // ========================================
        // FIREBASE INITIALIZATION
        // ========================================
        let database = null;
        
        function initializeFirebase() {
            if (!DEMO_MODE) {
                try {
                    // Initialize Firebase
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    
                    // Set up listeners
                    setupFirebaseListeners();
                    
                    console.log('Firebase initialized successfully');
                    showNotification('‚úÖ Connected to Firebase!');
                    updateConnectionStatus(true);
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    showNotification('‚ùå Firebase connection failed. Running in demo mode.');
                    updateConnectionStatus(false);
                }
            } else {
                updateConnectionStatus(false);
            }
        }
        
        // Setup Firebase listeners
        function setupFirebaseListeners() {
            if (!database) return;
            
            // Listen for breathalyzer readings
            database.ref('readings').on('child_added', (snapshot) => {
                const reading = snapshot.val();
                processBreathalyzerReading(reading);
            });
            
            // Listen for user updates
            database.ref('users').on('value', (snapshot) => {
                const users = snapshot.val();
                if (users) {
                    updatePartyData(users);
                }
            });
            
            // Connection status
            database.ref('.info/connected').on('value', (snapshot) => {
                const connected = snapshot.val();
                updateConnectionStatus(connected);
            });
        }
        
        // Process incoming breathalyzer reading
        function processBreathalyzerReading(reading) {
            if (!reading) return;
            
            // Find or create user
            const userId = reading.device || 'unknown';
            const userName = reading.user || 'Anonymous';
            
            if (!partyData[userId]) {
                partyData[userId] = {
                    name: userName,
                    bac: 0,
                    lastUpdate: Date.now(),
                    location: reading.location || 'Unknown',
                    trend: 'steady',
                    history: [],
                    device: reading.device
                };
            }
            
            // Update BAC
            const oldBac = partyData[userId].bac;
            partyData[userId].bac = reading.bac || 0;
            partyData[userId].lastUpdate = Date.now();
            partyData[userId].trend = reading.bac > oldBac ? 'up' : reading.bac < oldBac ? 'down' : 'steady';
            
            // Add to history
            partyData[userId].history.push({
                time: Date.now(),
                value: reading.bac
            });
            
            // Update UI
            updateUI();
            
            // Show notification
            showNotification(`üìä ${userName}: ${reading.bac.toFixed(3)}‚Ä∞`);
        }
        
        // Update party data from Firebase
        function updatePartyData(users) {
            Object.entries(users).forEach(([userId, userData]) => {
                partyData[userId] = {
                    ...userData,
                    lastUpdate: Date.now()
                };
            });
            updateUI();
        }
        
        // Error boundary
        window.addEventListener('error', (e) => {
            console.error('Application error:', e);
            showNotification('‚ö†Ô∏è Something went wrong. Refreshing might help.');
        });
        
        // Initialize particles
        function createParticles() {
            try {
                const particlesContainer = document.getElementById('particles');
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 20 + 's';
                    particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                    particlesContainer.appendChild(particle);
                }
            } catch (error) {
                console.error('Particle creation failed:', error);
            }
        }
        
        // Navigation - Fixed to handle clicks properly
        function switchSection(sectionId) {
            try {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.add('active');
                }
                
                // Find and activate the correct nav item
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    if (item.onclick && item.onclick.toString().includes(sectionId)) {
                        item.classList.add('active');
                    }
                });
                
                // Close mobile menu
                document.getElementById('navMenu').classList.remove('show');
                
                // Section-specific initializations
                if (sectionId === 'achievements') {
                    updateAchievements();
                } else if (sectionId === 'drinks') {
                    updateDrinkStats();
                    updateDrinkChart();
                }
            } catch (error) {
                console.error('Section switch failed:', error);
            }
        }
        
        function toggleMobileMenu() {
            document.getElementById('navMenu').classList.toggle('show');
        }
        
        // Demo data generator with error handling
        function generateDemoData() {
            try {
                const names = ['Alex üéì', 'Jordan üéØ', 'Sam üé∏', 'Casey üé®', 'Morgan üèÄ', 'Taylor üé≠', 'Jamie üé™', 'Riley üéµ'];
                const locations = ['Dorm A', 'Dorm B', 'Library Cafe', 'Student Bar', 'Main Campus', 'Sports Center'];
                const now = Date.now();
                
                names.forEach((name, index) => {
                    if (!partyData[name]) {
                        partyData[name] = {
                            name: name,
                            bac: 0,
                            lastUpdate: now,
                            location: locations[Math.floor(Math.random() * locations.length)],
                            trend: 'steady',
                            history: [],
                            status: 'online',
                            lastMessage: ''
                        };
                    }
                    
                    // Simulate BAC changes
                    const currentBac = partyData[name].bac;
                    const change = (Math.random() - 0.3) * 0.02;
                    const newBac = Math.max(0, Math.min(currentBac + change, 0.12));
                    
                    partyData[name].trend = newBac > currentBac ? 'up' : newBac < currentBac ? 'down' : 'steady';
                    partyData[name].bac = newBac;
                    partyData[name].lastUpdate = now;
                    
                    // Add to history for charts
                    if (!partyData[name].history) partyData[name].history = [];
                    partyData[name].history.push({ time: now, value: newBac });
                    if (partyData[name].history.length > 50) {
                        partyData[name].history.shift();
                    }
                    
                    // Random location changes
                    if (Math.random() < 0.1) {
                        partyData[name].location = locations[Math.floor(Math.random() * locations.length)];
                    }
                    
                    // Random online/offline status
                    partyData[name].status = Math.random() < 0.9 ? 'online' : 'offline';
                });
                
                updateUI();
            } catch (error) {
                console.error('Data generation failed:', error);
            }
        }
        
        // Update UI with error handling
        function updateUI() {
            try {
                updateFriendsGrid();
                updateStats();
                updateLeaderboard();
                updateVisualizer();
                checkForAlerts();
                updateWeather();
            } catch (error) {
                console.error('UI update failed:', error);
            }
        }
        
        // Get BAC status
        function getBACStatus(bac) {
            if (bac < 0.02) return { class: 'bac-safe', text: 'Sober', emoji: 'üòä' };
            if (bac < 0.05) return { class: 'bac-caution', text: 'Buzzed', emoji: 'üòé' };
            if (bac < 0.08) return { class: 'bac-danger', text: 'No Driving!', emoji: 'üö´' };
            return { class: 'bac-critical', text: 'Too Much!', emoji: 'ü§¢' };
        }
        
        // Update friends grid
        function updateFriendsGrid() {
            const grid = document.getElementById('friendsGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            Object.values(partyData).forEach(friend => {
                const status = getBACStatus(friend.bac);
                const timeSince = getTimeSince(friend.lastUpdate);
                
                const card = document.createElement('div');
                card.className = 'card friend-card';
                card.onclick = () => showFriendDetails(friend);
                
                const trendIcon = friend.trend === 'up' ? 'üìà' : friend.trend === 'down' ? 'üìâ' : '‚û°Ô∏è';
                const trendClass = friend.trend === 'up' ? 'trend-up' : friend.trend === 'down' ? 'trend-down' : '';
                
                card.innerHTML = `
                    <div class="friend-avatar">${friend.name.split(' ')[1]}</div>
                    <div class="friend-name">${friend.name.split(' ')[0]}</div>
                    <div class="bac-value ${status.class}">
                        ${friend.bac.toFixed(3)}‚Ä∞
                        <span class="bac-trend ${trendClass}">${trendIcon}</span>
                    </div>
                    <div class="friend-status">
                        <span class="status-badge">${status.emoji} ${status.text}</span>
                    </div>
                    <div class="location-tag">
                        <i class="fas fa-map-marker-alt"></i> ${friend.location}
                    </div>
                    <div class="last-update" style="margin-top: 10px; opacity: 0.7; font-size: 0.9em;">
                        Updated ${timeSince}
                    </div>
                `;
                
                // Add pulse animation for high BAC
                if (friend.bac >= 0.08) {
                    card.classList.add('pulse');
                }
                
                grid.appendChild(card);
            });
        }
        
        // Update stats
        function updateStats() {
            const friends = Object.values(partyData);
            
            // Average BAC
            const avgBac = friends.reduce((sum, f) => sum + f.bac, 0) / friends.length || 0;
            const avgElement = document.getElementById('partyAverage');
            if (avgElement) avgElement.textContent = avgBac.toFixed(3) + '‚Ä∞';
            
            // Safe friends
            const safeCount = friends.filter(f => f.bac < 0.02).length;
            const safeElement = document.getElementById('safeFriends');
            if (safeElement) safeElement.textContent = safeCount;
            
            // Update hydration timer
            const hydrationMinutes = 15 - (Date.now() % (15 * 60 * 1000)) / 60000;
            const hydrationElement = document.getElementById('hydrationTime');
            if (hydrationElement) hydrationElement.textContent = Math.floor(hydrationMinutes) + 'm';
            
            // Check achievements
            checkAchievements(friends);
        }
        
        // Update leaderboard
        function updateLeaderboard() {
            const leaderboard = document.getElementById('leaderboardList');
            if (!leaderboard) return;
            
            leaderboard.innerHTML = '';
            
            const sorted = Object.values(partyData)
                .sort((a, b) => a.bac - b.bac)
                .slice(0, 5);
            
            sorted.forEach((friend, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.onclick = () => {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                    showNotification(`${friend.name.split(' ')[0]} is winning! üèÜ`);
                };
                
                item.innerHTML = `
                    <span class="rank rank-${index + 1}">#${index + 1}</span>
                    <span>${friend.name}</span>
                    <span>${friend.bac.toFixed(3)}‚Ä∞</span>
                `;
                leaderboard.appendChild(item);
            });
        }
        
        // Music visualizer
        function updateVisualizer() {
            const visualizer = document.getElementById('visualizer');
            if (!visualizer) return;
            
            if (visualizer.children.length === 0) {
                for (let i = 0; i < 20; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    visualizer.appendChild(bar);
                }
            }
            
            visualizer.querySelectorAll('.bar').forEach(bar => {
                const height = Math.random() * 150 + 20;
                bar.style.height = height + 'px';
            });
        }
        
        // Party mode
        function startPartyMode() {
            partyMode = !partyMode;
            document.body.classList.toggle('party-mode');
            
            if (partyMode) {
                showNotification('üéâ PARTY MODE ACTIVATED! üéâ');
                // More frequent visualizer updates
                const vizInterval = setInterval(updateVisualizer, 100);
                
                // Random confetti
                const confettiInterval = setInterval(() => {
                    if (!partyMode) {
                        clearInterval(vizInterval);
                        clearInterval(confettiInterval);
                        return;
                    }
                    if (Math.random() < 0.3) {
                        confetti({
                            particleCount: 50,
                            spread: 60,
                            origin: { x: Math.random(), y: Math.random() }
                        });
                    }
                }, 5000);
                
                // Play party sound effect (if implemented)
                playSound('party-horn');
            } else {
                showNotification('Party mode deactivated');
            }
        }
        
        // Chat functionality
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message own';
                messageDiv.innerHTML = `
                    <div class="chat-author">You</div>
                    <div>${escapeHtml(message)}</div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                input.value = '';
                
                // Check for commands
                processCommand(message);
                
                // Simulate response
                setTimeout(() => {
                    const names = Object.keys(partyData);
                    const randomName = names[Math.floor(Math.random() * names.length)];
                    const responses = [
                        "Haha that's awesome! üòÇ",
                        "See you there! üéâ",
                        "Who's up for another round? üçª",
                        "Stay safe everyone! ‚ù§Ô∏è",
                        "Best party ever! üî•",
                        "Let's gooo! üöÄ",
                        "Anyone need a ride? üöó",
                        "Water break time! üíß"
                    ];
                    const response = responses[Math.floor(Math.random() * responses.length)];
                    
                    const responseDiv = document.createElement('div');
                    responseDiv.className = 'chat-message';
                    responseDiv.innerHTML = `
                        <div class="chat-author">${randomName.split(' ')[0]}</div>
                        <div>${response}</div>
                    `;
                    chatMessages.appendChild(responseDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 1000 + Math.random() * 2000);
            }
        }
        
        function handleChatEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // Command processing
        function processCommand(message) {
            const lower = message.toLowerCase();
            
            if (lower.includes('party mode')) {
                startPartyMode();
            } else if (lower.includes('emergency')) {
                showModal('emergency');
            } else if (lower.includes('uber') || lower.includes('taxi')) {
                callUber();
            } else if (lower.includes('water') || lower.includes('hydrate')) {
                showHydrationReminder();
            } else if (lower.includes('game')) {
                switchSection('games');
            }
        }
        
        // Modal functions
        function showModal(type, data = null) {
            const modal = document.getElementById('modal');
            const modalBody = document.getElementById('modalBody');
            
            let content = '';
            
            switch(type) {
                case 'checkin':
                    content = `
                        <h2>üìç Check In</h2>
                        <p>Select your current location:</p>
                        <div class="location-map" id="locationMap">
                            <!-- Simulated map -->
                        </div>
                        <div style="margin: 20px 0;">
                            ${['Dorm A - Room Party', 'Student Bar', 'Library Cafe', 'Sports Center', 'Main Campus', 'Off Campus'].map(loc => 
                                `<button class="btn" style="width: 100%; margin: 10px 0;" onclick="checkInLocation('${loc}')">${loc}</button>`
                            ).join('')}
                        </div>
                        <button class="btn" onclick="closeModal()">Cancel</button>
                    `;
                    break;
                    
                case 'emergency':
                    content = `
                        <h2>üö® Emergency Contacts</h2>
                        <div style="margin: 20px 0;">
                            <p><strong>Ambulance:</strong> 112</p>
                            <p><strong>HSG Security:</strong> +41 71 224 2424</p>
                            <p><strong>Poison Control:</strong> 145</p>
                            <p><strong>Mental Health Crisis:</strong> 143</p>
                        </div>
                        <button class="btn btn-danger" onclick="window.location.href='tel:112'">
                            <i class="fas fa-phone"></i> Call 112 Now
                        </button>
                        <button class="btn" onclick="showFirstAid()">
                            <i class="fas fa-medkit"></i> First Aid Guide
                        </button>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
                    
                case 'first-aid':
                    content = `
                        <h2>üè• First Aid Guide</h2>
                        <div class="first-aid-card">
                            <h3>Signs of Alcohol Poisoning:</h3>
                            <ul>
                                <li>Confusion, stupor</li>
                                <li>Vomiting</li>
                                <li>Seizures</li>
                                <li>Slow or irregular breathing</li>
                                <li>Unconsciousness</li>
                            </ul>
                        </div>
                        <div class="first-aid-card">
                            <h3>What to Do:</h3>
                            <div class="first-aid-step" data-step="1">Call 112 immediately</div>
                            <div class="first-aid-step" data-step="2">Keep them awake and sitting up</div>
                            <div class="first-aid-step" data-step="3">Give them water if conscious</div>
                            <div class="first-aid-step" data-step="4">Keep them warm</div>
                            <div class="first-aid-step" data-step="5">Stay with them</div>
                        </div>
                        <button class="btn btn-danger" onclick="window.location.href='tel:112'">Emergency Call</button>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
                    
                case 'friend-details':
                    content = `
                        <h2>Friend Details</h2>
                        <div id="friendDetailsContent"></div>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
                    
                case 'buddy-system':
                    content = `
                        <h2>üë• Buddy System</h2>
                        <p>Choose your buddy for tonight:</p>
                        <div class="buddy-list">
                            ${Object.values(partyData).map(friend => `
                                <div class="buddy-card" onclick="selectBuddy('${friend.name}')">
                                    <div style="font-size: 2em; margin-bottom: 10px;">${friend.name.split(' ')[1]}</div>
                                    <div>${friend.name.split(' ')[0]}</div>
                                    <div class="buddy-status ${friend.status}"></div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
                    
                case 'safe-friends':
                    const safeFriends = Object.values(partyData).filter(f => f.bac < 0.02);
                    content = `
                        <h2>‚úÖ Friends Safe to Drive</h2>
                        <div style="margin: 20px 0;">
                            ${safeFriends.length > 0 ? safeFriends.map(friend => `
                                <div class="buddy-card" style="margin: 10px 0;">
                                    <div>${friend.name}</div>
                                    <div>BAC: ${friend.bac.toFixed(3)}‚Ä∞</div>
                                    <button class="btn" onclick="callFriend('${friend.name}')">
                                        <i class="fas fa-phone"></i> Call
                                    </button>
                                </div>
                            `).join('') : '<p>No friends are currently safe to drive.</p>'}
                        </div>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
                    
                case 'locations':
                    content = `
                        <h2>üìç Active Party Locations</h2>
                        <div class="location-map" style="height: 400px;">
                            ${createLocationMap()}
                        </div>
                        <div style="margin: 20px 0;">
                            ${getActiveLocations().map(loc => `
                                <div class="buddy-card" style="margin: 10px 0;">
                                    <div><strong>${loc.name}</strong></div>
                                    <div>${loc.count} people</div>
                                    <div>Avg BAC: ${loc.avgBac.toFixed(3)}‚Ä∞</div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
            }
            
            modalBody.innerHTML = content;
            modal.classList.add('show');
            
            // Initialize location map if needed
            if (type === 'checkin' || type === 'locations') {
                setTimeout(initializeLocationMap, 100);
            }
        }
        
        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }
        
        // Show friend details
        function showFriendDetails(friend) {
            showModal('friend-details');
            setTimeout(() => {
                const content = document.getElementById('friendDetailsContent');
                const status = getBACStatus(friend.bac);
                
                content.innerHTML = `
                    <div style="text-align: center; margin: 20px 0;">
                        <div class="friend-avatar" style="width: 100px; height: 100px; font-size: 3em; margin: 0 auto 20px;">
                            ${friend.name.split(' ')[1]}
                        </div>
                        <h3>${friend.name}</h3>
                        <div class="bac-value ${status.class}" style="font-size: 2em; margin: 20px 0;">
                            ${friend.bac.toFixed(3)}‚Ä∞
                        </div>
                        <p><i class="fas fa-map-marker-alt"></i> ${friend.location}</p>
                        <div style="margin: 20px 0;">
                            <canvas id="friendChart" width="400" height="200"></canvas>
                        </div>
                        <div style="margin: 20px 0;">
                            <button class="btn" onclick="messageFriend('${friend.name}')">
                                <i class="fas fa-message"></i> Send Message
                            </button>
                            <button class="btn" onclick="callFriend('${friend.name}')">
                                <i class="fas fa-phone"></i> Call
                            </button>
                            <button class="btn" onclick="shareLocation('${friend.name}')">
                                <i class="fas fa-location-arrow"></i> Share Location
                            </button>
                        </div>
                    </div>
                `;
                
                // Draw friend's BAC chart
                drawFriendChart(friend);
            }, 100);
        }
        
        // Draw friend's BAC chart
        function drawFriendChart(friend) {
            const canvas = document.getElementById('friendChart');
            if (!canvas || !friend.history || friend.history.length === 0) return;
            
            const ctx = canvas.getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: friend.history.map((_, i) => i),
                    datasets: [{
                        label: 'BAC Level',
                        data: friend.history.map(h => h.value),
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 0.15
                        }
                    }
                }
            });
        }
        
        // Emergency functions
        function callEmergency(type) {
            switch(type) {
                case 'ambulance':
                    if (confirm('Call emergency services (112)?')) {
                        window.location.href = 'tel:112';
                    }
                    break;
                case 'campus-security':
                    if (confirm('Call HSG Campus Security?')) {
                        window.location.href = 'tel:+41712242424';
                    }
                    break;
                case 'taxi':
                    showNotification('üöï Opening taxi options...');
                    setTimeout(() => {
                        showTaxiOptions();
                    }, 500);
                    break;
            }
        }
        
        function callUber() {
            showNotification('üöï Opening Uber app...');
            // Try to open Uber app or website
            window.open('https://m.uber.com/ul/', '_blank');
        }
        
        function showTaxiOptions() {
            const options = `
                <h2>üöï Ride Options</h2>
                <div style="margin: 20px 0;">
                    <button class="btn" style="width: 100%; margin: 10px 0;" onclick="window.open('https://m.uber.com/ul/', '_blank')">
                        <i class="fab fa-uber"></i> Uber
                    </button>
                    <button class="btn" style="width: 100%; margin: 10px 0;" onclick="window.location.href='tel:+41712222222'">
                        <i class="fas fa-taxi"></i> Local Taxi
                    </button>
                    <button class="btn" style="width: 100%; margin: 10px 0;" onclick="callSoberFriend()">
                        <i class="fas fa-user-friends"></i> Call Sober Friend
                    </button>
                </div>
                <button class="btn" onclick="closeModal()">Cancel</button>
            `;
            
            document.getElementById('modalBody').innerHTML = options;
            document.getElementById('modal').classList.add('show');
        }
        
        function showFirstAid() {
            showModal('first-aid');
        }
        
        // Game functions
        function startGame(gameType) {
            currentGame = gameType;
            
            const gameOverlay = document.createElement('div');
            gameOverlay.className = 'game-overlay';
            gameOverlay.id = 'gameOverlay';
            
            let gameContent = '';
            
            switch(gameType) {
                case 'never-have-i-ever':
                    gameContent = createNeverHaveIEverGame();
                    break;
                case 'truth-or-dare':
                    gameContent = createTruthOrDareGame();
                    break;
                case 'kings-cup':
                    gameContent = createKingsCupGame();
                    break;
                case 'beer-pong':
                    gameContent = createBeerPongGame();
                    break;
                case 'flip-cup':
                    gameContent = createFlipCupGame();
                    break;
                case 'trivia':
                    gameContent = createTriviaGame();
                    break;
            }
            
            gameOverlay.innerHTML = `
                <div class="game-container">
                    <div class="game-header">
                        <div class="game-title">${getGameTitle(gameType)}</div>
                        <div class="close-game" onclick="closeGame()">√ó</div>
                    </div>
                    ${gameContent}
                </div>
            `;
            
            document.body.appendChild(gameOverlay);
            setTimeout(() => gameOverlay.classList.add('show'), 10);
            
            // Initialize game
            initializeGame(gameType);
            
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }
        
        function closeGame() {
            const overlay = document.getElementById('gameOverlay');
            if (overlay) {
                overlay.classList.remove('show');
                setTimeout(() => overlay.remove(), 500);
            }
            currentGame = null;
        }
        
        // Game creators
        function createNeverHaveIEverGame() {
            const questions = [
                "Never have I ever skipped a lecture for a party",
                "Never have I ever kissed someone at a HSG party",
                "Never have I ever failed an exam because of partying",
                "Never have I ever woken up in the library",
                "Never have I ever used ChatGPT for an assignment",
                "Never have I ever been to a professor's office hours drunk",
                "Never have I ever stolen food from a dorm kitchen",
                "Never have I ever dated someone from my study group"
            ];
            
            return `
                <div class="question-card" id="gameQuestion">
                    Click "Next Question" to start!
                </div>
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" onclick="nextNeverHaveIEver()">
                        <i class="fas fa-arrow-right"></i> Next Question
                    </button>
                </div>
                <div style="text-align: center; opacity: 0.7;">
                    <p>Drink if you've done it! üçª</p>
                </div>
            `;
        }
        
        function createTruthOrDareGame() {
            return `
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" style="margin: 10px;" onclick="showTruth()">
                        <i class="fas fa-comment"></i> Truth
                    </button>
                    <button class="btn btn-danger" style="margin: 10px;" onclick="showDare()">
                        <i class="fas fa-fire"></i> Dare
                    </button>
                </div>
                <div class="question-card" id="gameQuestion">
                    Choose Truth or Dare!
                </div>
                <div id="playerName" style="text-align: center; font-size: 1.5em; margin-top: 20px;"></div>
            `;
        }
        
        function createKingsCupGame() {
            const rules = {
                'A': 'üçâ Waterfall - Everyone drinks!',
                '2': 'üëâ You - Choose someone to drink',
                '3': 'üëà Me - You drink!',
                '4': 'üëØ Floor - Last to touch floor drinks',
                '5': 'üôã Guys - All guys drink',
                '6': 'üíÉ Chicks - All girls drink',
                '7': 'üåà Heaven - Last to raise hand drinks',
                '8': 'ü§ù Mate - Choose a drinking buddy',
                '9': 'üéµ Rhyme - Say a word, others rhyme',
                '10': 'üìè Categories - Name things in category',
                'J': 'üëë Make a Rule',
                'Q': '‚ùì Questions - Ask questions only',
                'K': 'üèÜ King\'s Cup - Pour into center cup'
            };
            
            return `
                <div style="text-align: center;">
                    <div style="font-size: 6em; margin: 20px 0;" id="currentCard">üé¥</div>
                    <button class="btn btn-primary" onclick="drawCard()">
                        <i class="fas fa-clone"></i> Draw Card
                    </button>
                </div>
                <div class="question-card" id="gameQuestion">
                    Click "Draw Card" to start!
                </div>
            `;
        }
        
        function createBeerPongGame() {
            return `
                <div class="score-display">
                    <div class="team-score">
                        <div class="team-name">Team 1</div>
                        <div class="team-points" id="team1Score">0</div>
                        <button class="btn" onclick="addScore('team1')">+1</button>
                    </div>
                    <div class="team-score">
                        <div class="team-name">Team 2</div>
                        <div class="team-points" id="team2Score">0</div>
                        <button class="btn" onclick="addScore('team2')">+1</button>
                    </div>
                </div>
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" onclick="resetBeerPong()">
                        <i class="fas fa-redo"></i> New Game
                    </button>
                </div>
                <div id="gameStatus" style="text-align: center; font-size: 1.5em; margin-top: 20px;"></div>
            `;
        }
        
        function createFlipCupGame() {
            return `
                <div class="timer-display" id="flipTimer">00:00</div>
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" id="timerBtn" onclick="toggleFlipTimer()">
                        <i class="fas fa-play"></i> Start Timer
                    </button>
                    <button class="btn" onclick="resetFlipTimer()">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
                <div id="bestTime" style="text-align: center; font-size: 1.2em; margin-top: 20px;">
                    Best Time: --:--
                </div>
            `;
        }
        
        function createTriviaGame() {
            return `
                <div class="question-card" id="gameQuestion">
                    Click "Next Question" to start HSG Trivia!
                </div>
                <div id="triviaOptions" style="margin: 20px 0;"></div>
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" onclick="nextTrivia()">
                        <i class="fas fa-arrow-right"></i> Next Question
                    </button>
                </div>
                <div class="score-display">
                    <div class="team-score">
                        <div class="team-name">Score</div>
                        <div class="team-points" id="triviaScore">0</div>
                    </div>
                </div>
            `;
        }
        
        // Game logic
        let gameData = {
            neverHaveIEver: [
                "Never have I ever skipped a lecture for a party",
                "Never have I ever kissed someone at a HSG party",
                "Never have I ever failed an exam because of partying",
                "Never have I ever woken up in the library",
                "Never have I ever used ChatGPT for an assignment",
                "Never have I ever been to a professor's office hours drunk",
                "Never have I ever stolen food from a dorm kitchen",
                "Never have I ever dated someone from my study group",
                "Never have I ever fallen asleep during a presentation",
                "Never have I ever pretended to be sick to avoid a group project"
            ],
            truths: [
                "What's your most embarrassing HSG moment?",
                "Who's your secret crush on campus?",
                "What's the worst grade you've ever gotten?",
                "Have you ever cheated on an exam?",
                "What's your biggest fear about graduation?",
                "Which professor do you have a crush on?",
                "What's the craziest thing you've done at HSG?"
            ],
            dares: [
                "Text your crush right now!",
                "Do 20 pushups",
                "Sing the HSG anthem",
                "Call a random contact and say 'I love you'",
                "Post an embarrassing photo on Instagram",
                "Dance without music for 1 minute",
                "Let someone go through your phone for 30 seconds"
            ],
            trivia: [
                {
                    question: "When was HSG founded?",
                    options: ["1898", "1923", "1945", "1967"],
                    correct: 0
                },
                {
                    question: "What does HSG stand for?",
                    options: ["High School Gymnasium", "Hochschule St. Gallen", "Higher Studies Group", "Helvetic Study Group"],
                    correct: 1
                },
                {
                    question: "How many students attend HSG?",
                    options: ["5,000", "9,000", "12,000", "15,000"],
                    correct: 1
                },
                {
                    question: "What's the most popular major at HSG?",
                    options: ["Law", "Business Administration", "Computer Science", "International Affairs"],
                    correct: 1
                }
            ]
        };
        
        let gameState = {
            flipTimer: null,
            flipTime: 0,
            bestFlipTime: null,
            triviaScore: 0,
            currentTriviaIndex: 0
        };
        
        function initializeGame(gameType) {
            switch(gameType) {
                case 'beer-pong':
                    gameScores = { team1: 0, team2: 0 };
                    updateBeerPongScore();
                    break;
                case 'trivia':
                    gameState.triviaScore = 0;
                    gameState.currentTriviaIndex = 0;
                    document.getElementById('triviaScore').textContent = '0';
                    break;
            }
        }
        
        function nextNeverHaveIEver() {
            const questions = gameData.neverHaveIEver;
            const random = Math.floor(Math.random() * questions.length);
            document.getElementById('gameQuestion').textContent = questions[random];
        }
        
        function showTruth() {
            const truths = gameData.truths;
            const random = Math.floor(Math.random() * truths.length);
            document.getElementById('gameQuestion').textContent = truths[random];
            selectRandomPlayer();
        }
        
        function showDare() {
            const dares = gameData.dares;
            const random = Math.floor(Math.random() * dares.length);
            document.getElementById('gameQuestion').textContent = dares[random];
            selectRandomPlayer();
        }
        
        function selectRandomPlayer() {
            const players = Object.keys(partyData);
            const random = Math.floor(Math.random() * players.length);
            const player = players[random].split(' ')[0];
            document.getElementById('playerName').textContent = `${player}'s turn!`;
        }
        
        function drawCard() {
            const cards = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            const suits = ['‚ô†Ô∏è', '‚ô•Ô∏è', '‚ô¶Ô∏è', '‚ô£Ô∏è'];
            const randomCard = cards[Math.floor(Math.random() * cards.length)];
            const randomSuit = suits[Math.floor(Math.random() * suits.length)];
            
            document.getElementById('currentCard').textContent = randomCard + randomSuit;
            
            const rules = {
                'A': 'üçâ Waterfall - Everyone drinks!',
                '2': 'üëâ You - Choose someone to drink',
                '3': 'üëà Me - You drink!',
                '4': 'üëØ Floor - Last to touch floor drinks',
                '5': 'üôã Guys - All guys drink',
                '6': 'üíÉ Chicks - All girls drink',
                '7': 'üåà Heaven - Last to raise hand drinks',
                '8': 'ü§ù Mate - Choose a drinking buddy',
                '9': 'üéµ Rhyme - Say a word, others rhyme',
                '10': 'üìè Categories - Name things in category',
                'J': 'üëë Make a Rule',
                'Q': '‚ùì Questions - Ask questions only',
                'K': 'üèÜ King\'s Cup - Pour into center cup'
            };
            
            document.getElementById('gameQuestion').textContent = rules[randomCard];
        }
        
        function addScore(team) {
            gameScores[team]++;
            updateBeerPongScore();
            
            if (gameScores[team] >= 10) {
                document.getElementById('gameStatus').textContent = `${team === 'team1' ? 'Team 1' : 'Team 2'} Wins! üèÜ`;
                confetti({
                    particleCount: 200,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }
        
        function updateBeerPongScore() {
            document.getElementById('team1Score').textContent = gameScores.team1;
            document.getElementById('team2Score').textContent = gameScores.team2;
        }
        
        function resetBeerPong() {
            gameScores = { team1: 0, team2: 0 };
            updateBeerPongScore();
            document.getElementById('gameStatus').textContent = '';
        }
        
        function toggleFlipTimer() {
            const btn = document.getElementById('timerBtn');
            
            if (gameState.flipTimer) {
                clearInterval(gameState.flipTimer);
                gameState.flipTimer = null;
                btn.innerHTML = '<i class="fas fa-play"></i> Start Timer';
                
                if (!gameState.bestFlipTime || gameState.flipTime < gameState.bestFlipTime) {
                    gameState.bestFlipTime = gameState.flipTime;
                    document.getElementById('bestTime').textContent = `Best Time: ${formatTime(gameState.bestFlipTime)}`;
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }
            } else {
                gameState.flipTime = 0;
                gameState.flipTimer = setInterval(() => {
                    gameState.flipTime++;
                    document.getElementById('flipTimer').textContent = formatTime(gameState.flipTime);
                }, 10);
                btn.innerHTML = '<i class="fas fa-pause"></i> Stop Timer';
            }
        }
        
        function resetFlipTimer() {
            if (gameState.flipTimer) {
                clearInterval(gameState.flipTimer);
                gameState.flipTimer = null;
            }
            gameState.flipTime = 0;
            document.getElementById('flipTimer').textContent = '00:00';
            document.getElementById('timerBtn').innerHTML = '<i class="fas fa-play"></i> Start Timer';
        }
        
        function formatTime(centiseconds) {
            const minutes = Math.floor(centiseconds / 6000);
            const seconds = Math.floor((centiseconds % 6000) / 100);
            const cs = centiseconds % 100;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${cs.toString().padStart(2, '0')}`;
        }
        
        function nextTrivia() {
            const trivia = gameData.trivia;
            const current = trivia[gameState.currentTriviaIndex % trivia.length];
            
            document.getElementById('gameQuestion').textContent = current.question;
            
            const optionsHtml = current.options.map((option, index) => 
                `<button class="btn" style="width: 100%; margin: 10px 0;" onclick="answerTrivia(${index}, ${current.correct})">${option}</button>`
            ).join('');
            
            document.getElementById('triviaOptions').innerHTML = optionsHtml;
            gameState.currentTriviaIndex++;
        }
        
        function answerTrivia(selected, correct) {
            const buttons = document.getElementById('triviaOptions').querySelectorAll('button');
            
            if (selected === correct) {
                gameState.triviaScore++;
                document.getElementById('triviaScore').textContent = gameState.triviaScore;
                buttons[selected].style.background = 'linear-gradient(45deg, #00ff88, #00d4ff)';
                showNotification('‚úÖ Correct! +1 point');
            } else {
                buttons[selected].style.background = 'linear-gradient(45deg, #ff4444, #ff0088)';
                buttons[correct].style.background = 'linear-gradient(45deg, #00ff88, #00d4ff)';
                showNotification('‚ùå Wrong answer!');
            }
            
            // Disable all buttons
            buttons.forEach(btn => btn.disabled = true);
            
            // Auto next question after 2 seconds
            setTimeout(nextTrivia, 2000);
        }
        
        function getGameTitle(gameType) {
            const titles = {
                'never-have-i-ever': 'üôä Never Have I Ever',
                'truth-or-dare': 'üéØ Truth or Dare',
                'kings-cup': 'üëë King\'s Cup',
                'beer-pong': 'üèì Beer Pong',
                'flip-cup': 'ü•§ Flip Cup',
                'trivia': 'üß† HSG Trivia'
            };
            return titles[gameType] || 'Party Game';
        }
        
        // Location functions
        function checkInLocation(location) {
            locationHistory.push({
                location: location,
                time: Date.now(),
                user: currentUser
            });
            
            showNotification(`üìç Checked in at ${location}!`);
            
            // Update achievement
            if (locationHistory.length >= 10) {
                achievements.partyAnimal = true;
                showAchievementUnlocked('Party Animal');
            }
            
            closeModal();
        }
        
        function createLocationMap() {
            // Simulated map with dots
            const locations = getActiveLocations();
            let mapHtml = '<div style="position: relative; width: 100%; height: 100%; background: rgba(255,255,255,0.05); border-radius: 20px;">';
            
            locations.forEach((loc, index) => {
                const x = 20 + (index % 3) * 30;
                const y = 20 + Math.floor(index / 3) * 30;
                mapHtml += `
                    <div class="location-dot" style="left: ${x}%; top: ${y}%;" title="${loc.name}: ${loc.count} people">
                        <span style="position: absolute; top: -20px; left: -20px; font-size: 0.8em; white-space: nowrap;">${loc.name}</span>
                    </div>
                `;
            });
            
            mapHtml += '</div>';
            return mapHtml;
        }
        
        function initializeLocationMap() {
            // Add interactive features to location map
            const dots = document.querySelectorAll('.location-dot');
            dots.forEach(dot => {
                dot.addEventListener('click', function() {
                    const location = this.getAttribute('title');
                    showNotification(`üìç ${location}`);
                });
            });
        }
        
        function getActiveLocations() {
            const locationCounts = {};
            
            Object.values(partyData).forEach(friend => {
                if (!locationCounts[friend.location]) {
                    locationCounts[friend.location] = { count: 0, totalBac: 0 };
                }
                locationCounts[friend.location].count++;
                locationCounts[friend.location].totalBac += friend.bac;
            });
            
            return Object.entries(locationCounts).map(([name, data]) => ({
                name,
                count: data.count,
                avgBac: data.totalBac / data.count
            }));
        }
        
        // Friend functions
        function messageFriend(friendName) {
            const messages = [
                "Hey! How's the party going? üéâ",
                "You okay? Need anything? üíö",
                "Where are you? Let's meet up! üìç",
                "Having fun? Stay safe! üéä",
                "Water break time! üíß"
            ];
            const randomMsg = messages[Math.floor(Math.random() * messages.length)];
            showNotification(`üì± Sent to ${friendName.split(' ')[0]}: "${randomMsg}"`);
            closeModal();
        }
        
        function callFriend(friendName) {
            showNotification(`üìû Calling ${friendName.split(' ')[0]}...`);
            // In real app, would initiate call
            closeModal();
        }
        
        function shareLocation(friendName) {
            showNotification(`üìç Location shared with ${friendName.split(' ')[0]}`);
            closeModal();
        }
        
        function selectBuddy(buddyName) {
            localStorage.setItem('buddy', buddyName);
            showNotification(`üë• ${buddyName.split(' ')[0]} is now your buddy!`);
            
            // Achievement check
            achievements.guardianAngel = true;
            showAchievementUnlocked('Guardian Angel');
            
            closeModal();
        }
        
        function callSoberFriend() {
            const soberFriends = Object.values(partyData).filter(f => f.bac < 0.02);
            if (soberFriends.length > 0) {
                const friend = soberFriends[0];
                showNotification(`üìû Calling ${friend.name.split(' ')[0]}...`);
            } else {
                showNotification('‚ùå No sober friends available right now');
            }
        }
        
        // Hydration reminder
        function showHydrationReminder() {
            showNotification('üíß Time for a water break! Stay hydrated!');
            confetti({
                particleCount: 50,
                spread: 60,
                colors: ['#00d4ff', '#0099ff', '#0066ff'],
                origin: { y: 0.6 }
            });
            
            // Achievement check
            const hydrationCount = parseInt(localStorage.getItem('hydrationCount') || '0') + 1;
            localStorage.setItem('hydrationCount', hydrationCount);
            
            if (hydrationCount >= 12) { // 3 hours worth
                achievements.hydroHomie = true;
                showAchievementUnlocked('Hydro Homie');
            }
        }
        
        // Achievements
        function updateAchievements() {
            const achievementElements = document.querySelectorAll('.achievement');
            
            Object.entries(achievements).forEach(([key, unlocked]) => {
                if (unlocked) {
                    const element = document.querySelector(`.achievement[data-achievement="${key}"]`);
                    if (element && !element.classList.contains('unlocked')) {
                        element.classList.add('unlocked');
                    }
                }
            });
        }
        
        function checkAchievements(friends) {
            // Responsible - stayed safe all night
            if (friends.every(f => f.bac < 0.05) && Date.now() - partyStartTime > 3600000) {
                achievements.responsible = true;
                showAchievementUnlocked('Responsible');
            }
            
            // Sunrise Warrior - party for 6+ hours
            if (Date.now() - partyStartTime > 21600000) {
                achievements.sunriseWarrior = true;
                showAchievementUnlocked('Sunrise Warrior');
            }
        }
        
        function showAchievementUnlocked(name) {
            if (!localStorage.getItem(`achievement_${name}`)) {
                localStorage.setItem(`achievement_${name}`, 'true');
                
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
                
                showNotification(`üèÜ Achievement Unlocked: ${name}!`);
            }
        }
        
        // Alert system
        function checkForAlerts() {
            const criticalFriends = Object.values(partyData).filter(f => f.bac >= 0.08);
            
            if (criticalFriends.length > 0) {
                const alertBanner = document.getElementById('alertBanner');
                const alertText = document.getElementById('alertText');
                
                if (alertBanner && alertText) {
                    const names = criticalFriends.map(f => f.name.split(' ')[0]).join(', ');
                    alertText.textContent = `‚ö†Ô∏è ${names} need${criticalFriends.length > 1 ? '' : 's'} attention! BAC too high!`;
                    
                    if (!alertBanner.classList.contains('show')) {
                        alertBanner.classList.add('show');
                        playSound('alert');
                    }
                }
            } else {
                const alertBanner = document.getElementById('alertBanner');
                if (alertBanner) {
                    alertBanner.classList.remove('show');
                }
            }
        }
        
        // Weather widget
        function updateWeather() {
            // Simulated weather for St. Gallen
            const weather = {
                temp: Math.floor(Math.random() * 10) + 5,
                condition: ['Clear', 'Cloudy', 'Rainy', 'Snowy'][Math.floor(Math.random() * 4)],
                icon: ['‚òÄÔ∏è', '‚òÅÔ∏è', 'üåßÔ∏è', '‚ùÑÔ∏è'][Math.floor(Math.random() * 4)]
            };
            
            const weatherHtml = `
                <div class="weather-widget" id="weatherWidget">
                    <div style="font-size: 2em;">${weather.icon}</div>
                    <div class="weather-temp">${weather.temp}¬∞C</div>
                    <div class="weather-condition">${weather.condition}</div>
                    <div style="font-size: 0.8em; margin-top: 10px; opacity: 0.7;">St. Gallen</div>
                </div>
            `;
            
            const existingWidget = document.getElementById('weatherWidget');
            if (existingWidget) {
                existingWidget.innerHTML = weatherHtml;
            } else {
                const widget = document.createElement('div');
                widget.innerHTML = weatherHtml;
                document.body.appendChild(widget.firstElementChild);
            }
        }
        
        // Voice commands
        function initializeVoiceCommands() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                voiceRecognition = new SpeechRecognition();
                voiceRecognition.continuous = false;
                voiceRecognition.interimResults = false;
                voiceRecognition.lang = 'en-US';
                
                voiceRecognition.onresult = function(event) {
                    const command = event.results[0][0].transcript.toLowerCase();
                    processVoiceCommand(command);
                    document.querySelector('.voice-indicator').classList.remove('listening');
                };
                
                voiceRecognition.onerror = function() {
                    showNotification('üé§ Voice command failed. Try again!');
                    document.querySelector('.voice-indicator').classList.remove('listening');
                };
                
                // Add voice button
                const voiceButton = document.createElement('div');
                voiceButton.className = 'voice-indicator';
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                voiceButton.onclick = toggleVoiceRecognition;
                document.body.appendChild(voiceButton);
            }
        }
        
        function toggleVoiceRecognition() {
            if (voiceRecognition) {
                const indicator = document.querySelector('.voice-indicator');
                
                if (indicator.classList.contains('listening')) {
                    voiceRecognition.stop();
                    indicator.classList.remove('listening');
                } else {
                    voiceRecognition.start();
                    indicator.classList.add('listening');
                    showNotification('üé§ Listening...');
                }
            }
        }
        
        function processVoiceCommand(command) {
            showNotification(`üé§ Heard: "${command}"`);
            
            if (command.includes('party mode')) {
                startPartyMode();
            } else if (command.includes('emergency')) {
                showModal('emergency');
            } else if (command.includes('uber') || command.includes('taxi')) {
                callUber();
            } else if (command.includes('water') || command.includes('hydrate')) {
                showHydrationReminder();
            } else if (command.includes('game')) {
                switchSection('games');
            } else if (command.includes('check in')) {
                showModal('checkin');
            } else if (command.includes('safe friends')) {
                showModal('safe-friends');
            } else {
                showNotification('üé§ Command not recognized');
            }
        }
        
        // Settings
        function saveSettings() {
            const userName = document.getElementById('userName').value;
            const emergencyContact = document.getElementById('emergencyContact').value;
            const shareLocation = document.getElementById('shareLocation').checked;
            const notifications = document.getElementById('notifications').checked;
            
            if (userName) currentUser = userName;
            
            localStorage.setItem('userName', userName);
            localStorage.setItem('emergencyContact', emergencyContact);
            localStorage.setItem('shareLocation', shareLocation);
            localStorage.setItem('notifications', notifications);
            
            // Show saved animation
            const savedIcon = document.createElement('div');
            savedIcon.className = 'settings-saved';
            savedIcon.innerHTML = '‚úÖ';
            document.body.appendChild(savedIcon);
            
            setTimeout(() => savedIcon.remove(), 1000);
            
            showNotification('‚úÖ Settings saved successfully!');
        }
        
        // Drink tracking functions with error handling
        function logDrink() {
            try {
                const type = document.getElementById('drinkType').value;
                const amount = parseInt(document.getElementById('drinkAmount').value) || 0;
                const alcoholPercent = parseFloat(document.getElementById('alcoholPercent').value) || 0;
                
                if (amount <= 0) {
                    showNotification('‚ùå Please enter a valid amount');
                    return;
                }
                
                const drink = {
                    id: Date.now(),
                    type: type,
                    amount: amount,
                    alcoholPercent: alcoholPercent,
                    pureAlcohol: (amount * alcoholPercent / 100).toFixed(1),
                    time: new Date(),
                    emoji: drinkPresets[type].emoji
                };
                
                drinkHistory.unshift(drink);
                
                // Save to localStorage
                saveDrinkHistory();
                
                // Update UI
                updateDrinkStats();
                updateDrinkHistory();
                updateDrinkChart();
                updateEmergencySummary();
                
                // Send to Firebase if connected
                if (!DEMO_MODE && database) {
                    database.ref('drinks/' + currentUser + '/' + drink.id).set({
                        ...drink,
                        time: drink.time.toISOString()
                    });
                }
                
                // Confetti for water!
                if (type === 'water') {
                    confetti({
                        particleCount: 50,
                        spread: 60,
                        colors: ['#00d4ff', '#0099ff', '#0066ff'],
                        origin: { y: 0.6 }
                    });
                    showNotification('üíß Great job staying hydrated!');
                } else {
                    showNotification(`${drink.emoji} Drink logged!`);
                }
                
                // Reset form to defaults
                document.getElementById('drinkAmount').value = drinkPresets[type].amount;
                document.getElementById('alcoholPercent').value = drinkPresets[type].alcohol;
            } catch (error) {
                console.error('Error logging drink:', error);
                showNotification('‚ùå Failed to log drink');
            }
        }
        
        function updateDrinkStats() {
            try {
                const now = Date.now();
                const oneHourAgo = now - 3600000;
                
                // Calculate totals
                const totalDrinks = drinkHistory.filter(d => d.type !== 'water').length;
                const totalWater = drinkHistory.filter(d => d.type === 'water').length;
                const totalAlcohol = drinkHistory.reduce((sum, d) => sum + parseFloat(d.pureAlcohol || 0), 0);
                const recentDrinks = drinkHistory.filter(d => new Date(d.time).getTime() > oneHourAgo && d.type !== 'water').length;
                
                // Update display with null checks
                const totalDrinksEl = document.getElementById('totalDrinks');
                if (totalDrinksEl) totalDrinksEl.textContent = totalDrinks;
                
                const totalWaterEl = document.getElementById('totalWater');
                if (totalWaterEl) totalWaterEl.textContent = totalWater;
                
                const totalAlcoholEl = document.getElementById('totalAlcohol');
                if (totalAlcoholEl) totalAlcoholEl.textContent = totalAlcohol.toFixed(0) + 'ml';
                
                const drinkRateEl = document.getElementById('drinkRate');
                if (drinkRateEl) drinkRateEl.textContent = recentDrinks + '/hr';
            } catch (error) {
                console.error('Error updating drink stats:', error);
            }
        }
        
        function updateDrinkHistory() {
            try {
                const historyContainer = document.getElementById('drinkHistory');
                if (!historyContainer) return;
                
                if (drinkHistory.length === 0) {
                    historyContainer.innerHTML = '<p style="text-align: center; opacity: 0.7;">No drinks logged yet</p>';
                    return;
                }
                
                historyContainer.innerHTML = drinkHistory.slice(0, 20).map(drink => `
                    <div class="playlist-track" style="margin: 10px 0;">
                        <div class="track-info">
                            <div style="font-size: 2em;">${drink.emoji}</div>
                            <div>
                                <div style="font-weight: bold;">${drink.type.charAt(0).toUpperCase() + drink.type.slice(1)}</div>
                                <div style="opacity: 0.7; font-size: 0.9em;">
                                    ${drink.amount}ml ‚Ä¢ ${drink.alcoholPercent}% ‚Ä¢ ${drink.pureAlcohol}ml pure
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.9em;">${formatDrinkTime(drink.time)}</div>
                            <button class="btn" style="padding: 5px 10px; margin-top: 5px;" onclick="removeDrink(${drink.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error updating drink history:', error);
            }
        }
        
        function updateDrinkChart() {
            try {
                const ctx = document.getElementById('drinkChart');
                if (!ctx) return;
                
                // Count drinks by type
                const drinkCounts = {};
                drinkHistory.forEach(drink => {
                    if (!drinkCounts[drink.type]) {
                        drinkCounts[drink.type] = 0;
                    }
                    drinkCounts[drink.type]++;
                });
                
                if (Object.keys(drinkCounts).length === 0) {
                    // No data yet
                    if (drinkChart) {
                        drinkChart.destroy();
                        drinkChart = null;
                    }
                    return;
                }
                
                const labels = Object.keys(drinkCounts);
                const data = Object.values(drinkCounts);
                const emojis = labels.map(type => drinkPresets[type]?.emoji || 'üçπ');
                
                if (drinkChart) {
                    // Update existing chart
                    drinkChart.data.labels = labels.map((label, i) => `${emojis[i]} ${label}`);
                    drinkChart.data.datasets[0].data = data;
                    drinkChart.update();
                } else {
                    // Create new chart
                    drinkChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels.map((label, i) => `${emojis[i]} ${label}`),
                            datasets: [{
                                data: data,
                                backgroundColor: [
                                    '#00ff88',
                                    '#00d4ff',
                                    '#ff00ff',
                                    '#ffcc00',
                                    '#ff4444',
                                    '#0099ff',
                                    '#00ccff',
                                    '#ff0088'
                                ],
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                    labels: {
                                        color: '#fff',
                                        padding: 10,
                                        font: {
                                            size: window.innerWidth < 768 ? 10 : 12
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error updating drink chart:', error);
            }
        }
        
        function updateEmergencySummary() {
            const summary = document.getElementById('emergencySummary');
            if (!summary) return;
            
            const totalAlcohol = drinkHistory.reduce((sum, d) => sum + parseFloat(d.pureAlcohol), 0);
            const timeSpan = drinkHistory.length > 0 ? 
                ((Date.now() - drinkHistory[drinkHistory.length - 1].time) / 3600000).toFixed(1) : 0;
            
            const drinkTypes = {};
            drinkHistory.forEach(d => {
                if (!drinkTypes[d.type]) drinkTypes[d.type] = 0;
                drinkTypes[d.type]++;
            });
            
            summary.innerHTML = `
                <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; margin: 10px 0;">
                    <p><strong>Time Period:</strong> ${timeSpan} hours</p>
                    <p><strong>Total Pure Alcohol:</strong> ${totalAlcohol.toFixed(0)}ml</p>
                    <p><strong>Drink Breakdown:</strong></p>
                    <ul style="margin-left: 20px;">
                        ${Object.entries(drinkTypes).map(([type, count]) => 
                            `<li>${drinkPresets[type].emoji} ${type}: ${count}</li>`
                        ).join('')}
                    </ul>
                    <p><strong>Last Drink:</strong> ${drinkHistory.length > 0 ? 
                        formatDrinkTime(drinkHistory[0].time) : 'None'}</p>
                    <p><strong>Estimated BAC:</strong> ${estimateBAC().toFixed(3)}‚Ä∞</p>
                </div>
            `;
        }
        
        function removeDrink(drinkId) {
            drinkHistory = drinkHistory.filter(d => d.id !== drinkId);
            saveDrinkHistory();
            updateDrinkStats();
            updateDrinkHistory();
            updateDrinkChart();
            updateEmergencySummary();
            showNotification('üóëÔ∏è Drink removed');
        }
        
        function saveDrinkHistory() {
            localStorage.setItem('drinkHistory', JSON.stringify(drinkHistory));
        }
        
        function loadDrinkHistory() {
            const saved = localStorage.getItem('drinkHistory');
            if (saved) {
                try {
                    drinkHistory = JSON.parse(saved);
                    // Convert time strings back to Date objects
                    drinkHistory.forEach(d => {
                        d.time = new Date(d.time);
                    });
                } catch (error) {
                    console.error('Failed to load drink history:', error);
                }
            }
        }
        
        function formatDrinkTime(time) {
            const now = new Date();
            const drinkTime = new Date(time);
            const diffMinutes = Math.floor((now - drinkTime) / 60000);
            
            if (diffMinutes < 1) return 'Just now';
            if (diffMinutes < 60) return `${diffMinutes}m ago`;
            if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}h ago`;
            return drinkTime.toLocaleDateString();
        }
        
        function estimateBAC() {
            // Widmark formula estimation (simplified)
            const weight = 70; // kg (average)
            const gender = 0.68; // male average (0.55 for female)
            const totalAlcohol = drinkHistory.reduce((sum, d) => sum + parseFloat(d.pureAlcohol), 0);
            const hoursSinceFirst = drinkHistory.length > 0 ? 
                ((Date.now() - drinkHistory[drinkHistory.length - 1].time) / 3600000) : 0;
            
            // BAC = (alcohol in grams / (weight * gender factor)) - (0.015 * hours)
            const alcoholGrams = totalAlcohol * 0.789; // ml to grams
            const bac = Math.max(0, (alcoholGrams / (weight * 1000 * gender)) * 100 - (0.015 * hoursSinceFirst));
            
            return bac;
        }
        
        function showEmergencyReport() {
            try {
                const report = {
                    timestamp: new Date().toISOString(),
                    estimatedBAC: estimateBAC().toFixed(3),
                    drinkHistory: drinkHistory,
                    totalAlcohol: drinkHistory.reduce((sum, d) => sum + parseFloat(d.pureAlcohol || 0), 0),
                    userData: {
                        name: currentUser,
                        emergencyContact: localStorage.getItem('emergencyContact') || 'Not provided'
                    }
                };
                
                const reportText = `EMERGENCY MEDICAL REPORT
========================
Generated: ${new Date().toLocaleString()}
Patient: ${report.userData.name}
Emergency Contact: ${report.userData.emergencyContact}

ALCOHOL CONSUMPTION SUMMARY
---------------------------
Estimated BAC: ${report.estimatedBAC}‚Ä∞
Total Pure Alcohol: ${report.totalAlcohol.toFixed(0)}ml
Number of Drinks: ${drinkHistory.filter(d => d.type !== 'water').length}
Water Consumed: ${drinkHistory.filter(d => d.type === 'water').length} glasses

DETAILED DRINK LOG
------------------
${drinkHistory.map(d => 
    `${formatDrinkTime(d.time)}: ${d.emoji} ${d.type} - ${d.amount}ml @ ${d.alcoholPercent}%`
).join('\n')}

MEDICAL NOTES
-------------
- Monitor for signs of alcohol poisoning
- Ensure airway remains clear
- Check vitals regularly
- Consider IV fluids if dehydrated`;
                
                // Create modal with report
                const modalContent = `
                    <h2>üö® Emergency Medical Report</h2>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; margin: 20px 0; max-height: 400px; overflow-y: auto;">
                        <pre style="white-space: pre-wrap; font-family: monospace; font-size: 0.9em;">${escapeHtml(reportText)}</pre>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="copyEmergencyReport()">
                            <i class="fas fa-copy"></i> Copy Report
                        </button>
                        <button class="btn btn-primary" onclick="downloadEmergencyReport()">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button class="btn btn-danger" onclick="shareEmergencyReport()">
                            <i class="fas fa-share"></i> Share
                        </button>
                        <button class="btn" onclick="closeModal()">Close</button>
                    </div>
                `;
                
                // Store report in window for other functions
                window.currentEmergencyReport = reportText;
                
                document.getElementById('modalBody').innerHTML = modalContent;
                document.getElementById('modal').classList.add('show');
            } catch (error) {
                console.error('Error generating emergency report:', error);
                showNotification('‚ùå Error generating report');
            }
        }
        
        function copyEmergencyReport() {
            if (window.currentEmergencyReport) {
                navigator.clipboard.writeText(window.currentEmergencyReport)
                    .then(() => showNotification('üìã Report copied to clipboard!'))
                    .catch(() => {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = window.currentEmergencyReport;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showNotification('üìã Report copied!');
                    });
            }
        }
        
        function downloadEmergencyReport() {
            try {
                const blob = new Blob([window.currentEmergencyReport], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `emergency_report_${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                showNotification('üì• Report downloaded!');
            } catch (error) {
                console.error('Download error:', error);
                showNotification('‚ùå Download failed - use copy instead');
            }
        }
        
        function shareEmergencyReport() {
            if (navigator.share && window.currentEmergencyReport) {
                navigator.share({
                    title: 'Emergency Medical Report',
                    text: window.currentEmergencyReport
                })
                .then(() => showNotification('üì§ Report shared!'))
                .catch(() => showNotification('‚ùå Sharing cancelled'));
            } else {
                // Fallback - copy to clipboard
                copyEmergencyReport();
                showNotification('üìã Report copied - share manually');
            }
        }
        
        // Playlist functions
        function createPlaylist() {
            const playlistHtml = `
                <div class="playlist-container">
                    <h3>üéµ Party Playlist</h3>
                    ${playlist.map((track, index) => `
                        <div class="playlist-track" onclick="playTrack(${index})">
                            <div class="track-info">
                                <div class="track-playing" style="display: ${track.playing ? 'flex' : 'none'};">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                                <div>
                                    <div style="font-weight: bold;">${track.title}</div>
                                    <div style="opacity: 0.7; font-size: 0.9em;">${track.artist}</div>
                                </div>
                            </div>
                            <div>
                                <i class="fas ${track.playing ? 'fa-pause' : 'fa-play'}"></i>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            const dashboardSection = document.getElementById('dashboard');
            const existingPlaylist = dashboardSection.querySelector('.playlist-container');
            
            if (!existingPlaylist) {
                const playlistDiv = document.createElement('div');
                playlistDiv.innerHTML = playlistHtml;
                dashboardSection.appendChild(playlistDiv.firstElementChild);
            }
        }
        
        function playTrack(index) {
            playlist.forEach((track, i) => {
                track.playing = i === index && !track.playing;
            });
            createPlaylist();
            
            if (playlist[index].playing) {
                showNotification(`üéµ Now playing: ${playlist[index].title}`);
            }
        }
        
        // Prediction engine
        function createPredictionEngine() {
            const friends = Object.values(partyData);
            const avgBac = friends.reduce((sum, f) => sum + f.bac, 0) / friends.length;
            const trend = avgBac > 0.05 ? 'increasing' : 'stable';
            const peakTime = new Date(Date.now() + 7200000).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            
            const predictionHtml = `
                <div class="prediction-card">
                    <h3>üîÆ Party Predictions</h3>
                    <div class="prediction-value">Peak BAC: ${(avgBac * 1.5).toFixed(3)}‚Ä∞</div>
                    <div>Expected peak time: ${peakTime}</div>
                    <div style="margin-top: 20px;">Party energy: ${trend}</div>
                    <div style="margin-top: 10px;">Recommended water breaks: Every 15 minutes</div>
                </div>
            `;
            
            const dashboardSection = document.getElementById('dashboard');
            const existingPrediction = dashboardSection.querySelector('.prediction-card');
            
            if (!existingPrediction) {
                const predictionDiv = document.createElement('div');
                predictionDiv.innerHTML = predictionHtml;
                dashboardSection.appendChild(predictionDiv.firstElementChild);
            }
        }
        
        // Sound effects (placeholder)
        function playSound(soundName) {
            // In real implementation, would play actual sound files
            console.log(`Playing sound: ${soundName}`);
        }
        
        // Utility functions
        function getTimeSince(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            return `${Math.floor(seconds / 3600)}h ago`;
        }
        
        function showNotification(message) {
            const notif = document.createElement('div');
            notif.className = 'notification';
            notif.innerHTML = escapeHtml(message);
            notif.onclick = () => notif.remove();
            document.body.appendChild(notif);
            
            setTimeout(() => {
                if (notif.parentNode) {
                    notif.remove();
                }
            }, 4000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Advanced initialization with error handling
        function advancedInit() {
            try {
                // Show loading state
                showLoadingState();
                
                // Initialize Firebase first
                initializeFirebase();
                
                // Create particles
                createParticles();
                
                // Initialize voice commands if supported
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    initializeVoiceCommands();
                }
                
                // Load saved data
                loadSavedData();
                
                // Initialize UI components
                initializeUIComponents();
                
                // Start demo data if in demo mode
                if (DEMO_MODE) {
                    generateDemoData();
                    setInterval(generateDemoData, 3000);
                }
                
                // Update intervals
                setInterval(updateVisualizer, 500);
                
                // Hydration reminders
                setInterval(() => {
                    const minutes = new Date().getMinutes();
                    if (minutes % 15 === 0) {
                        showHydrationReminder();
                    }
                }, 60000);
                
                // Auto-save
                setInterval(saveLocalData, 30000);
                
                // Hide loading state
                hideLoadingState();
                
                // Welcome message
                setTimeout(() => {
                    showNotification('üéâ Welcome to HSG Party Tracker! Stay safe and have fun!');
                }, 1000);
                
                // Add weather widget if not mobile
                if (window.innerWidth > 768) {
                    updateWeather();
                    setInterval(updateWeather, 300000);
                }
                
            } catch (error) {
                console.error('Initialization error:', error);
                hideLoadingState();
                showError('Failed to initialize app. Please refresh.');
            }
        }
        
        function showLoadingState() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'appLoading';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: #0a0a0a;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            `;
            loadingDiv.innerHTML = `
                <div style="text-align: center;">
                    <div class="loading" style="width: 50px; height: 50px; margin: 0 auto 20px;"></div>
                    <h2 style="color: white;">Loading Party Tracker...</h2>
                </div>
            `;
            document.body.appendChild(loadingDiv);
        }
        
        function hideLoadingState() {
            const loadingDiv = document.getElementById('appLoading');
            if (loadingDiv) {
                loadingDiv.style.opacity = '0';
                setTimeout(() => loadingDiv.remove(), 300);
            }
        }
        
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                max-width: 90%;
                z-index: 9999;
            `;
            errorDiv.innerHTML = `
                <h3>‚ö†Ô∏è Error</h3>
                <p>${message}</p>
                <button class="btn" onclick="location.reload()">Reload App</button>
            `;
            document.body.appendChild(errorDiv);
        }
        
        function initializeUIComponents() {
            // Fix drink type selector
            const drinkTypeSelect = document.getElementById('drinkType');
            if (drinkTypeSelect) {
                drinkTypeSelect.addEventListener('change', function() {
                    const preset = drinkPresets[this.value];
                    if (preset) {
                        document.getElementById('drinkAmount').value = preset.amount;
                        document.getElementById('alcoholPercent').value = preset.alcohol;
                    }
                });
            }
            
            // Initialize charts
            updateDrinkChart();
            
            // Create playlist
            createPlaylist();
            
            // Create prediction engine
            createPredictionEngine();
            
            // Fix mobile viewport height
            const setVH = () => {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            };
            setVH();
            window.addEventListener('resize', setVH);
            
            // Prevent pull-to-refresh on mobile
            let lastTouchY = 0;
            document.addEventListener('touchstart', e => {
                lastTouchY = e.touches[0].clientY;
            }, { passive: true });
            
            document.addEventListener('touchmove', e => {
                const touchY = e.touches[0].clientY;
                const touchDiff = touchY - lastTouchY;
                
                if (window.scrollY === 0 && touchDiff > 0) {
                    e.preventDefault();
                }
                lastTouchY = touchY;
            }, { passive: false });
        }
        
        function loadSavedData() {
            try {
                const savedName = localStorage.getItem('userName');
                if (savedName) {
                    const userNameInput = document.getElementById('userName');
                    if (userNameInput) userNameInput.value = savedName;
                    currentUser = savedName;
                }
                
                const emergencyContact = localStorage.getItem('emergencyContact');
                if (emergencyContact) {
                    const emergencyInput = document.getElementById('emergencyContact');
                    if (emergencyInput) emergencyInput.value = emergencyContact;
                }
                
                // Load drink history with error handling
                loadDrinkHistory();
                
                // Load achievements
                Object.keys(achievements).forEach(key => {
                    if (localStorage.getItem(`achievement_${key}`)) {
                        achievements[key] = true;
                    }
                });
                
                // Update displays
                updateDrinkStats();
                updateDrinkHistory();
                updateEmergencySummary();
                
            } catch (error) {
                console.error('Error loading saved data:', error);
            }
        }
        
        function saveLocalData() {
            localStorage.setItem('partyData', JSON.stringify(partyData));
            localStorage.setItem('locationHistory', JSON.stringify(locationHistory));
            localStorage.setItem('achievements', JSON.stringify(achievements));
        }
        
        // Window events
        window.onclick = (event) => {
            if (event.target.className === 'modal show') {
                closeModal();
            }
            if (event.target.className === 'game-overlay show') {
                closeGame();
            }
        };
        
        window.addEventListener('beforeunload', () => {
            saveLocalData();
        });
        
        // Error recovery
        window.addEventListener('unhandledrejection', event => {
            console.error('Unhandled promise rejection:', event.reason);
            showNotification('‚ö†Ô∏è Something went wrong. Try refreshing.');
        });
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                // Update drink type selection to auto-fill amounts
                const drinkTypeSelect = document.getElementById('drinkType');
                if (drinkTypeSelect) {
                    drinkTypeSelect.addEventListener('change', function() {
                        const preset = drinkPresets[this.value];
                        document.getElementById('drinkAmount').value = preset.amount;
                        document.getElementById('alcoholPercent').value = preset.alcohol;
                    });
                }
                
                // Start initialization
                advancedInit();
            });
        } else {
            // DOM already loaded
            advancedInit();
        }
    </script>
</body>
</html>
