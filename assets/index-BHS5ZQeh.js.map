{"version":3,"mappings":"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B,KAAM,2DAA2D,EAC1F,CAAE,KAAM,aAAc,KAAM,kDAAkD,EAC9E,CAAE,KAAM,YAAa,KAAM,oDAAoD,EAC/E,CAAE,KAAM,aAAc,KAAM,uDAAuD,EACnF,CAAE,KAAM,eAAgB,KAAM,qFAAqF,EACnH,CAAE,KAAM,oBAAqB,KAAM,4EAA4E,EAC/G,CAAE,KAAM,oBAAqB,KAAM,2FAA2F,CAC9I,CACA,CACA,EACI,qBAAsB,CAClB,QAAS,CACL,mEACA,6CACA,kEACA,4DACA,oDACA,2CACA,qDACA,2DACA,sDACA,6DACZ,EACQ,eAAgB,CACZ,yDACA,6CACA,sDACA,kEACA,8DACA,oDACA,mDACA,wDACA,kDACA,oDACZ,EACQ,OAAQ,CACJ,0DACA,8DACA,uDACA,2DACA,0DACA,2DACA,8DACA,gDACA,6DACA,oDACZ,EACQ,MAAO,CACH,8DACA,8CACA,mEACA,+CACA,mDACA,4CACA,mDACA,4CACA,4DACA,kDACZ,EACQ,QAAS,CACL,4DACA,mDACA,sDACA,0DACA,iDACA,+DACA,8DACA,kEACA,0DACA,iDACZ,CACA,EACI,qBAAsB,CAClB,QAAS,CACL,kCACA,sBACA,8BACA,iDACA,oCACA,oCACA,yCACA,6CACA,iBACA,sCACZ,EACQ,eAAgB,CACZ,2BACA,cACA,0BACA,iCACA,4BACA,qBACA,kCACA,iCACA,6BACA,qBACZ,EACQ,OAAQ,CACJ,oDACA,0BACA,oDACA,mCACA,kDACA,4CACA,8CACA,yCACA,gDACA,8BACZ,EACQ,MAAO,CACH,wDACA,yCACA,yBACA,4CACA,kCACA,4CACA,+BACA,2BACA,+BACA,8BACZ,EACQ,QAAS,CACL,mCACA,gCACA,4CACA,6CACA,mCACA,4CACA,oCACA,yCACA,2BACA,sCACZ,CACA,EACI,eAAgB,CACZ,QAAS,CACL,qDACA,yDACA,0CACA,iDACA,wCACA,iDACA,mDACA,6CACA,uDACA,4CACZ,EACQ,eAAgB,CACZ,kDACA,mCACA,+BACA,oCACA,sCACA,yCACA,iCACA,oDACA,wDACA,oDACZ,EACQ,OAAQ,CACJ,oCACA,0DACA,6CACA,kDACA,2DACA,qFACA,sCACA,6CACA,mDACA,4DACZ,EACQ,MAAO,CACH,8CACA,0CACA,kCACA,qCACA,0CACA,oDACA,qDACA,4DACA,6CACA,+DACZ,EACQ,QAAS,CACL,qDACA,qDACA,kDACA,yDACA,+CACA,uDACA,yDACA,kDACA,sEACA,gDACZ,CACA,EACI,OAAQ,CACJ,QAAS,CACL,6CACA,2CACA,8CACA,2DACA,mDACA,uCACA,gDACA,8DACA,mDACA,uCACZ,EACQ,eAAgB,CACZ,0CACA,4BACA,6BACA,mDACA,yCACA,yDACA,iCACA,+CACA,uCACA,4CACZ,EACQ,OAAQ,CACJ,sDACA,+CACA,gDACA,gCACA,oCACA,+CACA,2CACA,yEACA,kCACA,uDACZ,EACQ,MAAO,CACH,+BACA,mCACA,yDACA,6CACA,+BACA,6CACA,oDACA,0BACA,8CACA,oDACZ,EACQ,QAAS,CACL,2DACA,sDACA,4CACA,2CACA,gEACA,sDACA,iCACA,6CACA,sDACA,qEACZ,CACA,EACI,MAAO,CACH,QAAS,CACL,gBACA,qBACA,+CACA,2CACA,kCACA,iDACA,uCACA,oBACA,sBACA,oCACZ,EACQ,eAAgB,CACZ,4BACA,wCACA,oCACA,oCACA,0CACA,eACA,wCACA,oCACA,qBACA,gCACZ,EACQ,OAAQ,CACJ,4CACA,gDACA,sBACA,0CACA,8BACA,2DACA,gDACA,0BACA,mDACA,aACZ,EACQ,MAAO,CACH,oCACA,0CACA,4CACA,mCACA,0CACA,sDACA,iDACA,2CACA,iDACA,8BACZ,EACQ,QAAS,CACL,uCACA,6CACA,uDACA,4DACA,4CACA,mDACA,qCACA,2BACA,kDACA,8CACZ,CACA,EACI,eAAgB,CACZ,QAAS,CACL,iFACA,uEACA,iGACA,yEACA,mFACA,0EACA,mDACA,sCACA,mDACA,iEACZ,EACQ,eAAgB,CACZ,2DACA,wDACA,4DACA,qDACA,uDACA,qDACA,yEACA,wDACA,uDACA,wDACZ,EACQ,OAAQ,CACJ,6EACA,oDACA,+EACA,kHACA,qDACA,6DACA,kDACA,oDACA,sEACA,2EACZ,EACQ,MAAO,CACH,iGACA,qEACA,wEACA,gDACA,mEACA,uEACA,8CACA,0EACA,0EACA,sDACZ,EACQ,QAAS,CACL,qFACA,yEACA,sFACA,6EACA,+EACA,2EACA,sEACA,oEACA,gFACA,qEACZ,CACA,EACI,aAAc,CACV,QAAS,CACL,iDACA,yCACA,sCACA,6CACA,kDACA,mDACA,kDACA,+CACA,iDACA,gDACZ,EACQ,eAAgB,CACZ,0CACA,yCACA,qCACA,iDACA,yCACA,oCACA,6CACA,uCACA,0CACA,+CACZ,EACQ,OAAQ,CACJ,4CACA,8DACA,mCACA,yDACA,qCACA,2CACA,oCACA,kDACA,wCACA,4CACZ,EACQ,MAAO,CACH,+CACA,4DACA,8CACA,yCACA,mCACA,2CACA,gDACA,iDACA,gCACA,mDACZ,EACQ,QAAS,CACL,0CACA,+CACA,4DACA,wCACA,iDACA,qCACA,0CACA,mDACA,8BACA,2CACZ,CACA,EACI,gBAAiB,CACb,QAAS,CACL,oBACA,sCACA,0CACA,6BACA,0CACA,4BACA,yBACA,wBACA,cACA,gBACZ,EACQ,eAAgB,CACZ,kBACA,gCACA,iCACA,mCACA,2BACA,gBACA,iCACA,gDACA,+BACA,6BACZ,EACQ,OAAQ,CACJ,+CACA,2BACA,iCACA,kBACA,sCACA,oBACA,2BACA,cACA,6BACA,6CACZ,EACQ,MAAO,CACH,oBACA,kCACA,6BACA,mBACA,oCACA,gCACA,iBACA,qBACA,0BACA,4BACZ,EACQ,QAAS,CACL,sBACA,uCACA,oCACA,sCACA,2BACA,0BACA,yBACA,0CACA,wBACA,8BACZ,CACA,EACI,OAAQ,CACJ,CACI,SAAU,wBACV,QAAS,CAAC,OAAQ,OAAQ,OAAQ,MAAM,EACxC,QAAS,CACrB,EACQ,CACI,SAAU,2BACV,QAAS,CAAC,wBAAyB,wBAAyB,uBAAwB,sBAAsB,EAC1G,QAAS,CACrB,EACQ,CACI,SAAU,gCACV,QAAS,CAAC,QAAS,QAAS,SAAU,QAAQ,EAC9C,QAAS,CACrB,EACQ,CACI,SA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","names":["firebaseConfig","app","auth","database","storage","isInitialized","initializeFirebase","getApps","initializeApp","getAuth","getDatabase","getStorage","error","getFirebaseAuth","getFirebaseDatabase","getFirebaseStorage","ref","pathOrDatabase","maybePath","db","firebaseRef","onValue","reference","callback","firebaseOnValue","set","value","firebaseSet","get","firebaseGet","push","firebasePush","update","values","firebaseUpdate","remove","firebaseRemove","appState","getAppState","getStateValue","key","setStateValue","setCurrentUser","user","getCurrentUser","ErrorTypes","errorMessages","handleError","context","errorType","getErrorType","errorCode","getErrorCode","message","getUserFriendlyMessage","showErrorNotification","cleaned","type","validateInput","fieldName","errors","isSignUp","showAuthScreen","hideAuthScreen","showAuthError","errorDiv","hideAuthLoading","showAuthLoading","toggleAuthMode","handleAuthSubmit","event","email","password","username","signInWithEmailAndPassword","showNotification","createUserWithEmailAndPassword","errorInfo","signOut","firebaseSignOut","setupAuthListener","onAuthenticated","onAuthStateChanged","loadUserData","userData","displayName","initial","notif","deviceListeners","initializeDevices","snapshot","devices","updateDeviceList","deviceId","listenToDevice","pairDeviceById","deviceIdErrors","serverTimestamp","listener","reading","processDeviceReading","partyData","oldBac","deviceList","deviceData","device","lastReading","item","unpairDevice","off","renameDevice","newName","DRINK_PRESETS","BAC_STATUS","getBACStatus","bac","DEVELOPER_UIDS","isDeveloper","uid","SimpleCache","ttl","timer","partyCache","leaderboardCache","CACHE_TTL","createCacheKey","parts","BatchCache","entries","keys","results","pattern","keysToDelete","batchReadingsCache","currentParty","userParties","partyListeners","chatMessages","createParty","name","options","userName","code","partyRef","party","addToUserParties","saveUserParties","startPartyListeners","getPartyByCode","partiesSnapshot","foundParty","child","joinParty","autoJoin","isUserBanned","leaveParty","partyId","targetParty","p","deleteParty","removeFromUserParties","stopPartyListener","loadUserParties","savedParties","currentPartyId","partySnapshot","partyListener","handlePartyRemoved","updatedParty","chatRef","allMessages","newMessages","hasNewMessages","m","partyIds","switchToParty","sendPartyMessage","getPartyStats","memberCount","duration","hours","minutes","handleJoinRequest","userId","approve","requestRef","requestSnapshot","request","getPartyLeaderboard","cacheKey","cached","leaderboard","memberIds","devicePromises","devicesResults","allDeviceIds","userDeviceMap","index","deviceIds","cachedReadings","uncachedDeviceIds","id","readingPromises","readingsResults","deviceReadings","member","highestBac","userDevices","a","b","getFriendsParties","friends","friendIds","parties","friendsParties","now","getNearbyParties","publicParties","kickMember","memberId","reason","updatePartySettings","settings","allowedSettings","updates","togglePartyLock","locked","getCurrentPartyId","quickAddFriend","friendId","updateUI","updateFriendsGrid","updateStats","updateLeaderboard","updateVisualizer","checkForAlerts","grid","data","status","timeSince","getTimeSince","card","showFriendDetails","trendIcon","trendClass","emoji","avgBac","sum","f","avgElement","safeCount","safeElement","hydrationMinutes","hydrationElement","sorted","positionMessages","friend","visualizer","i","bar","height","lastAlertTime","ALERT_COOLDOWN","criticalFriends","names","alertBanner","timestamp","seconds","deferredPrompt","isInstalled","registerServiceWorker","initializePWA","showInstallButton","hideInstallButton","installButton","promptInstall","actionButtons","outcome","initializeOfflineStorage","drinksStore","readingsStore","registration","safeUpdatePartyDisplay","Parties","currentSection","dashboardInfo","currentUser","isCreator","isDev","e","updatePartySwitcher","showPartyUI","hidePartyUI","existingSwitcher","createPartySwitcher","switcher","switcherHTML","partyButtons","isActive","updatePartyInfo","updateMembersList","updatePartyStats","updateLeaveButton","updateCreatorControls","creatorControlsSection","pendingSection","nameEls","codeEls","el","membersList","membersHTML","isThisUserCreator","isCurrentUser","showKickButton","statsEl","stats","leaveBtn","lockBtn","pendingList","searchFriends","searchTerm","resultsDiv","users","friendsData","sendFriendRequest","updateFriendRequests","container","friendRequests","acceptFriendRequest","permission","selectFriendPermission","resolve","modalContent","declineFriendRequest","updateFriendsList","friendsList","friendInfo","friendDiv","updateFriendPermission","newPermission","removeFriend","sendMessage","input","__vitePreload","constants","messageDiv","escapeHtml","handleChatEnter","showHydrationReminder","hydrationCount","achievements","showAchievementUnlocked","checkInLocation","location","locationHistory","createLocationMap","locations","getActiveLocations","mapHtml","loc","x","y","initializeLocationMap","dot","locationCounts","callUber","address","encodedAddress","callEmergency","showTaxiOptions","selectBuddy","buddyName","showFirstAid","updateProfile","usernameCheck","changePassword","newPassword","saveEmergencyInfo","homeAddress","emergencyContact","medicalInfo","safetyNotes","showSettingsSaved","savePrivacySettings","shareLocation","notifications","publicProfile","savedIcon","updateToggleSwitches","toggle","deleteAccount","exportData","blob","url","pairDeviceFromModal","text","div","resolvePermission","Chart","drinkChart","logDrink","amount","alcoholPercent","drink","drinkHistory","saveDrinkHistory","updateDrinkStats","updateDrinkHistory","updateDrinkChart","updateEmergencySummary","firebaseError","oneHourAgo","totalDrinks","d","totalWater","totalAlcohol","recentDrinks","totalDrinksEl","totalWaterEl","totalAlcoholEl","drinkRateEl","historyContainer","formatDrinkTime","ctx","chartVisible","drinkCounts","labels","emojis","label","summary","timeSpan","drinkTypes","count","estimateBAC","removeDrink","drinkId","toggleChart","wrapper","toggleText","showEmergencyReport","report","reportText","copyEmergencyReport","textArea","downloadEmergencyReport","shareEmergencyReport","clearDrinkHistory","loadDrinkHistory","saved","time","drinkTime","diffMinutes","hoursSinceFirst","alcoholGrams","confetti","gamePlayers","currentPlayerIndex","gameData","gameState","startGame","gameType","gameOverlay","gameContent","createNeverHaveIEverGame","createTruthOrDareGame","createKingsCupGame","createBeerPongGame","createFlipCupGame","createTriviaGame","createWouldYouRatherGame","createMostLikelyToGame","createSpinBottleGame","getGameTitle","initializeGame","closeGame","overlay","updateBeerPongScore","selectGameCategory","category","updateCategoryBadge","changeCategoryMidGame","badge","categoryNames","categoryColors","nextNeverHaveIEver","questions","random","drawCard","cards","suits","randomCard","randomSuit","rules","addScore","team","gameScores","resetBeerPong","showBeerPongGame","toggleFlipTimer","btn","formatTime","resetFlipTimer","centiseconds","cs","nextTrivia","trivia","current","optionsHtml","option","answerTrivia","selected","correct","buttons","addPlayer","updatePlayersList","removePlayer","list","player","resetToPlayerSetup","startNeverHaveIEver","startTruthOrDare","updateCurrentPlayer","currentPlayer","nextTurnTruthOrDare","showTruth","truths","truth","showDare","dares","dare","startWouldYouRather","nextWouldYouRather","question","option1","option2","voteWouldYouRather","startMostLikelyTo","nextMostLikelyTo","votingDiv","showVotes","startSpinBottle","spinBottle","bottle","spinner","otherPlayers","_","target","tasks","task","showBeerPongRules","rulesDiv","gameDiv","tournamentDiv","rule","showBeerPongTournament","setupTournament","numTeams","teamInputsDiv","startTournament","teamName","createTournamentBracket","displayTournamentBracket","teams","rounds","currentRoundMatches","roundNumber","nextRoundMatches","bracketDiv","bracketHTML","round","roundIndex","roundName","getRoundName","match","team1Name","team2Name","canSelectWinner","updateRoundTitle","totalRounds","selectWinner","matchId","teamNumber","nextMatch","showTournamentWinner","winner","colors","currentRoundIndex","resetTournament","startNormalBeerPong","startSpecialBeerPong","categoryDiv","selectSpecialBeerPongCategory","startGameWithNames","initializeSpecialGame","createCupFormation","displayCupFormation","cups","isRule","content","rows","cupIndex","formationHTML","cupsInRow","rowIndex","cup","cupStyle","hitCup","ruleDisplay","c","showSpecialGameWinner","closeRuleDisplay","winnerName","resetSpecialGame","achievementDefinitions","userAchievements","loadAchievements","achievementsRef","updateAchievementsUI","saveAchievement","achievementKey","achievement","updateAchievementProgress","increment","updateAchievementStats","achievementEl","progressPercent","totalAchievements","unlockedAchievements","notification","checkAchievements","partyStartTime","onFirstLogin","createNewParty","nameInput","privacySelect","durationSelect","addressInput","result","joinPartyByCode","codeInput","confirmMsg","leaveCurrentParty","sendPartyChat","refreshPublicParties","listEl","joinPublicParty","photoFeedListener","currentFilter","initializePhotos","listenToPhotoFeed","initializeUploadHandler","handlePhotoUpload","photoData","uploadStatus","photoBlob","base64ToBlob","retroBlob","applyRetroFilter","fileName","photoStorageRef","storageRef","uploadBytes","photoUrl","getDownloadURL","photoRef","img","canvas","imageData","r","g","centerX","centerY","radius","distance","vignette","photos","visiblePhotos","photoId","photo","isRecent","displayPhotoFeed","photoFeed","timeAgo","getTimeAgo","likeCount","commentCount","userLiked","getInitials","addRetroStyles","toggleLike","likeRef","addComment","comment","commentRef","deletePhoto","deleteObject","base64","contentType","byteCharacters","byteArrays","offset","slice","byteNumbers","byteArray","oneDayAgo","n","style","refreshPhotoFeed","filterPhotos","viewPhoto","showComments","commentsDiv","comments","commentsHtml","sharePhoto","exposeGlobalFunctions","switchSection","toggleMobileMenu","showModal","closeModal","AllFunctions.searchFriends","AllFunctions.sendFriendRequest","AllFunctions.acceptFriendRequest","AllFunctions.declineFriendRequest","AllFunctions.updateFriendPermission","AllFunctions.removeFriend","AllFunctions.sendMessage","AllFunctions.handleChatEnter","AllFunctions.showHydrationReminder","AllFunctions.checkInLocation","AllFunctions.callUber","AllFunctions.callEmergency","AllFunctions.selectBuddy","AllFunctions.showFirstAid","AllFunctions.updateProfile","AllFunctions.changePassword","AllFunctions.saveEmergencyInfo","AllFunctions.savePrivacySettings","AllFunctions.exportData","AllFunctions.pairDeviceFromModal","AllFunctions.resolvePermission","Drinks.logDrink","Drinks.toggleChart","Drinks.removeDrink","Drinks.showEmergencyReport","Drinks.copyEmergencyReport","Drinks.downloadEmergencyReport","Drinks.shareEmergencyReport","Drinks.clearDrinkHistory","AllFunctions.deleteAccount","updatePartyDisplay","PartiesUI.createNewParty","PartiesUI.joinPartyByCode","PartiesUI.leaveCurrentParty","PartiesUI.sendPartyChat","PartiesUI.refreshPublicParties","PartiesUI.joinPublicParty","Games.startGame","Games.closeGame","Games.nextNeverHaveIEver","Games.showTruth","Games.showDare","Games.drawCard","Games.addScore","Games.resetBeerPong","Games.toggleFlipTimer","Games.resetFlipTimer","Games.nextTrivia","Games.answerTrivia","Games.addPlayer","Games.removePlayer","Games.resetToPlayerSetup","Games.startNeverHaveIEver","Games.startTruthOrDare","Games.nextTurnTruthOrDare","Games.startWouldYouRather","Games.nextWouldYouRather","Games.voteWouldYouRather","Games.startMostLikelyTo","Games.nextMostLikelyTo","Games.showVotes","Games.startSpinBottle","Games.spinBottle","Games.showBeerPongRules","Games.showBeerPongGame","Games.showBeerPongTournament","Games.setupTournament","Games.startTournament","Games.selectWinner","Games.resetTournament","Games.startNormalBeerPong","Games.startSpecialBeerPong","Games.startGameWithNames","Games.hitCup","Games.closeRuleDisplay","Games.resetSpecialGame","Games.selectGameCategory","Games.changeCategoryMidGame","Games.selectSpecialBeerPongCategory","AllFunctions.getActiveLocations","AllFunctions.createLocationMap","AllFunctions.initializeLocationMap","AllFunctions.updateFriendRequests","AllFunctions.updateFriendsList","AllFunctions.escapeHtml","Achievements.updateAchievements","Achievements.updateAchievementProgress","Achievements.checkAchievements","Devices.pairDeviceById","Devices.unpairDevice","Devices.renameDevice","Photos.refreshPhotoFeed","Photos.filterPhotos","Photos.toggleLike","Photos.addComment","Photos.deletePhoto","Photos.viewPhoto","Photos.showComments","Photos.sharePhoto","Photos.handlePhotoUpload","PartyEventManager","attempts","handlers","selector","handler","chatInput","ongoingOption","partyEventManager","PartiesModule","err","registrations","pwaError","authForm","onUserAuthenticated","createParticles","Drinks.loadDrinkHistory","drinkTypeSelect","preset","Drinks.saveDrinkHistory","lastScroll","nav","currentScroll","Photos.initializePhotos","Achievements.loadAchievements","setupFirebaseListeners","loadUserSettings","Achievements.onFirstLogin","cleanupOldBACData","updateChatUIForDeveloper","listenToFriend","requests","connected","updateConnectionStatus","messages","msg","devBadge","deleteBtn","unsafe","friendData","processFriendData","sectionId","s","section","navMenu","Drinks.updateDrinkStats","Drinks.updateDrinkChart","Drinks.updateDrinkHistory","Drinks.updateEmergencySummary","AllFunctions.updateToggleSwitches","particlesContainer","particle","statusElement","dotElement","modal","modalBody","partyDataSafe","safeFriends","emergency","updatePartyChat","chatEl","updatePartyLeaderboard","leaderboardEl","position","handlePartyRequest","kickMemberFromParty","memberName","togglePartyLockUI","isLocked","editPartySettings","sendButton","deleteMessage","messageId","deletePartyAsDev"],"ignoreList":[],"sources":["../../src/js/config/firebase.js","../../src/js/config/app-state.js","../../src/js/utils/error-handler.js","../../src/js/auth/auth.js","../../src/js/ui/notifications.js","../../src/js/features/devices.js","../../src/js/config/constants.js","../../src/js/utils/cache.js","../../src/js/features/parties.js","../../src/js/ui/dashboard.js","../../src/js/utils/pwa.js","../../src/js/main-party-display.js","../../src/js/features/all-functions.js","../../src/js/features/drinks.js","../../src/js/features/games.js","../../src/js/features/achievements.js","../../src/js/features/parties-ui.js","../../src/js/features/photos.js","../../src/js/main.js"],"sourcesContent":["// ========================================\n// FIREBASE CONFIGURATION MODULE\n// ========================================\n// This module handles Firebase initialization using modular SDK\n\nimport { initializeApp, getApps } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';\nimport { \n    getAuth, \n    createUserWithEmailAndPassword,\n    signInWithEmailAndPassword,\n    signOut as firebaseSignOut,\n    onAuthStateChanged,\n    updateProfile as firebaseUpdateProfile,\n    updatePassword as firebaseUpdatePassword,\n    EmailAuthProvider,\n    reauthenticateWithCredential\n} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';\nimport { \n    getDatabase, \n    ref as firebaseRef, \n    onValue as firebaseOnValue,\n    set as firebaseSet,\n    get as firebaseGet,\n    push as firebasePush,\n    update as firebaseUpdate,\n    remove as firebaseRemove,\n    off as firebaseOff,\n    serverTimestamp as firebaseServerTimestamp\n} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';\nimport { getStorage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';\n\n// Firebase configuration - these are public keys, safe to expose\nconst firebaseConfig = {\n    apiKey: \"AIzaSyCuOjiHa8C0jgAte40E774CRJROTWTUdmg\",\n    authDomain: \"hsg-party-tracker.firebaseapp.com\",\n    databaseURL: \"https://hsg-party-tracker-default-rtdb.europe-west1.firebasedatabase.app\",\n    projectId: \"hsg-party-tracker\",\n    storageBucket: \"hsg-party-tracker.firebasestorage.app\",\n    messagingSenderId: \"1047483086606\",\n    appId: \"1:1047483086606:web:a02d77baacd21166fb095f\",\n    measurementId: \"G-VFS4W30Z7P\"\n};\n\n// Initialize Firebase app\nlet app = null;\nlet auth = null;\nlet database = null;\nlet storage = null;\nlet isInitialized = false;\n\n// Initialize Firebase\nexport function initializeFirebase() {\n    // Check if already initialized\n    if (isInitialized) {\n        console.log('Firebase already initialized');\n        return true;\n    }\n    \n    try {\n        // Initialize Firebase app\n        if (!getApps().length) {\n            app = initializeApp(firebaseConfig);\n        } else {\n            app = getApps()[0];\n        }\n        \n        // Get Firebase services\n        auth = getAuth(app);\n        database = getDatabase(app);\n        storage = getStorage(app);\n        \n        isInitialized = true;\n        console.log('✅ Firebase initialized successfully');\n        return true;\n        \n    } catch (error) {\n        console.error('❌ Firebase initialization error:', error);\n        if (typeof window !== 'undefined' && window.showNotification) {\n            window.showNotification('Failed to connect to Firebase', 'error');\n        }\n        return false;\n    }\n}\n\n// Get the auth service\nexport function getFirebaseAuth() {\n    if (!auth) {\n        console.error('Firebase Auth not initialized. Call initializeFirebase() first.');\n        return null;\n    }\n    return auth;\n}\n\n// Get the database service\nexport function getFirebaseDatabase() {\n    if (!database) {\n        console.error('Firebase Database not initialized. Call initializeFirebase() first.');\n        return null;\n    }\n    return database;\n}\n\n// Get the storage service\nexport function getFirebaseStorage() {\n    if (!storage) {\n        console.error('Firebase Storage not initialized. Call initializeFirebase() first.');\n        return null;\n    }\n    return storage;\n}\n\n// Export Firebase Auth functions\nexport {\n    createUserWithEmailAndPassword,\n    signInWithEmailAndPassword,\n    firebaseSignOut as signOut,\n    onAuthStateChanged,\n    firebaseUpdateProfile as updateProfile,\n    firebaseUpdatePassword as updatePassword,\n    EmailAuthProvider,\n    reauthenticateWithCredential\n};\n\n// Export Firebase Database functions with consistent naming\nexport const ref = (pathOrDatabase, maybePath) => {\n    const db = getFirebaseDatabase();\n    if (!db) return null;\n    \n    // Handle both ref(database, path) and ref(path) signatures\n    if (typeof pathOrDatabase === 'string') {\n        return firebaseRef(db, pathOrDatabase);\n    } else if (maybePath !== undefined) {\n        return firebaseRef(pathOrDatabase, maybePath);\n    }\n    return firebaseRef(db, pathOrDatabase);\n};\n\nexport const onValue = (reference, callback) => {\n    if (!reference) return;\n    return firebaseOnValue(reference, callback);\n};\n\nexport const set = (reference, value) => {\n    if (!reference) return Promise.reject('No ref provided');\n    return firebaseSet(reference, value);\n};\n\nexport const get = (reference) => {\n    if (!reference) return Promise.reject('No ref provided');\n    return firebaseGet(reference);\n};\n\nexport const push = (reference, value) => {\n    if (!reference) return null;\n    return firebasePush(reference, value);\n};\n\nexport const update = (reference, values) => {\n    if (!reference) return Promise.reject('No ref provided');\n    return firebaseUpdate(reference, values);\n};\n\nexport const remove = (reference) => {\n    if (!reference) return Promise.reject('No ref provided');\n    return firebaseRemove(reference);\n};\n\nexport const off = (reference, callback) => {\n    if (!reference) return;\n    return firebaseOff(reference, callback);\n};\n\nexport const serverTimestamp = () => {\n    return firebaseServerTimestamp();\n};\n\n// Export auth and database for other modules\nexport { auth, database };","// ========================================\n// APPLICATION STATE MANAGEMENT\n// ========================================\n// Instead of using global variables everywhere,\n// we'll keep all app data in one organized place\n\n// The main state object - this replaces all those global variables\nconst appState = {\n    // User info\n    currentUser: null,\n    userData: {},\n    \n    // Party data\n    partyData: {},\n    partyStartTime: Date.now(),\n    \n    // Device data\n    deviceData: {},\n    \n    // Friends data\n    friendsData: {},\n    friendRequests: [],\n    \n    // Game data\n    currentGame: null,\n    gameScores: { team1: 0, team2: 0 },\n    \n    // Achievements\n    achievements: {\n        firstTimer: true,\n        responsible: false,\n        gameMaster: false,\n        partyAnimal: false,\n        guardianAngel: false,\n        hydroHomie: false,\n        danceMachine: false,\n        sunriseWarrior: false\n    },\n    \n    // User achievements with progress tracking\n    userAchievements: {},\n    \n    // History tracking\n    locationHistory: [],\n    drinkHistory: [],\n    \n    // UI state\n    chartVisible: true,\n    isSignUp: false,\n    isInitialized: false\n};\n\n// Get the entire app state\nexport function getAppState() {\n    return appState;\n}\n\n// Get a specific part of the state\nexport function getStateValue(key) {\n    return appState[key];\n}\n\n// Update a specific part of the state\nexport function setStateValue(key, value) {\n    appState[key] = value;\n}\n\n// Update user data\nexport function setCurrentUser(user) {\n    appState.currentUser = user;\n}\n\n// Get current user\nexport function getCurrentUser() {\n    return appState.currentUser;\n}\n\n// Add a drink to history\nexport function addDrinkToHistory(drink) {\n    appState.drinkHistory.unshift(drink);\n}\n\n// Clear all state (for logout)\nexport function clearAppState() {\n    appState.currentUser = null;\n    appState.userData = {};\n    appState.partyData = {};\n    appState.deviceData = {};\n    appState.friendsData = {};\n    appState.friendRequests = [];\n    appState.currentGame = null;\n    appState.gameScores = { team1: 0, team2: 0 };\n    // Keep achievements and history\n}","// ========================================\n// ERROR HANDLING MODULE\n// ========================================\n// Centralized error handling for better user experience\n\n// Error types\nexport const ErrorTypes = {\n    NETWORK: 'network',\n    AUTH: 'auth',\n    DATABASE: 'database',\n    VALIDATION: 'validation',\n    PERMISSION: 'permission',\n    UNKNOWN: 'unknown'\n};\n\n// User-friendly error messages\nconst errorMessages = {\n    // Network errors\n    'network/offline': 'You appear to be offline. Please check your internet connection.',\n    'network/timeout': 'The request took too long. Please try again.',\n    'network/server-error': 'Server is having issues. Please try again later.',\n    \n    // Auth errors\n    'auth/invalid-email': 'Please enter a valid email address.',\n    'auth/user-disabled': 'This account has been disabled.',\n    'auth/user-not-found': 'No account found with this email.',\n    'auth/wrong-password': 'Incorrect password. Please try again.',\n    'auth/email-already-in-use': 'An account already exists with this email.',\n    'auth/weak-password': 'Password should be at least 6 characters.',\n    'auth/invalid-credential': 'Invalid login credentials. Please try again.',\n    'auth/too-many-requests': 'Too many failed attempts. Please try again later.',\n    'auth/network-request-failed': 'Network error. Please check your connection.',\n    \n    // Database errors\n    'database/permission-denied': 'You don\\'t have permission to perform this action.',\n    'database/disconnected': 'Lost connection to database. Reconnecting...',\n    'database/write-failed': 'Failed to save data. Please try again.',\n    \n    // Default\n    'unknown': 'Something went wrong. Please try again.'\n};\n\n// Global error handler\nexport function handleError(error, context = '') {\n    console.error(`Error in ${context}:`, error);\n    \n    // Determine error type\n    const errorType = getErrorType(error);\n    const errorCode = getErrorCode(error);\n    const message = getUserFriendlyMessage(errorCode, error);\n    \n    // Log to console for debugging\n    if (typeof process !== 'undefined' && process.env?.NODE_ENV === 'development') {\n        console.group(`🚨 Error: ${context}`);\n        console.error('Type:', errorType);\n        console.error('Code:', errorCode);\n        console.error('Message:', message);\n        console.error('Original:', error);\n        console.groupEnd();\n    }\n    \n    // Show notification to user\n    showErrorNotification(message, errorType);\n    \n    // Return error info\n    return {\n        type: errorType,\n        code: errorCode,\n        message: message,\n        originalError: error\n    };\n}\n\n// Determine error type from error object\nfunction getErrorType(error) {\n    if (!error) return ErrorTypes.UNKNOWN;\n    \n    // Network errors\n    if (error.code === 'network-request-failed' || \n        error.message?.includes('network') ||\n        error.message?.includes('fetch')) {\n        return ErrorTypes.NETWORK;\n    }\n    \n    // Auth errors\n    if (error.code?.startsWith('auth/')) {\n        return ErrorTypes.AUTH;\n    }\n    \n    // Database errors\n    if (error.code?.startsWith('database/') || \n        error.code === 'permission-denied') {\n        return ErrorTypes.DATABASE;\n    }\n    \n    // Validation errors\n    if (error.name === 'ValidationError') {\n        return ErrorTypes.VALIDATION;\n    }\n    \n    return ErrorTypes.UNKNOWN;\n}\n\n// Extract error code\nfunction getErrorCode(error) {\n    if (error?.code) return error.code;\n    if (error?.message?.includes('network')) return 'network/offline';\n    if (error?.message?.includes('permission')) return 'database/permission-denied';\n    return 'unknown';\n}\n\n// Get user-friendly message\nfunction getUserFriendlyMessage(errorCode, error) {\n    // Check if we have a specific message\n    if (errorMessages[errorCode]) {\n        return errorMessages[errorCode];\n    }\n    \n    // Try to extract from Firebase error\n    if (error?.message && typeof error.message === 'string') {\n        // Clean up Firebase error messages\n        const cleaned = error.message\n            .replace(/Firebase: /g, '')\n            .replace(/Error \\(auth\\/[^)]+\\): /g, '')\n            .replace(/\\.$/, '');\n        \n        // If it's still technical, use a generic message\n        if (cleaned.includes('(') || cleaned.includes(')') || cleaned.length > 100) {\n            return errorMessages['unknown'];\n        }\n        \n        return cleaned;\n    }\n    \n    return errorMessages['unknown'];\n}\n\n// Show error notification\nfunction showErrorNotification(message, type) {\n    // Use existing notification system if available\n    if (window.showNotification) {\n        window.showNotification(message, 'error');\n    } else {\n        // Fallback to alert\n        alert(`Error: ${message}`);\n    }\n}\n\n// Retry helper for network errors\nexport async function retryOperation(operation, maxRetries = 3, delay = 1000) {\n    let lastError;\n    \n    for (let i = 0; i < maxRetries; i++) {\n        try {\n            return await operation();\n        } catch (error) {\n            lastError = error;\n            \n            // Don't retry auth errors\n            if (getErrorType(error) === ErrorTypes.AUTH) {\n                throw error;\n            }\n            \n            // Wait before retrying\n            if (i < maxRetries - 1) {\n                await new Promise(resolve => setTimeout(resolve, delay * (i + 1)));\n            }\n        }\n    }\n    \n    throw lastError;\n}\n\n// Network status monitoring\nlet isOnline = navigator.onLine;\n\nwindow.addEventListener('online', () => {\n    isOnline = true;\n    if (window.showNotification) {\n        window.showNotification('Back online!', 'success');\n    }\n});\n\nwindow.addEventListener('offline', () => {\n    isOnline = false;\n    if (window.showNotification) {\n        window.showNotification('You are offline. Some features may not work.', 'warning');\n    }\n});\n\nexport function checkNetworkStatus() {\n    return isOnline;\n}\n\n// Error boundary for async operations\nexport async function safeAsync(operation, context = 'operation') {\n    try {\n        return await operation();\n    } catch (error) {\n        handleError(error, context);\n        return null;\n    }\n}\n\n// Input validation helper\nexport function validateInput(value, type, fieldName) {\n    const errors = [];\n    \n    switch (type) {\n        case 'email':\n            if (!value) {\n                errors.push(`${fieldName} is required`);\n            } else if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(value)) {\n                errors.push(`Please enter a valid email address`);\n            }\n            break;\n            \n        case 'password':\n            if (!value) {\n                errors.push(`${fieldName} is required`);\n            } else if (value.length < 6) {\n                errors.push(`Password must be at least 6 characters`);\n            }\n            break;\n            \n        case 'username':\n            if (!value) {\n                errors.push(`${fieldName} is required`);\n            } else if (value.length < 3) {\n                errors.push(`Username must be at least 3 characters`);\n            } else if (!/^[a-zA-Z0-9_]+$/.test(value)) {\n                errors.push(`Username can only contain letters, numbers, and underscores`);\n            }\n            break;\n            \n        case 'deviceId':\n            if (!value) {\n                errors.push(`${fieldName} is required`);\n            } else if (!value.match(/^HSG_[a-zA-Z0-9]+$/)) {\n                errors.push(`Device ID must start with HSG_ followed by letters/numbers`);\n            }\n            break;\n    }\n    \n    return errors;\n}","// ========================================\n// AUTHENTICATION MODULE\n// ========================================\n// Handles all login, signup, and user authentication\n\nimport { getFirebaseAuth, getFirebaseDatabase, \n    signInWithEmailAndPassword, \n    createUserWithEmailAndPassword,\n    signOut as firebaseSignOut,\n    onAuthStateChanged \n} from '../config/firebase.js';\nimport { setCurrentUser, setStateValue } from '../config/app-state.js';\nimport { ref, set, get } from '../config/firebase.js';\nimport { handleError, validateInput, safeAsync } from '../utils/error-handler.js';\n\n// Track if we're in signup mode\nlet isSignUp = false;\n\n// ========================================\n// UI TOGGLE FUNCTIONS\n// ========================================\nexport function showAuthScreen() {\n    document.getElementById('authContainer').style.display = 'flex';\n    document.getElementById('userProfile').style.display = 'none';\n    document.querySelector('.container').style.display = 'none';\n}\n\nexport function hideAuthScreen() {\n    document.getElementById('authContainer').style.display = 'none';\n    document.getElementById('userProfile').style.display = 'block';\n    document.querySelector('.container').style.display = 'block';\n}\n\nfunction showAuthError(message) {\n    const errorDiv = document.getElementById('authError');\n    errorDiv.textContent = message;\n    errorDiv.classList.add('show');\n    hideAuthLoading();\n    \n    setTimeout(() => {\n        errorDiv.classList.remove('show');\n    }, 5000);\n}\n\nfunction showAuthLoading() {\n    document.getElementById('authLoading').classList.add('show');\n    document.getElementById('authSubmitBtn').disabled = true;\n}\n\nfunction hideAuthLoading() {\n    document.getElementById('authLoading').classList.remove('show');\n    document.getElementById('authSubmitBtn').disabled = false;\n}\n\n// ========================================\n// TOGGLE BETWEEN LOGIN/SIGNUP\n// ========================================\nexport function toggleAuthMode() {\n    isSignUp = !isSignUp;\n    \n    if (isSignUp) {\n        // Switch to signup\n        document.getElementById('authTitle').textContent = 'Create Your Account';\n        document.getElementById('authButton').textContent = 'Sign Up';\n        document.getElementById('usernameGroup').style.display = 'block';\n        document.getElementById('authToggleText').textContent = 'Already have an account?';\n        document.getElementById('authToggleLink').textContent = 'Login';\n    } else {\n        // Switch to login\n        document.getElementById('authTitle').textContent = 'Welcome Back';\n        document.getElementById('authButton').textContent = 'Login';\n        document.getElementById('usernameGroup').style.display = 'none';\n        document.getElementById('authToggleText').textContent = \"Don't have an account?\";\n        document.getElementById('authToggleLink').textContent = 'Sign up';\n    }\n}\n\n// ========================================\n// HANDLE LOGIN/SIGNUP\n// ========================================\nexport async function handleAuthSubmit(event) {\n    event.preventDefault();\n    \n    const email = document.getElementById('authEmail').value.trim();\n    const password = document.getElementById('authPassword').value;\n    const username = document.getElementById('authUsername').value.trim();\n    \n    // Validation\n    if (!email || !password) {\n        showAuthError('Please fill in all fields');\n        return;\n    }\n    \n    if (password.length < 6) {\n        showAuthError('Password must be at least 6 characters');\n        return;\n    }\n    \n    showAuthLoading();\n    \n    try {\n        const auth = getFirebaseAuth();\n        const database = getFirebaseDatabase();\n        \n        if (!isSignUp) {\n            // LOGIN\n            await signInWithEmailAndPassword(auth, email, password);\n            showNotification('✅ Welcome back!', 'success');\n            \n        } else {\n            // SIGNUP\n            if (!username || username.length < 3) {\n                showAuthError('Username must be at least 3 characters');\n                hideAuthLoading();\n                return;\n            }\n            \n            // Check if username is taken\n            const usernameCheck = await get(ref(database, 'usernames/' + username.toLowerCase()));\n            if (usernameCheck.exists()) {\n                showAuthError('Username already taken');\n                hideAuthLoading();\n                return;\n            }\n            \n            // Create account\n            const userCredential = await createUserWithEmailAndPassword(auth, email, password);\n            const user = userCredential.user;\n            \n            // Save user data\n            await set(ref(database, 'users/' + user.uid), {\n                username: username,\n                email: email,\n                createdAt: new Date().toISOString(),\n                devices: {},\n                friends: {},\n                achievements: {},\n                settings: {\n                    notifications: true,\n                    shareLocation: false,\n                    publicProfile: true\n                }\n            });\n            \n            // Reserve username\n            await set(ref(database, 'usernames/' + username.toLowerCase()), user.uid);\n            \n            showNotification('✅ Account created successfully!', 'success');\n        }\n        \n        hideAuthLoading();\n        \n    } catch (error) {\n        hideAuthLoading();\n        const errorInfo = handleError(error, 'Authentication');\n        showAuthError(errorInfo.message);\n    }\n}\n\n// ========================================\n// SIGN OUT\n// ========================================\nexport async function signOut() {\n    try {\n        const auth = getFirebaseAuth();\n        await firebaseSignOut(auth);\n        showNotification('👋 Signed out successfully');\n        location.reload();\n    } catch (error) {\n        const errorInfo = handleError(error, 'Sign Out');\n        showNotification(errorInfo.message, 'error');\n    }\n}\n\n// ========================================\n// SETUP AUTH LISTENER\n// ========================================\nexport function setupAuthListener(onAuthenticated) {\n    const auth = getFirebaseAuth();\n    \n    onAuthStateChanged(auth, (user) => {\n        if (user) {\n            setCurrentUser(user);\n            onAuthenticated(user);\n        } else {\n            setCurrentUser(null);\n            showAuthScreen();\n        }\n    });\n}\n\n// ========================================\n// LOAD USER DATA\n// ========================================\nexport async function loadUserData(user) {\n    try {\n        const database = getFirebaseDatabase();\n        const snapshot = await get(ref(database, 'users/' + user.uid));\n        const userData = snapshot.val() || {};\n        \n        // Update profile displays\n        const displayName = userData.username || user.email.split('@')[0];\n        document.getElementById('profileName').textContent = displayName;\n        document.getElementById('profileEmail').textContent = user.email;\n        \n        // Update settings page\n        document.getElementById('settingsUsername').textContent = displayName;\n        document.getElementById('settingsEmail').textContent = user.email;\n        document.getElementById('username').value = userData.username || '';\n        document.getElementById('emailDisplay').value = user.email;\n        document.getElementById('linkedEmail').textContent = user.email;\n        \n        // Update profile initial\n        const initial = displayName.charAt(0).toUpperCase();\n        document.getElementById('profileInitial').textContent = initial;\n        \n        // Store user data in app state\n        setStateValue('userData', userData);\n        \n        return userData;\n        \n    } catch (error) {\n        console.error('Error loading user data:', error);\n        throw error;\n    }\n}\n\n// ========================================\n// HELPER: Show notification (temporary - will move to UI module)\n// ========================================\nfunction showNotification(message, type = 'success') {\n    const notif = document.createElement('div');\n    notif.className = `notification ${type}`;\n    notif.textContent = message;\n    notif.onclick = () => notif.remove();\n    document.body.appendChild(notif);\n    \n    setTimeout(() => {\n        if (notif.parentNode) {\n            notif.remove();\n        }\n    }, 4000);\n}","// ========================================\n// NOTIFICATION SYSTEM\n// ========================================\n// Handles all notification displays in the app\n\nexport function showNotification(message, type = 'success') {\n    const notif = document.createElement('div');\n    notif.className = `notification ${type}`;\n    notif.textContent = message;\n    notif.onclick = () => notif.remove();\n    document.body.appendChild(notif);\n    \n    setTimeout(() => {\n        if (notif.parentNode) {\n            notif.remove();\n        }\n    }, 4000);\n}\n\n// Also make it globally available for HTML onclick handlers\nwindow.showNotification = showNotification;","// ========================================\n// DEVICE MANAGEMENT MODULE\n// ========================================\n// Handles breathalyzer pairing and BAC readings\n\nimport { getFirebaseDatabase } from '../config/firebase.js';\nimport { getCurrentUser, getStateValue, setStateValue } from '../config/app-state.js';\nimport { ref, set, get, remove, onValue, off, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';\nimport { showNotification } from '../ui/notifications.js';\nimport { handleError, validateInput, safeAsync } from '../utils/error-handler.js';\n\n// Store device listeners\nconst deviceListeners = {};\n\n// ========================================\n// INITIALIZE DEVICES\n// ========================================\nexport function initializeDevices() {\n    const user = getCurrentUser();\n    if (!user) return;\n    \n    const database = getFirebaseDatabase();\n    \n    // Listen for user's devices\n    onValue(ref(database, 'users/' + user.uid + '/devices'), (snapshot) => {\n        const devices = snapshot.val() || {};\n        setStateValue('deviceData', devices);\n        updateDeviceList();\n        document.getElementById('deviceCount').textContent = Object.keys(devices).length;\n        \n        // Start listening to each device\n        Object.keys(devices).forEach(deviceId => {\n            listenToDevice(deviceId);\n        });\n    });\n}\n\n// ========================================\n// PAIR NEW DEVICE\n// ========================================\nexport async function pairDeviceById() {\n    const deviceId = document.getElementById('deviceIdInput').value.trim().toUpperCase();\n    \n    // Validate device ID format\n    const deviceIdErrors = validateInput(deviceId, 'deviceId', 'Device ID');\n    if (deviceIdErrors.length > 0) {\n        showNotification(deviceIdErrors[0], 'error');\n        return;\n    }\n    \n    try {\n        const database = getFirebaseDatabase();\n        const user = getCurrentUser();\n        \n        // Check if device exists in readings\n        const deviceSnapshot = await get(ref(database, 'readings/' + deviceId));\n        \n        if (!deviceSnapshot.exists()) {\n            showNotification('❌ Device not found. Make sure it\\'s connected.', 'error');\n            return;\n        }\n        \n        // Check if already paired\n        const deviceData = getStateValue('deviceData');\n        if (deviceData[deviceId]) {\n            showNotification('ℹ️ Device already paired');\n            return;\n        }\n        \n        // Add device to user\n        await set(ref(database, 'users/' + user.uid + '/devices/' + deviceId), {\n            pairedAt: serverTimestamp(),\n            name: 'My Breathalyzer'\n        });\n        \n        // Clear input\n        document.getElementById('deviceIdInput').value = '';\n        \n        showNotification('✅ Device paired successfully!', 'success');\n        \n    } catch (error) {\n        const errorInfo = handleError(error, 'Device Pairing');\n        showNotification(errorInfo.message, 'error');\n    }\n}\n\n// ========================================\n// LISTEN TO DEVICE READINGS\n// ========================================\nfunction listenToDevice(deviceId) {\n    // Don't create duplicate listeners\n    if (deviceListeners[deviceId]) return;\n    \n    const database = getFirebaseDatabase();\n    const listener = onValue(ref(database, 'readings/' + deviceId), (snapshot) => {\n        const reading = snapshot.val();\n        if (reading) {\n            processDeviceReading(deviceId, reading);\n        }\n    });\n    \n    deviceListeners[deviceId] = listener;\n}\n\n// ========================================\n// PROCESS DEVICE READING\n// ========================================\nfunction processDeviceReading(deviceId, reading) {\n    let partyData = getStateValue('partyData') || {};\n    \n    if (!partyData[deviceId]) {\n        partyData[deviceId] = {\n            name: getStateValue('userData').username || 'You',\n            bac: 0,\n            lastUpdate: Date.now(),\n            location: 'Party',\n            trend: 'steady',\n            history: [],\n            isOwn: true\n        };\n    }\n    \n    const oldBac = partyData[deviceId].bac;\n    partyData[deviceId].bac = reading.bac || 0;\n    partyData[deviceId].lastUpdate = Date.now();\n    partyData[deviceId].trend = reading.bac > oldBac ? 'up' : reading.bac < oldBac ? 'down' : 'steady';\n    \n    // Add to history\n    partyData[deviceId].history.push({\n        time: Date.now(),\n        value: reading.bac\n    });\n    \n    // Keep history reasonable\n    if (partyData[deviceId].history.length > 50) {\n        partyData[deviceId].history.shift();\n    }\n    \n    setStateValue('partyData', partyData);\n    \n    // Update UI\n    if (window.updateUI) {\n        window.updateUI();\n    }\n    \n    // Check for alerts\n    if (reading.bac >= 0.08) {\n        showNotification(`⚠️ Your BAC is too high: ${reading.bac.toFixed(3)}‰`, 'error');\n    }\n}\n\n// ========================================\n// UPDATE DEVICE LIST UI\n// ========================================\nfunction updateDeviceList() {\n    const deviceList = document.getElementById('deviceList');\n    if (!deviceList) return;\n    \n    const deviceData = getStateValue('deviceData') || {};\n    deviceList.innerHTML = '';\n    \n    if (Object.keys(deviceData).length === 0) {\n        deviceList.innerHTML = '<p style=\"text-align: center; opacity: 0.7;\">No devices paired yet</p>';\n        return;\n    }\n    \n    const partyData = getStateValue('partyData') || {};\n    \n    Object.entries(deviceData).forEach(([deviceId, device]) => {\n        const lastReading = partyData[deviceId];\n        const item = document.createElement('div');\n        item.className = 'device-item';\n        item.innerHTML = `\n            <div class=\"device-info\">\n                <h4>${device.name || 'Breathalyzer'}</h4>\n                <p>ID: ${deviceId}</p>\n                <p>Last Reading: ${lastReading ? lastReading.bac.toFixed(3) + '‰' : 'No data'}</p>\n            </div>\n            <div>\n                <button class=\"btn\" onclick=\"renameDevice('${deviceId}')\">\n                    <i class=\"fas fa-edit\"></i>\n                </button>\n                <button class=\"btn btn-danger\" onclick=\"unpairDevice('${deviceId}')\">\n                    <i class=\"fas fa-unlink\"></i>\n                </button>\n            </div>\n        `;\n        deviceList.appendChild(item);\n    });\n}\n\n// ========================================\n// DEVICE ACTIONS\n// ========================================\nexport async function unpairDevice(deviceId) {\n    if (confirm('Unpair this device?')) {\n        const database = getFirebaseDatabase();\n        const user = getCurrentUser();\n        await remove(ref(database, 'users/' + user.uid + '/devices/' + deviceId));\n        \n        // Stop listening to this device\n        if (deviceListeners[deviceId]) {\n            const database = getFirebaseDatabase();\n            off(ref(database, 'readings/' + deviceId), 'value', deviceListeners[deviceId]);\n            delete deviceListeners[deviceId];\n        }\n        \n        showNotification('🔓 Device unpaired');\n    }\n}\n\nexport async function renameDevice(deviceId) {\n    const deviceData = getStateValue('deviceData');\n    const newName = prompt('Enter new name for device:', deviceData[deviceId]?.name || 'My Breathalyzer');\n    \n    if (newName) {\n        const database = getFirebaseDatabase();\n        const user = getCurrentUser();\n        await set(ref(database, 'users/' + user.uid + '/devices/' + deviceId + '/name'), newName);\n        showNotification('✏️ Device renamed');\n    }\n}\n\n// Make functions available globally for onclick handlers\nwindow.pairDeviceById = pairDeviceById;\nwindow.unpairDevice = unpairDevice;\nwindow.renameDevice = renameDevice;","// ========================================\n// APPLICATION CONSTANTS\n// ========================================\n// All the constant values used in the app\n// Having them in one place makes them easy to change\n\n// Drink presets - standard serving sizes\nexport const DRINK_PRESETS = {\n    beer: { \n        amount: 330,      // milliliters\n        alcohol: 5,       // percentage\n        emoji: '🍺' \n    },\n    wine: { \n        amount: 150,\n        alcohol: 12,\n        emoji: '🍷' \n    },\n    shot: { \n        amount: 40,\n        alcohol: 40,\n        emoji: '🥃' \n    },\n    cocktail: { \n        amount: 200,\n        alcohol: 15,\n        emoji: '🍸' \n    },\n    mixed: { \n        amount: 250,\n        alcohol: 10,\n        emoji: '🥤' \n    },\n    champagne: { \n        amount: 150,\n        alcohol: 12,\n        emoji: '🥂' \n    },\n    water: { \n        amount: 250,\n        alcohol: 0,\n        emoji: '💧' \n    },\n    other: { \n        amount: 200,\n        alcohol: 5,\n        emoji: '🍹' \n    }\n};\n\n// BAC (Blood Alcohol Content) levels and their meanings\nexport const BAC_STATUS = {\n    SOBER: {\n        max: 0.02,\n        class: 'bac-safe',\n        text: 'Sober',\n        emoji: '😊'\n    },\n    BUZZED: {\n        max: 0.05,\n        class: 'bac-caution',\n        text: 'Buzzed',\n        emoji: '😎'\n    },\n    IMPAIRED: {\n        max: 0.08,\n        class: 'bac-danger',\n        text: 'No Driving!',\n        emoji: '🚫'\n    },\n    DRUNK: {\n        max: Infinity,\n        class: 'bac-critical',\n        text: 'Too Much!',\n        emoji: '🤢'\n    }\n};\n\n// Helper function to get BAC status\nexport function getBACStatus(bac) {\n    if (bac < BAC_STATUS.SOBER.max) return BAC_STATUS.SOBER;\n    if (bac < BAC_STATUS.BUZZED.max) return BAC_STATUS.BUZZED;\n    if (bac < BAC_STATUS.IMPAIRED.max) return BAC_STATUS.IMPAIRED;\n    return BAC_STATUS.DRUNK;\n}\n\n// Developer/Admin UIDs - Add your UID here\nexport const DEVELOPER_UIDS = [\n    // Add your Firebase UID here after checking it in the console\n    // You can find it in Firebase Console > Authentication > Users\n    // Example: 'abc123def456'\n    'k1OvkYapqbZUAf9RbvfmnhgWcY23'  // rongtimon@gmail.com\n];\n\n// Developer permissions\nexport const DEV_PERMISSIONS = {\n    DELETE_ANY_PARTY: true,\n    KICK_ANY_MEMBER: true,\n    JOIN_LOCKED_PARTIES: true,\n    BYPASS_BANS: true,\n    VIEW_ALL_PARTIES: true,\n    MODERATE_CHAT: true\n};\n\n// Check if user is developer\nexport function isDeveloper(uid) {\n    return DEVELOPER_UIDS.includes(uid);\n}","// ========================================\n// CACHE UTILITY MODULE\n// ========================================\n// Simple in-memory cache with TTL support\n\nclass SimpleCache {\n    constructor() {\n        this.cache = new Map();\n        this.timers = new Map();\n    }\n\n    // Set a value with optional TTL (in milliseconds)\n    set(key, value, ttl = null) {\n        // Clear existing timer if any\n        if (this.timers.has(key)) {\n            clearTimeout(this.timers.get(key));\n            this.timers.delete(key);\n        }\n\n        // Store the value\n        this.cache.set(key, {\n            value,\n            timestamp: Date.now()\n        });\n\n        // Set expiration timer if TTL provided\n        if (ttl && ttl > 0) {\n            const timer = setTimeout(() => {\n                this.delete(key);\n            }, ttl);\n            this.timers.set(key, timer);\n        }\n    }\n\n    // Get a value from cache\n    get(key) {\n        const item = this.cache.get(key);\n        return item ? item.value : null;\n    }\n\n    // Check if key exists and is not expired\n    has(key) {\n        return this.cache.has(key);\n    }\n\n    // Delete a key\n    delete(key) {\n        if (this.timers.has(key)) {\n            clearTimeout(this.timers.get(key));\n            this.timers.delete(key);\n        }\n        return this.cache.delete(key);\n    }\n\n    // Clear entire cache\n    clear() {\n        // Clear all timers\n        for (const timer of this.timers.values()) {\n            clearTimeout(timer);\n        }\n        this.timers.clear();\n        this.cache.clear();\n    }\n\n    // Get cache size\n    size() {\n        return this.cache.size;\n    }\n\n    // Get age of cached item in milliseconds\n    getAge(key) {\n        const item = this.cache.get(key);\n        if (!item) return null;\n        return Date.now() - item.timestamp;\n    }\n}\n\n// Create cache instances for different purposes\nexport const partyCache = new SimpleCache();\nexport const leaderboardCache = new SimpleCache();\nexport const deviceReadingsCache = new SimpleCache();\n\n// Cache TTL constants (in milliseconds)\nexport const CACHE_TTL = {\n    PARTY_DATA: 30000,       // 30 seconds\n    LEADERBOARD: 10000,      // 10 seconds  \n    DEVICE_READINGS: 5000,   // 5 seconds\n    FRIENDS_PARTIES: 60000,  // 1 minute\n    PUBLIC_PARTIES: 120000   // 2 minutes\n};\n\n// Helper function to create a cache key\nexport function createCacheKey(...parts) {\n    return parts.filter(Boolean).join(':');\n}\n\n// Batch cache operations\nexport class BatchCache extends SimpleCache {\n    // Set multiple values at once\n    setMany(entries, ttl = null) {\n        for (const [key, value] of entries) {\n            this.set(key, value, ttl);\n        }\n    }\n\n    // Get multiple values at once\n    getMany(keys) {\n        const results = new Map();\n        for (const key of keys) {\n            const value = this.get(key);\n            if (value !== null) {\n                results.set(key, value);\n            }\n        }\n        return results;\n    }\n\n    // Delete keys matching a pattern\n    deletePattern(pattern) {\n        const keysToDelete = [];\n        for (const key of this.cache.keys()) {\n            if (key.includes(pattern)) {\n                keysToDelete.push(key);\n            }\n        }\n        for (const key of keysToDelete) {\n            this.delete(key);\n        }\n        return keysToDelete.length;\n    }\n}\n\n// Export a batch cache instance for device readings\nexport const batchReadingsCache = new BatchCache();","// PARTY SYSTEM WITH ACTUAL FEATURES\n\nimport { database, auth, ref, set, push, update, get, onValue, serverTimestamp, remove } from '../config/firebase.js';\nimport { showNotification } from '../ui/notifications.js';\nimport { partyCache, leaderboardCache, batchReadingsCache, CACHE_TTL, createCacheKey } from '../utils/cache.js';\nimport { getAppState } from '../config/app-state.js';\nimport { isDeveloper, DEV_PERMISSIONS } from '../config/constants.js';\n\n// Party state - support multiple parties\nexport let currentParty = null;  // Currently viewing party\nexport let userParties = [];     // All parties user is member of\nlet partyListeners = new Map();  // Map of partyId -> listener\nlet chatListener = null;\n\n// Chat optimization\nconst CHAT_PAGE_SIZE = 50;\nconst CHAT_BUFFER_SIZE = 100;\nlet chatMessages = [];\nlet oldestChatKey = null;\n\n// Create party - ENHANCED\nexport async function createParty(name, options = {}) {\n    try {\n        const user = auth.currentUser;\n        if (!user) throw new Error('Not logged in');\n        \n        // Get username from app state\n        const userData = getAppState().userData;\n        const userName = userData.username || user.email.split('@')[0];\n        \n        const code = Math.random().toString(36).substring(2, 8).toUpperCase();\n        const partyRef = push(ref(database, 'parties'));\n        \n        const party = {\n            id: partyRef.key,\n            name: name,\n            code: code,\n            creatorId: user.uid,\n            creatorName: userName,\n            privacy: options.privacy || 'private', // private, friends-only, public\n            duration: options.duration || '24h', // 24h or ongoing\n            address: options.address || '',\n            maxMembers: options.maxMembers || 50,\n            description: options.description || '',\n            members: {\n                [user.uid]: {\n                    name: userName,\n                    joinedAt: Date.now(),\n                    role: 'creator'\n                }\n            },\n            pendingRequests: {}, // For private parties\n            stats: {\n                totalDrinks: 0,\n                avgBac: 0,\n                peakBac: 0,\n                safetyScore: 100\n            },\n            createdAt: Date.now(),\n            expiresAt: options.duration === '24h' ? Date.now() + (24 * 60 * 60 * 1000) : null\n        };\n        \n        await set(partyRef, party);\n        \n        // Add to user's parties list\n        addToUserParties(party);\n        \n        // Set as current party\n        currentParty = party;\n        saveUserParties();\n        \n        // Start listening to party updates\n        startPartyListeners(party.id);\n        \n        return { success: true, code: code, party: party };\n    } catch (error) {\n        console.error('Create party error:', error);\n        return { success: false, error: error.message };\n    }\n}\n\n// Get party info by code (for preview before joining)\nexport async function getPartyByCode(code) {\n    try {\n        const partiesSnapshot = await get(ref(database, 'parties'));\n        if (!partiesSnapshot.exists()) return null;\n        \n        let foundParty = null;\n        partiesSnapshot.forEach((child) => {\n            const party = child.val();\n            if (party.code === code.toUpperCase()) {\n                foundParty = { ...party, id: child.key };\n            }\n        });\n        \n        return foundParty;\n    } catch (error) {\n        console.error('Get party error:', error);\n        return null;\n    }\n}\n\n// Join party - ENHANCED with privacy handling\nexport async function joinParty(code, autoJoin = false) {\n    try {\n        const user = auth.currentUser;\n        if (!user) throw new Error('Not logged in');\n        \n        // Find party by code\n        const foundParty = await getPartyByCode(code);\n        if (!foundParty) throw new Error('Invalid code');\n        \n        // Check if user is banned (unless developer)\n        const isBanned = await isUserBanned(foundParty.id, user.uid);\n        if (isBanned && !isDeveloper(user.uid)) {\n            throw new Error('You have been banned from this party');\n        }\n        \n        // Check if party is locked (unless developer)\n        if (foundParty.locked && !autoJoin && !isDeveloper(user.uid)) {\n            throw new Error('This party is locked. No new members allowed.');\n        }\n        \n        // Check if already a member\n        if (foundParty.members && foundParty.members[user.uid]) {\n            // Already in party, just switch to it\n            addToUserParties(foundParty);\n            currentParty = foundParty;\n            saveUserParties();\n            startPartyListeners(foundParty.id);\n            return { success: true, alreadyMember: true };\n        }\n        \n        // Check party capacity\n        const memberCount = Object.keys(foundParty.members || {}).length;\n        if (memberCount >= (foundParty.maxMembers || 50)) {\n            throw new Error('Party is full');\n        }\n        \n        // Check expiration\n        if (foundParty.expiresAt && Date.now() > foundParty.expiresAt) {\n            throw new Error('Party has expired');\n        }\n        \n        // Get username from app state\n        const userData = getAppState().userData;\n        const userName = userData.username || user.email.split('@')[0];\n        \n        // Handle different privacy levels\n        if (foundParty.privacy === 'public' || autoJoin) {\n            // Direct join for public parties\n            await update(ref(database, `parties/${foundParty.id}/members/${user.uid}`), {\n                name: userName,\n                joinedAt: Date.now(),\n                role: 'member'\n            });\n            \n            // Add to user's parties\n            addToUserParties(foundParty);\n            currentParty = foundParty;\n            saveUserParties();\n            \n            // Start listening to party updates\n            startPartyListeners(foundParty.id);\n            \n            return { success: true };\n            \n        } else if (foundParty.privacy === 'friends-only') {\n            // Check if creator is a friend\n            const friendsSnapshot = await get(ref(database, `users/${user.uid}/friends/${foundParty.creatorId}`));\n            if (!friendsSnapshot.exists()) {\n                throw new Error('This party is for friends only');\n            }\n            \n            // Join as friend\n            await update(ref(database, `parties/${foundParty.id}/members/${user.uid}`), {\n                name: userName,\n                joinedAt: Date.now(),\n                role: 'friend'\n            });\n            \n            addToUserParties(foundParty);\n            currentParty = foundParty;\n            saveUserParties();\n            startPartyListeners(foundParty.id);\n            \n            return { success: true };\n            \n        } else {\n            // Private party - request to join\n            await update(ref(database, `parties/${foundParty.id}/pendingRequests/${user.uid}`), {\n                name: userName,\n                requestedAt: Date.now()\n            });\n            \n            return { success: true, pending: true, party: foundParty };\n        }\n        \n    } catch (error) {\n        console.error('Join party error:', error);\n        return { success: false, error: error.message };\n    }\n}\n\n// Leave party - ENHANCED with creator check\nexport async function leaveParty(partyId = null) {\n    try {\n        const targetParty = partyId ? userParties.find(p => p.id === partyId) : currentParty;\n        if (!targetParty) return { success: true };\n        \n        const user = auth.currentUser;\n        if (!user) throw new Error('Not logged in');\n        \n        // Check if user is the creator\n        if (targetParty.creatorId === user.uid) {\n            // Creator leaving should delete the party\n            return await deleteParty(targetParty.id);\n        }\n        \n        // Regular member leaving\n        await set(\n            ref(database, `parties/${targetParty.id}/members/${user.uid}`), \n            null\n        );\n        \n        // Remove from user's parties list\n        removeFromUserParties(targetParty.id);\n        \n        // If it was the current party, switch to another or null\n        if (currentParty && currentParty.id === targetParty.id) {\n            currentParty = userParties.length > 0 ? userParties[0] : null;\n        }\n        \n        saveUserParties();\n        \n        // Stop listeners for this party\n        stopPartyListener(targetParty.id);\n        \n        return { success: true };\n    } catch (error) {\n        console.error('Leave party error:', error);\n        return { success: false, error: error.message };\n    }\n}\n\n// Delete party (creator only or developer)\nexport async function deleteParty(partyId = null) {\n    try {\n        if (!auth.currentUser) {\n            return { success: false, error: 'Not authenticated' };\n        }\n        \n        const targetParty = partyId ? userParties.find(p => p.id === partyId) : currentParty;\n        \n        // If developer is trying to delete any party by ID\n        if (partyId && !targetParty && isDeveloper(auth.currentUser.uid)) {\n            // Delete directly without checks\n            await remove(ref(database, `parties/${partyId}`));\n            return { success: true };\n        }\n        \n        if (!targetParty) {\n            return { success: false, error: 'Party not found' };\n        }\n        \n        const user = auth.currentUser;\n        \n        // Check if user is the creator or developer\n        if (targetParty.creatorId !== user.uid && !isDeveloper(user.uid)) {\n            return { success: false, error: 'Only the party creator can delete the party' };\n        }\n        \n        // Delete the entire party from Firebase\n        await remove(ref(database, `parties/${targetParty.id}`));\n        \n        // Remove from user's parties list\n        removeFromUserParties(targetParty.id);\n        \n        // If it was the current party, switch to another or null\n        if (currentParty && currentParty.id === targetParty.id) {\n            currentParty = userParties.length > 0 ? userParties[0] : null;\n        }\n        \n        saveUserParties();\n        \n        // Stop listeners\n        stopPartyListener(targetParty.id);\n        \n        return { success: true };\n    } catch (error) {\n        console.error('Delete party error:', error);\n        return { success: false, error: error.message };\n    }\n}\n\n// Load user's parties on startup\nexport async function loadUserParties() {\n    try {\n        const user = auth.currentUser;\n        if (!user) {\n            console.log('No authenticated user');\n            return;\n        }\n        \n        // Load saved party IDs\n        const savedParties = JSON.parse(localStorage.getItem('userParties') || '[]');\n        const currentPartyId = localStorage.getItem('currentPartyId');\n        \n        // Clear arrays\n        userParties = [];\n        currentParty = null;\n        \n        // Check each saved party\n        for (const partyId of savedParties) {\n            const partySnapshot = await get(ref(database, `parties/${partyId}`));\n            if (partySnapshot.exists()) {\n                const partyData = { ...partySnapshot.val(), id: partyId };\n                \n                // Validate membership\n                if (partyData.members && partyData.members[user.uid]) {\n                    // Check expiration\n                    if (!partyData.expiresAt || Date.now() <= partyData.expiresAt) {\n                        userParties.push(partyData);\n                        startPartyListeners(partyId);\n                        \n                        // Set current party if it matches\n                        if (partyId === currentPartyId) {\n                            currentParty = partyData;\n                        }\n                    }\n                }\n            }\n        }\n        \n        // If no current party but user has parties, set the first one\n        if (!currentParty && userParties.length > 0) {\n            currentParty = userParties[0];\n        }\n        \n        // Save cleaned up list\n        saveUserParties();\n        \n        // Update UI\n        if (typeof window !== 'undefined' && window.updatePartyDisplay) {\n            window.updatePartyDisplay();\n        }\n    } catch (error) {\n        console.error('Load parties error:', error);\n    }\n}\n\n// Start party listeners\nfunction startPartyListeners(partyId) {\n    // Don't create duplicate listeners\n    if (partyListeners.has(partyId)) return;\n    \n    // Listen to party updates\n    const partyListener = onValue(ref(database, `parties/${partyId}`), (snapshot) => {\n        if (snapshot.exists()) {\n            const partyData = snapshot.val();\n            const user = auth.currentUser;\n            \n            // Validate party state\n            if (!partyData || !user) {\n                handlePartyRemoved();\n                return;\n            }\n            \n            // Check if user is still a member\n            if (!partyData.members || !partyData.members[user.uid]) {\n                console.log('User no longer a member of party');\n                handlePartyRemoved(partyId);\n                return;\n            }\n            \n            // Check if party has expired\n            if (partyData.expiresAt && Date.now() > partyData.expiresAt) {\n                console.log('Party has expired');\n                handlePartyRemoved(partyId);\n                return;\n            }\n            \n            // Update party data in our list\n            const updatedParty = { ...partyData, id: partyId };\n            addToUserParties(updatedParty);\n            \n            // Update current party if it's the one being viewed\n            if (currentParty && currentParty.id === partyId) {\n                currentParty = updatedParty;\n            }\n            \n            // Save state\n            saveUserParties();\n            \n            // Update UI\n            if (typeof window !== 'undefined' && window.updatePartyDisplay) {\n                window.updatePartyDisplay();\n            }\n        } else {\n            // Party was deleted or doesn't exist\n            console.log('Party no longer exists in Firebase');\n            handlePartyRemoved(partyId);\n        }\n    });\n    \n    // Store the listener\n    partyListeners.set(partyId, partyListener);\n    \n    // Listen to chat with pagination\n    const chatRef = ref(database, `parties/${partyId}/chat`);\n    \n    // Initial load - get last CHAT_PAGE_SIZE messages\n    get(chatRef).then((snapshot) => {\n        chatMessages = [];\n        const allMessages = [];\n        \n        snapshot.forEach((child) => {\n            allMessages.push({ id: child.key, ...child.val() });\n        });\n        \n        // Get the last CHAT_PAGE_SIZE messages\n        chatMessages = allMessages.slice(-CHAT_PAGE_SIZE);\n        if (allMessages.length > 0) {\n            oldestChatKey = allMessages[0].id;\n        }\n        \n        // Update UI with initial messages\n        window.updatePartyChat && window.updatePartyChat(chatMessages);\n    });\n    \n    // Listen only to new messages (not the entire chat)\n    chatListener = onValue(chatRef, (snapshot) => {\n        if (!snapshot.exists()) return;\n        \n        const newMessages = [];\n        let hasNewMessages = false;\n        \n        snapshot.forEach((child) => {\n            const message = { id: child.key, ...child.val() };\n            \n            // Check if this is a new message (not in our current list)\n            const existingIndex = chatMessages.findIndex(m => m.id === message.id);\n            if (existingIndex === -1) {\n                newMessages.push(message);\n                hasNewMessages = true;\n            }\n        });\n        \n        if (hasNewMessages) {\n            // Add new messages and maintain buffer size\n            chatMessages = [...chatMessages, ...newMessages].slice(-CHAT_BUFFER_SIZE);\n            \n            // Update UI with optimized message list\n            window.updatePartyChat && window.updatePartyChat(chatMessages.slice(-CHAT_PAGE_SIZE));\n        }\n    });\n}\n\n// Stop all party listeners\nfunction stopAllPartyListeners() {\n    partyListeners.forEach((listener, partyId) => {\n        listener();\n    });\n    partyListeners.clear();\n    \n    if (chatListener) {\n        chatListener();\n        chatListener = null;\n    }\n}\n\n// Stop specific party listener\nfunction stopPartyListener(partyId) {\n    const listener = partyListeners.get(partyId);\n    if (listener) {\n        listener();\n        partyListeners.delete(partyId);\n    }\n}\n\n// Handle party removal (deleted, expired, or kicked out)\nfunction handlePartyRemoved(partyId) {\n    if (!partyId) return;\n    \n    // Remove from user's parties\n    removeFromUserParties(partyId);\n    \n    // If it was the current party, switch to another\n    if (currentParty && currentParty.id === partyId) {\n        currentParty = userParties.length > 0 ? userParties[0] : null;\n    }\n    \n    saveUserParties();\n    \n    // Stop listeners for this party\n    stopPartyListener(partyId);\n    \n    // Update UI with a small delay to ensure state is settled\n    setTimeout(() => {\n        if (typeof window !== 'undefined' && window.updatePartyDisplay) {\n            window.updatePartyDisplay();\n        }\n    }, 100);\n    \n    // Show notification\n    if (typeof window !== 'undefined' && window.showNotification) {\n        window.showNotification('You have left the party', 'info');\n    }\n}\n\n// Helper functions for multi-party support\nfunction addToUserParties(party) {\n    // Remove if already exists (to update data)\n    userParties = userParties.filter(p => p.id !== party.id);\n    // Add to list\n    userParties.push(party);\n}\n\nfunction removeFromUserParties(partyId) {\n    userParties = userParties.filter(p => p.id !== partyId);\n}\n\nfunction saveUserParties() {\n    const partyIds = userParties.map(p => p.id);\n    localStorage.setItem('userParties', JSON.stringify(partyIds));\n    if (currentParty) {\n        localStorage.setItem('currentPartyId', currentParty.id);\n    } else {\n        localStorage.removeItem('currentPartyId');\n    }\n}\n\n// Switch to a different party\nexport function switchToParty(partyId) {\n    const party = userParties.find(p => p.id === partyId);\n    if (party) {\n        currentParty = party;\n        saveUserParties();\n        \n        // Update UI\n        if (typeof window !== 'undefined' && window.updatePartyDisplay) {\n            window.updatePartyDisplay();\n        }\n        \n        return true;\n    }\n    return false;\n}\n\n// Send party message\nexport async function sendPartyMessage(message) {\n    try {\n        if (!currentParty || !message.trim()) return { success: false };\n        \n        const user = auth.currentUser;\n        if (!user) return { success: false };\n        \n        // Get username from app state\n        const userData = getAppState().userData;\n        const userName = userData.username || user.email.split('@')[0];\n        \n        await push(ref(database, `parties/${currentParty.id}/chat`), {\n            userId: user.uid,\n            userName: userName,\n            message: message.trim(),\n            timestamp: Date.now()\n        });\n        \n        return { success: true };\n    } catch (error) {\n        console.error('Send message error:', error);\n        return { success: false };\n    }\n}\n\n// Get party stats\nexport function getPartyStats() {\n    if (!currentParty) return null;\n    \n    const memberCount = Object.keys(currentParty.members || {}).length;\n    const duration = Date.now() - currentParty.createdAt;\n    const hours = Math.floor(duration / (1000 * 60 * 60));\n    const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));\n    \n    return {\n        memberCount,\n        duration: hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`,\n        code: currentParty.code\n    };\n}\n\n// Approve or decline join request (for party creator)\nexport async function handleJoinRequest(userId, approve) {\n    try {\n        if (!currentParty || currentParty.creatorId !== auth.currentUser.uid) {\n            throw new Error('Only party creator can manage requests');\n        }\n        \n        const requestRef = ref(database, `parties/${currentParty.id}/pendingRequests/${userId}`);\n        const requestSnapshot = await get(requestRef);\n        \n        if (!requestSnapshot.exists()) {\n            throw new Error('Request not found');\n        }\n        \n        const request = requestSnapshot.val();\n        \n        if (approve) {\n            // Add to members\n            await update(ref(database, `parties/${currentParty.id}/members/${userId}`), {\n                name: request.name,\n                joinedAt: Date.now(),\n                role: 'member'\n            });\n        }\n        \n        // Remove from pending\n        await remove(requestRef);\n        \n        return { success: true };\n    } catch (error) {\n        console.error('Handle join request error:', error);\n        return { success: false, error: error.message };\n    }\n}\n\n// Get party leaderboard with caching\nexport async function getPartyLeaderboard() {\n    if (!currentParty) return [];\n    \n    // Check cache first\n    const cacheKey = createCacheKey('leaderboard', currentParty.id);\n    const cached = leaderboardCache.get(cacheKey);\n    if (cached) {\n        return cached;\n    }\n    \n    const leaderboard = [];\n    const memberIds = Object.keys(currentParty.members || {});\n    \n    // Batch fetch all user devices and readings in parallel\n    const devicePromises = memberIds.map(userId => \n        get(ref(database, `users/${userId}/devices`))\n    );\n    \n    const devicesResults = await Promise.all(devicePromises);\n    \n    // Collect all device IDs that need reading\n    const allDeviceIds = [];\n    const userDeviceMap = new Map();\n    \n    devicesResults.forEach((snapshot, index) => {\n        const userId = memberIds[index];\n        if (snapshot.exists()) {\n            const deviceIds = Object.keys(snapshot.val());\n            userDeviceMap.set(userId, deviceIds);\n            allDeviceIds.push(...deviceIds);\n        } else {\n            userDeviceMap.set(userId, []);\n        }\n    });\n    \n    // Check cache for device readings\n    const cachedReadings = batchReadingsCache.getMany(allDeviceIds);\n    const uncachedDeviceIds = allDeviceIds.filter(id => !cachedReadings.has(id));\n    \n    // Batch fetch only uncached readings\n    const readingPromises = uncachedDeviceIds.map(deviceId => \n        get(ref(database, `readings/${deviceId}`))\n    );\n    \n    const readingsResults = await Promise.all(readingPromises);\n    \n    // Create a map of device readings (combining cached and fresh data)\n    const deviceReadings = new Map(cachedReadings);\n    \n    uncachedDeviceIds.forEach((deviceId, index) => {\n        const snapshot = readingsResults[index];\n        if (snapshot.exists()) {\n            const bac = snapshot.val().bac || 0;\n            deviceReadings.set(deviceId, bac);\n            // Cache the fresh reading\n            batchReadingsCache.set(deviceId, bac, CACHE_TTL.DEVICE_READINGS);\n        }\n    });\n    \n    // Build leaderboard with fetched data\n    for (const [userId, member] of Object.entries(currentParty.members || {})) {\n        let highestBac = 0;\n        const userDevices = userDeviceMap.get(userId) || [];\n        \n        for (const deviceId of userDevices) {\n            const bac = deviceReadings.get(deviceId) || 0;\n            if (bac > highestBac) {\n                highestBac = bac;\n            }\n        }\n        \n        leaderboard.push({\n            userId,\n            name: member.name,\n            bac: highestBac,\n            joinedAt: member.joinedAt,\n            role: member.role || 'member'\n        });\n    }\n    \n    // Sort by BAC descending\n    leaderboard.sort((a, b) => b.bac - a.bac);\n    \n    // Cache the result\n    leaderboardCache.set(cacheKey, leaderboard, CACHE_TTL.LEADERBOARD);\n    \n    return leaderboard;\n}\n\n// Get friends' parties\nexport async function getFriendsParties() {\n    try {\n        if (!auth.currentUser) return [];\n        \n        const user = auth.currentUser;\n        \n        // Get user's friends list\n        const friendsSnapshot = await get(ref(database, `users/${user.uid}/friends`));\n        const friends = friendsSnapshot.val() || {};\n        const friendIds = Object.keys(friends);\n        \n        if (friendIds.length === 0) return [];\n        \n        // Get all parties\n        const partiesSnapshot = await get(ref(database, 'parties'));\n        const parties = partiesSnapshot.val() || {};\n        \n        const friendsParties = [];\n        const now = Date.now();\n        \n        // Filter for friends-only parties created by friends\n        Object.entries(parties).forEach(([id, party]) => {\n            // Check if party is friends-only and not expired\n            if (party.privacy === 'friends-only' && \n                (!party.expiresAt || party.expiresAt > now) &&\n                friendIds.includes(party.creatorId)) {\n                \n                const memberCount = Object.keys(party.members || {}).length;\n                friendsParties.push({\n                    ...party,\n                    id,\n                    memberCount,\n                    code: party.code,\n                    creatorName: friends[party.creatorId]?.name || 'Friend'\n                });\n            }\n        });\n        \n        // Sort by member count (popularity)\n        return friendsParties.sort((a, b) => b.memberCount - a.memberCount);\n    } catch (error) {\n        console.error('Error getting friends parties:', error);\n        return [];\n    }\n}\n\n// Get nearby public parties\nexport async function getNearbyParties() {\n    try {\n        // Check cache first\n        const cacheKey = 'public:parties';\n        const cached = partyCache.get(cacheKey);\n        if (cached) {\n            return cached;\n        }\n        \n        const partiesSnapshot = await get(ref(database, 'parties'));\n        if (!partiesSnapshot.exists()) return [];\n        \n        const publicParties = [];\n        const now = Date.now();\n        \n        partiesSnapshot.forEach((child) => {\n            const party = child.val();\n            \n            // Only show public, non-expired parties\n            if (party.privacy === 'public' && (!party.expiresAt || party.expiresAt > now)) {\n                publicParties.push({\n                    ...party,\n                    id: child.key,\n                    memberCount: Object.keys(party.members || {}).length\n                });\n            }\n        });\n        \n        // Sort by member count (popularity)\n        publicParties.sort((a, b) => b.memberCount - a.memberCount);\n        \n        // Cache the result\n        partyCache.set(cacheKey, publicParties, CACHE_TTL.PUBLIC_PARTIES);\n        \n        return publicParties;\n    } catch (error) {\n        console.error('Get nearby parties error:', error);\n        return [];\n    }\n}\n\n// Kick member from party (creator only)\nexport async function kickMember(memberId, reason = '') {\n    try {\n        if (!currentParty || !auth.currentUser) {\n            return { success: false, error: 'Not in a party or not authenticated' };\n        }\n        \n        // Only creator or developer can kick\n        if (currentParty.creatorId !== auth.currentUser.uid && !isDeveloper(auth.currentUser.uid)) {\n            return { success: false, error: 'Only the party creator can kick members' };\n        }\n        \n        // Can't kick yourself\n        if (memberId === auth.currentUser.uid) {\n            return { success: false, error: 'Cannot kick yourself. Use delete party instead.' };\n        }\n        \n        // Check if member exists\n        if (!currentParty.members || !currentParty.members[memberId]) {\n            return { success: false, error: 'Member not found in party' };\n        }\n        \n        // Log the kick action (for potential moderation history)\n        await push(ref(database, `parties/${currentParty.id}/moderation`), {\n            action: 'kick',\n            targetId: memberId,\n            targetName: currentParty.members[memberId].name,\n            moderatorId: auth.currentUser.uid,\n            reason: reason,\n            timestamp: Date.now()\n        });\n        \n        // Remove member\n        await remove(ref(database, `parties/${currentParty.id}/members/${memberId}`));\n        \n        // Add to banned list to prevent immediate rejoin\n        await set(ref(database, `parties/${currentParty.id}/banned/${memberId}`), {\n            bannedAt: Date.now(),\n            bannedBy: auth.currentUser.uid,\n            reason: reason\n        });\n        \n        return { success: true };\n    } catch (error) {\n        console.error('Kick member error:', error);\n        return { success: false, error: error.message };\n    }\n}\n\n// Update party settings (creator only)\nexport async function updatePartySettings(settings) {\n    try {\n        if (!currentParty || !auth.currentUser) {\n            return { success: false, error: 'Not in a party or not authenticated' };\n        }\n        \n        // Only creator or developer can update settings\n        if (currentParty.creatorId !== auth.currentUser.uid && !isDeveloper(auth.currentUser.uid)) {\n            return { success: false, error: 'Only the party creator can update settings' };\n        }\n        \n        // Validate settings\n        const allowedSettings = ['name', 'privacy', 'maxMembers', 'description', 'address', 'locked'];\n        const updates = {};\n        \n        for (const [key, value] of Object.entries(settings)) {\n            if (allowedSettings.includes(key)) {\n                updates[key] = value;\n            }\n        }\n        \n        if (Object.keys(updates).length === 0) {\n            return { success: false, error: 'No valid settings provided' };\n        }\n        \n        // Update Firebase\n        await update(ref(database, `parties/${currentParty.id}`), updates);\n        \n        return { success: true };\n    } catch (error) {\n        console.error('Update party settings error:', error);\n        return { success: false, error: error.message };\n    }\n}\n\n// Lock/unlock party (creator only)\nexport async function togglePartyLock(locked) {\n    try {\n        if (!currentParty || !auth.currentUser) {\n            return { success: false, error: 'Not in a party or not authenticated' };\n        }\n        \n        // Only creator can lock/unlock\n        if (currentParty.creatorId !== auth.currentUser.uid) {\n            return { success: false, error: 'Only the party creator can lock/unlock the party' };\n        }\n        \n        await update(ref(database, `parties/${currentParty.id}`), {\n            locked: locked,\n            lockedAt: locked ? Date.now() : null\n        });\n        \n        return { success: true, locked: locked };\n    } catch (error) {\n        console.error('Toggle party lock error:', error);\n        return { success: false, error: error.message };\n    }\n}\n\n\n// Check if user is banned from party\nexport async function isUserBanned(partyId, userId) {\n    try {\n        const bannedSnapshot = await get(ref(database, `parties/${partyId}/banned/${userId}`));\n        return bannedSnapshot.exists();\n    } catch (error) {\n        console.error('Check ban status error:', error);\n        return false;\n    }\n}\n\n// Update party UI - called when party state changes\nexport function getCurrentPartyId() {\n    return currentParty?.id || null;\n}\n\nexport async function quickAddFriend(friendId) {\n    // Placeholder for friend functionality\n    showNotification('Friend system coming soon!', 'info');\n    return { success: false };\n}\n\n// Note: UI updates are handled by updatePartyDisplay() in main.js\n// This avoids circular dependencies and keeps UI logic centralized","// ========================================\n// DASHBOARD UI MODULE\n// ========================================\n// Updates the main dashboard display\n\nimport { getStateValue } from '../config/app-state.js';\nimport { getBACStatus } from '../config/constants.js';\nimport { getCurrentPartyId, getPartyLeaderboard, quickAddFriend } from '../features/parties.js';\n\n\n// ========================================\n// MAIN UI UPDATE\n// ========================================\nexport function updateUI() {\n    try {\n        updateFriendsGrid();\n        updateStats();\n        updateLeaderboard();\n        updateVisualizer();\n        checkForAlerts();\n    } catch (error) {\n        console.error('UI update failed:', error);\n    }\n}\n\n// ========================================\n// UPDATE FRIENDS GRID\n// ========================================\nfunction updateFriendsGrid() {\n    const grid = document.getElementById('friendsGrid');\n    if (!grid) return;\n    \n    const partyData = getStateValue('partyData') || {};\n    grid.innerHTML = '';\n    \n    Object.entries(partyData).forEach(([deviceId, data]) => {\n        // Skip data older than 24 hours\n        const isRecent = Date.now() - data.lastUpdate < 24 * 60 * 60 * 1000;\n        if (!isRecent) return;\n        \n        const status = getBACStatus(data.bac);\n        const timeSince = getTimeSince(data.lastUpdate);\n        \n        const card = document.createElement('div');\n        card.className = 'card friend-card';\n        card.setAttribute('data-friend-id', data.friendId || deviceId);\n        card.onclick = () => showFriendDetails(data);\n        \n        const trendIcon = data.trend === 'up' ? '📈' : data.trend === 'down' ? '📉' : '➡️';\n        const trendClass = data.trend === 'up' ? 'trend-up' : data.trend === 'down' ? 'trend-down' : '';\n        \n        const emoji = data.isOwn ? '👤' : data.permission === 'guardian' ? '🛡️' : '👥';\n        \n        card.innerHTML = `\n            <div class=\"friend-avatar\">${emoji}</div>\n            <div class=\"friend-name\">${data.name}</div>\n            <div class=\"bac-value ${status.class}\">\n                ${data.bac.toFixed(3)}‰\n                <span class=\"bac-trend ${trendClass}\">${trendIcon}</span>\n            </div>\n            <div class=\"friend-status\">\n                <span class=\"status-badge\">${status.emoji} ${status.text}</span>\n            </div>\n            <div class=\"location-tag\">\n                <i class=\"fas fa-map-marker-alt\"></i> ${data.location}\n            </div>\n            <div class=\"last-update\" style=\"margin-top: 10px; opacity: 0.7; font-size: 0.9em;\">\n                Updated ${timeSince}\n            </div>\n        `;\n        \n        // Add pulse animation for high BAC\n        if (data.bac >= 0.08) {\n            card.classList.add('pulse');\n        }\n        \n        grid.appendChild(card);\n    });\n}\n\n// ========================================\n// UPDATE STATS\n// ========================================\nfunction updateStats() {\n    const partyData = getStateValue('partyData') || {};\n    // Filter only recent data (within 24 hours)\n    const friends = Object.values(partyData).filter(data => \n        Date.now() - data.lastUpdate < 24 * 60 * 60 * 1000\n    );\n    \n    // Average BAC\n    const avgBac = friends.reduce((sum, f) => sum + f.bac, 0) / friends.length || 0;\n    const avgElement = document.getElementById('partyAverage');\n    if (avgElement) avgElement.textContent = avgBac.toFixed(3) + '‰';\n    \n    // Safe friends\n    const safeCount = friends.filter(f => f.bac < 0.02).length;\n    const safeElement = document.getElementById('safeFriends');\n    if (safeElement) safeElement.textContent = safeCount;\n    \n    // Update hydration timer\n    const hydrationMinutes = 15 - (Date.now() % (15 * 60 * 1000)) / 60000;\n    const hydrationElement = document.getElementById('hydrationTime');\n    if (hydrationElement) hydrationElement.textContent = Math.floor(hydrationMinutes) + 'm';\n}\n\n// ========================================\n// UPDATE LEADERBOARD\n// ========================================\nasync function updateLeaderboard() {\n    const leaderboard = document.getElementById('leaderboardList');\n    if (!leaderboard) return;\n    \n    leaderboard.innerHTML = '';\n    \n    // Check if in a party\n    const currentPartyId = getCurrentPartyId();\n    let sorted = [];\n    \n    if (currentPartyId) {\n        // Use party-specific leaderboard\n        sorted = await getPartyLeaderboard(currentPartyId);\n        sorted = sorted.slice(0, 5);\n    } else {\n        // Use regular leaderboard\n        const partyData = getStateValue('partyData') || {};\n        sorted = Object.values(partyData)\n            .sort((a, b) => b.bac - a.bac)\n            .slice(0, 5);\n    }\n    \n    // Position-specific messages\n    const positionMessages = [\n        (name) => `🏆 ${name} is absolutely dominating the party! Living their best life!`,\n        (name) => `🥈 ${name} is so close! One more and they could take the crown!`,\n        (name) => `🥉 ${name} is holding strong! The podium suits them well!`,\n        (name) => `${name} is warming up! The night is still young!`,\n        (name) => `${name} is taking it easy... or are they just getting started? 🤔`\n    ];\n    \n    sorted.forEach((friend, index) => {\n        const item = document.createElement('div');\n        item.className = 'leaderboard-item';\n        item.onclick = () => {\n            // Only confetti for first place\n            if (index === 0 && window.confetti) {\n                confetti({\n                    particleCount: 100,\n                    spread: 70,\n                    origin: { y: 0.6 }\n                });\n            }\n            // Show position-specific message\n            const message = positionMessages[index] ? positionMessages[index](friend.name) : `${friend.name} is participating!`;\n            window.showNotification(message);\n        };\n        \n        item.innerHTML = `\n            <span class=\"rank rank-${index + 1}\">#${index + 1}</span>\n            <span>${friend.name}</span>\n            <span>${friend.bac.toFixed(3)}‰</span>\n            ${currentPartyId && friend.id ? `<button class=\"quick-add-btn\" onclick=\"window.quickAddPartyFriend('${friend.id}')\">+</button>` : ''}\n        `;\n        leaderboard.appendChild(item);\n    });\n}\n\n// ========================================\n// MUSIC VISUALIZER\n// ========================================\nfunction updateVisualizer() {\n    const visualizer = document.getElementById('visualizer');\n    if (!visualizer) return;\n    \n    if (visualizer.children.length === 0) {\n        for (let i = 0; i < 20; i++) {\n            const bar = document.createElement('div');\n            bar.className = 'bar';\n            visualizer.appendChild(bar);\n        }\n    }\n    \n    visualizer.querySelectorAll('.bar').forEach(bar => {\n        const height = Math.random() * 150 + 20;\n        bar.style.height = height + 'px';\n    });\n}\n\n// ========================================\n// ALERT SYSTEM\n// ========================================\nlet lastAlertTime = 0;\nconst ALERT_COOLDOWN = 5 * 60 * 1000; // 5 minutes between alerts\n\nfunction checkForAlerts() {\n    const partyData = getStateValue('partyData') || {};\n    // Only check recent data (within 24 hours)\n    const criticalFriends = Object.values(partyData).filter(f => \n        Date.now() - f.lastUpdate < 24 * 60 * 60 * 1000 && f.bac >= 0.08\n    );\n    \n    if (criticalFriends.length > 0) {\n        const now = Date.now();\n        \n        // Show notification instead of persistent banner (with cooldown)\n        if (now - lastAlertTime > ALERT_COOLDOWN) {\n            const names = criticalFriends.map(f => f.name).join(', ');\n            showNotification(\n                `⚠️ ${names} need${criticalFriends.length > 1 ? '' : 's'} attention! BAC too high!`, \n                'warning'\n            );\n            lastAlertTime = now;\n        }\n        \n        // Add subtle indicator to friend cards instead\n        criticalFriends.forEach(friend => {\n            const card = document.querySelector(`[data-friend-id=\"${friend.friendId || friend.deviceId}\"]`);\n            if (card) {\n                card.classList.add('bac-warning');\n            }\n        });\n    } else {\n        // Remove warning indicators\n        document.querySelectorAll('.bac-warning').forEach(card => {\n            card.classList.remove('bac-warning');\n        });\n    }\n    \n    // Hide the old alert banner if it exists\n    const alertBanner = document.getElementById('alertBanner');\n    if (alertBanner) {\n        alertBanner.style.display = 'none';\n    }\n}\n\n// ========================================\n// FRIEND DETAILS\n// ========================================\nfunction showFriendDetails(friend) {\n    // TODO: Implement modal showing friend details\n    console.log('Show friend details:', friend);\n}\n\n// Quick add friend from party\nwindow.quickAddPartyFriend = async function(userId) {\n    await quickAddFriend(userId);\n};\n\n// ========================================\n// UTILITY FUNCTIONS\n// ========================================\nfunction getTimeSince(timestamp) {\n    const seconds = Math.floor((Date.now() - timestamp) / 1000);\n    if (seconds < 60) return 'just now';\n    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;\n    return `${Math.floor(seconds / 3600)}h ago`;\n}\n\n// Make updateUI available globally\nwindow.updateUI = updateUI;","// ========================================\n// PWA (PROGRESSIVE WEB APP) MODULE\n// ========================================\n// Handles service worker registration and app installation\n\nimport { showNotification } from '../ui/notifications.js';\n\nlet deferredPrompt;\nlet isInstalled = false;\n\n// Check if app is installed\nif (window.matchMedia('(display-mode: standalone)').matches || \n    window.navigator.standalone === true) {\n    isInstalled = true;\n}\n\n// ========================================\n// REGISTER SERVICE WORKER\n// ========================================\nexport async function registerServiceWorker() {\n    // Service worker registration disabled due to GitHub Pages issues\n    console.log('Service worker registration disabled');\n    return null;\n}\n\n// ========================================\n// HANDLE INSTALL PROMPT\n// ========================================\nexport function initializePWA() {\n    // Listen for beforeinstallprompt\n    window.addEventListener('beforeinstallprompt', (e) => {\n        e.preventDefault();\n        deferredPrompt = e;\n        \n        // Show install button if not already installed\n        if (!isInstalled) {\n            showInstallButton();\n        }\n    });\n    \n    // Listen for app installed\n    window.addEventListener('appinstalled', () => {\n        console.log('PWA was installed');\n        isInstalled = true;\n        hideInstallButton();\n        showNotification('App installed successfully!', 'success');\n    });\n}\n\n// ========================================\n// SHOW/HIDE INSTALL BUTTON\n// ========================================\nfunction showInstallButton() {\n    // Create install button if it doesn't exist\n    let installButton = document.getElementById('installButton');\n    if (!installButton) {\n        installButton = document.createElement('button');\n        installButton.id = 'installButton';\n        installButton.className = 'btn btn-primary install-button';\n        installButton.innerHTML = '<i class=\"fas fa-download\"></i> Install App';\n        installButton.onclick = promptInstall;\n        \n        // Add to header action buttons\n        const actionButtons = document.querySelector('.action-buttons');\n        if (actionButtons) {\n            actionButtons.appendChild(installButton);\n        }\n    }\n    \n    installButton.style.display = 'inline-block';\n}\n\nfunction hideInstallButton() {\n    const installButton = document.getElementById('installButton');\n    if (installButton) {\n        installButton.style.display = 'none';\n    }\n}\n\n// ========================================\n// PROMPT INSTALLATION\n// ========================================\nexport async function promptInstall() {\n    if (!deferredPrompt) {\n        showNotification('App is already installed or not available for installation', 'info');\n        return;\n    }\n    \n    // Show the install prompt\n    deferredPrompt.prompt();\n    \n    // Wait for user response\n    const { outcome } = await deferredPrompt.userChoice;\n    console.log(`User response to install prompt: ${outcome}`);\n    \n    if (outcome === 'accepted') {\n        console.log('User accepted the install prompt');\n    } else {\n        console.log('User dismissed the install prompt');\n    }\n    \n    // Clear the deferred prompt\n    deferredPrompt = null;\n}\n\n// ========================================\n// CHECK FOR UPDATES\n// ========================================\nexport async function checkForUpdates() {\n    if ('serviceWorker' in navigator) {\n        const registration = await navigator.serviceWorker.getRegistration();\n        if (registration) {\n            registration.update();\n        }\n    }\n}\n\n// ========================================\n// OFFLINE STORAGE\n// ========================================\nexport function initializeOfflineStorage() {\n    // Open IndexedDB for offline data storage\n    const request = indexedDB.open('BoozeLensDB', 1);\n    \n    request.onerror = () => {\n        console.error('Failed to open IndexedDB');\n    };\n    \n    request.onsuccess = (event) => {\n        const db = event.target.result;\n        console.log('IndexedDB opened successfully');\n    };\n    \n    request.onupgradeneeded = (event) => {\n        const db = event.target.result;\n        \n        // Create object stores for offline data\n        if (!db.objectStoreNames.contains('drinks')) {\n            const drinksStore = db.createObjectStore('drinks', { keyPath: 'id', autoIncrement: true });\n            drinksStore.createIndex('timestamp', 'timestamp', { unique: false });\n            drinksStore.createIndex('synced', 'synced', { unique: false });\n        }\n        \n        if (!db.objectStoreNames.contains('readings')) {\n            const readingsStore = db.createObjectStore('readings', { keyPath: 'id', autoIncrement: true });\n            readingsStore.createIndex('timestamp', 'timestamp', { unique: false });\n            readingsStore.createIndex('synced', 'synced', { unique: false });\n        }\n    };\n}\n\n// ========================================\n// SAVE DATA OFFLINE\n// ========================================\nexport async function saveOfflineData(storeName, data) {\n    return new Promise((resolve, reject) => {\n        const request = indexedDB.open('BoozeLensDB', 1);\n        \n        request.onsuccess = (event) => {\n            const db = event.target.result;\n            const transaction = db.transaction([storeName], 'readwrite');\n            const store = transaction.objectStore(storeName);\n            \n            const addRequest = store.add({\n                ...data,\n                synced: false,\n                timestamp: new Date().toISOString()\n            });\n            \n            addRequest.onsuccess = () => {\n                resolve();\n                // Register for background sync\n                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {\n                    navigator.serviceWorker.ready.then(registration => {\n                        if ('sync' in registration) {\n                            registration.sync.register(`sync-${storeName}`);\n                        }\n                    });\n                }\n            };\n            \n            addRequest.onerror = () => reject(addRequest.error);\n        };\n        \n        request.onerror = () => reject(request.error);\n    });\n}\n\n// ========================================\n// GET OFFLINE DATA\n// ========================================\nexport async function getOfflineData(storeName) {\n    return new Promise((resolve, reject) => {\n        const request = indexedDB.open('BoozeLensDB', 1);\n        \n        request.onsuccess = (event) => {\n            const db = event.target.result;\n            const transaction = db.transaction([storeName], 'readonly');\n            const store = transaction.objectStore(storeName);\n            const getAllRequest = store.getAll();\n            \n            getAllRequest.onsuccess = () => resolve(getAllRequest.result);\n            getAllRequest.onerror = () => reject(getAllRequest.error);\n        };\n        \n        request.onerror = () => reject(request.error);\n    });\n}\n\n// ========================================\n// NETWORK STATUS\n// ========================================\nexport function isOnline() {\n    return navigator.onLine;\n}\n\n// Listen for online/offline events\nwindow.addEventListener('online', () => {\n    showNotification('Back online! Syncing data...', 'success');\n    // Trigger sync\n    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {\n        navigator.serviceWorker.ready.then(registration => {\n            if ('sync' in registration) {\n                registration.sync.register('sync-all');\n            }\n        });\n    }\n});\n\nwindow.addEventListener('offline', () => {\n    showNotification('You are offline. Data will be saved locally.', 'warning');\n});","// Separate module for party display to avoid scoping issues\nimport { getCurrentUser } from './config/app-state.js';\nimport { isDeveloper } from './config/constants.js';\n\nexport function safeUpdatePartyDisplay(Parties) {\n    try {\n        // Early exit if Parties module not ready\n        if (!Parties) {\n            console.warn('Parties module not ready');\n            return;\n        }\n\n        const party = Parties.currentParty;\n        const userParties = Parties.userParties || [];\n        const currentSection = document.getElementById('currentPartySection');\n        const dashboardInfo = document.getElementById('dashboardPartyInfo');\n        \n        // Get current user safely\n        let currentUser = null;\n        let isCreator = false;\n        let isDev = false;\n        \n        try {\n            currentUser = getCurrentUser();\n            if (currentUser) {\n                isCreator = party && party.creatorId === currentUser.uid;\n                isDev = isDeveloper(currentUser.uid);\n            }\n        } catch (e) {\n            console.warn('Could not get current user:', e);\n        }\n        \n        // Handle party switcher\n        updatePartySwitcher(userParties, party);\n        \n        if (party) {\n            showPartyUI(party, currentSection, dashboardInfo, currentUser, isCreator, isDev, Parties);\n        } else {\n            hidePartyUI(currentSection, dashboardInfo);\n        }\n        \n    } catch (error) {\n        console.error('Error in safeUpdatePartyDisplay:', error);\n    }\n}\n\nfunction updatePartySwitcher(userParties, currentParty) {\n    const existingSwitcher = document.getElementById('partySwitcher');\n    \n    if (userParties.length > 1) {\n        if (existingSwitcher) {\n            existingSwitcher.remove();\n        }\n        createPartySwitcher(userParties, currentParty);\n    } else if (existingSwitcher) {\n        existingSwitcher.remove();\n    }\n}\n\nfunction createPartySwitcher(userParties, currentParty) {\n    const switcher = document.createElement('div');\n    switcher.id = 'partySwitcher';\n    switcher.style.cssText = `\n        position: fixed; \n        top: 80px; \n        right: 20px; \n        background: rgba(0,0,0,0.95); \n        border: 2px solid #00ff88; \n        border-radius: 10px; \n        padding: 15px; \n        z-index: 1000; \n        max-width: 250px; \n        box-shadow: 0 4px 20px rgba(0,255,136,0.3); \n        max-height: 400px; \n        overflow-y: auto;\n    `;\n    \n    const switcherHTML = `\n        <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;\">\n            <h4 style=\"margin: 0; color: #00ff88;\">My Parties (${userParties.length})</h4>\n            <button onclick=\"document.getElementById('partySwitcher').remove()\" \n                    style=\"background: none; border: none; color: #fff; cursor: pointer; font-size: 20px;\">×</button>\n        </div>\n    `;\n    \n    const partyButtons = userParties.map(party => {\n        const memberCount = party.members ? Object.keys(party.members).length : 0;\n        const isActive = currentParty && currentParty.id === party.id;\n        return `\n            <button class=\"btn ${isActive ? 'btn-primary' : ''}\" \n                    style=\"display: block; width: 100%; margin: 5px 0; text-align: left; padding: 10px;\"\n                    onclick=\"switchToParty('${party.id}')\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <span>🎉 ${party.name}</span>\n                    <span style=\"font-size: 0.8em; opacity: 0.7;\">${memberCount} 👥</span>\n                </div>\n                ${isActive ? '<small style=\"color: #00ff88;\">Currently viewing</small>' : ''}\n            </button>\n        `;\n    }).join('');\n    \n    switcher.innerHTML = switcherHTML + partyButtons;\n    document.body.appendChild(switcher);\n}\n\nfunction showPartyUI(party, currentSection, dashboardInfo, currentUser, isCreator, isDev, Parties) {\n    // Show sections\n    if (currentSection) currentSection.style.display = 'block';\n    if (dashboardInfo) dashboardInfo.style.display = 'block';\n    \n    // Update party info\n    updatePartyInfo(party);\n    \n    // Update members list\n    updateMembersList(party, currentUser, isCreator, isDev);\n    \n    // Update stats\n    updatePartyStats(party, Parties);\n    \n    // Update leave/delete button\n    updateLeaveButton(party, currentUser, isCreator);\n    \n    // Show/hide creator controls\n    updateCreatorControls(party, isCreator, isDev);\n    \n    // Update leaderboard\n    if (window.updatePartyLeaderboard) {\n        window.updatePartyLeaderboard();\n    }\n}\n\nfunction hidePartyUI(currentSection, dashboardInfo) {\n    if (currentSection) currentSection.style.display = 'none';\n    if (dashboardInfo) dashboardInfo.style.display = 'none';\n    \n    const creatorControlsSection = document.getElementById('creatorControlsSection');\n    if (creatorControlsSection) creatorControlsSection.style.display = 'none';\n    \n    const pendingSection = document.getElementById('pendingRequestsSection');\n    if (pendingSection) pendingSection.style.display = 'none';\n}\n\nfunction updatePartyInfo(party) {\n    const nameEls = document.querySelectorAll('#currentPartyName, #dashboardPartyName');\n    const codeEls = document.querySelectorAll('#currentPartyCode, #dashboardPartyCode');\n    \n    nameEls.forEach(el => { \n        if (el) {\n            el.innerHTML = party.name + ` <span style=\"font-size: 0.8em; opacity: 0.7;\">by ${party.creatorName || 'Unknown'}</span>`;\n        }\n    });\n    \n    codeEls.forEach(el => { \n        if (el) el.textContent = party.code; \n    });\n}\n\nfunction updateMembersList(party, currentUser, isCreator, isDev) {\n    const membersList = document.getElementById('partyMembersList');\n    if (!membersList || !party.members) return;\n    \n    let membersHTML = '';\n    \n    for (const [id, member] of Object.entries(party.members)) {\n        const isThisUserCreator = id === party.creatorId;\n        const isCurrentUser = currentUser && id === currentUser.uid;\n        const showKickButton = (isCreator || isDev) && !isCurrentUser && !isThisUserCreator;\n        \n        membersHTML += `\n            <div class=\"friend-item\">\n                <div class=\"friend-info\">\n                    <div class=\"friend-avatar-small\">${isThisUserCreator ? '👑' : '👤'}</div>\n                    <div class=\"friend-details\">\n                        <h4>${member.name} ${isThisUserCreator ? '<span style=\"color: #00ff88;\">(Host)</span>' : ''}</h4>\n                        <p style=\"opacity: 0.7; font-size: 0.9em;\">\n                            ${member.role === 'creator' ? 'Party Host • ' : ''}\n                            Joined ${new Date(member.joinedAt).toLocaleTimeString()}\n                        </p>\n                    </div>\n                </div>\n                ${showKickButton ? `\n                    <button class=\"btn btn-danger\" style=\"padding: 5px 10px; font-size: 0.9em;\" \n                            onclick=\"kickMemberFromParty('${id}', '${member.name}')\">\n                        <i class=\"fas fa-user-times\"></i> Kick\n                    </button>\n                ` : ''}\n            </div>\n        `;\n    }\n    \n    membersList.innerHTML = membersHTML;\n}\n\nfunction updatePartyStats(party, Parties) {\n    const statsEl = document.getElementById('partyStats');\n    if (!statsEl) return;\n    \n    const stats = Parties.getPartyStats();\n    if (!stats) return;\n    \n    statsEl.innerHTML = `\n        <div style=\"text-align: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;\">\n            <div style=\"font-size: 2em;\">👥</div>\n            <div style=\"font-size: 1.5em; font-weight: bold;\">${stats.memberCount}</div>\n            <div style=\"opacity: 0.7;\">Members</div>\n        </div>\n        <div style=\"text-align: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;\">\n            <div style=\"font-size: 2em;\">⏱️</div>\n            <div style=\"font-size: 1.5em; font-weight: bold;\">${stats.duration}</div>\n            <div style=\"opacity: 0.7;\">Duration</div>\n        </div>\n        <div style=\"text-align: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;\">\n            <div style=\"font-size: 2em;\">🎆</div>\n            <div style=\"font-size: 1.5em; font-weight: bold;\">${stats.code}</div>\n            <div style=\"opacity: 0.7;\">Party Code</div>\n        </div>\n    `;\n}\n\nfunction updateLeaveButton(party, currentUser, isCreator) {\n    const leaveBtn = document.getElementById('leavePartyBtn');\n    if (!leaveBtn || !currentUser) return;\n    \n    if (isCreator) {\n        leaveBtn.innerHTML = '<i class=\"fas fa-trash\"></i> Delete Party';\n        leaveBtn.className = 'btn btn-danger';\n    } else {\n        leaveBtn.innerHTML = '<i class=\"fas fa-door-open\"></i> Leave Party';\n        leaveBtn.className = 'btn btn-danger';\n    }\n}\n\nfunction updateCreatorControls(party, isCreator, isDev) {\n    if (!isCreator && !isDev) {\n        const creatorControlsSection = document.getElementById('creatorControlsSection');\n        if (creatorControlsSection) creatorControlsSection.style.display = 'none';\n        \n        const pendingSection = document.getElementById('pendingRequestsSection');\n        if (pendingSection) pendingSection.style.display = 'none';\n        return;\n    }\n    \n    // Show creator controls\n    const creatorControlsSection = document.getElementById('creatorControlsSection');\n    if (creatorControlsSection) {\n        creatorControlsSection.style.display = 'block';\n        \n        // Update lock button\n        const lockBtn = document.getElementById('lockPartyBtn');\n        if (lockBtn) {\n            if (party.locked) {\n                lockBtn.innerHTML = '<i class=\"fas fa-lock-open\"></i> Unlock Party';\n            } else {\n                lockBtn.innerHTML = '<i class=\"fas fa-lock\"></i> Lock Party';\n            }\n        }\n    }\n    \n    // Show pending requests\n    const pendingSection = document.getElementById('pendingRequestsSection');\n    const pendingList = document.getElementById('pendingRequestsList');\n    \n    if (pendingSection && pendingList && party.pendingRequests) {\n        const pendingCount = Object.keys(party.pendingRequests).length;\n        if (pendingCount > 0) {\n            pendingSection.style.display = 'block';\n            pendingList.innerHTML = Object.entries(party.pendingRequests).map(([userId, request]) => `\n                <div class=\"friend-item\" style=\"margin-bottom: 15px;\">\n                    <div class=\"friend-info\">\n                        <div class=\"friend-avatar-small\">👤</div>\n                        <div class=\"friend-details\">\n                            <h4>${request.name}</h4>\n                            <p style=\"opacity: 0.7;\">Requested ${new Date(request.requestedAt).toLocaleTimeString()}</p>\n                        </div>\n                    </div>\n                    <div style=\"display: flex; gap: 10px;\">\n                        <button class=\"btn btn-primary\" onclick=\"handlePartyRequest('${userId}', true)\">\n                            <i class=\"fas fa-check\"></i> Approve\n                        </button>\n                        <button class=\"btn\" onclick=\"handlePartyRequest('${userId}', false)\">\n                            <i class=\"fas fa-times\"></i> Decline\n                        </button>\n                    </div>\n                </div>\n            `).join('');\n        } else if (pendingSection) {\n            pendingSection.style.display = 'none';\n        }\n    } else if (pendingSection) {\n        pendingSection.style.display = 'none';\n    }\n}","// ========================================\n// ALL ORIGINAL FUNCTIONS FROM safe.html\n// ========================================\n// This file contains ALL the functions from your original app\n// They're organized by category but maintain their original functionality\n\nimport { getFirebaseDatabase, getFirebaseAuth } from '../config/firebase.js';\nimport { getAppState, setStateValue, getCurrentUser } from '../config/app-state.js';\nimport { DRINK_PRESETS, getBACStatus } from '../config/constants.js';\nimport { showNotification } from '../ui/notifications.js';\nimport { ref, set, get, push, remove, onValue, off, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';\n\n// ========================================\n// FRIENDS SYSTEM FUNCTIONS\n// ========================================\nexport async function searchFriends() {\n    const searchTerm = document.getElementById('friendSearchInput').value.trim().toLowerCase();\n    \n    if (!searchTerm || searchTerm.length < 3) {\n        showNotification('❌ Please enter at least 3 characters', 'error');\n        return;\n    }\n    \n    const resultsDiv = document.getElementById('searchResults');\n    resultsDiv.innerHTML = '<p>Searching...</p>';\n    \n    try {\n        const database = getFirebaseDatabase();\n        const currentUser = getCurrentUser();\n        const usersSnapshot = await get(ref(database, 'users'));\n        const users = usersSnapshot.val() || {};\n        \n        const results = [];\n        Object.entries(users).forEach(([uid, user]) => {\n            if (uid !== currentUser.uid && \n                user.settings?.publicProfile !== false &&\n                (user.username?.toLowerCase().includes(searchTerm) || \n                 user.email?.toLowerCase().includes(searchTerm))) {\n                results.push({ uid, ...user });\n            }\n        });\n        \n        if (results.length === 0) {\n            resultsDiv.innerHTML = '<p style=\"text-align: center; opacity: 0.7;\">No users found</p>';\n        } else {\n            const friendsData = getAppState().friendsData || {};\n            resultsDiv.innerHTML = '<h4>Search Results:</h4>' + results.map(user => `\n                <div class=\"friend-item\">\n                    <div class=\"friend-info\">\n                        <div class=\"friend-avatar-small\">\n                            ${(user.username || user.email).charAt(0).toUpperCase()}\n                        </div>\n                        <div class=\"friend-details\">\n                            <h4>${user.username || 'User'}</h4>\n                            <p>${user.email || 'Phone user'}</p>\n                        </div>\n                    </div>\n                    <div class=\"friend-actions\">\n                        ${friendsData[user.uid] ? \n                            '<span style=\"color: #00ff88;\">✓ Friends</span>' : \n                            `<button class=\"btn btn-primary\" onclick=\"sendFriendRequest('${user.uid}')\">\n                                <i class=\"fas fa-user-plus\"></i> Add Friend\n                            </button>`\n                        }\n                    </div>\n                </div>\n            `).join('');\n        }\n    } catch (error) {\n        console.error('Search error:', error);\n        resultsDiv.innerHTML = '<p style=\"color: #ff4444;\">Search failed. Try again.</p>';\n    }\n}\n\nexport async function sendFriendRequest(friendId) {\n    try {\n        const database = getFirebaseDatabase();\n        const currentUser = getCurrentUser();\n        const userData = getAppState().userData;\n        const friendsData = getAppState().friendsData;\n        \n        if (friendsData[friendId]) {\n            showNotification('ℹ️ Already friends');\n            return;\n        }\n        \n        await set(ref(database, 'friendRequests/' + friendId + '/' + currentUser.uid), {\n            from: userData.username || currentUser.email,\n            timestamp: serverTimestamp()\n        });\n        \n        showNotification('📤 Friend request sent!', 'success');\n        searchFriends();\n        \n    } catch (error) {\n        console.error('Friend request error:', error);\n        showNotification('❌ Failed to send request', 'error');\n    }\n}\n\nexport function updateFriendRequests() {\n    const container = document.getElementById('friendRequests');\n    const friendRequests = getAppState().friendRequests || [];\n    \n    if (friendRequests.length === 0) {\n        container.innerHTML = '<p style=\"opacity: 0.7;\">No pending requests</p>';\n        return;\n    }\n    \n    container.innerHTML = friendRequests.map(request => `\n        <div class=\"friend-request\">\n            <div>\n                <strong>${request.from}</strong>\n                <small style=\"opacity: 0.7; margin-left: 10px;\">\n                    ${getTimeSince(request.timestamp)}\n                </small>\n            </div>\n            <div>\n                <button class=\"btn\" onclick=\"acceptFriendRequest('${request.id}')\">\n                    <i class=\"fas fa-check\"></i> Accept\n                </button>\n                <button class=\"btn btn-danger\" onclick=\"declineFriendRequest('${request.id}')\">\n                    <i class=\"fas fa-times\"></i>\n                </button>\n            </div>\n        </div>\n    `).join('');\n}\n\nexport async function acceptFriendRequest(friendId) {\n    try {\n        const permission = await selectFriendPermission();\n        if (!permission) return;\n        \n        const database = getFirebaseDatabase();\n        const currentUser = getCurrentUser();\n        \n        await set(ref(database, 'users/' + currentUser.uid + '/friends/' + friendId), {\n            permission: permission,\n            addedAt: serverTimestamp()\n        });\n        \n        await set(ref(database, 'users/' + friendId + '/friends/' + currentUser.uid), {\n            permission: permission,\n            addedAt: serverTimestamp()\n        });\n        \n        await remove(ref(database, 'friendRequests/' + currentUser.uid + '/' + friendId));\n        \n        showNotification('✅ Friend added!', 'success');\n        \n    } catch (error) {\n        console.error('Accept friend error:', error);\n        showNotification('❌ Failed to accept request', 'error');\n    }\n}\n\nexport async function selectFriendPermission() {\n    return new Promise((resolve) => {\n        const modalContent = `\n            <h2>Set Friend Permissions</h2>\n            <p>Choose what this friend can see:</p>\n            <div style=\"margin: 20px 0;\">\n                <div class=\"friend-item\" style=\"cursor: pointer; margin: 10px 0;\" onclick=\"resolvePermission('observer')\">\n                    <div>\n                        <h4>👀 Observer</h4>\n                        <p>Can see if you're at a party (no BAC data)</p>\n                    </div>\n                </div>\n                <div class=\"friend-item\" style=\"cursor: pointer; margin: 10px 0;\" onclick=\"resolvePermission('buddy')\">\n                    <div>\n                        <h4>🤝 Buddy</h4>\n                        <p>Can see your BAC and get notifications</p>\n                    </div>\n                </div>\n                <div class=\"friend-item\" style=\"cursor: pointer; margin: 10px 0;\" onclick=\"resolvePermission('guardian')\">\n                    <div>\n                        <h4>🛡️ Guardian</h4>\n                        <p>Full access including emergency info</p>\n                    </div>\n                </div>\n            </div>\n            <button class=\"btn\" onclick=\"resolvePermission(null)\">Cancel</button>\n        `;\n        \n        document.getElementById('modalBody').innerHTML = modalContent;\n        document.getElementById('modal').classList.add('show');\n        \n        window.resolvePermission = (permission) => {\n            window.closeModal();\n            resolve(permission);\n        };\n    });\n}\n\nexport async function declineFriendRequest(friendId) {\n    const database = getFirebaseDatabase();\n    const currentUser = getCurrentUser();\n    await remove(ref(database, 'friendRequests/' + currentUser.uid + '/' + friendId));\n    showNotification('❌ Request declined');\n}\n\nexport function updateFriendsList() {\n    const friendsList = document.getElementById('friendsList');\n    if (!friendsList) return;\n    \n    const friendsData = getAppState().friendsData || {};\n    friendsList.innerHTML = '';\n    \n    if (Object.keys(friendsData).length === 0) {\n        friendsList.innerHTML = '<p style=\"text-align: center; opacity: 0.7;\">No friends added yet</p>';\n        return;\n    }\n    \n    Object.entries(friendsData).forEach(async ([friendId, friend]) => {\n        const database = getFirebaseDatabase();\n        const friendSnapshot = await get(ref(database, 'users/' + friendId));\n        const friendInfo = friendSnapshot.val();\n        \n        if (friendInfo) {\n            const friendDiv = document.createElement('div');\n            friendDiv.className = 'friend-item';\n            friendDiv.innerHTML = `\n                <div class=\"friend-info\">\n                    <div class=\"friend-avatar-small\">\n                        ${(friendInfo.username || friendInfo.email || 'U').charAt(0).toUpperCase()}\n                    </div>\n                    <div class=\"friend-details\">\n                        <h4>${friendInfo.username || 'Friend'}</h4>\n                        <p>${friendInfo.email || 'Phone user'}</p>\n                    </div>\n                </div>\n                <div class=\"friend-actions\">\n                    <select class=\"permission-select\" onchange=\"updateFriendPermission('${friendId}', this.value)\">\n                        <option value=\"observer\" ${friend.permission === 'observer' ? 'selected' : ''}>Observer</option>\n                        <option value=\"buddy\" ${friend.permission === 'buddy' ? 'selected' : ''}>Buddy</option>\n                        <option value=\"guardian\" ${friend.permission === 'guardian' ? 'selected' : ''}>Guardian</option>\n                    </select>\n                    <button class=\"btn btn-danger\" onclick=\"removeFriend('${friendId}')\">\n                        <i class=\"fas fa-user-minus\"></i>\n                    </button>\n                </div>\n            `;\n            friendsList.appendChild(friendDiv);\n        }\n    });\n}\n\nexport async function updateFriendPermission(friendId, newPermission) {\n    try {\n        const database = getFirebaseDatabase();\n        const currentUser = getCurrentUser();\n        await set(ref(database, 'users/' + currentUser.uid + '/friends/' + friendId + '/permission'), newPermission);\n        await set(ref(database, 'users/' + friendId + '/friends/' + currentUser.uid + '/permission'), newPermission);\n        showNotification('✅ Permission updated', 'success');\n    } catch (error) {\n        console.error('Update permission error:', error);\n        showNotification('❌ Failed to update permission', 'error');\n    }\n}\n\nexport async function removeFriend(friendId) {\n    if (confirm('Remove this friend?')) {\n        const database = getFirebaseDatabase();\n        const currentUser = getCurrentUser();\n        await remove(ref(database, 'users/' + currentUser.uid + '/friends/' + friendId));\n        await remove(ref(database, 'users/' + friendId + '/friends/' + currentUser.uid));\n        showNotification('👋 Friend removed');\n    }\n}\n\n// ========================================\n// CHAT FUNCTIONS\n// ========================================\nexport async function sendMessage() {\n    const input = document.getElementById('chatInput');\n    const message = input.value.trim();\n    \n    if (message) {\n        const currentUser = getCurrentUser();\n        const userData = getAppState().userData;\n        \n        // Check if user is developer\n        const { isDeveloper } = await import('../config/constants.js');\n        if (!isDeveloper(currentUser.uid)) {\n            showNotification('❌ Only developers can send messages in the main chat', 'error');\n            input.value = '';\n            return;\n        }\n        \n        const chatMessages = document.getElementById('chatMessages');\n        const messageDiv = document.createElement('div');\n        messageDiv.className = 'chat-message own';\n        messageDiv.innerHTML = `\n            <div class=\"chat-author\">${userData.username || 'You'} <span style=\"color: #00ff88;\">🛠️</span></div>\n            <div>${escapeHtml(message)}</div>\n        `;\n        chatMessages.appendChild(messageDiv);\n        chatMessages.scrollTop = chatMessages.scrollHeight;\n        input.value = '';\n        \n        // Save to Firebase\n        const database = getFirebaseDatabase();\n        if (database && currentUser) {\n            push(ref(database, 'chat'), {\n                uid: currentUser.uid,\n                username: userData.username,\n                message: message,\n                timestamp: serverTimestamp(),\n                isDeveloper: true\n            });\n        }\n    }\n}\n\nexport function handleChatEnter(event) {\n    if (event.key === 'Enter') {\n        sendMessage();\n    }\n}\n\n// ========================================\n// HYDRATION & ACHIEVEMENTS\n// ========================================\nexport function showHydrationReminder() {\n    showNotification('💧 Time for a water break! Stay hydrated!');\n    if (window.confetti) {\n        confetti({\n            particleCount: 50,\n            spread: 60,\n            colors: ['#00d4ff', '#0099ff', '#0066ff'],\n            origin: { y: 0.6 }\n        });\n    }\n    \n    const hydrationCount = parseInt(localStorage.getItem('hydrationCount') || '0') + 1;\n    localStorage.setItem('hydrationCount', hydrationCount);\n    \n    if (hydrationCount >= 12) {\n        const achievements = getAppState().achievements;\n        achievements.hydroHomie = true;\n        showAchievementUnlocked('Hydro Homie');\n    }\n}\n\nexport function updateAchievements() {\n    const achievements = getAppState().achievements;\n    const achievementElements = document.querySelectorAll('.achievement');\n    \n    Object.entries(achievements).forEach(([key, unlocked]) => {\n        if (unlocked) {\n            const element = document.querySelector(`.achievement[data-achievement=\"${key}\"]`);\n            if (element && !element.classList.contains('unlocked')) {\n                element.classList.add('unlocked');\n            }\n        }\n    });\n}\n\nexport function showAchievementUnlocked(name) {\n    if (!localStorage.getItem(`achievement_${name}`)) {\n        localStorage.setItem(`achievement_${name}`, 'true');\n        \n        if (window.confetti) {\n            confetti({\n                particleCount: 100,\n                spread: 70,\n                origin: { y: 0.6 }\n            });\n        }\n        \n        showNotification(`🏆 Achievement Unlocked: ${name}!`);\n    }\n}\n\n// ========================================\n// LOCATION FUNCTIONS\n// ========================================\nexport function checkInLocation(location) {\n    const locationHistory = getAppState().locationHistory;\n    const userData = getAppState().userData;\n    \n    locationHistory.push({\n        location: location,\n        time: Date.now(),\n        user: userData.username\n    });\n    \n    showNotification(`📍 Checked in at ${location}!`);\n    \n    if (locationHistory.length >= 10) {\n        const achievements = getAppState().achievements;\n        achievements.partyAnimal = true;\n        showAchievementUnlocked('Party Animal');\n    }\n    \n    window.closeModal();\n}\n\nexport function createLocationMap() {\n    const locations = getActiveLocations();\n    let mapHtml = '<div style=\"position: relative; width: 100%; height: 100%; background: rgba(255,255,255,0.05); border-radius: 20px;\">';\n    \n    locations.forEach((loc, index) => {\n        const x = 20 + (index % 3) * 30;\n        const y = 20 + Math.floor(index / 3) * 30;\n        mapHtml += `\n            <div class=\"location-dot\" style=\"left: ${x}%; top: ${y}%;\" title=\"${loc.name}: ${loc.count} people\">\n                <span style=\"position: absolute; top: -20px; left: -20px; font-size: 0.8em; white-space: nowrap;\">${loc.name}</span>\n            </div>\n        `;\n    });\n    \n    mapHtml += '</div>';\n    return mapHtml;\n}\n\nexport function initializeLocationMap() {\n    const dots = document.querySelectorAll('.location-dot');\n    dots.forEach(dot => {\n        dot.addEventListener('click', function() {\n            const location = this.getAttribute('title');\n            showNotification(`📍 ${location}`);\n        });\n    });\n}\n\nexport function getActiveLocations() {\n    const partyData = getAppState().partyData || {};\n    const locationCounts = {};\n    \n    Object.values(partyData).forEach(friend => {\n        if (!locationCounts[friend.location]) {\n            locationCounts[friend.location] = { count: 0, totalBac: 0 };\n        }\n        locationCounts[friend.location].count++;\n        locationCounts[friend.location].totalBac += friend.bac;\n    });\n    \n    return Object.entries(locationCounts).map(([name, data]) => ({\n        name,\n        count: data.count,\n        avgBac: data.totalBac / data.count\n    }));\n}\n\n// ========================================\n// UBER & EMERGENCY FUNCTIONS\n// ========================================\nexport function callUber() {\n    const address = localStorage.getItem('homeAddress');\n    \n    if (address) {\n        const encodedAddress = encodeURIComponent(address);\n        showNotification('🚕 Opening Uber with your home address...');\n        \n        navigator.clipboard.writeText(address)\n            .then(() => showNotification('📋 Home address copied to clipboard!'))\n            .catch(() => {});\n        \n        window.open(`https://m.uber.com/ul/?action=setPickup&pickup=my_location&dropoff[formatted_address]=${encodedAddress}`, '_blank');\n    } else {\n        showNotification('🚕 Opening Uber app...');\n        window.open('https://m.uber.com/ul/', '_blank');\n    }\n}\n\nexport function callEmergency(type) {\n    switch(type) {\n        case 'ambulance':\n            if (confirm('Call emergency services (112)?')) {\n                window.location.href = 'tel:112';\n            }\n            break;\n        case 'campus-security':\n            if (confirm('Call HSG Campus Security?')) {\n                window.location.href = 'tel:+41712242424';\n            }\n            break;\n        case 'taxi':\n            showNotification('🚕 Opening taxi options...');\n            setTimeout(() => {\n                showTaxiOptions();\n            }, 500);\n            break;\n    }\n}\n\nexport function showTaxiOptions() {\n    const address = localStorage.getItem('homeAddress') || '';\n    const options = `\n        <h2>🚕 Ride Options</h2>\n        ${address ? `<div style=\"margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;\">\n            <p><strong>Your Home Address:</strong></p>\n            <p>${escapeHtml(address)}</p>\n            <button class=\"btn\" style=\"margin-top: 10px;\" onclick=\"navigator.clipboard.writeText('${escapeHtml(address)}').then(() => showNotification('📋 Address copied!'))\">\n                <i class=\"fas fa-copy\"></i> Copy Address\n            </button>\n        </div>` : ''}\n        <div style=\"margin: 20px 0;\">\n            <button class=\"btn\" style=\"width: 100%; margin: 10px 0;\" onclick=\"callUber()\">\n                <i class=\"fab fa-uber\"></i> Uber\n            </button>\n            <button class=\"btn\" style=\"width: 100%; margin: 10px 0;\" onclick=\"window.location.href='tel:+41712222222'\">\n                <i class=\"fas fa-taxi\"></i> Local Taxi\n            </button>\n            <button class=\"btn\" style=\"width: 100%; margin: 10px 0;\" onclick=\"callSoberFriend()\">\n                <i class=\"fas fa-user-friends\"></i> Call Sober Friend\n            </button>\n        </div>\n        <button class=\"btn\" onclick=\"closeModal()\">Cancel</button>\n    `;\n    \n    document.getElementById('modalBody').innerHTML = options;\n    document.getElementById('modal').classList.add('show');\n}\n\nexport function callSoberFriend() {\n    const partyData = getAppState().partyData || {};\n    const soberFriends = Object.values(partyData).filter(f => f.bac < 0.02);\n    if (soberFriends.length > 0) {\n        const friend = soberFriends[0];\n        showNotification(`📞 Calling ${friend.name}...`);\n    } else {\n        showNotification('❌ No sober friends available right now');\n    }\n}\n\nexport function selectBuddy(buddyName) {\n    localStorage.setItem('buddy', buddyName);\n    showNotification(`👥 ${buddyName} is now your buddy!`);\n    \n    const achievements = getAppState().achievements;\n    achievements.guardianAngel = true;\n    showAchievementUnlocked('Guardian Angel');\n    \n    window.closeModal();\n}\n\nexport function showFirstAid() {\n    window.showModal('first-aid');\n}\n\n// ========================================\n// SETTINGS & PROFILE FUNCTIONS\n// ========================================\nexport async function updateProfile() {\n    const username = document.getElementById('username').value.trim();\n    \n    if (!username || username.length < 3) {\n        showNotification('❌ Username must be at least 3 characters', 'error');\n        return;\n    }\n    \n    try {\n        const database = getFirebaseDatabase();\n        const currentUser = getCurrentUser();\n        const userData = getAppState().userData;\n        \n        if (username.toLowerCase() !== userData.username?.toLowerCase()) {\n            const usernameCheck = await get(ref(database, 'usernames/' + username.toLowerCase()));\n            if (usernameCheck.exists() && usernameCheck.val() !== currentUser.uid) {\n                showNotification('❌ Username already taken', 'error');\n                return;\n            }\n            \n            if (userData.username) {\n                await remove(ref(database, 'usernames/' + userData.username.toLowerCase()));\n            }\n            \n            await set(ref(database, 'usernames/' + username.toLowerCase()), currentUser.uid);\n        }\n        \n        await set(ref(database, 'users/' + currentUser.uid + '/username'), username);\n        \n        showNotification('✅ Profile updated!', 'success');\n        \n        userData.username = username;\n        document.getElementById('profileName').textContent = username;\n        document.getElementById('settingsUsername').textContent = username;\n        document.getElementById('profileInitial').textContent = username.charAt(0).toUpperCase();\n        \n    } catch (error) {\n        console.error('Update profile error:', error);\n        showNotification('❌ Failed to update profile', 'error');\n    }\n}\n\nexport async function changePassword() {\n    const newPassword = prompt('Enter new password (min 6 characters):');\n    if (newPassword && newPassword.length >= 6) {\n        try {\n            const currentUser = getCurrentUser();\n            await currentUser.updatePassword(newPassword);\n            showNotification('✅ Password changed successfully', 'success');\n        } catch (error) {\n            console.error('Password change error:', error);\n            if (error.code === 'auth/requires-recent-login') {\n                showNotification('❌ Please sign out and sign in again before changing password', 'error');\n            } else {\n                showNotification('❌ Failed to change password', 'error');\n            }\n        }\n    }\n}\n\nexport async function saveEmergencyInfo() {\n    const homeAddress = document.getElementById('homeAddress').value;\n    const emergencyContact = document.getElementById('emergencyContact').value;\n    const medicalInfo = document.getElementById('medicalInfo').value;\n    const safetyNotes = document.getElementById('safetyNotes').value;\n    \n    try {\n        const database = getFirebaseDatabase();\n        const currentUser = getCurrentUser();\n        \n        await set(ref(database, 'users/' + currentUser.uid + '/emergency'), {\n            homeAddress,\n            emergencyContact,\n            medicalInfo,\n            safetyNotes,\n            updatedAt: serverTimestamp()\n        });\n        \n        localStorage.setItem('homeAddress', homeAddress);\n        localStorage.setItem('emergencyContact', emergencyContact);\n        localStorage.setItem('medicalInfo', medicalInfo);\n        localStorage.setItem('safetyNotes', safetyNotes);\n        \n        showNotification('✅ Emergency information saved', 'success');\n        showSettingsSaved();\n    } catch (error) {\n        console.error('Save emergency info error:', error);\n        showNotification('❌ Failed to save emergency info', 'error');\n    }\n}\n\nexport async function savePrivacySettings() {\n    const shareLocation = document.getElementById('shareLocation').checked;\n    const notifications = document.getElementById('notifications').checked;\n    const publicProfile = document.getElementById('publicProfile').checked;\n    \n    try {\n        const database = getFirebaseDatabase();\n        const currentUser = getCurrentUser();\n        \n        await set(ref(database, 'users/' + currentUser.uid + '/settings'), {\n            shareLocation,\n            notifications,\n            publicProfile\n        });\n        \n        localStorage.setItem('shareLocation', shareLocation);\n        localStorage.setItem('notifications', notifications);\n        \n        showNotification('✅ Privacy settings saved', 'success');\n        showSettingsSaved();\n    } catch (error) {\n        console.error('Save privacy settings error:', error);\n        showNotification('❌ Failed to save settings', 'error');\n    }\n}\n\nexport function showSettingsSaved() {\n    const savedIcon = document.createElement('div');\n    savedIcon.className = 'settings-saved';\n    savedIcon.innerHTML = '✅';\n    document.body.appendChild(savedIcon);\n    \n    setTimeout(() => savedIcon.remove(), 1000);\n}\n\nexport function updateToggleSwitches() {\n    document.querySelectorAll('.toggle-switch').forEach(toggle => {\n        const input = toggle.querySelector('input');\n        if (input && input.checked) {\n            toggle.classList.add('active');\n        } else {\n            toggle.classList.remove('active');\n        }\n    });\n}\n\nexport async function deleteAccount() {\n    if (!confirm('Delete your account? This cannot be undone!')) return;\n    if (!confirm('Are you absolutely sure? All your data will be permanently deleted.')) return;\n    \n    try {\n        const database = getFirebaseDatabase();\n        const currentUser = getCurrentUser();\n        const userData = getAppState().userData;\n        const friendsData = getAppState().friendsData;\n        \n        await remove(ref(database, 'users/' + currentUser.uid));\n        \n        if (userData.username) {\n            await remove(ref(database, 'usernames/' + userData.username.toLowerCase()));\n        }\n        \n        if (friendsData) {\n            for (const friendId in friendsData) {\n                await remove(ref(database, 'users/' + friendId + '/friends/' + currentUser.uid));\n            }\n        }\n        \n        await currentUser.delete();\n        \n        showNotification('Account deleted. Goodbye!');\n        location.reload();\n    } catch (error) {\n        console.error('Delete account error:', error);\n        if (error.code === 'auth/requires-recent-login') {\n            showNotification('❌ Please sign out and sign in again before deleting account', 'error');\n        } else {\n            showNotification('❌ Failed to delete account', 'error');\n        }\n    }\n}\n\n// ========================================\n// DATA EXPORT\n// ========================================\nexport function exportData() {\n    const currentUser = getCurrentUser();\n    const appState = getAppState();\n    \n    const data = {\n        user: {\n            email: currentUser?.email,\n            username: appState.userData.username\n        },\n        settings: appState.userData.settings,\n        emergency: appState.userData.emergency,\n        devices: appState.deviceData,\n        friends: appState.friendsData,\n        drinkHistory: appState.drinkHistory,\n        achievements: appState.achievements,\n        partyData: appState.partyData\n    };\n    \n    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });\n    const url = window.URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `hsg_party_tracker_${new Date().toISOString().slice(0,10)}.json`;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    window.URL.revokeObjectURL(url);\n    \n    showNotification('📥 Data exported successfully!', 'success');\n}\n\n// ========================================\n// DEVICE PAIRING FROM MODAL\n// ========================================\nexport async function pairDeviceFromModal() {\n    const deviceId = document.getElementById('modalDeviceId').value.trim().toUpperCase();\n    \n    if (!deviceId) {\n        showNotification('❌ Please enter a Device ID', 'error');\n        return;\n    }\n    \n    try {\n        const database = getFirebaseDatabase();\n        const currentUser = getCurrentUser();\n        const deviceData = getAppState().deviceData;\n        \n        const deviceSnapshot = await get(ref(database, 'readings/' + deviceId));\n        \n        if (!deviceSnapshot.exists()) {\n            showNotification('❌ Device not found. Make sure it\\'s connected.', 'error');\n            return;\n        }\n        \n        if (deviceData[deviceId]) {\n            showNotification('ℹ️ Device already paired');\n            window.closeModal();\n            return;\n        }\n        \n        await set(ref(database, 'users/' + currentUser.uid + '/devices/' + deviceId), {\n            pairedAt: serverTimestamp(),\n            name: 'My Breathalyzer'\n        });\n        \n        showNotification('✅ Device paired successfully!', 'success');\n        window.closeModal();\n        \n    } catch (error) {\n        console.error('Pairing error:', error);\n        showNotification('❌ Pairing failed', 'error');\n    }\n}\n\n// ========================================\n// UTILITY FUNCTIONS\n// ========================================\nexport function getTimeSince(timestamp) {\n    const seconds = Math.floor((Date.now() - timestamp) / 1000);\n    if (seconds < 60) return 'just now';\n    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;\n    return `${Math.floor(seconds / 3600)}h ago`;\n}\n\nexport function escapeHtml(text) {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n}\n\nexport function resolvePermission(permission) {\n    // This will be set dynamically when modal is shown\n    console.log('Permission resolved:', permission);\n}","// ========================================\n// DRINK TRACKING MODULE\n// ========================================\n// All drink-related functions from your original app\n\nimport { getFirebaseDatabase } from '../config/firebase.js';\nimport { getAppState, setStateValue, getCurrentUser } from '../config/app-state.js';\nimport { DRINK_PRESETS } from '../config/constants.js';\nimport { showNotification } from '../ui/notifications.js';\nimport { escapeHtml } from './all-functions.js';\nimport { ref, set, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';\n// Chart.js is loaded globally via CDN in index.html\nconst Chart = window.Chart;\nconst confetti = window.confetti;\n\n// Chart instance\nlet drinkChart = null;\n\n// ========================================\n// LOG DRINK\n// ========================================\nexport async function logDrink() {\n    try {\n        const type = document.getElementById('drinkType').value;\n        const amount = parseInt(document.getElementById('drinkAmount').value) || 0;\n        const alcoholPercent = parseFloat(document.getElementById('alcoholPercent').value) || 0;\n        \n        if (amount <= 0) {\n            showNotification('❌ Please enter a valid amount', 'error');\n            return;\n        }\n        \n        const drink = {\n            id: Date.now(),\n            type: type,\n            amount: amount,\n            alcoholPercent: alcoholPercent,\n            pureAlcohol: (amount * alcoholPercent / 100).toFixed(1),\n            time: new Date(),\n            emoji: DRINK_PRESETS[type].emoji\n        };\n        \n        // Add to history\n        let drinkHistory = getAppState().drinkHistory || [];\n        drinkHistory.unshift(drink);\n        setStateValue('drinkHistory', drinkHistory);\n        \n        // Save to localStorage\n        saveDrinkHistory();\n        \n        // Update UI\n        updateDrinkStats();\n        updateDrinkHistory();\n        updateDrinkChart();\n        updateEmergencySummary();\n        \n        // Send to Firebase if connected\n        const database = getFirebaseDatabase();\n        const currentUser = getCurrentUser();\n        if (database && currentUser) {\n            try {\n                await set(ref(database, 'users/' + currentUser.uid + '/drinks/' + drink.id), {\n                    ...drink,\n                    time: drink.time.toISOString()\n                });\n            } catch (firebaseError) {\n                console.warn('Firebase save failed (non-critical):', firebaseError);\n                // Continue - localStorage save was successful\n            }\n        }\n        \n        // Track achievements\n        if (typeof onDrinkLogged === 'function') {\n            // If achievements module is loaded\n            onDrinkLogged(type, drinkHistory);\n        }\n        \n        // Confetti for water!\n        if (type === 'water') {\n            // Use global confetti if available (from CDN)\n            if (typeof window.confetti === 'function') {\n                window.confetti({\n                    particleCount: 50,\n                    spread: 60,\n                    colors: ['#00d4ff', '#0099ff', '#0066ff'],\n                    origin: { y: 0.6 }\n                });\n            }\n            showNotification('💧 Great job staying hydrated!', 'success');\n        } else {\n            showNotification(`${drink.emoji} Drink logged!`);\n        }\n        \n        // Reset form to defaults\n        document.getElementById('drinkAmount').value = DRINK_PRESETS[type].amount;\n        document.getElementById('alcoholPercent').value = DRINK_PRESETS[type].alcohol;\n    } catch (error) {\n        console.error('Error logging drink:', error);\n        showNotification('❌ Failed to log drink', 'error');\n    }\n}\n\n// ========================================\n// UPDATE DRINK STATS\n// ========================================\nexport function updateDrinkStats() {\n    try {\n        const drinkHistory = getAppState().drinkHistory || [];\n        const now = Date.now();\n        const oneHourAgo = now - 3600000;\n        \n        // Calculate totals\n        const totalDrinks = drinkHistory.filter(d => d.type !== 'water').length;\n        const totalWater = drinkHistory.filter(d => d.type === 'water').length;\n        const totalAlcohol = drinkHistory.reduce((sum, d) => sum + parseFloat(d.pureAlcohol || 0), 0);\n        const recentDrinks = drinkHistory.filter(d => new Date(d.time).getTime() > oneHourAgo && d.type !== 'water').length;\n        \n        // Update display\n        const totalDrinksEl = document.getElementById('totalDrinks');\n        if (totalDrinksEl) totalDrinksEl.textContent = totalDrinks;\n        \n        const totalWaterEl = document.getElementById('totalWater');\n        if (totalWaterEl) totalWaterEl.textContent = totalWater;\n        \n        const totalAlcoholEl = document.getElementById('totalAlcohol');\n        if (totalAlcoholEl) totalAlcoholEl.textContent = totalAlcohol.toFixed(0) + 'ml';\n        \n        const drinkRateEl = document.getElementById('drinkRate');\n        if (drinkRateEl) drinkRateEl.textContent = recentDrinks + '/hr';\n    } catch (error) {\n        console.error('Error updating drink stats:', error);\n    }\n}\n\n// ========================================\n// UPDATE DRINK HISTORY UI\n// ========================================\nexport function updateDrinkHistory() {\n    try {\n        const historyContainer = document.getElementById('drinkHistory');\n        if (!historyContainer) return;\n        \n        const drinkHistory = getAppState().drinkHistory || [];\n        \n        if (drinkHistory.length === 0) {\n            historyContainer.innerHTML = '<p style=\"text-align: center; opacity: 0.7;\">No drinks logged yet</p>';\n            return;\n        }\n        \n        historyContainer.innerHTML = drinkHistory.slice(0, 20).map(drink => `\n            <div class=\"buddy-card\" style=\"margin: 10px 0;\">\n                <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                    <div style=\"display: flex; align-items: center; gap: 15px;\">\n                        <div style=\"font-size: 2em;\">${drink.emoji}</div>\n                        <div>\n                            <div style=\"font-weight: bold;\">${drink.type.charAt(0).toUpperCase() + drink.type.slice(1)}</div>\n                            <div style=\"opacity: 0.7; font-size: 0.9em;\">\n                                ${drink.amount}ml • ${drink.alcoholPercent}% • ${drink.pureAlcohol}ml pure\n                            </div>\n                        </div>\n                    </div>\n                    <div style=\"text-align: right;\">\n                        <div style=\"font-size: 0.9em;\">${formatDrinkTime(drink.time)}</div>\n                        <button class=\"btn\" style=\"padding: 5px 10px; margin-top: 5px;\" onclick=\"removeDrink(${drink.id})\">\n                            <i class=\"fas fa-trash\"></i>\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `).join('');\n    } catch (error) {\n        console.error('Error updating drink history:', error);\n    }\n}\n\n// ========================================\n// UPDATE DRINK CHART\n// ========================================\nexport function updateDrinkChart() {\n    try {\n        const ctx = document.getElementById('drinkChart');\n        const chartVisible = getAppState().chartVisible;\n        if (!ctx || !chartVisible) return;\n        \n        const drinkHistory = getAppState().drinkHistory || [];\n        \n        // Count drinks by type\n        const drinkCounts = {};\n        drinkHistory.forEach(drink => {\n            if (!drinkCounts[drink.type]) {\n                drinkCounts[drink.type] = 0;\n            }\n            drinkCounts[drink.type]++;\n        });\n        \n        if (Object.keys(drinkCounts).length === 0) {\n            // No data yet\n            if (drinkChart) {\n                drinkChart.destroy();\n                drinkChart = null;\n            }\n            return;\n        }\n        \n        const labels = Object.keys(drinkCounts);\n        const data = Object.values(drinkCounts);\n        const emojis = labels.map(type => DRINK_PRESETS[type]?.emoji || '🍹');\n        \n        if (drinkChart) {\n            // Update existing chart\n            drinkChart.data.labels = labels.map((label, i) => `${emojis[i]} ${label}`);\n            drinkChart.data.datasets[0].data = data;\n            drinkChart.update();\n        } else {\n            // Create new chart\n            drinkChart = new Chart(ctx, {\n                type: 'doughnut',\n                data: {\n                    labels: labels.map((label, i) => `${emojis[i]} ${label}`),\n                    datasets: [{\n                        data: data,\n                        backgroundColor: [\n                            '#00ff88',\n                            '#00d4ff',\n                            '#ff00ff',\n                            '#ffcc00',\n                            '#ff4444',\n                            '#0099ff',\n                            '#00ccff',\n                            '#ff0088'\n                        ],\n                        borderColor: 'rgba(255, 255, 255, 0.1)',\n                        borderWidth: 2\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: {\n                            position: 'bottom',\n                            labels: {\n                                color: '#fff',\n                                padding: 10,\n                                font: {\n                                    size: window.innerWidth < 768 ? 10 : 12\n                                }\n                            }\n                        }\n                    }\n                }\n            });\n        }\n    } catch (error) {\n        console.error('Error updating drink chart:', error);\n    }\n}\n\n// ========================================\n// EMERGENCY SUMMARY\n// ========================================\nexport function updateEmergencySummary() {\n    const summary = document.getElementById('emergencySummary');\n    if (!summary) return;\n    \n    const drinkHistory = getAppState().drinkHistory || [];\n    const totalAlcohol = drinkHistory.reduce((sum, d) => sum + parseFloat(d.pureAlcohol), 0);\n    const timeSpan = drinkHistory.length > 0 ? \n        ((Date.now() - drinkHistory[drinkHistory.length - 1].time) / 3600000).toFixed(1) : 0;\n    \n    const drinkTypes = {};\n    drinkHistory.forEach(d => {\n        if (!drinkTypes[d.type]) drinkTypes[d.type] = 0;\n        drinkTypes[d.type]++;\n    });\n    \n    const medicalInfo = localStorage.getItem('medicalInfo') || 'None provided';\n    const safetyNotes = localStorage.getItem('safetyNotes') || 'None provided';\n    \n    summary.innerHTML = `\n        <div style=\"background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; margin: 10px 0;\">\n            <p><strong>Time Period:</strong> ${timeSpan} hours</p>\n            <p><strong>Total Pure Alcohol:</strong> ${totalAlcohol.toFixed(0)}ml</p>\n            <p><strong>Drink Breakdown:</strong></p>\n            <ul style=\"margin-left: 20px;\">\n                ${Object.entries(drinkTypes).map(([type, count]) => \n                    `<li>${DRINK_PRESETS[type].emoji} ${type}: ${count}</li>`\n                ).join('')}\n            </ul>\n            <p><strong>Last Drink:</strong> ${drinkHistory.length > 0 ? \n                formatDrinkTime(drinkHistory[0].time) : 'None'}</p>\n            <p><strong>Estimated BAC:</strong> ${estimateBAC().toFixed(3)}‰</p>\n            <p><strong>Medical Info:</strong> ${escapeHtml(medicalInfo)}</p>\n            <p><strong>Safety Notes:</strong> ${escapeHtml(safetyNotes)}</p>\n        </div>\n    `;\n}\n\n// ========================================\n// REMOVE DRINK\n// ========================================\nexport function removeDrink(drinkId) {\n    let drinkHistory = getAppState().drinkHistory || [];\n    drinkHistory = drinkHistory.filter(d => d.id !== drinkId);\n    setStateValue('drinkHistory', drinkHistory);\n    \n    saveDrinkHistory();\n    updateDrinkStats();\n    updateDrinkHistory();\n    updateDrinkChart();\n    updateEmergencySummary();\n    showNotification('🗑️ Drink removed');\n}\n\n// ========================================\n// TOGGLE CHART\n// ========================================\nexport function toggleChart() {\n    let chartVisible = getAppState().chartVisible;\n    chartVisible = !chartVisible;\n    setStateValue('chartVisible', chartVisible);\n    \n    const wrapper = document.getElementById('chartWrapper');\n    const toggleText = document.getElementById('chartToggleText');\n    \n    if (chartVisible) {\n        wrapper.classList.remove('collapsed');\n        toggleText.textContent = 'Hide Chart';\n    } else {\n        wrapper.classList.add('collapsed');\n        toggleText.textContent = 'Show Chart';\n    }\n}\n\n// ========================================\n// EMERGENCY REPORT\n// ========================================\nexport function showEmergencyReport() {\n    try {\n        const drinkHistory = getAppState().drinkHistory || [];\n        const userData = getAppState().userData;\n        const currentUser = getCurrentUser();\n        \n        const report = {\n            timestamp: new Date().toISOString(),\n            estimatedBAC: estimateBAC().toFixed(3),\n            drinkHistory: drinkHistory,\n            totalAlcohol: drinkHistory.reduce((sum, d) => sum + parseFloat(d.pureAlcohol || 0), 0),\n            userData: {\n                name: userData.username || currentUser?.email || 'Unknown',\n                address: localStorage.getItem('homeAddress') || 'Not provided',\n                emergencyContact: localStorage.getItem('emergencyContact') || 'Not provided',\n                medicalInfo: localStorage.getItem('medicalInfo') || 'None',\n                safetyNotes: localStorage.getItem('safetyNotes') || 'None'\n            }\n        };\n        \n        const reportText = `EMERGENCY MEDICAL REPORT\n========================\nGenerated: ${new Date().toLocaleString()}\nPatient: ${report.userData.name}\nAddress: ${report.userData.address}\nEmergency Contact: ${report.userData.emergencyContact}\n\nMEDICAL INFORMATION\n-------------------\n${report.userData.medicalInfo}\n\nSAFETY NOTES\n------------\n${report.userData.safetyNotes}\n\nALCOHOL CONSUMPTION SUMMARY\n---------------------------\nEstimated BAC: ${report.estimatedBAC}‰\nTotal Pure Alcohol: ${report.totalAlcohol.toFixed(0)}ml\nNumber of Drinks: ${drinkHistory.filter(d => d.type !== 'water').length}\nWater Consumed: ${drinkHistory.filter(d => d.type === 'water').length} glasses\n\nDETAILED DRINK LOG\n------------------\n${drinkHistory.map(d => \n    `${formatDrinkTime(d.time)}: ${d.emoji} ${d.type} - ${d.amount}ml @ ${d.alcoholPercent}%`\n).join('\\n')}\n\nMEDICAL NOTES\n-------------\n- Monitor for signs of alcohol poisoning\n- Ensure airway remains clear\n- Check vitals regularly\n- Consider IV fluids if dehydrated`;\n        \n        // Create modal with report\n        const modalContent = `\n            <h2>🚨 Emergency Medical Report</h2>\n            <div style=\"background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; margin: 20px 0; max-height: 400px; overflow-y: auto;\">\n                <pre style=\"white-space: pre-wrap; font-family: monospace; font-size: 0.9em;\">${escapeHtml(reportText)}</pre>\n            </div>\n            <div style=\"display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;\">\n                <button class=\"btn btn-primary\" onclick=\"copyEmergencyReport()\">\n                    <i class=\"fas fa-copy\"></i> Copy Report\n                </button>\n                <button class=\"btn btn-primary\" onclick=\"downloadEmergencyReport()\">\n                    <i class=\"fas fa-download\"></i> Download\n                </button>\n                <button class=\"btn btn-danger\" onclick=\"shareEmergencyReport()\">\n                    <i class=\"fas fa-share\"></i> Share\n                </button>\n                <button class=\"btn\" onclick=\"closeModal()\">Close</button>\n            </div>\n        `;\n        \n        // Store report in window for other functions\n        window.currentEmergencyReport = reportText;\n        \n        document.getElementById('modalBody').innerHTML = modalContent;\n        document.getElementById('modal').classList.add('show');\n    } catch (error) {\n        console.error('Error generating emergency report:', error);\n        showNotification('❌ Error generating report', 'error');\n    }\n}\n\nexport function copyEmergencyReport() {\n    if (window.currentEmergencyReport) {\n        navigator.clipboard.writeText(window.currentEmergencyReport)\n            .then(() => showNotification('📋 Report copied to clipboard!', 'success'))\n            .catch(() => {\n                // Fallback for older browsers\n                const textArea = document.createElement('textarea');\n                textArea.value = window.currentEmergencyReport;\n                document.body.appendChild(textArea);\n                textArea.select();\n                document.execCommand('copy');\n                document.body.removeChild(textArea);\n                showNotification('📋 Report copied!', 'success');\n            });\n    }\n}\n\nexport function downloadEmergencyReport() {\n    try {\n        const blob = new Blob([window.currentEmergencyReport], { type: 'text/plain' });\n        const url = window.URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = `emergency_report_${new Date().toISOString().slice(0,10)}.txt`;\n        document.body.appendChild(a);\n        a.click();\n        document.body.removeChild(a);\n        window.URL.revokeObjectURL(url);\n        showNotification('📥 Report downloaded!', 'success');\n    } catch (error) {\n        console.error('Download error:', error);\n        showNotification('❌ Download failed - use copy instead', 'error');\n    }\n}\n\nexport function shareEmergencyReport() {\n    if (navigator.share && window.currentEmergencyReport) {\n        navigator.share({\n            title: 'Emergency Medical Report',\n            text: window.currentEmergencyReport\n        })\n        .then(() => showNotification('📤 Report shared!', 'success'))\n        .catch(() => showNotification('❌ Sharing cancelled'));\n    } else {\n        // Fallback - copy to clipboard\n        copyEmergencyReport();\n        showNotification('📋 Report copied - share manually');\n    }\n}\n\n// ========================================\n// CLEAR DRINK HISTORY\n// ========================================\nexport function clearDrinkHistory() {\n    if (confirm('Clear all drink history? This cannot be undone!')) {\n        setStateValue('drinkHistory', []);\n        saveDrinkHistory();\n        updateDrinkStats();\n        updateDrinkHistory();\n        updateDrinkChart();\n        updateEmergencySummary();\n        \n        // Clear from Firebase\n        const database = getFirebaseDatabase();\n        const currentUser = getCurrentUser();\n        if (database && currentUser) {\n            remove(ref(database, 'users/' + currentUser.uid + '/drinks'));\n        }\n        \n        showNotification('🗑️ Drink history cleared');\n    }\n}\n\n// ========================================\n// PERSISTENCE\n// ========================================\nexport function saveDrinkHistory() {\n    const drinkHistory = getAppState().drinkHistory || [];\n    localStorage.setItem('drinkHistory', JSON.stringify(drinkHistory));\n}\n\nexport function loadDrinkHistory() {\n    const saved = localStorage.getItem('drinkHistory');\n    if (saved) {\n        try {\n            const drinkHistory = JSON.parse(saved);\n            // Convert time strings back to Date objects\n            drinkHistory.forEach(d => {\n                d.time = new Date(d.time);\n            });\n            setStateValue('drinkHistory', drinkHistory);\n        } catch (error) {\n            console.error('Failed to load drink history:', error);\n        }\n    }\n}\n\n// ========================================\n// UTILITY FUNCTIONS\n// ========================================\nfunction formatDrinkTime(time) {\n    const now = new Date();\n    const drinkTime = new Date(time);\n    const diffMinutes = Math.floor((now - drinkTime) / 60000);\n    \n    if (diffMinutes < 1) return 'Just now';\n    if (diffMinutes < 60) return `${diffMinutes}m ago`;\n    if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}h ago`;\n    return drinkTime.toLocaleDateString();\n}\n\nfunction estimateBAC() {\n    // Widmark formula estimation (simplified)\n    const weight = 70; // kg (average)\n    const gender = 0.68; // male average (0.55 for female)\n    const drinkHistory = getAppState().drinkHistory || [];\n    const totalAlcohol = drinkHistory.reduce((sum, d) => sum + parseFloat(d.pureAlcohol), 0);\n    const hoursSinceFirst = drinkHistory.length > 0 ? \n        ((Date.now() - drinkHistory[drinkHistory.length - 1].time) / 3600000) : 0;\n    \n    // BAC = (alcohol in grams / (weight * gender factor)) - (0.015 * hours)\n    const alcoholGrams = totalAlcohol * 0.789; // ml to grams\n    const bac = Math.max(0, (alcoholGrams / (weight * 1000 * gender)) * 100 - (0.015 * hoursSinceFirst));\n    \n    return bac;\n}","// ========================================\n// PARTY GAMES MODULE\n// ========================================\n// All game functions from your original app\n\nimport { getAppState, setStateValue } from '../config/app-state.js';\nimport { showNotification } from '../ui/notifications.js';\n// Canvas confetti is loaded globally via CDN in index.html\nconst confetti = window.confetti;\n\n// Game state\nlet gamePlayers = [];\nlet currentPlayerIndex = 0;\nlet gameHistory = [];\n\n// Game data - expanded with industrial-grade content\nconst gameData = {\n    beerPongRules: {\n        standard: {\n            title: \"📜 Standard Beer Pong Rules\",\n            description: \"The official way to play Beer Pong\",\n            rules: [\n                { name: \"🔄 Balls Back\", desc: \"Both partners make cups = shoot again! No re-racks during bonus shots.\" },\n                { name: \"🔙 Behind-the-Back\", desc: \"Miss and grab the ball while it's on the table? Shoot behind your back for a bonus cup!\" },\n                { name: \"⚡ Bouncing\", desc: \"Bounce shots count as 2 cups! But opponents can swat bounced shots away.\" },\n                { name: \"💪 Elbows\", desc: \"Keep those elbows behind the table edge when shooting. Breaking the plane = reshoot!\" },\n                { name: \"👀 Eye-to-Eye\", desc: \"To decide who goes first, one player from each team shoots while making eye contact. First to make it wins!\" },\n                { name: \"🔥 Fire\", desc: \"Make 2 in a row? Call 'heating up'. Make the 3rd? Call 'fire' and keep shooting until you miss!\" },\n                { name: \"🏝️ Island\", desc: \"Once per game, call 'island' on an isolated cup. Make it = remove 2 cups!\" },\n                { name: \"⏰ Overtime\", desc: \"Tied game? Each team sets up 3 cups in a triangle. No re-racks allowed!\" },\n                { name: \"🙏 Redemption\", desc: \"Lost all cups? Keep shooting until you miss! Make them all = overtime!\" },\n                { name: \"♻️ Re-racks\", desc: \"2 re-racks per game. Diamond, line, triangle - get creative!\" },\n                { name: \"🧹 Tidying-up\", desc: \"Tighten those cups anytime! Keep the formation clean.\" }\n            ]\n        },\n        creator: {\n            title: \"🎯 Creator's Beer Pong Rules\",\n            description: \"The way Beer Pong was meant to be played! 🍺\",\n            rules: [\n                { name: \"👀 Eye-to-Eye\", desc: \"Same as standard - stare into their soul while shooting to go first!\" },\n                { name: \"♻️ Re-racks\", desc: \"2 per game - get creative with those formations!\" },\n                { name: \"🎩 Gentleman\", desc: \"Call 'Gentleman' to tidy cups OR force opponent to line up their last 2 cups!\" },\n                { name: \"🔄 Balls Back\", desc: \"Both make it = balls back baby! Keep that momentum going!\" },\n                { name: \"⚡ Bouncing\", desc: \"Bounce = 2 cups removed! High risk, high reward!\" },\n                { name: \"💪 Elbows\", desc: \"Watch those elbows - we're not playing reach pong!\" },\n                { name: \"🏝️ Island\", desc: \"Isolated cup = 2 cups removed when made. Call it out!\" },\n                { name: \"🎪 Trickshot\", desc: \"Ball on table after miss? Any creative shot = 2 cups! Behind back is for beginners!\" },\n                { name: \"💥 Double Trouble\", desc: \"Same cup hit twice? That cup + ALL touching cups are gone! Legendary move!\" },\n                { name: \"🎮 Redemption 2.0\", desc: \"Lost all cups? Make one to stay alive - but nothing gets removed! It's sudden death mode!\" }\n            ]\n        }\n    },\n    specialBeerPongRules: {\n        classic: [\n            \"🎯 Make a rule! Everyone must follow it for the rest of the game\",\n            \"🔄 Switch sides! Both teams swap positions\",\n            \"💃 Dance before shooting! Do a 10-second dance before each shot\",\n            \"🎵 Sing while shooting! Must sing during your entire turn\",\n            \"🎭 Accent round! Speak in an accent for 5 minutes\",\n            \"🤐 Silent round! No talking for 2 rounds\",\n            \"👯 Mirror mode! Copy everything your opponent does\",\n            \"🎯 Call your shot! Must call which cup you're aiming for\",\n            \"⏰ Speed round! 5-second shot clock for next 3 shots\",\n            \"🤡 Compliment battle! Compliment opponents before each shot\"\n        ],\n        gettingStarted: [\n            \"🎯 Nice shot bonus! Make a cup = opponent drinks water\",\n            \"🤝 Team spirit! High five after every shot\",\n            \"🎵 Theme song! Pick a song to play during your turn\",\n            \"📣 Announce your shots! Describe your technique before shooting\",\n            \"🎪 Celebration dance! Do a victory dance after making a cup\",\n            \"👏 Applause rule! Everyone claps after a made cup\",\n            \"🎯 Practice shot! Get one practice shot per turn\",\n            \"🤗 Encouragement only! Only positive comments allowed\",\n            \"🎯 Second chance! Miss = get one retry per game\",\n            \"🏆 MVP! Best shot of the round gets to make a rule\"\n        ],\n        normal: [\n            \"👁️ Blindfold shot! Next shot must be taken blindfolded\",\n            \"🤝 Partner shot! Both teammates must hold the ball together\",\n            \"🎪 Trick shot only! Next 3 shots must be trick shots\",\n            \"🚫 No elbows! Next round, elbows must stay at your sides\",\n            \"🦩 Flamingo stance! Stand on one leg for your next shot\",\n            \"🔄 Opposite hand! Use your non-dominant hand for 2 turns\",\n            \"🎪 Spin before shooting! Do 3 spins before taking your shot\",\n            \"💪 Push-up penalty! Do 5 push-ups if you miss\",\n            \"🎯 Behind the back only! All shots must be behind the back\",\n            \"🤸 Gymnastics shot! Do a cartwheel before shooting\"\n        ],\n        spicy: [\n            \"👕 Strip pong! Remove clothing item when opponent makes cup\",\n            \"💋 Kiss for miss! Miss = kiss your teammate\",\n            \"🍑 Distraction allowed! Opponents can distract however they want\",\n            \"📱 Phone roulette! Text your ex 'I miss you'\",\n            \"🔥 Hot seat! Answer any question or take 2 shots\",\n            \"💃 Sexy dance! Do a lap dance if you miss\",\n            \"🎯 Body shots! Made cup = body shot off opponent\",\n            \"👅 Lick it! Lick the ball before shooting\",\n            \"🔥 Truth shot! Make cup = opponent answers truth question\",\n            \"💋 Make out break! Teams make out for 30 seconds\"\n        ],\n        couples: [\n            \"💑 Couple shots! Partners must be touching while shooting\",\n            \"💋 Kiss for cups! Make a cup = kiss your partner\",\n            \"🤝 Trust shot! Partner guides your blindfolded shot\",\n            \"💕 Compliment rule! Compliment partner before each shot\",\n            \"🎯 Love wins! Make 2 in a row = opponents kiss\",\n            \"👫 Switch partners! Play with opponent's partner for 1 round\",\n            \"💑 Couple's choice! Make cup = give opponents a couple dare\",\n            \"❤️ Heart eyes! Maintain eye contact with partner while shooting\",\n            \"💋 Victory kiss! Kiss for 10 seconds after making a cup\",\n            \"🤗 Support system! Hug partner after every shot\"\n        ]\n    },\n    specialBeerPongDares: {\n        classic: [\n            \"Take a shot chosen by opponents\",\n            \"Do 20 jumping jacks\",\n            \"Sing the alphabet backwards\",\n            \"Do your best impression of someone in the room\",\n            \"Tell your most embarrassing story\",\n            \"Do the chicken dance for 1 minute\",\n            \"Speak in rhymes for the next 5 minutes\",\n            \"Call a random contact and say 'I love you'\",\n            \"Do 10 push-ups\",\n            \"Let opponents choose your next drink\"\n        ],\n        gettingStarted: [\n            \"Give someone a high five\",\n            \"Tell a joke\",\n            \"Do your best dance move\",\n            \"Sing your favorite song chorus\",\n            \"Give someone a compliment\",\n            \"Do 5 jumping jacks\",\n            \"Share a fun fact about yourself\",\n            \"Do your best animal impression\",\n            \"Tell us your hidden talent\",\n            \"Make everyone laugh\"\n        ],\n        normal: [\n            \"Let opponents post something on your social media\",\n            \"Do 20 burpees right now\",\n            \"Let everyone go through your phone for 30 seconds\",\n            \"Show your last 5 Google searches\",\n            \"Let opponents give you a nickname for the night\",\n            \"Swap an item of clothing with an opponent\",\n            \"Let opponents draw on your face with marker\",\n            \"Chug a mystery drink made by opponents\",\n            \"Let everyone read your last text conversation\",\n            \"Freestyle rap for 30 seconds\"\n        ],\n        spicy: [\n            \"Call your crush and tell them you're thinking of them\",\n            \"Send a nude to your ex (or pretend to)\",\n            \"Reveal your body count\",\n            \"Let opponents go through your dating apps\",\n            \"Do a strip tease for 30 seconds\",\n            \"Make out with someone chosen by opponents\",\n            \"Send a dirty text to someone\",\n            \"Reveal your biggest kink\",\n            \"Take a body shot off someone\",\n            \"Flash everyone for 3 seconds\"\n        ],\n        couples: [\n            \"Kiss your partner for 30 seconds\",\n            \"Give your partner a lap dance\",\n            \"Reveal your partner's most annoying habit\",\n            \"Let your partner post on your social media\",\n            \"Switch clothes with your partner\",\n            \"Tell everyone your partner's biggest fear\",\n            \"Massage your partner for 1 minute\",\n            \"Share your wildest experience together\",\n            \"Feed your partner a shot\",\n            \"Whisper your fantasy to your partner\"\n        ]\n    },\n    neverHaveIEver: {\n        classic: [\n            \"Never have I ever been kicked out of a bar or club\",\n            \"Never have I ever lied about my age to get into a club\", \n            \"Never have I ever karaoke'd while drunk\",\n            \"Never have I ever lost my phone on a night out\",\n            \"Never have I ever thrown up in public\",\n            \"Never have I ever called in sick when I wasn't\",\n            \"Never have I ever fallen asleep at work/in class\",\n            \"Never have I ever gotten a tattoo I regret\",\n            \"Never have I ever crashed a wedding or private party\",\n            \"Never have I ever danced on a table or bar\"\n        ],\n        gettingStarted: [\n            \"Never have I ever traveled to another continent\",\n            \"Never have I ever gone skydiving\",\n            \"Never have I ever been on TV\",\n            \"Never have I ever met a celebrity\",\n            \"Never have I ever won a competition\",\n            \"Never have I ever been in a helicopter\",\n            \"Never have I ever gone surfing\",\n            \"Never have I ever stayed up for 24 hours straight\",\n            \"Never have I ever eaten something I couldn't identify\",\n            \"Never have I ever gotten lost in a foreign country\"\n        ],\n        normal: [\n            \"Never have I ever ghosted someone\",\n            \"Never have I ever sent a risky text to the wrong person\",\n            \"Never have I ever walked into a glass door\",\n            \"Never have I ever farted loudly in a quiet room\",\n            \"Never have I ever tripped and fallen in front of a crowd\",\n            \"Never have I ever accidentally sent a screenshot to the person I was talking about\",\n            \"Never have I ever lied on my resume\",\n            \"Never have I ever eaten food off the floor\",\n            \"Never have I ever gone 3+ days without showering\",\n            \"Never have I ever broken something and blamed someone else\"\n        ],\n        spicy: [\n            \"Never have I ever kissed someone I just met\",\n            \"Never have I ever had a one night stand\",\n            \"Never have I ever skinny dipped\",\n            \"Never have I ever done a body shot\",\n            \"Never have I ever slept with a coworker\",\n            \"Never have I ever hooked up with a professor/boss\",\n            \"Never have I ever been in a hot tub with strangers\",\n            \"Never have I ever woken up wearing someone else's clothes\",\n            \"Never have I ever dated two people at once\",\n            \"Never have I ever kissed someone to make someone else jealous\"\n        ],\n        couples: [\n            \"Never have I ever been in love with my best friend\",\n            \"Never have I ever broken up with someone over text\",\n            \"Never have I ever stalked an ex on social media\",\n            \"Never have I ever been in love with two people at once\",\n            \"Never have I ever cheated or been cheated on\",\n            \"Never have I ever had a crush on my partner's friend\",\n            \"Never have I ever lied to my partner about where I was\",\n            \"Never have I ever kept a secret from my partner\",\n            \"Never have I ever dreamt about someone else while in a relationship\",\n            \"Never have I ever compared my partner to an ex\"\n        ]\n    },\n    truths: {\n        classic: [\n            \"What's your most embarrassing drunk story?\",\n            \"What's the biggest lie you've ever told?\",\n            \"What's the most trouble you've gotten into?\",\n            \"Have you ever been caught doing something you shouldn't?\",\n            \"What's your worst habit that no one knows about?\",\n            \"Who in this room has the best style?\",\n            \"Who here would you want to switch lives with?\",\n            \"What's the most embarrassing thing on your phone right now?\",\n            \"What's the craziest thing you've done for money?\",\n            \"What's your most embarrassing moment?\"\n        ],\n        gettingStarted: [\n            \"What's your dream vacation destination?\",\n            \"What's your biggest fear?\",\n            \"What's your hidden talent?\",\n            \"What's the best compliment you've ever received?\",\n            \"What's your favorite childhood memory?\",\n            \"If you could have dinner with anyone, who would it be?\",\n            \"What's your biggest pet peeve?\",\n            \"What's the best advice you've ever received?\",\n            \"What's your guilty pleasure TV show?\",\n            \"What's something you've never told anyone?\"\n        ],\n        normal: [\n            \"What's the weirdest thing you do when you're alone?\",\n            \"What's your most embarrassing Google search?\",\n            \"Who here do you think has the biggest secret?\",\n            \"What's the last lie you told?\",\n            \"What's your most irrational fear?\",\n            \"What's the most childish thing you still do?\",\n            \"What's your worst dating app experience?\",\n            \"What's the most embarrassing thing your parents have caught you doing?\",\n            \"What's your biggest insecurity?\",\n            \"What's the meanest thing you've ever said to someone?\"\n        ],\n        spicy: [\n            \"What's your biggest turn on?\",\n            \"Who was your worst kiss and why?\",\n            \"Who in this room would you most want to make out with?\",\n            \"What's the wildest place you've hooked up?\",\n            \"What's your wildest fantasy?\",\n            \"What's the most illegal thing you've done?\",\n            \"If you had to date someone here, who would it be?\",\n            \"What's your body count?\",\n            \"What's the kinkiest thing you've ever done?\",\n            \"Who in this room do you think is the best looking?\"\n        ],\n        couples: [\n            \"What's the most embarrassing thing you've done for love?\",\n            \"Have you ever been in love with two people at once?\",\n            \"Have you ever cheated or been cheated on?\",\n            \"What's your biggest relationship regret?\",\n            \"What's the longest you've gone without sex in a relationship?\",\n            \"What's something your partner does that annoys you?\",\n            \"Have you ever faked an orgasm?\",\n            \"What's your partner's most annoying habit?\",\n            \"What's something you've lied to your partner about?\",\n            \"If you could change one thing about your partner, what would it be?\"\n        ]\n    },\n    dares: {\n        classic: [\n            \"Do 10 pushups\",\n            \"Plank for 1 minute\",\n            \"Sing everything you say for the next 2 turns\",\n            \"Speak in an accent for the next 3 rounds\",\n            \"Act like a chicken for 1 minute\",\n            \"Do your best impression of someone in the room\",\n            \"Take a shot without using your hands\",\n            \"Finish your drink\",\n            \"Do 20 jumping jacks\",\n            \"Tell a joke and make someone laugh\"\n        ],\n        gettingStarted: [\n            \"Show your best dance move\",\n            \"Sing the chorus of your favorite song\",\n            \"Do your best celebrity impression\",\n            \"Tell your most embarrassing story\",\n            \"Show the last photo in your camera roll\",\n            \"Do 5 pushups\",\n            \"Speak in a British accent for 2 turns\",\n            \"Make animal noises for 30 seconds\",\n            \"Do the robot dance\",\n            \"High five everyone in the room\"\n        ],\n        normal: [\n            \"Let someone draw on your face with marker\",\n            \"Let someone style your hair however they want\",\n            \"Post an ugly selfie\",\n            \"Let someone text anyone from your phone\",\n            \"Eat a spoonful of hot sauce\",\n            \"Let the group choose someone for you to call and sing to\",\n            \"Make a gross drink combination and take a sip\",\n            \"Waterfall for 5 seconds\",\n            \"Let someone go through your phone for 30 seconds\",\n            \"Do the worm\"\n        ],\n        spicy: [\n            \"Do your best twerk for 30 seconds\",\n            \"Give someone a lap dance for 10 seconds\",\n            \"Kiss the person to your left on the cheek\",\n            \"Give someone a 30 second massage\",\n            \"Switch an item of clothing with someone\",\n            \"Whisper something dirty to the person on your right\",\n            \"Post 'I'm pregnant' on your story for 1 minute\",\n            \"Like your crush's oldest Instagram photo\",\n            \"Send the last photo in your gallery to your ex\",\n            \"Take a body shot off someone\"\n        ],\n        couples: [\n            \"Give your partner a 1 minute massage\",\n            \"Recreate your first kiss with your partner\",\n            \"Let your partner post something on your social media\",\n            \"Switch clothes with your partner for the rest of the game\",\n            \"Slow dance with your partner for 1 minute\",\n            \"Tell everyone your partner's most annoying habit\",\n            \"Let your partner draw on your face\",\n            \"Feed your partner a shot\",\n            \"Sit on your partner's lap for the next 3 rounds\",\n            \"Whisper your wildest fantasy to your partner\"\n        ]\n    },\n    wouldYouRather: {\n        classic: [\n            \"Would you rather have to sing everything you say or dance everywhere you walk?\",\n            \"Would you rather be the funniest person in the room or the smartest?\",\n            \"Would you rather never be able to drink alcohol again or never be able to eat chocolate again?\",\n            \"Would you rather have a rewind button or a pause button for your life?\",\n            \"Would you rather go to a party where you know everyone or where you know no one?\",\n            \"Would you rather always smell like garlic or always smell like wet dog?\",\n            \"Would you rather be able to fly or be invisible?\",\n            \"Would you rather be rich or famous?\",\n            \"Would you rather lose your phone or your wallet?\",\n            \"Would you rather always be 10 minutes late or 20 minutes early?\"\n        ],\n        gettingStarted: [\n            \"Would you rather have unlimited money or unlimited time?\",\n            \"Would you rather live in the city or the countryside?\",\n            \"Would you rather be able to read minds or see the future?\",\n            \"Would you rather travel to the past or the future?\",\n            \"Would you rather have a pet dragon or a pet unicorn?\",\n            \"Would you rather be a superhero or a supervillain?\",\n            \"Would you rather never use social media again or never watch TV again?\",\n            \"Would you rather always tell the truth or always lie?\",\n            \"Would you rather have super strength or super speed?\",\n            \"Would you rather live without music or without movies?\"\n        ],\n        normal: [\n            \"Would you rather have fingers as long as legs or legs as short as fingers?\",\n            \"Would you rather drunk text your ex or your boss?\",\n            \"Would you rather throw up in front of your crush or pee yourself at a party?\",\n            \"Would you rather be able to fly but only 1 foot off the ground or be invisible but only when no one is looking?\",\n            \"Would you rather eat a live spider or a dead worm?\",\n            \"Would you rather swim in a pool of beer or a pool of wine?\",\n            \"Would you rather burp glitter or fart confetti?\",\n            \"Would you rather have a third arm or a third leg?\",\n            \"Would you rather always speak in rhymes or sing everything you say?\",\n            \"Would you rather have taste buds in your butt or poop through your mouth?\"\n        ],\n        spicy: [\n            \"Would you rather date someone who's extremely hot but boring or average looking but hilarious?\",\n            \"Would you rather have sex with the lights on always or off always?\",\n            \"Would you rather be naked in public or have everyone read your texts?\",\n            \"Would you rather give up sex or give up food?\",\n            \"Would you rather have a threesome or be in an open relationship?\",\n            \"Would you rather sleep with your boss or your best friend's partner?\",\n            \"Would you rather be dominant or submissive?\",\n            \"Would you rather have great sex once a month or mediocre sex every day?\",\n            \"Would you rather be caught masturbating or catch your parents doing it?\",\n            \"Would you rather send nudes to your ex or your boss?\"\n        ],\n        couples: [\n            \"Would you rather have your partner be best friends with their ex or hate their ex?\",\n            \"Would you rather catch your parents having sex or have them catch you?\",\n            \"Would you rather be in a relationship with someone who's too clingy or too distant?\",\n            \"Would you rather know when you're going to die or how you're going to die?\",\n            \"Would you rather have your partner forget your birthday or your anniversary?\",\n            \"Would you rather have a partner who's too jealous or not jealous at all?\",\n            \"Would you rather argue every day for a week or not talk for a week?\",\n            \"Would you rather have your partner be a bad kisser or bad in bed?\",\n            \"Would you rather live with your partner's parents or have them live with you?\",\n            \"Would you rather have your partner cheat emotionally or physically?\"\n        ]\n    },\n    mostLikelyTo: {\n        classic: [\n            \"Who's most likely to get kicked out of a club?\",\n            \"Who's most likely to throw up tonight?\",\n            \"Who's most likely to become famous?\",\n            \"Who's most likely to become a millionaire?\",\n            \"Who's most likely to forget their own birthday?\",\n            \"Who's most likely to get lost in their own city?\",\n            \"Who's most likely to cry during a Disney movie?\",\n            \"Who's most likely to eat food off the floor?\",\n            \"Who's most likely to laugh at their own jokes?\",\n            \"Who's most likely to lose their phone tonight?\"\n        ],\n        gettingStarted: [\n            \"Who's most likely to win a Nobel Prize?\",\n            \"Who's most likely to travel the world?\",\n            \"Who's most likely to write a book?\",\n            \"Who's most likely to start their own business?\",\n            \"Who's most likely to become a teacher?\",\n            \"Who's most likely to adopt a pet?\",\n            \"Who's most likely to learn a new language?\",\n            \"Who's most likely to run a marathon?\",\n            \"Who's most likely to become vegetarian?\",\n            \"Who's most likely to move to another country?\"\n        ],\n        normal: [\n            \"Who's most likely to drunk text their ex?\",\n            \"Who's most likely to end up sleeping on the bathroom floor?\",\n            \"Who's most likely to go to jail?\",\n            \"Who's most likely to die first in a zombie apocalypse?\",\n            \"Who's most likely to have 10 kids?\",\n            \"Who's most likely to get a weird tattoo?\",\n            \"Who's most likely to join a cult?\",\n            \"Who's most likely to become a crazy cat person?\",\n            \"Who's most likely to marry for money?\",\n            \"Who's most likely to fake their own death?\"\n        ],\n        spicy: [\n            \"Who's most likely to have a one night stand?\",\n            \"Who's most likely to have a secret crush on someone here?\",\n            \"Who's most likely to sleep with their boss?\",\n            \"Who's most likely to have a threesome?\",\n            \"Who's most likely to send nudes?\",\n            \"Who's most likely to have sex in public?\",\n            \"Who's most likely to date two people at once?\",\n            \"Who's most likely to have a sugar daddy/mommy?\",\n            \"Who's most likely to do porn?\",\n            \"Who's most likely to have the highest body count?\"\n        ],\n        couples: [\n            \"Who's most likely to get married first?\",\n            \"Who's most likely to cheat on their partner?\",\n            \"Who's most likely to fall in love with their best friend?\",\n            \"Who's most likely to have kids first?\",\n            \"Who's most likely to forget their anniversary?\",\n            \"Who's most likely to get divorced?\",\n            \"Who's most likely to propose in public?\",\n            \"Who's most likely to have a destination wedding?\",\n            \"Who's most likely to elope?\",\n            \"Who's most likely to stay single forever?\"\n        ]\n    },\n    spinBottleTasks: {\n        classic: [\n            \"Give a compliment\",\n            \"Share your most embarrassing moment\",\n            \"Do your best impression of someone here\",\n            \"Sing a song for 30 seconds\",\n            \"Tell them something you like about them\",\n            \"Do a silly dance together\",\n            \"Take a selfie together\",\n            \"Give them a high five\",\n            \"Tell a joke\",\n            \"Share a secret\"\n        ],\n        gettingStarted: [\n            \"Give them a hug\",\n            \"Say something nice about them\",\n            \"Show them your best dance move\",\n            \"Teach them your secret handshake\",\n            \"Play rock paper scissors\",\n            \"Thumb wrestle\",\n            \"Staring contest for 30 seconds\",\n            \"Tell them your favorite thing about the party\",\n            \"Share your worst pickup line\",\n            \"Do 5 jumping jacks together\"\n        ],\n        normal: [\n            \"Let them post something on your social media\",\n            \"Give a 30 second massage\",\n            \"Whisper something in their ear\",\n            \"Do a trust fall\",\n            \"Sit on their lap for the next round\",\n            \"Feed them a snack\",\n            \"Let them style your hair\",\n            \"Arm wrestle\",\n            \"Let them draw on your hand\",\n            \"Share an embarrassing photo from your phone\"\n        ],\n        spicy: [\n            \"Kiss on the cheek\",\n            \"Give a lap dance for 10 seconds\",\n            \"Switch an item of clothing\",\n            \"Take a body shot\",\n            \"Play with their hair for 1 minute\",\n            \"Whisper your dirtiest thought\",\n            \"Lick their ear\",\n            \"Give them a hickey\",\n            \"Make out for 10 seconds\",\n            \"Remove an item of clothing\"\n        ],\n        couples: [\n            \"Kiss for 30 seconds\",\n            \"Give your partner a 1 minute massage\",\n            \"Whisper what you want to do later\",\n            \"Share your favorite memory together\",\n            \"Recreate your first kiss\",\n            \"Slow dance for 1 minute\",\n            \"Feed each other a shot\",\n            \"Tell them what you love most about them\",\n            \"Give them a lap dance\",\n            \"Make out until the next turn\"\n        ]\n    },\n    trivia: [\n        {\n            question: \"When was HSG founded?\",\n            options: [\"1898\", \"1923\", \"1945\", \"1967\"],\n            correct: 0\n        },\n        {\n            question: \"What does HSG stand for?\",\n            options: [\"High School Gymnasium\", \"Hochschule St. Gallen\", \"Higher Studies Group\", \"Helvetic Study Group\"],\n            correct: 1\n        },\n        {\n            question: \"How many students attend HSG?\",\n            options: [\"5,000\", \"9,000\", \"12,000\", \"15,000\"],\n            correct: 1\n        },\n        {\n            question: \"What's the most popular major at HSG?\",\n            options: [\"Law\", \"Business Administration\", \"Computer Science\", \"International Affairs\"],\n            correct: 1\n        }\n    ]\n};\n\n// Game state\nconst gameState = {\n    flipTimer: null,\n    flipTime: 0,\n    bestFlipTime: null,\n    triviaScore: 0,\n    currentTriviaIndex: 0,\n    // Tournament state\n    tournament: {\n        teams: [],\n        bracket: [],\n        currentRound: 0,\n        totalTeams: 0,\n        rounds: []\n    },\n    // Beer Pong state\n    beerPong: {\n        currentMode: 'normal',\n        team1Name: 'Team 1',\n        team2Name: 'Team 2',\n        specialCups: {\n            team1: [],\n            team2: []\n        }\n    },\n    // Category state for games\n    selectedCategory: 'classic'\n};\n\n// ========================================\n// START GAME\n// ========================================\nexport function startGame(gameType) {\n    setStateValue('currentGame', gameType);\n    \n    const gameOverlay = document.createElement('div');\n    gameOverlay.className = 'game-overlay';\n    gameOverlay.id = 'gameOverlay';\n    \n    let gameContent = '';\n    \n    switch(gameType) {\n        case 'never-have-i-ever':\n            gameContent = createNeverHaveIEverGame();\n            break;\n        case 'truth-or-dare':\n            gameContent = createTruthOrDareGame();\n            break;\n        case 'kings-cup':\n            gameContent = createKingsCupGame();\n            break;\n        case 'beer-pong':\n            gameContent = createBeerPongGame();\n            break;\n        case 'flip-cup':\n            gameContent = createFlipCupGame();\n            break;\n        case 'trivia':\n            gameContent = createTriviaGame();\n            break;\n        case 'would-you-rather':\n            gameContent = createWouldYouRatherGame();\n            break;\n        case 'most-likely-to':\n            gameContent = createMostLikelyToGame();\n            break;\n        case 'spin-the-bottle':\n            gameContent = createSpinBottleGame();\n            break;\n    }\n    \n    gameOverlay.innerHTML = `\n        <div class=\"game-container\">\n            <div class=\"game-header\">\n                <div class=\"game-title\">${getGameTitle(gameType)}</div>\n                <div class=\"close-game\" onclick=\"closeGame()\">×</div>\n            </div>\n            ${gameContent}\n        </div>\n    `;\n    \n    document.body.appendChild(gameOverlay);\n    setTimeout(() => gameOverlay.classList.add('show'), 10);\n    \n    // Initialize game\n    initializeGame(gameType);\n    \n    if (confetti) {\n        confetti({\n            particleCount: 100,\n            spread: 70,\n            origin: { y: 0.6 }\n        });\n    }\n}\n\n// ========================================\n// CLOSE GAME\n// ========================================\nexport function closeGame() {\n    const overlay = document.getElementById('gameOverlay');\n    if (overlay) {\n        overlay.classList.remove('show');\n        setTimeout(() => overlay.remove(), 500);\n    }\n    setStateValue('currentGame', null);\n}\n\n// ========================================\n// GAME CREATORS\n// ========================================\nfunction createNeverHaveIEverGame() {\n    return `\n        <div id=\"categorySelection\" style=\"display: block;\">\n            <h3 style=\"text-align: center; margin-bottom: 20px;\">Choose Your Vibe</h3>\n            <div style=\"display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;\">\n                <button class=\"btn btn-primary\" onclick=\"selectGameCategory('classic', 'neverHaveIEver')\">\n                    <i class=\"fas fa-beer\"></i> Classic\n                </button>\n                <button class=\"btn\" onclick=\"selectGameCategory('gettingStarted', 'neverHaveIEver')\">\n                    <i class=\"fas fa-play-circle\"></i> Getting Started\n                </button>\n                <button class=\"btn\" onclick=\"selectGameCategory('normal', 'neverHaveIEver')\">\n                    <i class=\"fas fa-dice\"></i> Normal\n                </button>\n                <button class=\"btn btn-danger\" onclick=\"selectGameCategory('spicy', 'neverHaveIEver')\">\n                    <i class=\"fas fa-fire\"></i> Spicy\n                </button>\n                <button class=\"btn\" style=\"background: linear-gradient(45deg, #ff0088, #ff4444);\" \n                    onclick=\"selectGameCategory('couples', 'neverHaveIEver')\">\n                    <i class=\"fas fa-heart\"></i> Couples\n                </button>\n            </div>\n        </div>\n        \n        <div id=\"playerSetup\" style=\"display: none;\">\n            <h3 style=\"text-align: center; margin-bottom: 20px;\">Add Players</h3>\n            <div style=\"display: flex; gap: 10px; margin-bottom: 20px;\">\n                <input type=\"text\" id=\"playerNameInput\" placeholder=\"Enter player name\" \n                    style=\"flex: 1; padding: 10px; background: rgba(255,255,255,0.1); \n                    border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white;\"\n                    onkeypress=\"if(event.key==='Enter') addPlayer()\">\n                <button class=\"btn btn-primary\" onclick=\"addPlayer()\">\n                    <i class=\"fas fa-plus\"></i> Add\n                </button>\n            </div>\n            <div id=\"playersList\" style=\"margin-bottom: 20px;\"></div>\n            <button class=\"btn btn-primary\" onclick=\"startNeverHaveIEver()\" \n                style=\"width: 100%; display: none;\" id=\"startGameBtn\">\n                <i class=\"fas fa-play\"></i> Start Game\n            </button>\n        </div>\n        \n        <div id=\"gamePlay\" style=\"display: none;\">\n            <div style=\"text-align: center; margin-bottom: 20px;\">\n                <span class=\"category-badge\" id=\"categoryBadge\">Classic</span>\n            </div>\n            <div class=\"question-card\" id=\"gameQuestion\">\n                Ready to start!\n            </div>\n            <div id=\"drinkingPlayers\" style=\"margin: 20px 0; text-align: center; min-height: 60px;\"></div>\n            <div style=\"text-align: center; margin: 30px 0;\">\n                <button class=\"btn btn-primary\" onclick=\"nextNeverHaveIEver()\">\n                    <i class=\"fas fa-arrow-right\"></i> Next Question\n                </button>\n                <button class=\"btn\" onclick=\"resetToPlayerSetup()\">\n                    <i class=\"fas fa-users\"></i> Change Players\n                </button>\n                <button class=\"btn\" onclick=\"changeCategoryMidGame('neverHaveIEver')\">\n                    <i class=\"fas fa-sync\"></i> Change Category\n                </button>\n            </div>\n            <div style=\"text-align: center; opacity: 0.7;\">\n                <p>Drink if you've done it! 🍻</p>\n            </div>\n        </div>\n        \n        <style>\n            .category-badge {\n                display: inline-block;\n                padding: 5px 15px;\n                background: linear-gradient(45deg, #00ff88, #00d4ff);\n                border-radius: 20px;\n                font-size: 0.9em;\n                font-weight: bold;\n                color: #000;\n                text-transform: uppercase;\n            }\n        </style>\n    `;\n}\n\nfunction createTruthOrDareGame() {\n    return `\n        <div id=\"playerSetup\" style=\"display: block;\">\n            <h3 style=\"text-align: center; margin-bottom: 20px;\">Add Players</h3>\n            <div style=\"display: flex; gap: 10px; margin-bottom: 20px;\">\n                <input type=\"text\" id=\"playerNameInput\" placeholder=\"Enter player name\" \n                    style=\"flex: 1; padding: 10px; background: rgba(255,255,255,0.1); \n                    border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white;\"\n                    onkeypress=\"if(event.key==='Enter') addPlayer()\">\n                <button class=\"btn btn-primary\" onclick=\"addPlayer()\">\n                    <i class=\"fas fa-plus\"></i> Add\n                </button>\n            </div>\n            <div id=\"playersList\" style=\"margin-bottom: 20px;\"></div>\n            <button class=\"btn btn-primary\" onclick=\"startTruthOrDare()\" \n                style=\"width: 100%; display: none;\" id=\"startGameBtn\">\n                <i class=\"fas fa-play\"></i> Start Game\n            </button>\n        </div>\n        \n        <div id=\"gamePlay\" style=\"display: none;\">\n            <div id=\"currentPlayer\" style=\"text-align: center; font-size: 2em; margin: 20px 0; color: #00ff88;\"></div>\n            <div style=\"text-align: center; margin: 30px 0;\">\n                <button class=\"btn btn-primary\" style=\"margin: 10px; width: 120px;\" onclick=\"showTruth()\">\n                    <i class=\"fas fa-comment\"></i> Truth\n                </button>\n                <button class=\"btn btn-danger\" style=\"margin: 10px; width: 120px;\" onclick=\"showDare()\">\n                    <i class=\"fas fa-fire\"></i> Dare\n                </button>\n            </div>\n            <div class=\"question-card\" id=\"gameQuestion\">\n                Choose Truth or Dare!\n            </div>\n            <div style=\"text-align: center; margin-top: 30px;\">\n                <button class=\"btn\" onclick=\"nextTurnTruthOrDare()\" style=\"display: none;\" id=\"nextTurnBtn\">\n                    <i class=\"fas fa-arrow-right\"></i> Next Player\n                </button>\n                <button class=\"btn\" onclick=\"resetToPlayerSetup()\">\n                    <i class=\"fas fa-users\"></i> Change Players\n                </button>\n            </div>\n        </div>\n    `;\n}\n\nfunction createKingsCupGame() {\n    return `\n        <div style=\"text-align: center;\">\n            <div style=\"font-size: 6em; margin: 20px 0;\" id=\"currentCard\">🎴</div>\n            <button class=\"btn btn-primary\" onclick=\"drawCard()\">\n                <i class=\"fas fa-clone\"></i> Draw Card\n            </button>\n        </div>\n        <div class=\"question-card\" id=\"gameQuestion\">\n            Click \"Draw Card\" to start!\n        </div>\n    `;\n}\n\nfunction createBeerPongGame() {\n    return `\n        <div style=\"text-align: center; margin-bottom: 20px;\">\n            <div style=\"display: inline-flex; background: rgba(255,255,255,0.1); border-radius: 30px; padding: 5px;\">\n                <button class=\"btn\" id=\"standardRulesBtn\" onclick=\"showBeerPongRules('standard')\" \n                    style=\"padding: 10px 20px; border-radius: 25px; margin: 0;\">\n                    📜 Standard Rules\n                </button>\n                <button class=\"btn\" id=\"creatorRulesBtn\" onclick=\"showBeerPongRules('creator')\" \n                    style=\"padding: 10px 20px; border-radius: 25px; margin: 0;\">\n                    🎯 Creator's Rules\n                </button>\n                <button class=\"btn btn-primary\" id=\"playGameBtn\" onclick=\"showBeerPongGame()\" \n                    style=\"padding: 10px 20px; border-radius: 25px; margin: 0;\">\n                    🏓 Play Game\n                </button>\n                <button class=\"btn\" id=\"tournamentBtn\" onclick=\"showBeerPongTournament()\" \n                    style=\"padding: 10px 20px; border-radius: 25px; margin: 0;\">\n                    🏆 Tournament\n                </button>\n            </div>\n        </div>\n        \n        <div id=\"beerPongRules\" style=\"display: none; max-height: 400px; overflow-y: auto; padding: 20px; \n            background: rgba(0,0,0,0.3); border-radius: 15px; margin-bottom: 20px;\">\n        </div>\n        \n        <div id=\"beerPongGame\" style=\"display: block;\">\n            <div id=\"gameModeSelection\" style=\"display: block;\">\n                <h3 style=\"text-align: center; margin-bottom: 20px;\">Choose Your Game Mode</h3>\n                <div style=\"display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;\">\n                    <button class=\"btn btn-primary\" onclick=\"startNormalBeerPong()\" \n                        style=\"padding: 20px 30px; font-size: 1.1em;\">\n                        <i class=\"fas fa-beer\"></i> Normal Beer Pong\n                    </button>\n                    <button class=\"btn btn-danger\" onclick=\"startSpecialBeerPong()\" \n                        style=\"padding: 20px 30px; font-size: 1.1em;\">\n                        <i class=\"fas fa-dice\"></i> Special Beer Pong\n                    </button>\n                </div>\n                <p style=\"text-align: center; margin-top: 20px; opacity: 0.7;\">\n                    Special mode: Each cup has a dare or rule!\n                </p>\n            </div>\n            \n            <div id=\"teamNameSetup\" style=\"display: none;\">\n                <h3 style=\"text-align: center; margin-bottom: 20px;\">Name Your Teams</h3>\n                <div style=\"display: flex; justify-content: center; gap: 30px; flex-wrap: wrap;\">\n                    <div>\n                        <label>Team 1:</label>\n                        <input type=\"text\" id=\"team1NameInput\" placeholder=\"Enter team name\" \n                            style=\"padding: 10px; background: rgba(255,255,255,0.1); \n                            border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; \n                            color: white; width: 200px; margin-left: 10px;\" value=\"Team 1\">\n                    </div>\n                    <div>\n                        <label>Team 2:</label>\n                        <input type=\"text\" id=\"team2NameInput\" placeholder=\"Enter team name\" \n                            style=\"padding: 10px; background: rgba(255,255,255,0.1); \n                            border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; \n                            color: white; width: 200px; margin-left: 10px;\" value=\"Team 2\">\n                    </div>\n                </div>\n                <div style=\"text-align: center; margin-top: 20px;\">\n                    <button class=\"btn btn-primary\" onclick=\"startGameWithNames()\" style=\"padding: 10px 30px;\">\n                        <i class=\"fas fa-play\"></i> Start Game\n                    </button>\n                </div>\n            </div>\n            \n            <div id=\"normalGamePlay\" style=\"display: none;\">\n                <div class=\"score-display\">\n                    <div class=\"team-score\">\n                        <div class=\"team-name\" id=\"team1Display\">Team 1</div>\n                        <div class=\"team-points\" id=\"team1Score\">0</div>\n                        <button class=\"btn\" onclick=\"addScore('team1')\">+1</button>\n                    </div>\n                    <div class=\"team-score\">\n                        <div class=\"team-name\" id=\"team2Display\">Team 2</div>\n                        <div class=\"team-points\" id=\"team2Score\">0</div>\n                        <button class=\"btn\" onclick=\"addScore('team2')\">+1</button>\n                    </div>\n                </div>\n                <div style=\"text-align: center; margin: 30px 0;\">\n                    <button class=\"btn btn-primary\" onclick=\"resetBeerPong()\">\n                        <i class=\"fas fa-redo\"></i> New Game\n                    </button>\n                </div>\n                <div id=\"gameStatus\" style=\"text-align: center; font-size: 1.5em; margin-top: 20px;\"></div>\n            </div>\n            \n            <div id=\"specialGamePlay\" style=\"display: none;\">\n                <h3 style=\"text-align: center; margin-bottom: 20px;\">\n                    <span id=\"specialTeam1Name\">Team 1</span> vs <span id=\"specialTeam2Name\">Team 2</span>\n                </h3>\n                <div style=\"display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 40px;\">\n                    <div id=\"team1Cups\" style=\"text-align: center;\">\n                        <h4 id=\"specialTeam1Display\">Team 1</h4>\n                        <div class=\"cup-formation\" style=\"margin-top: 20px;\">\n                        </div>\n                    </div>\n                    <div style=\"text-align: center;\">\n                        <div style=\"font-size: 3em;\">🏓</div>\n                        <button class=\"btn btn-primary\" onclick=\"resetSpecialGame()\" style=\"margin-top: 20px;\">\n                            <i class=\"fas fa-redo\"></i> Reset\n                        </button>\n                    </div>\n                    <div id=\"team2Cups\" style=\"text-align: center;\">\n                        <h4 id=\"specialTeam2Display\">Team 2</h4>\n                        <div class=\"cup-formation\" style=\"margin-top: 20px;\">\n                        </div>\n                    </div>\n                </div>\n                <div id=\"ruleDisplay\" style=\"display: none; margin-top: 30px; text-align: center; \n                    padding: 20px; background: rgba(255,255,255,0.1); border-radius: 15px;\">\n                </div>\n            </div>\n        </div>\n        \n        <div id=\"beerPongTournament\" style=\"display: none;\">\n            <div id=\"tournamentSetup\" style=\"display: block;\">\n                <h3 style=\"text-align: center; margin-bottom: 20px;\">🏆 Tournament Setup</h3>\n                <div style=\"text-align: center; margin-bottom: 30px;\">\n                    <p style=\"margin-bottom: 15px;\">Select number of teams:</p>\n                    <div style=\"display: flex; justify-content: center; gap: 20px;\">\n                        <button class=\"btn btn-primary\" onclick=\"setupTournament(4)\" style=\"padding: 15px 30px;\">\n                            4 Teams\n                        </button>\n                        <button class=\"btn btn-primary\" onclick=\"setupTournament(8)\" style=\"padding: 15px 30px;\">\n                            8 Teams\n                        </button>\n                        <button class=\"btn btn-primary\" onclick=\"setupTournament(16)\" style=\"padding: 15px 30px;\">\n                            16 Teams\n                        </button>\n                    </div>\n                </div>\n            </div>\n            \n            <div id=\"teamNaming\" style=\"display: none;\">\n                <h3 style=\"text-align: center; margin-bottom: 20px;\">Name Your Teams</h3>\n                <div id=\"teamInputs\" style=\"max-height: 400px; overflow-y: auto; padding: 20px;\">\n                </div>\n                <div style=\"text-align: center; margin-top: 20px;\">\n                    <button class=\"btn btn-primary\" onclick=\"startTournament()\" style=\"padding: 10px 30px;\">\n                        <i class=\"fas fa-trophy\"></i> Start Tournament\n                    </button>\n                </div>\n            </div>\n            \n            <div id=\"tournamentBracket\" style=\"display: none;\">\n                <h3 style=\"text-align: center; margin-bottom: 20px;\">\n                    <span id=\"tournamentRoundTitle\">Tournament Bracket</span>\n                </h3>\n                <div id=\"bracketDisplay\" style=\"overflow-x: auto; padding: 20px;\">\n                </div>\n                <div style=\"text-align: center; margin-top: 20px;\">\n                    <button class=\"btn\" onclick=\"resetTournament()\" style=\"padding: 10px 20px;\">\n                        <i class=\"fas fa-redo\"></i> New Tournament\n                    </button>\n                </div>\n            </div>\n        </div>\n    `;\n}\n\nfunction createFlipCupGame() {\n    return `\n        <div class=\"timer-display\" id=\"flipTimer\">00:00</div>\n        <div style=\"text-align: center; margin: 30px 0;\">\n            <button class=\"btn btn-primary\" id=\"timerBtn\" onclick=\"toggleFlipTimer()\">\n                <i class=\"fas fa-play\"></i> Start Timer\n            </button>\n            <button class=\"btn\" onclick=\"resetFlipTimer()\">\n                <i class=\"fas fa-redo\"></i> Reset\n            </button>\n        </div>\n        <div id=\"bestTime\" style=\"text-align: center; font-size: 1.2em; margin-top: 20px;\">\n            Best Time: --:--\n        </div>\n    `;\n}\n\nfunction createTriviaGame() {\n    return `\n        <div class=\"question-card\" id=\"gameQuestion\">\n            Click \"Next Question\" to start HSG Trivia!\n        </div>\n        <div id=\"triviaOptions\" style=\"margin: 20px 0;\"></div>\n        <div style=\"text-align: center; margin: 30px 0;\">\n            <button class=\"btn btn-primary\" onclick=\"nextTrivia()\">\n                <i class=\"fas fa-arrow-right\"></i> Next Question\n            </button>\n        </div>\n        <div class=\"score-display\">\n            <div class=\"team-score\">\n                <div class=\"team-name\">Score</div>\n                <div class=\"team-points\" id=\"triviaScore\">0</div>\n            </div>\n        </div>\n    `;\n}\n\nfunction createWouldYouRatherGame() {\n    return `\n        <div id=\"playerSetup\" style=\"display: block;\">\n            <h3 style=\"text-align: center; margin-bottom: 20px;\">Add Players</h3>\n            <div style=\"display: flex; gap: 10px; margin-bottom: 20px;\">\n                <input type=\"text\" id=\"playerNameInput\" placeholder=\"Enter player name\" \n                    style=\"flex: 1; padding: 10px; background: rgba(255,255,255,0.1); \n                    border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white;\"\n                    onkeypress=\"if(event.key==='Enter') addPlayer()\">\n                <button class=\"btn btn-primary\" onclick=\"addPlayer()\">\n                    <i class=\"fas fa-plus\"></i> Add\n                </button>\n            </div>\n            <div id=\"playersList\" style=\"margin-bottom: 20px;\"></div>\n            <button class=\"btn btn-primary\" onclick=\"startWouldYouRather()\" \n                style=\"width: 100%; display: none;\" id=\"startGameBtn\">\n                <i class=\"fas fa-play\"></i> Start Game\n            </button>\n        </div>\n        \n        <div id=\"gamePlay\" style=\"display: none;\">\n            <div class=\"question-card\" id=\"gameQuestion\">\n                Ready to start!\n            </div>\n            <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0;\">\n                <button class=\"btn btn-primary\" id=\"option1Btn\" onclick=\"voteWouldYouRather(0)\" style=\"padding: 20px;\">\n                    Option 1\n                </button>\n                <button class=\"btn btn-danger\" id=\"option2Btn\" onclick=\"voteWouldYouRather(1)\" style=\"padding: 20px;\">\n                    Option 2\n                </button>\n            </div>\n            <div id=\"voteResults\" style=\"display: none; margin: 20px 0;\"></div>\n            <button class=\"btn\" onclick=\"nextWouldYouRather()\" style=\"display: none;\" id=\"nextQuestionBtn\">\n                <i class=\"fas fa-arrow-right\"></i> Next Question\n            </button>\n        </div>\n    `;\n}\n\nfunction createMostLikelyToGame() {\n    return `\n        <div id=\"playerSetup\" style=\"display: block;\">\n            <h3 style=\"text-align: center; margin-bottom: 20px;\">Add Players</h3>\n            <div style=\"display: flex; gap: 10px; margin-bottom: 20px;\">\n                <input type=\"text\" id=\"playerNameInput\" placeholder=\"Enter player name\" \n                    style=\"flex: 1; padding: 10px; background: rgba(255,255,255,0.1); \n                    border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white;\"\n                    onkeypress=\"if(event.key==='Enter') addPlayer()\">\n                <button class=\"btn btn-primary\" onclick=\"addPlayer()\">\n                    <i class=\"fas fa-plus\"></i> Add\n                </button>\n            </div>\n            <div id=\"playersList\" style=\"margin-bottom: 20px;\"></div>\n            <button class=\"btn btn-primary\" onclick=\"startMostLikelyTo()\" \n                style=\"width: 100%; display: none;\" id=\"startGameBtn\">\n                <i class=\"fas fa-play\"></i> Start Game\n            </button>\n        </div>\n        \n        <div id=\"gamePlay\" style=\"display: none;\">\n            <div class=\"question-card\" id=\"gameQuestion\">\n                Ready to start!\n            </div>\n            <div style=\"text-align: center; margin: 30px 0;\">\n                <h3>Count to 3, then everyone point!</h3>\n                <button class=\"btn btn-primary\" onclick=\"showVotes()\">\n                    <i class=\"fas fa-eye\"></i> Show Who Got Most Votes\n                </button>\n                <button class=\"btn\" onclick=\"nextMostLikelyTo()\">\n                    <i class=\"fas fa-arrow-right\"></i> Next Question\n                </button>\n            </div>\n            <div id=\"votingPlayers\" style=\"margin: 20px 0;\"></div>\n        </div>\n    `;\n}\n\nfunction createSpinBottleGame() {\n    return `\n        <div id=\"playerSetup\" style=\"display: block;\">\n            <h3 style=\"text-align: center; margin-bottom: 20px;\">Add Players</h3>\n            <div style=\"display: flex; gap: 10px; margin-bottom: 20px;\">\n                <input type=\"text\" id=\"playerNameInput\" placeholder=\"Enter player name\" \n                    style=\"flex: 1; padding: 10px; background: rgba(255,255,255,0.1); \n                    border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white;\"\n                    onkeypress=\"if(event.key==='Enter') addPlayer()\">\n                <button class=\"btn btn-primary\" onclick=\"addPlayer()\">\n                    <i class=\"fas fa-plus\"></i> Add\n                </button>\n            </div>\n            <div id=\"playersList\" style=\"margin-bottom: 20px;\"></div>\n            <button class=\"btn btn-primary\" onclick=\"startSpinBottle()\" \n                style=\"width: 100%; display: none;\" id=\"startGameBtn\">\n                <i class=\"fas fa-play\"></i> Start Game\n            </button>\n        </div>\n        \n        <div id=\"gamePlay\" style=\"display: none;\">\n            <div style=\"text-align: center;\">\n                <div id=\"bottleContainer\" style=\"font-size: 6em; margin: 20px 0; position: relative;\">\n                    🍾\n                </div>\n                <button class=\"btn btn-primary\" onclick=\"spinBottle()\">\n                    <i class=\"fas fa-sync\"></i> Spin the Bottle\n                </button>\n            </div>\n            <div id=\"spinResult\" style=\"margin: 30px 0; text-align: center;\"></div>\n            <div class=\"question-card\" id=\"gameTask\" style=\"display: none;\">\n                Task will appear here\n            </div>\n        </div>\n    `;\n}\n\n// ========================================\n// GAME LOGIC\n// ========================================\nfunction initializeGame(gameType) {\n    switch(gameType) {\n        case 'beer-pong':\n            setStateValue('gameScores', { team1: 0, team2: 0 });\n            updateBeerPongScore();\n            break;\n        case 'trivia':\n            gameState.triviaScore = 0;\n            gameState.currentTriviaIndex = 0;\n            document.getElementById('triviaScore').textContent = '0';\n            break;\n    }\n}\n\n// ========================================\n// CATEGORY SELECTION\n// ========================================\nexport function selectGameCategory(category, gameType) {\n    gameState.selectedCategory = category;\n    \n    // Update UI to show next step\n    document.getElementById('categorySelection').style.display = 'none';\n    \n    if (gameType === 'truthOrDare' || gameType === 'specialBeerPong') {\n        // These games don't need player setup\n        document.getElementById('gamePlay').style.display = 'block';\n        updateCategoryBadge();\n    } else {\n        // Show player setup for other games\n        document.getElementById('playerSetup').style.display = 'block';\n    }\n}\n\nexport function changeCategoryMidGame(gameType) {\n    // Hide game play, show category selection\n    document.getElementById('gamePlay').style.display = 'none';\n    document.getElementById('categorySelection').style.display = 'block';\n}\n\nfunction updateCategoryBadge() {\n    const badge = document.getElementById('categoryBadge');\n    if (badge) {\n        const categoryNames = {\n            classic: 'Classic',\n            gettingStarted: 'Getting Started',\n            normal: 'Normal',\n            spicy: 'Spicy 🔥',\n            couples: 'Couples 💕'\n        };\n        badge.textContent = categoryNames[gameState.selectedCategory] || 'Classic';\n        \n        // Update badge color based on category\n        const categoryColors = {\n            classic: 'linear-gradient(45deg, #00ff88, #00d4ff)',\n            gettingStarted: 'linear-gradient(45deg, #4CAF50, #8BC34A)',\n            normal: 'linear-gradient(45deg, #2196F3, #03A9F4)',\n            spicy: 'linear-gradient(45deg, #ff0088, #ff4444)',\n            couples: 'linear-gradient(45deg, #E91E63, #FF4081)'\n        };\n        badge.style.background = categoryColors[gameState.selectedCategory] || categoryColors.classic;\n    }\n}\n\n// Never Have I Ever\nexport function nextNeverHaveIEver() {\n    const questions = gameData.neverHaveIEver[gameState.selectedCategory] || gameData.neverHaveIEver.classic;\n    const random = Math.floor(Math.random() * questions.length);\n    document.getElementById('gameQuestion').textContent = questions[random];\n}\n\n// Truth or Dare functions are defined later with player management\n\nfunction selectRandomPlayer() {\n    const partyData = getAppState().partyData || {};\n    const players = Object.values(partyData).map(p => p.name);\n    if (players.length === 0) players.push('You');\n    const random = Math.floor(Math.random() * players.length);\n    const player = players[random];\n    document.getElementById('playerName').textContent = `${player}'s turn!`;\n}\n\n// King's Cup\nexport function drawCard() {\n    const cards = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];\n    const suits = ['♠️', '♥️', '♦️', '♣️'];\n    const randomCard = cards[Math.floor(Math.random() * cards.length)];\n    const randomSuit = suits[Math.floor(Math.random() * suits.length)];\n    \n    document.getElementById('currentCard').textContent = randomCard + randomSuit;\n    \n    const rules = {\n        'A': '🍉 Waterfall - Everyone drinks!',\n        '2': '👉 You - Choose someone to drink',\n        '3': '👈 Me - You drink!',\n        '4': '👯 Floor - Last to touch floor drinks',\n        '5': '🙋 Guys - All guys drink',\n        '6': '💃 Chicks - All girls drink',\n        '7': '🌈 Heaven - Last to raise hand drinks',\n        '8': '🤝 Mate - Choose a drinking buddy',\n        '9': '🎵 Rhyme - Say a word, others rhyme',\n        '10': '📏 Categories - Name things in category',\n        'J': '👑 Make a Rule',\n        'Q': '❓ Questions - Ask questions only',\n        'K': '🏆 King\\'s Cup - Pour into center cup'\n    };\n    \n    document.getElementById('gameQuestion').textContent = rules[randomCard];\n}\n\n// Beer Pong\nexport function addScore(team) {\n    let gameScores = getAppState().gameScores || { team1: 0, team2: 0 };\n    gameScores[team]++;\n    setStateValue('gameScores', gameScores);\n    updateBeerPongScore();\n    \n    if (gameScores[team] >= 10) {\n        document.getElementById('gameStatus').textContent = `${team === 'team1' ? 'Team 1' : 'Team 2'} Wins! 🏆`;\n        if (confetti) {\n            confetti({\n                particleCount: 200,\n                spread: 70,\n                origin: { y: 0.6 }\n            });\n        }\n    }\n}\n\nfunction updateBeerPongScore() {\n    const gameScores = getAppState().gameScores || { team1: 0, team2: 0 };\n    document.getElementById('team1Score').textContent = gameScores.team1;\n    document.getElementById('team2Score').textContent = gameScores.team2;\n}\n\nexport function resetBeerPong() {\n    setStateValue('gameScores', { team1: 0, team2: 0 });\n    updateBeerPongScore();\n    document.getElementById('gameStatus').textContent = '';\n    \n    // Reset to mode selection\n    showBeerPongGame();\n}\n\n// Flip Cup\nexport function toggleFlipTimer() {\n    const btn = document.getElementById('timerBtn');\n    \n    if (gameState.flipTimer) {\n        clearInterval(gameState.flipTimer);\n        gameState.flipTimer = null;\n        btn.innerHTML = '<i class=\"fas fa-play\"></i> Start Timer';\n        \n        if (!gameState.bestFlipTime || gameState.flipTime < gameState.bestFlipTime) {\n            gameState.bestFlipTime = gameState.flipTime;\n            document.getElementById('bestTime').textContent = `Best Time: ${formatTime(gameState.bestFlipTime)}`;\n            if (confetti) {\n                confetti({\n                    particleCount: 100,\n                    spread: 70,\n                    origin: { y: 0.6 }\n                });\n            }\n        }\n    } else {\n        gameState.flipTime = 0;\n        gameState.flipTimer = setInterval(() => {\n            gameState.flipTime++;\n            document.getElementById('flipTimer').textContent = formatTime(gameState.flipTime);\n        }, 10);\n        btn.innerHTML = '<i class=\"fas fa-pause\"></i> Stop Timer';\n    }\n}\n\nexport function resetFlipTimer() {\n    if (gameState.flipTimer) {\n        clearInterval(gameState.flipTimer);\n        gameState.flipTimer = null;\n    }\n    gameState.flipTime = 0;\n    document.getElementById('flipTimer').textContent = '00:00';\n    document.getElementById('timerBtn').innerHTML = '<i class=\"fas fa-play\"></i> Start Timer';\n}\n\nfunction formatTime(centiseconds) {\n    const minutes = Math.floor(centiseconds / 6000);\n    const seconds = Math.floor((centiseconds % 6000) / 100);\n    const cs = centiseconds % 100;\n    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${cs.toString().padStart(2, '0')}`;\n}\n\n// Trivia\nexport function nextTrivia() {\n    const trivia = gameData.trivia;\n    const current = trivia[gameState.currentTriviaIndex % trivia.length];\n    \n    document.getElementById('gameQuestion').textContent = current.question;\n    \n    const optionsHtml = current.options.map((option, index) => \n        `<button class=\"btn\" style=\"width: 100%; margin: 10px 0;\" onclick=\"answerTrivia(${index}, ${current.correct})\">${option}</button>`\n    ).join('');\n    \n    document.getElementById('triviaOptions').innerHTML = optionsHtml;\n    gameState.currentTriviaIndex++;\n}\n\nexport function answerTrivia(selected, correct) {\n    const buttons = document.getElementById('triviaOptions').querySelectorAll('button');\n    \n    if (selected === correct) {\n        gameState.triviaScore++;\n        document.getElementById('triviaScore').textContent = gameState.triviaScore;\n        buttons[selected].style.background = 'linear-gradient(45deg, #00ff88, #00d4ff)';\n        showNotification('✅ Correct! +1 point');\n    } else {\n        buttons[selected].style.background = 'linear-gradient(45deg, #ff4444, #ff0088)';\n        buttons[correct].style.background = 'linear-gradient(45deg, #00ff88, #00d4ff)';\n        showNotification('❌ Wrong answer!');\n    }\n    \n    // Disable all buttons\n    buttons.forEach(btn => btn.disabled = true);\n    \n    // Auto next question after 2 seconds\n    setTimeout(nextTrivia, 2000);\n}\n\nfunction getGameTitle(gameType) {\n    const titles = {\n        'never-have-i-ever': '🙊 Never Have I Ever',\n        'truth-or-dare': '🎯 Truth or Dare',\n        'kings-cup': '👑 King\\'s Cup',\n        'beer-pong': '🏓 Beer Pong',\n        'flip-cup': '🥤 Flip Cup',\n        'trivia': '🧠 HSG Trivia',\n        'would-you-rather': '🤔 Would You Rather',\n        'most-likely-to': '👉 Most Likely To',\n        'spin-the-bottle': '🍾 Spin the Bottle'\n    };\n    return titles[gameType] || 'Party Game';\n}\n\n// ========================================\n// PLAYER MANAGEMENT\n// ========================================\nexport function addPlayer() {\n    const input = document.getElementById('playerNameInput');\n    const name = input.value.trim();\n    \n    if (!name) {\n        showNotification('Please enter a player name', 'error');\n        return;\n    }\n    \n    if (gamePlayers.find(p => p.name.toLowerCase() === name.toLowerCase())) {\n        showNotification('Player already added', 'error');\n        return;\n    }\n    \n    gamePlayers.push({\n        name: name,\n        drinks: 0,\n        score: 0\n    });\n    \n    input.value = '';\n    updatePlayersList();\n    \n    if (gamePlayers.length >= 2) {\n        document.getElementById('startGameBtn').style.display = 'block';\n    }\n}\n\nexport function removePlayer(index) {\n    gamePlayers.splice(index, 1);\n    updatePlayersList();\n    \n    if (gamePlayers.length < 2) {\n        document.getElementById('startGameBtn').style.display = 'none';\n    }\n}\n\nfunction updatePlayersList() {\n    const list = document.getElementById('playersList');\n    if (!list) return;\n    \n    list.innerHTML = gamePlayers.map((player, index) => `\n        <div style=\"display: flex; align-items: center; justify-content: space-between; \n            padding: 10px; margin: 5px 0; background: rgba(255,255,255,0.1); \n            border-radius: 10px;\">\n            <span>${player.name}</span>\n            <button class=\"btn btn-danger\" onclick=\"removePlayer(${index})\" \n                style=\"padding: 5px 10px; font-size: 0.9em;\">\n                <i class=\"fas fa-times\"></i>\n            </button>\n        </div>\n    `).join('');\n}\n\nexport function resetToPlayerSetup() {\n    document.getElementById('playerSetup').style.display = 'block';\n    document.getElementById('gamePlay').style.display = 'none';\n    currentPlayerIndex = 0;\n}\n\n// Never Have I Ever functions\nexport function startNeverHaveIEver() {\n    if (gamePlayers.length < 2) {\n        showNotification('Add at least 2 players', 'error');\n        return;\n    }\n    \n    document.getElementById('playerSetup').style.display = 'none';\n    document.getElementById('gamePlay').style.display = 'block';\n    updateCategoryBadge();\n    gameHistory = [];\n}\n\n// Truth or Dare functions\nexport function startTruthOrDare() {\n    if (gamePlayers.length < 2) {\n        showNotification('Add at least 2 players', 'error');\n        return;\n    }\n    \n    document.getElementById('playerSetup').style.display = 'none';\n    document.getElementById('gamePlay').style.display = 'block';\n    currentPlayerIndex = 0;\n    updateCurrentPlayer();\n}\n\nfunction updateCurrentPlayer() {\n    const currentPlayer = gamePlayers[currentPlayerIndex];\n    document.getElementById('currentPlayer').textContent = `${currentPlayer.name}'s Turn`;\n}\n\nexport function nextTurnTruthOrDare() {\n    currentPlayerIndex = (currentPlayerIndex + 1) % gamePlayers.length;\n    updateCurrentPlayer();\n    document.getElementById('gameQuestion').textContent = 'Choose Truth or Dare!';\n    document.getElementById('nextTurnBtn').style.display = 'none';\n}\n\n// Update existing functions to show next turn button\nexport function showTruth() {\n    const truths = gameData.truths[gameState.selectedCategory] || gameData.truths.classic;\n    const truth = truths[Math.floor(Math.random() * truths.length)];\n    document.getElementById('gameQuestion').textContent = truth;\n    document.getElementById('nextTurnBtn').style.display = 'inline-block';\n}\n\nexport function showDare() {\n    const dares = gameData.dares[gameState.selectedCategory] || gameData.dares.classic;\n    const dare = dares[Math.floor(Math.random() * dares.length)];\n    document.getElementById('gameQuestion').textContent = dare;\n    document.getElementById('nextTurnBtn').style.display = 'inline-block';\n}\n\n// Would You Rather functions\nexport function startWouldYouRather() {\n    if (gamePlayers.length < 2) {\n        showNotification('Add at least 2 players', 'error');\n        return;\n    }\n    \n    document.getElementById('playerSetup').style.display = 'none';\n    document.getElementById('gamePlay').style.display = 'block';\n    gameHistory = [];\n    nextWouldYouRather();\n}\n\nlet currentWouldYouRatherVotes = { 0: [], 1: [] };\n\nexport function nextWouldYouRather() {\n    const questions = gameData.wouldYouRather[gameState.selectedCategory] || gameData.wouldYouRather.classic;\n    const question = questions[Math.floor(Math.random() * questions.length)];\n    \n    // Split the question\n    const parts = question.split(' or ');\n    const option1 = parts[0].replace('Would you rather ', '');\n    const option2 = parts[1] || parts[0];\n    \n    document.getElementById('gameQuestion').textContent = question;\n    document.getElementById('option1Btn').textContent = option1;\n    document.getElementById('option2Btn').textContent = option2;\n    \n    // Reset votes\n    currentWouldYouRatherVotes = { 0: [], 1: [] };\n    document.getElementById('voteResults').style.display = 'none';\n    document.getElementById('nextQuestionBtn').style.display = 'none';\n    \n    // Enable voting buttons\n    document.getElementById('option1Btn').disabled = false;\n    document.getElementById('option2Btn').disabled = false;\n}\n\nexport function voteWouldYouRather(option) {\n    // In a real multiplayer game, each player would vote\n    // For now, show results after one vote\n    document.getElementById('option1Btn').disabled = true;\n    document.getElementById('option2Btn').disabled = true;\n    \n    // Show results\n    const resultsDiv = document.getElementById('voteResults');\n    resultsDiv.innerHTML = `\n        <h3>Minority drinks! 🍺</h3>\n        <p>In a real game, everyone votes and the minority drinks!</p>\n    `;\n    resultsDiv.style.display = 'block';\n    document.getElementById('nextQuestionBtn').style.display = 'inline-block';\n}\n\n// Most Likely To functions\nexport function startMostLikelyTo() {\n    if (gamePlayers.length < 3) {\n        showNotification('Add at least 3 players', 'error');\n        return;\n    }\n    \n    document.getElementById('playerSetup').style.display = 'none';\n    document.getElementById('gamePlay').style.display = 'block';\n    nextMostLikelyTo();\n}\n\nexport function nextMostLikelyTo() {\n    const questions = gameData.mostLikelyTo[gameState.selectedCategory] || gameData.mostLikelyTo.classic;\n    const question = questions[Math.floor(Math.random() * questions.length)];\n    \n    document.getElementById('gameQuestion').textContent = question;\n    \n    // Show all players as voting options\n    const votingDiv = document.getElementById('votingPlayers');\n    votingDiv.innerHTML = `\n        <h4>Players in the game:</h4>\n        <div style=\"display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;\">\n            ${gamePlayers.map(p => `\n                <div style=\"padding: 10px; background: rgba(255,255,255,0.1); \n                    border-radius: 10px; text-align: center;\">\n                    ${p.name}\n                </div>\n            `).join('')}\n        </div>\n    `;\n}\n\nexport function showVotes() {\n    showNotification('Person with most votes drinks! 🍻', 'info');\n}\n\n// Spin the Bottle functions\nexport function startSpinBottle() {\n    if (gamePlayers.length < 3) {\n        showNotification('Add at least 3 players', 'error');\n        return;\n    }\n    \n    document.getElementById('playerSetup').style.display = 'none';\n    document.getElementById('gamePlay').style.display = 'block';\n    currentPlayerIndex = 0;\n}\n\nexport function spinBottle() {\n    const bottle = document.getElementById('bottleContainer');\n    const spinner = gamePlayers[currentPlayerIndex];\n    const otherPlayers = gamePlayers.filter((_, i) => i !== currentPlayerIndex);\n    const target = otherPlayers[Math.floor(Math.random() * otherPlayers.length)];\n    \n    // Animate bottle spin\n    bottle.style.transition = 'transform 2s ease-out';\n    bottle.style.transform = `rotate(${720 + Math.random() * 360}deg)`;\n    \n    setTimeout(() => {\n        // Show result\n        document.getElementById('spinResult').innerHTML = `\n            <h3>${spinner.name} → ${target.name}</h3>\n        `;\n        \n        // Show random task\n        const tasks = gameData.spinBottleTasks[gameState.selectedCategory] || gameData.spinBottleTasks.classic;\n        const task = tasks[Math.floor(Math.random() * tasks.length)];\n        \n        document.getElementById('gameTask').textContent = task;\n        document.getElementById('gameTask').style.display = 'block';\n        \n        // Next player's turn\n        currentPlayerIndex = (currentPlayerIndex + 1) % gamePlayers.length;\n        \n        // Reset bottle\n        setTimeout(() => {\n            bottle.style.transition = 'none';\n            bottle.style.transform = 'rotate(0deg)';\n        }, 100);\n    }, 2000);\n}\n\n// ========================================\n// BEER PONG RULES FUNCTIONS\n// ========================================\nexport function showBeerPongRules(type) {\n    const rulesDiv = document.getElementById('beerPongRules');\n    const gameDiv = document.getElementById('beerPongGame');\n    const tournamentDiv = document.getElementById('beerPongTournament');\n    const rules = gameData.beerPongRules[type];\n    \n    // Update button styles\n    document.getElementById('standardRulesBtn').classList.remove('btn-primary');\n    document.getElementById('creatorRulesBtn').classList.remove('btn-primary');\n    document.getElementById('playGameBtn').classList.remove('btn-primary');\n    document.getElementById('tournamentBtn').classList.remove('btn-primary');\n    \n    document.getElementById(`${type}RulesBtn`).classList.add('btn-primary');\n    \n    // Hide others, show rules\n    gameDiv.style.display = 'none';\n    tournamentDiv.style.display = 'none';\n    rulesDiv.style.display = 'block';\n    \n    // Display rules with fun animations\n    rulesDiv.innerHTML = `\n        <h2 style=\"text-align: center; margin-bottom: 10px;\">${rules.title}</h2>\n        <p style=\"text-align: center; opacity: 0.8; margin-bottom: 20px;\">${rules.description}</p>\n        <div style=\"display: grid; gap: 15px;\">\n            ${rules.rules.map((rule, index) => `\n                <div class=\"rule-item\" style=\"background: rgba(255,255,255,0.05); padding: 15px; \n                    border-radius: 10px; border-left: 3px solid ${type === 'creator' ? '#00ff88' : '#00d4ff'};\n                    animation: slideIn 0.3s ease-out ${index * 0.05}s both;\">\n                    <div style=\"font-weight: bold; font-size: 1.1em; margin-bottom: 5px;\">\n                        ${rule.name}\n                    </div>\n                    <div style=\"opacity: 0.9; line-height: 1.4;\">\n                        ${rule.desc}\n                    </div>\n                </div>\n            `).join('')}\n        </div>\n        <style>\n            @keyframes slideIn {\n                from {\n                    opacity: 0;\n                    transform: translateX(-20px);\n                }\n                to {\n                    opacity: 1;\n                    transform: translateX(0);\n                }\n            }\n        </style>\n    `;\n    \n    if (confetti && type === 'creator') {\n        confetti({\n            particleCount: 50,\n            spread: 60,\n            origin: { y: 0.2 },\n            colors: ['#00ff88', '#00d4ff', '#ff0088']\n        });\n    }\n}\n\nexport function showBeerPongGame() {\n    const rulesDiv = document.getElementById('beerPongRules');\n    const gameDiv = document.getElementById('beerPongGame');\n    const tournamentDiv = document.getElementById('beerPongTournament');\n    \n    // Update button styles\n    document.getElementById('standardRulesBtn').classList.remove('btn-primary');\n    document.getElementById('creatorRulesBtn').classList.remove('btn-primary');\n    document.getElementById('playGameBtn').classList.add('btn-primary');\n    document.getElementById('tournamentBtn').classList.remove('btn-primary');\n    \n    // Hide others, show game\n    rulesDiv.style.display = 'none';\n    tournamentDiv.style.display = 'none';\n    gameDiv.style.display = 'block';\n    \n    // Reset to mode selection\n    document.getElementById('gameModeSelection').style.display = 'block';\n    document.getElementById('teamNameSetup').style.display = 'none';\n    document.getElementById('normalGamePlay').style.display = 'none';\n    document.getElementById('specialGamePlay').style.display = 'none';\n}\n\n// ========================================\n// BEER PONG TOURNAMENT FUNCTIONS\n// ========================================\nexport function showBeerPongTournament() {\n    const rulesDiv = document.getElementById('beerPongRules');\n    const gameDiv = document.getElementById('beerPongGame');\n    const tournamentDiv = document.getElementById('beerPongTournament');\n    \n    // Update button styles\n    document.getElementById('standardRulesBtn').classList.remove('btn-primary');\n    document.getElementById('creatorRulesBtn').classList.remove('btn-primary');\n    document.getElementById('playGameBtn').classList.remove('btn-primary');\n    document.getElementById('tournamentBtn').classList.add('btn-primary');\n    \n    // Hide others, show tournament\n    rulesDiv.style.display = 'none';\n    gameDiv.style.display = 'none';\n    tournamentDiv.style.display = 'block';\n    \n    // Reset to setup screen\n    document.getElementById('tournamentSetup').style.display = 'block';\n    document.getElementById('teamNaming').style.display = 'none';\n    document.getElementById('tournamentBracket').style.display = 'none';\n}\n\nexport function setupTournament(numTeams) {\n    gameState.tournament.totalTeams = numTeams;\n    gameState.tournament.teams = [];\n    gameState.tournament.bracket = [];\n    gameState.tournament.currentRound = 0;\n    \n    // Show team naming screen\n    document.getElementById('tournamentSetup').style.display = 'none';\n    document.getElementById('teamNaming').style.display = 'block';\n    \n    // Create team input fields\n    const teamInputsDiv = document.getElementById('teamInputs');\n    teamInputsDiv.innerHTML = '';\n    \n    for (let i = 1; i <= numTeams; i++) {\n        teamInputsDiv.innerHTML += `\n            <div style=\"margin-bottom: 15px;\">\n                <label style=\"display: inline-block; width: 100px;\">Team ${i}:</label>\n                <input type=\"text\" id=\"team${i}Name\" placeholder=\"Enter team name\" \n                    style=\"padding: 10px; background: rgba(255,255,255,0.1); \n                    border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; \n                    color: white; width: 250px;\" value=\"Team ${i}\">\n            </div>\n        `;\n    }\n    \n    if (confetti) {\n        confetti({\n            particleCount: 100,\n            spread: 70,\n            origin: { y: 0.6 },\n            colors: ['#FFD700', '#FFA500', '#FF6347']\n        });\n    }\n}\n\nexport function startTournament() {\n    const numTeams = gameState.tournament.totalTeams;\n    gameState.tournament.teams = [];\n    \n    // Collect team names\n    for (let i = 1; i <= numTeams; i++) {\n        const teamName = document.getElementById(`team${i}Name`).value.trim() || `Team ${i}`;\n        gameState.tournament.teams.push({\n            id: i,\n            name: teamName,\n            eliminated: false\n        });\n    }\n    \n    // Create initial bracket\n    createTournamentBracket();\n    \n    // Show bracket screen\n    document.getElementById('teamNaming').style.display = 'none';\n    document.getElementById('tournamentBracket').style.display = 'block';\n    \n    // Display the bracket\n    displayTournamentBracket();\n}\n\nfunction createTournamentBracket() {\n    const teams = [...gameState.tournament.teams];\n    const rounds = [];\n    let currentRoundMatches = [];\n    \n    // Create first round matches\n    for (let i = 0; i < teams.length; i += 2) {\n        currentRoundMatches.push({\n            team1: teams[i],\n            team2: teams[i + 1],\n            winner: null,\n            matchId: `R1M${Math.floor(i/2) + 1}`\n        });\n    }\n    rounds.push(currentRoundMatches);\n    \n    // Calculate subsequent rounds\n    let roundNumber = 2;\n    while (currentRoundMatches.length > 1) {\n        const nextRoundMatches = [];\n        for (let i = 0; i < currentRoundMatches.length; i += 2) {\n            nextRoundMatches.push({\n                team1: null, // Will be filled by winner\n                team2: null, // Will be filled by winner\n                winner: null,\n                matchId: `R${roundNumber}M${Math.floor(i/2) + 1}`,\n                previousMatch1: currentRoundMatches[i].matchId,\n                previousMatch2: currentRoundMatches[i + 1] ? currentRoundMatches[i + 1].matchId : null\n            });\n        }\n        rounds.push(nextRoundMatches);\n        currentRoundMatches = nextRoundMatches;\n        roundNumber++;\n    }\n    \n    gameState.tournament.rounds = rounds;\n}\n\nfunction displayTournamentBracket() {\n    const bracketDiv = document.getElementById('bracketDisplay');\n    const rounds = gameState.tournament.rounds;\n    \n    // Create responsive bracket display\n    let bracketHTML = '<div style=\"display: flex; gap: 50px; align-items: center; min-width: max-content;\">';\n    \n    rounds.forEach((round, roundIndex) => {\n        const roundName = getRoundName(roundIndex, rounds.length);\n        bracketHTML += `\n            <div style=\"flex-shrink: 0;\">\n                <h4 style=\"text-align: center; margin-bottom: 20px; color: #00ff88;\">${roundName}</h4>\n                <div style=\"display: flex; flex-direction: column; gap: ${30 * (roundIndex + 1)}px;\">\n        `;\n        \n        round.forEach(match => {\n            const team1Name = match.team1 ? match.team1.name : 'TBD';\n            const team2Name = match.team2 ? match.team2.name : 'TBD';\n            const canSelectWinner = match.team1 && match.team2 && !match.winner;\n            \n            bracketHTML += `\n                <div style=\"background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;\n                    border: 2px solid ${match.winner ? '#00ff88' : 'rgba(255,255,255,0.2)'};\">\n                    <div style=\"margin-bottom: 10px;\">\n                        <div style=\"display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px;\">\n                            <span style=\"${match.winner === match.team1 ? 'color: #00ff88; font-weight: bold;' : ''}\">${team1Name}</span>\n                            ${canSelectWinner ? `<button class=\"btn btn-sm\" onclick=\"selectWinner('${match.matchId}', 1)\" style=\"padding: 5px 10px;\">Win</button>` : ''}\n                        </div>\n                        <div style=\"display: flex; align-items: center; justify-content: space-between;\">\n                            <span style=\"${match.winner === match.team2 ? 'color: #00ff88; font-weight: bold;' : ''}\">${team2Name}</span>\n                            ${canSelectWinner ? `<button class=\"btn btn-sm\" onclick=\"selectWinner('${match.matchId}', 2)\" style=\"padding: 5px 10px;\">Win</button>` : ''}\n                        </div>\n                    </div>\n                    ${match.winner ? `<div style=\"text-align: center; font-size: 0.9em; color: #00ff88;\">Winner: ${match.winner.name}</div>` : ''}\n                </div>\n            `;\n        });\n        \n        bracketHTML += '</div></div>';\n    });\n    \n    bracketHTML += '</div>';\n    bracketDiv.innerHTML = bracketHTML;\n    \n    // Update round title\n    updateRoundTitle();\n}\n\nfunction getRoundName(roundIndex, totalRounds) {\n    if (roundIndex === totalRounds - 1) return '🏆 FINAL';\n    if (roundIndex === totalRounds - 2) return '🥈 Semi-Finals';\n    if (roundIndex === totalRounds - 3) return '🥉 Quarter-Finals';\n    return `Round ${roundIndex + 1}`;\n}\n\nexport function selectWinner(matchId, teamNumber) {\n    const rounds = gameState.tournament.rounds;\n    \n    // Find the match\n    for (let roundIndex = 0; roundIndex < rounds.length; roundIndex++) {\n        const match = rounds[roundIndex].find(m => m.matchId === matchId);\n        if (match) {\n            // Set winner\n            match.winner = teamNumber === 1 ? match.team1 : match.team2;\n            \n            // Advance winner to next round\n            if (roundIndex < rounds.length - 1) {\n                const nextRound = rounds[roundIndex + 1];\n                const nextMatch = nextRound.find(m => \n                    m.previousMatch1 === matchId || m.previousMatch2 === matchId\n                );\n                \n                if (nextMatch) {\n                    if (nextMatch.previousMatch1 === matchId) {\n                        nextMatch.team1 = match.winner;\n                    } else {\n                        nextMatch.team2 = match.winner;\n                    }\n                }\n            }\n            \n            // Check if tournament is complete\n            if (roundIndex === rounds.length - 1) {\n                // Final match completed!\n                showTournamentWinner(match.winner);\n            }\n            \n            break;\n        }\n    }\n    \n    // Redisplay bracket\n    displayTournamentBracket();\n}\n\nfunction showTournamentWinner(winner) {\n    const bracketDiv = document.getElementById('bracketDisplay');\n    \n    // Epic winner announcement\n    bracketDiv.innerHTML = `\n        <div style=\"text-align: center; padding: 50px;\">\n            <div style=\"font-size: 6em; margin-bottom: 20px;\">🏆</div>\n            <h1 style=\"font-size: 3em; color: #FFD700; margin-bottom: 20px;\">CHAMPIONS!</h1>\n            <h2 style=\"font-size: 2em; color: #00ff88;\">${winner.name}</h2>\n            <p style=\"font-size: 1.2em; margin-top: 30px; opacity: 0.8;\">\n                Congratulations on winning the Beer Pong Tournament!\n            </p>\n        </div>\n    `;\n    \n    // Epic confetti\n    if (confetti) {\n        // Multiple bursts for epic effect\n        const colors = ['#FFD700', '#FFA500', '#FF6347', '#00ff88', '#00d4ff'];\n        \n        for (let i = 0; i < 5; i++) {\n            setTimeout(() => {\n                confetti({\n                    particleCount: 150,\n                    spread: 100,\n                    origin: { x: Math.random(), y: Math.random() * 0.5 },\n                    colors: colors\n                });\n            }, i * 200);\n        }\n    }\n}\n\nfunction updateRoundTitle() {\n    const rounds = gameState.tournament.rounds;\n    let currentRoundIndex = 0;\n    \n    // Find current round (first round with incomplete matches)\n    for (let i = 0; i < rounds.length; i++) {\n        if (rounds[i].some(match => match.team1 && match.team2 && !match.winner)) {\n            currentRoundIndex = i;\n            break;\n        }\n    }\n    \n    const roundName = getRoundName(currentRoundIndex, rounds.length);\n    document.getElementById('tournamentRoundTitle').textContent = `${roundName} - Beer Pong Tournament`;\n}\n\nexport function resetTournament() {\n    gameState.tournament = {\n        teams: [],\n        bracket: [],\n        currentRound: 0,\n        totalTeams: 0,\n        rounds: []\n    };\n    \n    showBeerPongTournament();\n}\n\n// ========================================\n// BEER PONG NORMAL & SPECIAL MODE FUNCTIONS\n// ========================================\nexport function startNormalBeerPong() {\n    gameState.beerPong.currentMode = 'normal';\n    document.getElementById('gameModeSelection').style.display = 'none';\n    document.getElementById('teamNameSetup').style.display = 'block';\n}\n\nexport function startSpecialBeerPong() {\n    gameState.beerPong.currentMode = 'special';\n    document.getElementById('gameModeSelection').style.display = 'none';\n    \n    // Show category selection first\n    const categoryDiv = document.createElement('div');\n    categoryDiv.id = 'specialCategorySelection';\n    categoryDiv.innerHTML = `\n        <h3 style=\"text-align: center; margin-bottom: 20px;\">Choose Your Vibe</h3>\n        <div style=\"display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;\">\n            <button class=\"btn btn-primary\" onclick=\"selectSpecialBeerPongCategory('classic')\">\n                <i class=\"fas fa-beer\"></i> Classic\n            </button>\n            <button class=\"btn\" onclick=\"selectSpecialBeerPongCategory('gettingStarted')\">\n                <i class=\"fas fa-play-circle\"></i> Getting Started\n            </button>\n            <button class=\"btn\" onclick=\"selectSpecialBeerPongCategory('normal')\">\n                <i class=\"fas fa-dice\"></i> Normal\n            </button>\n            <button class=\"btn btn-danger\" onclick=\"selectSpecialBeerPongCategory('spicy')\">\n                <i class=\"fas fa-fire\"></i> Spicy\n            </button>\n            <button class=\"btn\" style=\"background: linear-gradient(45deg, #ff0088, #ff4444);\" \n                onclick=\"selectSpecialBeerPongCategory('couples')\">\n                <i class=\"fas fa-heart\"></i> Couples\n            </button>\n        </div>\n    `;\n    \n    const gameDiv = document.getElementById('beerPongGame');\n    if (document.getElementById('specialCategorySelection')) {\n        document.getElementById('specialCategorySelection').remove();\n    }\n    gameDiv.insertBefore(categoryDiv, gameDiv.firstChild);\n}\n\nexport function selectSpecialBeerPongCategory(category) {\n    gameState.selectedCategory = category;\n    document.getElementById('specialCategorySelection').style.display = 'none';\n    document.getElementById('teamNameSetup').style.display = 'block';\n}\n\nexport function startGameWithNames() {\n    // Get team names\n    const team1Name = document.getElementById('team1NameInput').value.trim() || 'Team 1';\n    const team2Name = document.getElementById('team2NameInput').value.trim() || 'Team 2';\n    \n    gameState.beerPong.team1Name = team1Name;\n    gameState.beerPong.team2Name = team2Name;\n    \n    document.getElementById('teamNameSetup').style.display = 'none';\n    \n    if (gameState.beerPong.currentMode === 'normal') {\n        // Update normal game display\n        document.getElementById('team1Display').textContent = team1Name;\n        document.getElementById('team2Display').textContent = team2Name;\n        document.getElementById('normalGamePlay').style.display = 'block';\n    } else {\n        // Initialize special game\n        initializeSpecialGame(team1Name, team2Name);\n        document.getElementById('specialGamePlay').style.display = 'block';\n    }\n}\n\nfunction initializeSpecialGame(team1Name, team2Name) {\n    // Update team names\n    document.getElementById('specialTeam1Name').textContent = team1Name;\n    document.getElementById('specialTeam2Name').textContent = team2Name;\n    document.getElementById('specialTeam1Display').textContent = team1Name;\n    document.getElementById('specialTeam2Display').textContent = team2Name;\n    \n    // Initialize cups for both teams\n    gameState.beerPong.specialCups.team1 = createCupFormation('team1');\n    gameState.beerPong.specialCups.team2 = createCupFormation('team2');\n    \n    // Display cups\n    displayCupFormation('team1');\n    displayCupFormation('team2');\n}\n\nfunction createCupFormation(team) {\n    const cups = [];\n    const rules = gameData.specialBeerPongRules[gameState.selectedCategory] || gameData.specialBeerPongRules.classic;\n    const dares = gameData.specialBeerPongDares[gameState.selectedCategory] || gameData.specialBeerPongDares.classic;\n    \n    // Create 10 cups with random rules/dares\n    for (let i = 0; i < 10; i++) {\n        const isRule = Math.random() > 0.5;\n        const content = isRule \n            ? rules[Math.floor(Math.random() * rules.length)]\n            : dares[Math.floor(Math.random() * dares.length)];\n        \n        cups.push({\n            id: `${team}-cup-${i}`,\n            active: true,\n            type: isRule ? 'rule' : 'dare',\n            content: content\n        });\n    }\n    return cups;\n}\n\nfunction displayCupFormation(team) {\n    const cups = gameState.beerPong.specialCups[team];\n    const container = document.querySelector(`#${team}Cups .cup-formation`);\n    \n    // Create pyramid formation (4-3-2-1)\n    const rows = [4, 3, 2, 1];\n    let cupIndex = 0;\n    let formationHTML = '';\n    \n    rows.forEach((cupsInRow, rowIndex) => {\n        formationHTML += `<div style=\"display: flex; justify-content: center; margin-bottom: 5px;\">`;\n        for (let i = 0; i < cupsInRow; i++) {\n            const cup = cups[cupIndex];\n            const cupStyle = cup.active \n                ? 'font-size: 2.5em; cursor: pointer; margin: 0 5px; transition: transform 0.2s;'\n                : 'font-size: 2.5em; margin: 0 5px; opacity: 0.3;';\n            \n            formationHTML += `\n                <span id=\"${cup.id}\" \n                    style=\"${cupStyle}\" \n                    onclick=\"${cup.active ? `hitCup('${team}', ${cupIndex})` : ''}\"\n                    onmouseover=\"this.style.transform='scale(1.1)'\"\n                    onmouseout=\"this.style.transform='scale(1)'\">\n                    ${cup.active ? '🥤' : '💨'}\n                </span>\n            `;\n            cupIndex++;\n        }\n        formationHTML += '</div>';\n    });\n    \n    container.innerHTML = formationHTML;\n}\n\nexport function hitCup(team, cupIndex) {\n    const cup = gameState.beerPong.specialCups[team][cupIndex];\n    if (!cup.active) return;\n    \n    // Mark cup as hit\n    cup.active = false;\n    \n    // Display the rule/dare\n    const ruleDisplay = document.getElementById('ruleDisplay');\n    ruleDisplay.style.display = 'block';\n    ruleDisplay.innerHTML = `\n        <h3 style=\"color: ${cup.type === 'rule' ? '#00ff88' : '#ff0088'};\">\n            ${cup.type === 'rule' ? '📜 NEW RULE!' : '🎯 DARE TIME!'}\n        </h3>\n        <p style=\"font-size: 1.3em; margin: 20px 0;\">\n            ${cup.content}\n        </p>\n        <button class=\"btn btn-primary\" onclick=\"closeRuleDisplay()\">\n            Got it!\n        </button>\n    `;\n    \n    // Redisplay cups\n    displayCupFormation(team);\n    \n    // Check for winner\n    const activeCups = gameState.beerPong.specialCups[team].filter(c => c.active).length;\n    if (activeCups === 0) {\n        showSpecialGameWinner(team === 'team1' ? gameState.beerPong.team2Name : gameState.beerPong.team1Name);\n    }\n    \n    // Confetti for hits\n    if (confetti) {\n        confetti({\n            particleCount: 50,\n            spread: 60,\n            origin: { y: 0.6 },\n            colors: cup.type === 'rule' ? ['#00ff88', '#00d4ff'] : ['#ff0088', '#ff4444']\n        });\n    }\n}\n\nexport function closeRuleDisplay() {\n    document.getElementById('ruleDisplay').style.display = 'none';\n}\n\nfunction showSpecialGameWinner(winnerName) {\n    document.getElementById('specialGamePlay').innerHTML = `\n        <div style=\"text-align: center; padding: 50px;\">\n            <div style=\"font-size: 6em; margin-bottom: 20px;\">🏆</div>\n            <h1 style=\"font-size: 3em; color: #FFD700; margin-bottom: 20px;\">WINNER!</h1>\n            <h2 style=\"font-size: 2em; color: #00ff88;\">${winnerName}</h2>\n            <p style=\"font-size: 1.2em; margin-top: 30px; opacity: 0.8;\">\n                Conquered Special Beer Pong!\n            </p>\n            <button class=\"btn btn-primary\" onclick=\"resetBeerPong()\" style=\"margin-top: 30px;\">\n                <i class=\"fas fa-redo\"></i> Play Again\n            </button>\n        </div>\n    `;\n    \n    // Epic confetti\n    if (confetti) {\n        for (let i = 0; i < 3; i++) {\n            setTimeout(() => {\n                confetti({\n                    particleCount: 100,\n                    spread: 70,\n                    origin: { x: Math.random(), y: Math.random() * 0.5 }\n                });\n            }, i * 300);\n        }\n    }\n}\n\nexport function resetSpecialGame() {\n    initializeSpecialGame(gameState.beerPong.team1Name, gameState.beerPong.team2Name);\n    document.getElementById('ruleDisplay').style.display = 'none';\n}","// ========================================\n// ACHIEVEMENTS MODULE\n// ========================================\n// Industrial-grade achievement system with progress tracking\n\nimport { getFirebaseDatabase } from '../config/firebase.js';\nimport { getAppState, setStateValue, getCurrentUser } from '../config/app-state.js';\nimport { showNotification } from '../ui/notifications.js';\nimport { ref, set, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';\n\n// Achievement definitions with progress tracking\nexport const achievementDefinitions = {\n    firstTimer: {\n        name: \"First Timer\",\n        icon: \"🎉\",\n        description: \"Joined your first party!\",\n        requirement: 1,\n        progress: 0,\n        unlocked: false,\n        category: \"beginner\"\n    },\n    responsible: {\n        name: \"Responsible\",\n        icon: \"😇\",\n        description: \"Stayed under 0.05 BAC all night\",\n        requirement: 1,\n        progress: 0,\n        unlocked: false,\n        category: \"safety\"\n    },\n    gameMaster: {\n        name: \"Game Master\",\n        icon: \"🏆\",\n        description: \"Win 5 party games\",\n        requirement: 5,\n        progress: 0,\n        unlocked: false,\n        category: \"games\"\n    },\n    partyAnimal: {\n        name: \"Party Animal\",\n        icon: \"📍\",\n        description: \"Check in at 10 parties\",\n        requirement: 10,\n        progress: 0,\n        unlocked: false,\n        category: \"social\"\n    },\n    guardianAngel: {\n        name: \"Guardian Angel\",\n        icon: \"🦸\",\n        description: \"Help 3 friends get home safe\",\n        requirement: 3,\n        progress: 0,\n        unlocked: false,\n        category: \"safety\"\n    },\n    hydroHomie: {\n        name: \"Hydro Homie\",\n        icon: \"💧\",\n        description: \"Stay hydrated for 3 hours\",\n        requirement: 12,\n        progress: 0,\n        unlocked: false,\n        category: \"health\"\n    },\n    danceMachine: {\n        name: \"Dance Machine\",\n        icon: \"🕺\",\n        description: \"Log 50 songs danced to\",\n        requirement: 50,\n        progress: 0,\n        unlocked: false,\n        category: \"fun\"\n    },\n    sunriseWarrior: {\n        name: \"Sunrise Warrior\",\n        icon: \"🌅\",\n        description: \"Party until sunrise (6+ hours)\",\n        requirement: 1,\n        progress: 0,\n        unlocked: false,\n        category: \"endurance\"\n    },\n    socialButterfly: {\n        name: \"Social Butterfly\",\n        icon: \"🦋\",\n        description: \"Add 20 friends\",\n        requirement: 20,\n        progress: 0,\n        unlocked: false,\n        category: \"social\"\n    },\n    safetyFirst: {\n        name: \"Safety First\",\n        icon: \"🛡️\",\n        description: \"Use emergency services 0 times in 10 parties\",\n        requirement: 10,\n        progress: 0,\n        unlocked: false,\n        category: \"safety\"\n    },\n    mixologist: {\n        name: \"Mixologist\",\n        icon: \"🍸\",\n        description: \"Try 15 different drink types\",\n        requirement: 15,\n        progress: 0,\n        unlocked: false,\n        category: \"drinks\"\n    },\n    designated: {\n        name: \"Designated Hero\",\n        icon: \"🚗\",\n        description: \"Be the designated driver 5 times\",\n        requirement: 5,\n        progress: 0,\n        unlocked: false,\n        category: \"safety\"\n    }\n};\n\n// User achievements state\nlet userAchievements = {};\n\n// ========================================\n// ACHIEVEMENT LOADING AND SAVING\n// ========================================\nexport function loadAchievements() {\n    const currentUser = getCurrentUser();\n    if (!currentUser) return;\n    \n    const database = getFirebaseDatabase();\n    const achievementsRef = ref(database, `users/${currentUser.uid}/achievements`);\n    \n    onValue(achievementsRef, (snapshot) => {\n        const data = snapshot.val() || {};\n        \n        // Initialize achievements with saved data\n        Object.keys(achievementDefinitions).forEach(key => {\n            userAchievements[key] = {\n                ...achievementDefinitions[key],\n                ...data[key]\n            };\n        });\n        \n        // Update state\n        setStateValue('userAchievements', userAchievements);\n        \n        // Update UI\n        updateAchievementsUI();\n    });\n}\n\nexport function saveAchievement(achievementKey) {\n    const currentUser = getCurrentUser();\n    if (!currentUser) return;\n    \n    const database = getFirebaseDatabase();\n    const achievement = userAchievements[achievementKey];\n    if (!achievement) return;\n    \n    set(ref(database, `users/${currentUser.uid}/achievements/${achievementKey}`), {\n        progress: achievement.progress,\n        unlocked: achievement.unlocked,\n        unlockedAt: achievement.unlockedAt || null\n    });\n}\n\n// ========================================\n// ACHIEVEMENT PROGRESS TRACKING\n// ========================================\nexport function updateAchievementProgress(achievementKey, increment = 1) {\n    if (!userAchievements[achievementKey]) return;\n    \n    const achievement = userAchievements[achievementKey];\n    \n    // Don't update if already unlocked\n    if (achievement.unlocked) return;\n    \n    // Update progress\n    achievement.progress = Math.min(achievement.progress + increment, achievement.requirement);\n    \n    // Check if achievement is now unlocked\n    if (achievement.progress >= achievement.requirement) {\n        achievement.unlocked = true;\n        achievement.unlockedAt = Date.now();\n        \n        // Show unlock notification\n        showAchievementUnlocked(achievement);\n        \n        // Update stats\n        updateAchievementStats();\n    }\n    \n    // Save to Firebase\n    saveAchievement(achievementKey);\n    \n    // Update UI\n    updateAchievementsUI();\n}\n\n// ========================================\n// ACHIEVEMENT UI\n// ========================================\nexport function updateAchievementsUI() {\n    const container = document.querySelector('.achievements-grid');\n    if (!container) return;\n    \n    // Clear existing achievements\n    container.innerHTML = '';\n    \n    // Sort achievements by category and unlocked status\n    const sortedAchievements = Object.entries(userAchievements)\n        .sort(([, a], [, b]) => {\n            if (a.unlocked && !b.unlocked) return -1;\n            if (!a.unlocked && b.unlocked) return 1;\n            return a.category.localeCompare(b.category);\n        });\n    \n    // Create achievement elements\n    sortedAchievements.forEach(([key, achievement]) => {\n        const achievementEl = document.createElement('div');\n        achievementEl.className = `achievement ${achievement.unlocked ? 'unlocked' : ''}`;\n        achievementEl.setAttribute('data-achievement', key);\n        \n        // Calculate progress percentage\n        const progressPercent = (achievement.progress / achievement.requirement) * 100;\n        \n        achievementEl.innerHTML = `\n            <div class=\"achievement-icon\">${achievement.icon}</div>\n            <div class=\"achievement-name\">${achievement.name}</div>\n            <div class=\"achievement-description\">${achievement.description}</div>\n            ${!achievement.unlocked ? `\n                <div class=\"achievement-progress\">\n                    <div class=\"progress-bar\">\n                        <div class=\"progress-fill\" style=\"width: ${progressPercent}%\"></div>\n                    </div>\n                    <div class=\"progress-text\">${achievement.progress}/${achievement.requirement}</div>\n                </div>\n            ` : `\n                <div class=\"achievement-unlocked-date\">\n                    Unlocked ${new Date(achievement.unlockedAt).toLocaleDateString()}\n                </div>\n            `}\n        `;\n        \n        container.appendChild(achievementEl);\n    });\n    \n    // Update achievement stats\n    updateAchievementStats();\n}\n\nfunction updateAchievementStats() {\n    const totalAchievements = Object.keys(userAchievements).length;\n    const unlockedAchievements = Object.values(userAchievements).filter(a => a.unlocked).length;\n    \n    // Update any stats displays\n    const statsElements = document.querySelectorAll('[data-achievement-stats]');\n    statsElements.forEach(el => {\n        el.textContent = `${unlockedAchievements}/${totalAchievements}`;\n    });\n}\n\n// ========================================\n// ACHIEVEMENT UNLOCK NOTIFICATION\n// ========================================\nfunction showAchievementUnlocked(achievement) {\n    // Play confetti animation\n    if (typeof confetti === 'function') {\n        confetti({\n            particleCount: 100,\n            spread: 70,\n            origin: { y: 0.6 }\n        });\n    }\n    \n    // Show notification with custom styling\n    const notification = document.createElement('div');\n    notification.className = 'achievement-notification';\n    notification.innerHTML = `\n        <div class=\"achievement-popup\">\n            <div class=\"achievement-popup-icon\">${achievement.icon}</div>\n            <div class=\"achievement-popup-content\">\n                <div class=\"achievement-popup-title\">Achievement Unlocked!</div>\n                <div class=\"achievement-popup-name\">${achievement.name}</div>\n                <div class=\"achievement-popup-description\">${achievement.description}</div>\n            </div>\n        </div>\n    `;\n    \n    document.body.appendChild(notification);\n    \n    // Animate in\n    setTimeout(() => {\n        notification.classList.add('show');\n    }, 100);\n    \n    // Remove after 5 seconds\n    setTimeout(() => {\n        notification.classList.remove('show');\n        setTimeout(() => {\n            notification.remove();\n        }, 500);\n    }, 5000);\n}\n\n// ========================================\n// ACHIEVEMENT CHECKING\n// ========================================\nexport function checkAchievements() {\n    const appState = getAppState();\n    const partyData = appState.partyData || {};\n    const friendsData = appState.friendsData || {};\n    const partyStartTime = appState.partyStartTime;\n    \n    // Convert partyData object to array for easier processing\n    const friends = Object.values(partyData);\n    \n    // Responsible - stayed safe all night\n    if (friends.every(f => f.bac < 0.05) && Date.now() - partyStartTime > 3600000) {\n        updateAchievementProgress('responsible');\n    }\n    \n    // Sunrise Warrior - party for 6+ hours\n    if (Date.now() - partyStartTime > 21600000) {\n        updateAchievementProgress('sunriseWarrior');\n    }\n    \n    // Social Butterfly - check friend count\n    if (Object.keys(friendsData).length >= 20) {\n        updateAchievementProgress('socialButterfly', Object.keys(friendsData).length);\n    }\n}\n\n// ========================================\n// ACHIEVEMENT TRIGGERS\n// ========================================\n// These functions are called from other modules when relevant events occur\n\nexport function onDrinkLogged(drinkType, drinkHistory) {\n    // Track unique drink types for Mixologist achievement\n    const uniqueDrinkTypes = new Set(drinkHistory.map(d => d.type));\n    const currentProgress = userAchievements.mixologist?.progress || 0;\n    if (uniqueDrinkTypes.size > currentProgress) {\n        updateAchievementProgress('mixologist', uniqueDrinkTypes.size - currentProgress);\n    }\n    \n    // Track hydration for Hydro Homie\n    if (drinkType === 'water') {\n        updateAchievementProgress('hydroHomie');\n    }\n}\n\nexport function onGameWon() {\n    updateAchievementProgress('gameMaster');\n}\n\nexport function onLocationCheckedIn() {\n    updateAchievementProgress('partyAnimal');\n}\n\nexport function onBuddyHelped() {\n    updateAchievementProgress('guardianAngel');\n}\n\nexport function onFirstLogin() {\n    updateAchievementProgress('firstTimer');\n}\n\nexport function onDesignatedDriver() {\n    updateAchievementProgress('designated');\n}\n\n// Export updateAchievements for backwards compatibility\nexport { updateAchievementsUI as updateAchievements };","// UI wrapper functions for party HTML onclick handlers\nimport { createParty, getPartyByCode, joinParty, leaveParty, sendPartyMessage, getNearbyParties } from './parties.js';\nimport { showNotification } from '../ui/notifications.js';\n\nexport async function createNewParty() {\n    const nameInput = document.getElementById('partyName');\n    const privacySelect = document.getElementById('partyPrivacy');\n    const durationSelect = document.getElementById('partyDuration');\n    const addressInput = document.getElementById('partyAddress');\n    \n    if (!nameInput || !nameInput.value.trim()) {\n        showNotification('Enter a party name', 'error');\n        return;\n    }\n    \n    const options = {\n        privacy: privacySelect ? privacySelect.value : 'private',\n        duration: durationSelect ? durationSelect.value : 'ongoing',\n        address: addressInput ? addressInput.value : ''\n    };\n    \n    try {\n        const result = await createParty(nameInput.value.trim(), options);\n        if (result.success) {\n            showNotification(`Party created! Code: ${result.code}`, 'success');\n            nameInput.value = '';\n            if (addressInput) addressInput.value = '';\n            if (window.updatePartyDisplay) window.updatePartyDisplay();\n        } else {\n            showNotification(result.error || 'Failed to create party', 'error');\n        }\n    } catch (error) {\n        showNotification('Failed to create party', 'error');\n    }\n}\n\nexport async function joinPartyByCode() {\n    const codeInput = document.getElementById('joinPartyCode');\n    if (!codeInput || !codeInput.value.trim()) {\n        showNotification('Enter a party code', 'error');\n        return;\n    }\n    \n    const code = codeInput.value.trim();\n    \n    try {\n        showNotification('Checking party...', 'info');\n        const party = await getPartyByCode(code);\n        \n        if (!party) {\n            showNotification('Invalid party code', 'error');\n            return;\n        }\n        \n        const memberCount = Object.keys(party.members || {}).length;\n        const confirmMsg = `Join \"${party.name}\"?\\n` +\n            `👥 ${memberCount} members\\n` +\n            `🔒 Privacy: ${party.privacy || 'Unknown'}\\n` +\n            `📍 ${party.address || 'No location set'}\\n` +\n            `⏱️ ${party.duration === '24h' ? '24 hour party' : 'Ongoing party'}`;\n        \n        if (!confirm(confirmMsg)) {\n            return;\n        }\n        \n        const result = await joinParty(code);\n        if (result.success) {\n            if (result.pending) {\n                showNotification('Join request sent! Waiting for approval.', 'info');\n            } else if (result.alreadyMember) {\n                showNotification('Rejoined party!', 'success');\n            } else {\n                showNotification('Joined party!', 'success');\n            }\n            codeInput.value = '';\n            if (window.updatePartyDisplay) window.updatePartyDisplay();\n        } else {\n            showNotification(result.error || 'Failed to join party', 'error');\n        }\n    } catch (error) {\n        showNotification('Failed to join party', 'error');\n    }\n}\n\nexport async function leaveCurrentParty() {\n    if (confirm('Leave this party?')) {\n        try {\n            const result = await leaveParty();\n            if (result.success) {\n                showNotification('Left party', 'info');\n                if (window.updatePartyDisplay) window.updatePartyDisplay();\n            }\n        } catch (error) {\n            showNotification('Failed to leave party', 'error');\n        }\n    }\n}\n\nexport async function sendPartyChat() {\n    const input = document.getElementById('partyChatInput');\n    if (!input || !input.value.trim()) return;\n    \n    try {\n        const result = await sendPartyMessage(input.value);\n        if (result.success) {\n            input.value = '';\n        }\n    } catch (error) {\n        showNotification('Failed to send message', 'error');\n    }\n}\n\nexport async function refreshPublicParties() {\n    const listEl = document.getElementById('publicPartiesList');\n    if (!listEl) return;\n    \n    listEl.innerHTML = '<p style=\"opacity: 0.7;\">Loading parties...</p>';\n    \n    try {\n        const publicParties = await getNearbyParties();\n        \n        if (publicParties.length === 0) {\n            listEl.innerHTML = '<p style=\"opacity: 0.7;\">No public parties found. Create one!</p>';\n            return;\n        }\n        \n        // Check if current user is developer\n        const currentUser = window.firebase?.auth?.currentUser;\n        const isDev = currentUser && window.isDeveloper && window.isDeveloper(currentUser.uid);\n        \n        listEl.innerHTML = publicParties.map(party => `\n            <div class=\"friend-item\" style=\"margin-bottom: 15px;\">\n                <div class=\"friend-info\">\n                    <div class=\"friend-avatar-small\">🎉</div>\n                    <div class=\"friend-details\">\n                        <h4>${party.name}</h4>\n                        <p style=\"opacity: 0.7;\">\n                            👥 ${party.memberCount} members\n                            ${party.address ? `• 📍 ${party.address}` : ''}\n                            ${party.duration === '24h' ? '• ⏰ 24h party' : ''}\n                        </p>\n                    </div>\n                </div>\n                <div style=\"display: flex; gap: 10px;\">\n                    <button class=\"btn btn-primary\" onclick=\"joinPublicParty('${party.code}')\">\n                        Join\n                    </button>\n                    ${isDev ? `\n                        <button class=\"btn btn-danger\" onclick=\"deletePartyAsDev('${party.id}')\" title=\"Developer: Delete this party\">\n                            <i class=\"fas fa-trash\"></i>\n                        </button>\n                    ` : ''}\n                </div>\n            </div>\n        `).join('');\n    } catch (error) {\n        listEl.innerHTML = '<p style=\"opacity: 0.7;\">Failed to load parties</p>';\n    }\n}\n\nexport async function joinPublicParty(code) {\n    try {\n        const result = await joinParty(code, true);\n        if (result.success) {\n            showNotification('Joined public party!', 'success');\n            if (window.updatePartyDisplay) window.updatePartyDisplay();\n        } else {\n            showNotification(result.error || 'Failed to join party', 'error');\n        }\n    } catch (error) {\n        showNotification('Failed to join party', 'error');\n    }\n}","// ========================================\n// PHOTO FEED MODULE\n// ========================================\n// Handles photo uploads, feed display, and social interactions\n\nimport { getFirebaseDatabase, getFirebaseStorage } from '../config/firebase.js';\nimport { ref as storageRef, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';\nimport { ref, set, get, push, onValue, off, remove, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';\nimport { getCurrentUser, getStateValue, setStateValue } from '../config/app-state.js';\nimport { showNotification } from '../ui/notifications.js';\nimport { handleError, safeAsync } from '../utils/error-handler.js';\n\n// Photo feed state\nlet photoFeedListener = null;\nlet currentFilter = 'all';\n\n// ========================================\n// INITIALIZE PHOTOS MODULE\n// ========================================\nexport function initializePhotos() {\n    const user = getCurrentUser();\n    if (!user) return;\n    \n    // Start listening to photo feed\n    listenToPhotoFeed();\n    \n    // Initialize upload handler for ESP32 devices\n    initializeUploadHandler();\n}\n\n// ========================================\n// PHOTO UPLOAD HANDLER (FOR ESP32)\n// ========================================\nexport async function handlePhotoUpload(photoData) {\n    try {\n        const user = getCurrentUser();\n        if (!user) throw new Error('User not authenticated');\n        \n        // Show upload status\n        const uploadStatus = document.getElementById('uploadStatus');\n        if (uploadStatus) uploadStatus.style.display = 'block';\n        \n        // Get current device data\n        const deviceData = getStateValue('deviceData') || {};\n        const deviceId = photoData.deviceId;\n        \n        // Validate device ownership\n        if (!deviceData[deviceId]) {\n            throw new Error('Device not paired with this account');\n        }\n        \n        // Convert base64 to blob\n        const photoBlob = base64ToBlob(photoData.imageBase64, 'image/jpeg');\n        \n        // Apply retro filter\n        const retroBlob = await applyRetroFilter(photoBlob);\n        \n        // Upload to Firebase Storage\n        const storage = getFirebaseStorage();\n        const timestamp = Date.now();\n        const fileName = `photos/${user.uid}/${timestamp}_${deviceId}.jpg`;\n        const photoStorageRef = storageRef(storage, fileName);\n        \n        const snapshot = await uploadBytes(photoStorageRef, retroBlob);\n        const photoUrl = await getDownloadURL(snapshot.ref);\n        \n        // Save photo metadata to database\n        const database = getFirebaseDatabase();\n        const photoRef = push(ref(database, 'photos'));\n        \n        await set(photoRef, {\n            userId: user.uid,\n            userName: user.displayName || 'Anonymous',\n            deviceId: deviceId,\n            photoUrl: photoUrl,\n            thumbnailUrl: photoUrl, // In production, generate actual thumbnail\n            bac: photoData.bac || null, // Optional BAC reading\n            timestamp: serverTimestamp(),\n            likes: {},\n            comments: {},\n            partyId: getStateValue('currentPartyId') || null,\n            location: photoData.location || null,\n            retro: true\n        });\n        \n        // Hide upload status\n        if (uploadStatus) uploadStatus.style.display = 'none';\n        \n        showNotification('📸 Photo uploaded successfully!', 'success');\n        \n        // Trigger achievement check\n        if (window.checkAchievements) {\n            window.checkAchievements('photo_upload');\n        }\n        \n        return { success: true, photoId: photoRef.key };\n        \n    } catch (error) {\n        const uploadStatus = document.getElementById('uploadStatus');\n        if (uploadStatus) uploadStatus.style.display = 'none';\n        \n        const errorInfo = handleError(error, 'Photo Upload');\n        showNotification(errorInfo.message, 'error');\n        return { success: false, error: errorInfo.message };\n    }\n}\n\n// ========================================\n// RETRO FILTER APPLICATION\n// ========================================\nasync function applyRetroFilter(blob) {\n    return new Promise((resolve) => {\n        const img = new Image();\n        const canvas = document.createElement('canvas');\n        const ctx = canvas.getContext('2d');\n        \n        img.onload = () => {\n            canvas.width = img.width;\n            canvas.height = img.height;\n            \n            // Draw original image\n            ctx.drawImage(img, 0, 0);\n            \n            // Apply retro filter\n            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\n            const data = imageData.data;\n            \n            for (let i = 0; i < data.length; i += 4) {\n                // Sepia tone effect\n                const r = data[i];\n                const g = data[i + 1];\n                const b = data[i + 2];\n                \n                data[i] = Math.min(255, (r * 0.393) + (g * 0.769) + (b * 0.189));\n                data[i + 1] = Math.min(255, (r * 0.349) + (g * 0.686) + (b * 0.168));\n                data[i + 2] = Math.min(255, (r * 0.272) + (g * 0.534) + (b * 0.131));\n            }\n            \n            // Add slight vignette\n            const centerX = canvas.width / 2;\n            const centerY = canvas.height / 2;\n            const radius = Math.min(centerX, centerY);\n            \n            for (let y = 0; y < canvas.height; y++) {\n                for (let x = 0; x < canvas.width; x++) {\n                    const distance = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));\n                    const vignette = Math.max(0, 1 - (distance / radius) * 0.7);\n                    const index = (y * canvas.width + x) * 4;\n                    \n                    data[index] *= vignette;\n                    data[index + 1] *= vignette;\n                    data[index + 2] *= vignette;\n                }\n            }\n            \n            ctx.putImageData(imageData, 0, 0);\n            \n            // Convert to blob\n            canvas.toBlob((retroBlob) => {\n                resolve(retroBlob);\n            }, 'image/jpeg', 0.9);\n        };\n        \n        img.src = URL.createObjectURL(blob);\n    });\n}\n\n// ========================================\n// PHOTO FEED DISPLAY\n// ========================================\nfunction listenToPhotoFeed() {\n    const database = getFirebaseDatabase();\n    const user = getCurrentUser();\n    \n    // Clean up existing listener\n    if (photoFeedListener) {\n        off(ref(database, 'photos'), photoFeedListener);\n    }\n    \n    // Listen to all photos (we'll filter client-side for privacy)\n    photoFeedListener = onValue(ref(database, 'photos'), async (snapshot) => {\n        const photos = snapshot.val() || {};\n        const friendsList = getStateValue('friendsList') || [];\n        const currentPartyId = getStateValue('currentPartyId');\n        \n        // Filter photos based on privacy (friends only + self)\n        const visiblePhotos = [];\n        const friendIds = friendsList.map(f => f.id);\n        friendIds.push(user.uid); // Include own photos\n        \n        for (const [photoId, photo] of Object.entries(photos)) {\n            // Check if photo is from a friend or self\n            if (friendIds.includes(photo.userId)) {\n                // Apply additional filters\n                if (currentFilter === 'all' ||\n                    (currentFilter === 'recent' && isRecent(photo.timestamp)) ||\n                    (currentFilter === 'party' && photo.partyId === currentPartyId) ||\n                    (currentFilter === 'high-bac' && photo.bac !== null && photo.bac >= 0.08)) {\n                    \n                    visiblePhotos.push({ id: photoId, ...photo });\n                }\n            }\n        }\n        \n        // Sort by timestamp (newest first)\n        visiblePhotos.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));\n        \n        // Update UI\n        displayPhotoFeed(visiblePhotos);\n    });\n}\n\n// ========================================\n// DISPLAY PHOTO FEED UI\n// ========================================\nfunction displayPhotoFeed(photos) {\n    const photoFeed = document.getElementById('photoFeed');\n    if (!photoFeed) return;\n    \n    if (photos.length === 0) {\n        photoFeed.innerHTML = `\n            <div class=\"photo-placeholder\">\n                <i class=\"fas fa-camera-retro\" style=\"font-size: 4em; opacity: 0.3;\"></i>\n                <p style=\"opacity: 0.5;\">No photos to show. ${currentFilter !== 'all' ? 'Try changing the filter!' : 'Connect your BoozeLens to start!'}</p>\n            </div>\n        `;\n        return;\n    }\n    \n    photoFeed.innerHTML = photos.map(photo => {\n        const timeAgo = getTimeAgo(photo.timestamp);\n        const likeCount = Object.keys(photo.likes || {}).length;\n        const commentCount = Object.keys(photo.comments || {}).length;\n        const userLiked = photo.likes && photo.likes[getCurrentUser().uid];\n        \n        return `\n            <div class=\"photo-card\" data-photo-id=\"${photo.id}\">\n                <div class=\"photo-header\">\n                    <div class=\"photo-user\">\n                        <div class=\"user-avatar\">${getInitials(photo.userName)}</div>\n                        <div class=\"user-info\">\n                            <h4>${photo.userName}</h4>\n                            <p>${timeAgo} ${photo.bac !== null && photo.bac !== undefined ? `• ${photo.bac.toFixed(3)}‰` : ''}</p>\n                        </div>\n                    </div>\n                    ${photo.userId === getCurrentUser().uid ? `\n                        <button class=\"btn-icon\" onclick=\"deletePhoto('${photo.id}')\" title=\"Delete\">\n                            <i class=\"fas fa-trash\"></i>\n                        </button>\n                    ` : ''}\n                </div>\n                \n                <div class=\"photo-image\" onclick=\"viewPhoto('${photo.id}')\">\n                    <img src=\"${photo.photoUrl}\" alt=\"Party photo\" loading=\"lazy\">\n                    ${photo.bac !== null && photo.bac >= 0.08 ? '<div class=\"bac-badge\">🔥 High BAC</div>' : ''}\n                </div>\n                \n                <div class=\"photo-actions\">\n                    <button class=\"btn-icon ${userLiked ? 'liked' : ''}\" onclick=\"toggleLike('${photo.id}')\">\n                        <i class=\"fas fa-heart\"></i> ${likeCount > 0 ? likeCount : ''}\n                    </button>\n                    <button class=\"btn-icon\" onclick=\"showComments('${photo.id}')\">\n                        <i class=\"fas fa-comment\"></i> ${commentCount > 0 ? commentCount : ''}\n                    </button>\n                    <button class=\"btn-icon\" onclick=\"sharePhoto('${photo.id}')\">\n                        <i class=\"fas fa-share\"></i>\n                    </button>\n                </div>\n                \n                <div class=\"photo-comments\" id=\"comments-${photo.id}\" style=\"display: none;\">\n                    <!-- Comments will be loaded here -->\n                </div>\n            </div>\n        `;\n    }).join('');\n    \n    // Add CSS for retro photo styling\n    addRetroStyles();\n}\n\n// ========================================\n// LIKE/UNLIKE PHOTO\n// ========================================\nexport async function toggleLike(photoId) {\n    try {\n        const user = getCurrentUser();\n        const database = getFirebaseDatabase();\n        const likeRef = ref(database, `photos/${photoId}/likes/${user.uid}`);\n        \n        const snapshot = await get(likeRef);\n        \n        if (snapshot.exists()) {\n            // Unlike\n            await remove(likeRef);\n        } else {\n            // Like\n            await set(likeRef, {\n                timestamp: serverTimestamp(),\n                userName: user.displayName || 'Anonymous'\n            });\n            \n            // Check achievement\n            if (window.checkAchievements) {\n                window.checkAchievements('give_likes');\n            }\n        }\n        \n    } catch (error) {\n        handleError(error, 'Toggle Like');\n    }\n}\n\n// ========================================\n// ADD COMMENT\n// ========================================\nexport async function addComment(photoId, comment) {\n    try {\n        const user = getCurrentUser();\n        const database = getFirebaseDatabase();\n        const commentRef = push(ref(database, `photos/${photoId}/comments`));\n        \n        await set(commentRef, {\n            userId: user.uid,\n            userName: user.displayName || 'Anonymous',\n            text: comment,\n            timestamp: serverTimestamp()\n        });\n        \n        showNotification('💬 Comment added!', 'success');\n        \n    } catch (error) {\n        handleError(error, 'Add Comment');\n    }\n}\n\n// ========================================\n// DELETE PHOTO\n// ========================================\nexport async function deletePhoto(photoId) {\n    if (!confirm('Delete this photo? This cannot be undone.')) return;\n    \n    try {\n        const database = getFirebaseDatabase();\n        const storage = getFirebaseStorage();\n        \n        // Get photo data first\n        const photoSnapshot = await get(ref(database, `photos/${photoId}`));\n        const photoData = photoSnapshot.val();\n        \n        if (!photoData) throw new Error('Photo not found');\n        \n        // Delete from storage\n        if (photoData.photoUrl) {\n            try {\n                const photoRef = storageRef(storage, photoData.photoUrl);\n                await deleteObject(photoRef);\n            } catch (e) {\n                console.error('Storage deletion failed:', e);\n            }\n        }\n        \n        // Delete from database\n        await remove(ref(database, `photos/${photoId}`));\n        \n        showNotification('📸 Photo deleted', 'info');\n        \n    } catch (error) {\n        handleError(error, 'Delete Photo');\n    }\n}\n\n// ========================================\n// HELPER FUNCTIONS\n// ========================================\nfunction base64ToBlob(base64, contentType) {\n    const byteCharacters = atob(base64);\n    const byteArrays = [];\n    \n    for (let offset = 0; offset < byteCharacters.length; offset += 512) {\n        const slice = byteCharacters.slice(offset, offset + 512);\n        const byteNumbers = new Array(slice.length);\n        \n        for (let i = 0; i < slice.length; i++) {\n            byteNumbers[i] = slice.charCodeAt(i);\n        }\n        \n        const byteArray = new Uint8Array(byteNumbers);\n        byteArrays.push(byteArray);\n    }\n    \n    return new Blob(byteArrays, { type: contentType });\n}\n\nfunction isRecent(timestamp) {\n    const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);\n    return timestamp > oneDayAgo;\n}\n\nfunction getTimeAgo(timestamp) {\n    if (!timestamp) return 'Just now';\n    \n    const seconds = Math.floor((Date.now() - timestamp) / 1000);\n    \n    if (seconds < 60) return 'Just now';\n    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;\n    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;\n    return `${Math.floor(seconds / 86400)}d ago`;\n}\n\nfunction getInitials(name) {\n    return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);\n}\n\n// ========================================\n// RETRO STYLING\n// ========================================\nfunction addRetroStyles() {\n    if (document.getElementById('retro-photo-styles')) return;\n    \n    const style = document.createElement('style');\n    style.id = 'retro-photo-styles';\n    style.innerHTML = `\n        .photo-feed {\n            display: grid;\n            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));\n            gap: 20px;\n            margin: 20px 0;\n        }\n        \n        .photo-card {\n            background: rgba(255, 255, 255, 0.05);\n            border: 2px solid rgba(255, 255, 255, 0.1);\n            border-radius: 15px;\n            overflow: hidden;\n            transition: transform 0.2s;\n        }\n        \n        .photo-card:hover {\n            transform: scale(1.02);\n            border-color: #00ff88;\n        }\n        \n        .photo-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 15px;\n        }\n        \n        .photo-user {\n            display: flex;\n            align-items: center;\n            gap: 10px;\n        }\n        \n        .user-avatar {\n            width: 40px;\n            height: 40px;\n            border-radius: 50%;\n            background: #00ff88;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-weight: bold;\n            color: #1a1a1a;\n        }\n        \n        .user-info h4 {\n            margin: 0;\n            font-size: 1em;\n        }\n        \n        .user-info p {\n            margin: 0;\n            font-size: 0.8em;\n            opacity: 0.7;\n        }\n        \n        .photo-image {\n            position: relative;\n            cursor: pointer;\n            overflow: hidden;\n            aspect-ratio: 1;\n        }\n        \n        .photo-image img {\n            width: 100%;\n            height: 100%;\n            object-fit: cover;\n            filter: contrast(1.1) brightness(0.9);\n        }\n        \n        .bac-badge {\n            position: absolute;\n            top: 10px;\n            right: 10px;\n            background: rgba(255, 0, 0, 0.8);\n            color: white;\n            padding: 5px 10px;\n            border-radius: 20px;\n            font-size: 0.8em;\n            font-weight: bold;\n        }\n        \n        .photo-actions {\n            display: flex;\n            gap: 15px;\n            padding: 15px;\n            border-top: 1px solid rgba(255, 255, 255, 0.1);\n        }\n        \n        .btn-icon {\n            background: none;\n            border: none;\n            color: inherit;\n            cursor: pointer;\n            display: flex;\n            align-items: center;\n            gap: 5px;\n            opacity: 0.7;\n            transition: all 0.2s;\n        }\n        \n        .btn-icon:hover {\n            opacity: 1;\n            color: #00ff88;\n        }\n        \n        .btn-icon.liked {\n            color: #ff0066;\n            opacity: 1;\n        }\n        \n        .photo-comments {\n            padding: 15px;\n            border-top: 1px solid rgba(255, 255, 255, 0.1);\n        }\n        \n        .photo-controls {\n            display: flex;\n            gap: 15px;\n            margin: 20px 0;\n            align-items: center;\n        }\n        \n        .photo-filter {\n            background: rgba(255, 255, 255, 0.1);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            color: inherit;\n            padding: 10px;\n            border-radius: 8px;\n            cursor: pointer;\n        }\n        \n        .upload-status {\n            background: rgba(0, 255, 136, 0.1);\n            border: 2px solid #00ff88;\n            border-radius: 10px;\n            padding: 15px;\n            margin: 20px 0;\n            text-align: center;\n        }\n        \n        .upload-progress {\n            color: #00ff88;\n            font-weight: bold;\n        }\n    `;\n    \n    document.head.appendChild(style);\n}\n\n// ========================================\n// EXPORT FUNCTIONS\n// ========================================\nexport async function refreshPhotoFeed() {\n    listenToPhotoFeed();\n    showNotification('📸 Feed refreshed!', 'success');\n}\n\nexport function filterPhotos() {\n    const filter = document.getElementById('photoFilter').value;\n    currentFilter = filter;\n    listenToPhotoFeed();\n}\n\nexport async function viewPhoto(photoId) {\n    // In a real app, this would open a full-screen viewer\n    console.log('View photo:', photoId);\n}\n\nexport async function showComments(photoId) {\n    const commentsDiv = document.getElementById(`comments-${photoId}`);\n    if (!commentsDiv) return;\n    \n    if (commentsDiv.style.display === 'none') {\n        // Load and show comments\n        const database = getFirebaseDatabase();\n        const commentsSnapshot = await get(ref(database, `photos/${photoId}/comments`));\n        const comments = commentsSnapshot.val() || {};\n        \n        const commentsHtml = Object.entries(comments)\n            .sort((a, b) => (a[1].timestamp || 0) - (b[1].timestamp || 0))\n            .map(([id, comment]) => `\n                <div class=\"comment\">\n                    <strong>${comment.userName}:</strong> ${comment.text}\n                </div>\n            `).join('');\n        \n        commentsDiv.innerHTML = `\n            ${commentsHtml}\n            <div class=\"comment-input\">\n                <input type=\"text\" id=\"comment-input-${photoId}\" placeholder=\"Add a comment...\" \n                    onkeypress=\"if(event.key==='Enter') addComment('${photoId}', this.value)\">\n            </div>\n        `;\n        \n        commentsDiv.style.display = 'block';\n    } else {\n        commentsDiv.style.display = 'none';\n    }\n}\n\nexport async function sharePhoto(photoId) {\n    // Copy link to clipboard\n    const url = `${window.location.origin}/#photo/${photoId}`;\n    await navigator.clipboard.writeText(url);\n    showNotification('📋 Link copied!', 'success');\n}\n\n// ========================================\n// ESP32 UPLOAD ENDPOINT\n// ========================================\nexport function initializeUploadHandler() {\n    // This would be called by your server/cloud function\n    // when receiving uploads from ESP32 devices\n    window.handleBoozeLensUpload = handlePhotoUpload;\n}\n\n// ========================================\n// CLEANUP\n// ========================================\nexport function cleanupPhotos() {\n    if (photoFeedListener) {\n        const database = getFirebaseDatabase();\n        off(ref(database, 'photos'), photoFeedListener);\n        photoFeedListener = null;\n    }\n}","// ========================================\n// MAIN ENTRY POINT - Complete Application\n// ========================================\n\nimport { initializeFirebase, getFirebaseDatabase } from './config/firebase.js';\nimport { setupAuthListener, handleAuthSubmit, toggleAuthMode, signOut, loadUserData, hideAuthScreen } from './auth/auth.js';\nimport { initializeDevices } from './features/devices.js';\nimport { updateUI } from './ui/dashboard.js';\nimport { showNotification } from './ui/notifications.js';\nimport { DRINK_PRESETS } from './config/constants.js';\nimport { ref, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';\nimport { \n    getAppState, \n    setStateValue, \n    getCurrentUser,\n    clearAppState\n} from './config/app-state.js';\nimport { isDeveloper } from './config/constants.js';\nimport { registerServiceWorker, initializePWA, initializeOfflineStorage } from './utils/pwa.js';\nimport { safeUpdatePartyDisplay } from './main-party-display.js';\n\n// Import all functions from feature modules\nimport * as AllFunctions from './features/all-functions.js';\nimport * as Drinks from './features/drinks.js';\nimport * as Games from './features/games.js';\nimport * as Achievements from './features/achievements.js';\nimport * as Devices from './features/devices.js';\nimport * as PartiesModule from './features/parties.js';\nimport * as PartiesUI from './features/parties-ui.js';\nimport * as Photos from './features/photos.js';\n\n// ========================================\n// PARTY MODULE REFERENCE\n// ========================================\nlet Parties = null;\n\n// ========================================\n// EXPOSE ALL FUNCTIONS GLOBALLY\n// ========================================\n// This is necessary for HTML onclick handlers to work\nfunction exposeGlobalFunctions() {\n    // Auth functions\n    window.toggleAuthMode = toggleAuthMode;\n    window.signOut = signOut;\n    \n    // UI functions\n    window.updateUI = updateUI;\n    window.switchSection = switchSection;\n    window.toggleMobileMenu = toggleMobileMenu;\n    window.showNotification = showNotification;\n    window.showModal = showModal;\n    window.closeModal = closeModal;\n    \n    // All functions from all-functions.js\n    window.searchFriends = AllFunctions.searchFriends;\n    window.sendFriendRequest = AllFunctions.sendFriendRequest;\n    window.acceptFriendRequest = AllFunctions.acceptFriendRequest;\n    window.declineFriendRequest = AllFunctions.declineFriendRequest;\n    window.updateFriendPermission = AllFunctions.updateFriendPermission;\n    window.removeFriend = AllFunctions.removeFriend;\n    window.sendMessage = AllFunctions.sendMessage;\n    window.handleChatEnter = AllFunctions.handleChatEnter;\n    window.showHydrationReminder = AllFunctions.showHydrationReminder;\n    window.checkInLocation = AllFunctions.checkInLocation;\n    window.callUber = AllFunctions.callUber;\n    window.callEmergency = AllFunctions.callEmergency;\n    window.selectBuddy = AllFunctions.selectBuddy;\n    window.showFirstAid = AllFunctions.showFirstAid;\n    window.updateProfile = AllFunctions.updateProfile;\n    window.changePassword = AllFunctions.changePassword;\n    window.saveEmergencyInfo = AllFunctions.saveEmergencyInfo;\n    window.savePrivacySettings = AllFunctions.savePrivacySettings;\n    window.exportData = AllFunctions.exportData;\n    window.pairDeviceFromModal = AllFunctions.pairDeviceFromModal;\n    window.resolvePermission = AllFunctions.resolvePermission;\n    \n    // Drink functions\n    window.logDrink = Drinks.logDrink;\n    window.toggleChart = Drinks.toggleChart;\n    window.removeDrink = Drinks.removeDrink;\n    window.showEmergencyReport = Drinks.showEmergencyReport;\n    window.copyEmergencyReport = Drinks.copyEmergencyReport;\n    window.downloadEmergencyReport = Drinks.downloadEmergencyReport;\n    window.shareEmergencyReport = Drinks.shareEmergencyReport;\n    window.clearDrinkHistory = Drinks.clearDrinkHistory;\n    window.deleteAccount = AllFunctions.deleteAccount;\n    \n    // Party functions - ONLY expose if Parties module is loaded\n    if (Parties) {\n        window.createParty = Parties.createParty;\n        window.joinParty = Parties.joinParty;\n        window.leaveParty = Parties.leaveParty;\n        window.deleteParty = Parties.deleteParty;\n        window.sendPartyMessage = Parties.sendPartyMessage;\n        window.getPartyByCode = Parties.getPartyByCode;\n        window.getNearbyParties = Parties.getNearbyParties;\n        window.getFriendsParties = Parties.getFriendsParties;\n        window.updatePartyDisplay = updatePartyDisplay; // Use main.js version, not parties.js\n        \n        // New creator control functions\n        window.kickMember = Parties.kickMember;\n        window.updatePartySettings = Parties.updatePartySettings;\n        window.togglePartyLock = Parties.togglePartyLock;\n        \n        // Multi-party support\n        window.switchToParty = Parties.switchToParty;\n        window.getUserParties = () => Parties.userParties;\n    }\n    \n    // Party UI functions\n    window.createNewParty = PartiesUI.createNewParty;\n    window.joinPartyByCode = PartiesUI.joinPartyByCode;\n    window.leaveCurrentParty = PartiesUI.leaveCurrentParty;\n    window.sendPartyChat = PartiesUI.sendPartyChat;\n    window.refreshPublicParties = PartiesUI.refreshPublicParties;\n    window.joinPublicParty = PartiesUI.joinPublicParty;\n    window.isDeveloper = isDeveloper; // Expose for parties-ui.js\n    \n    // Game functions\n    window.startGame = Games.startGame;\n    window.closeGame = Games.closeGame;\n    window.nextNeverHaveIEver = Games.nextNeverHaveIEver;\n    window.showTruth = Games.showTruth;\n    window.showDare = Games.showDare;\n    window.drawCard = Games.drawCard;\n    window.addScore = Games.addScore;\n    window.resetBeerPong = Games.resetBeerPong;\n    window.toggleFlipTimer = Games.toggleFlipTimer;\n    window.resetFlipTimer = Games.resetFlipTimer;\n    window.nextTrivia = Games.nextTrivia;\n    window.answerTrivia = Games.answerTrivia;\n    \n    // Player management functions\n    window.addPlayer = Games.addPlayer;\n    window.removePlayer = Games.removePlayer;\n    window.resetToPlayerSetup = Games.resetToPlayerSetup;\n    window.startNeverHaveIEver = Games.startNeverHaveIEver;\n    window.startTruthOrDare = Games.startTruthOrDare;\n    window.nextTurnTruthOrDare = Games.nextTurnTruthOrDare;\n    \n    // New game functions\n    window.startWouldYouRather = Games.startWouldYouRather;\n    window.nextWouldYouRather = Games.nextWouldYouRather;\n    window.voteWouldYouRather = Games.voteWouldYouRather;\n    window.startMostLikelyTo = Games.startMostLikelyTo;\n    window.nextMostLikelyTo = Games.nextMostLikelyTo;\n    window.showVotes = Games.showVotes;\n    window.startSpinBottle = Games.startSpinBottle;\n    window.spinBottle = Games.spinBottle;\n    window.showBeerPongRules = Games.showBeerPongRules;\n    window.showBeerPongGame = Games.showBeerPongGame;\n    window.showBeerPongTournament = Games.showBeerPongTournament;\n    window.setupTournament = Games.setupTournament;\n    window.startTournament = Games.startTournament;\n    window.selectWinner = Games.selectWinner;\n    window.resetTournament = Games.resetTournament;\n    window.startNormalBeerPong = Games.startNormalBeerPong;\n    window.startSpecialBeerPong = Games.startSpecialBeerPong;\n    window.startGameWithNames = Games.startGameWithNames;\n    window.hitCup = Games.hitCup;\n    window.closeRuleDisplay = Games.closeRuleDisplay;\n    window.resetSpecialGame = Games.resetSpecialGame;\n    window.selectGameCategory = Games.selectGameCategory;\n    window.changeCategoryMidGame = Games.changeCategoryMidGame;\n    window.selectSpecialBeerPongCategory = Games.selectSpecialBeerPongCategory;\n    \n    // Also expose some internal functions that are used\n    window.getActiveLocations = AllFunctions.getActiveLocations;\n    window.createLocationMap = AllFunctions.createLocationMap;\n    window.initializeLocationMap = AllFunctions.initializeLocationMap;\n    window.updateFriendRequests = AllFunctions.updateFriendRequests;\n    window.updateFriendsList = AllFunctions.updateFriendsList;\n    window.escapeHtml = AllFunctions.escapeHtml;\n    \n    // Achievement functions\n    window.updateAchievements = Achievements.updateAchievements;\n    window.updateAchievementProgress = Achievements.updateAchievementProgress;\n    window.checkAchievements = Achievements.checkAchievements;\n    \n    // Device functions\n    window.pairDeviceById = Devices.pairDeviceById;\n    window.unpairDevice = Devices.unpairDevice;\n    window.renameDevice = Devices.renameDevice;\n    \n    // Photo functions\n    window.refreshPhotoFeed = Photos.refreshPhotoFeed;\n    window.filterPhotos = Photos.filterPhotos;\n    window.toggleLike = Photos.toggleLike;\n    window.addComment = Photos.addComment;\n    window.deletePhoto = Photos.deletePhoto;\n    window.viewPhoto = Photos.viewPhoto;\n    window.showComments = Photos.showComments;\n    window.sharePhoto = Photos.sharePhoto;\n    window.handleBoozeLensUpload = Photos.handlePhotoUpload;\n    \n    console.log('✅ All functions exposed globally including party functions');\n}\n\n\n// ========================================\n// PARTY EVENT MANAGEMENT SYSTEM\n// ========================================\nclass PartyEventManager {\n    constructor() {\n        this.initialized = false;\n        this.handlers = new Map();\n        this.moduleReady = false;\n    }\n\n    // Initialize the event system\n    async init() {\n        if (this.initialized) return;\n        \n        console.log('🎯 Initializing Party Event Manager');\n        \n        // Wait for party module to be ready\n        await this.waitForModule();\n        \n        // Set up event delegation\n        this.setupEventDelegation();\n        \n        // Set up form handlers\n        this.setupFormHandlers();\n        \n        this.initialized = true;\n        console.log('✅ Party Event Manager initialized');\n    }\n\n    // Wait for party module to load\n    async waitForModule() {\n        const maxAttempts = 50; // 5 seconds max\n        let attempts = 0;\n        \n        while (!window.Parties && attempts < maxAttempts) {\n            await new Promise(resolve => setTimeout(resolve, 100));\n            attempts++;\n        }\n        \n        if (!window.Parties) {\n            throw new Error('Party module failed to load');\n        }\n        \n        this.moduleReady = true;\n    }\n\n    // Set up centralized event delegation\n    setupEventDelegation() {\n        // Remove any existing listeners first\n        if (this.delegationHandler) {\n            document.removeEventListener('click', this.delegationHandler);\n        }\n        \n        // Create delegation handler\n        this.delegationHandler = async (e) => {\n            // Party button handlers\n            const handlers = {\n                '#createPartyBtn': () => this.handleCreateParty(),\n                '#joinPartyBtn': () => this.handleJoinParty(),\n                '#leavePartyBtn': () => this.handleLeaveParty(),\n                '#sendPartyChatBtn': () => this.handleSendChat(),\n                '#refreshPartiesBtn': () => this.handleRefreshParties(),\n                '#refreshFriendsPartiesBtn': () => this.handleRefreshFriendsParties(),\n                '[data-action=\"join-public-party\"]': (target) => this.handleJoinPublicParty(target.dataset.partyCode)\n            };\n            \n            // Check each handler\n            for (const [selector, handler] of Object.entries(handlers)) {\n                const target = e.target.closest(selector);\n                if (target) {\n                    e.preventDefault();\n                    e.stopPropagation();\n                    \n                    if (!this.moduleReady) {\n                        showNotification('App still loading, please wait...', 'warning');\n                        return;\n                    }\n                    \n                    try {\n                        await handler(target);\n                    } catch (error) {\n                        console.error('Event handler error:', error);\n                        showNotification('An error occurred. Please try again.', 'error');\n                    }\n                    break;\n                }\n            }\n        };\n        \n        // Add the delegation handler\n        document.addEventListener('click', this.delegationHandler);\n    }\n\n    // Set up form-specific handlers\n    setupFormHandlers() {\n        // Party chat enter key\n        const chatInput = document.getElementById('partyChatInput');\n        if (chatInput) {\n            chatInput.addEventListener('keypress', (e) => {\n                if (e.key === 'Enter' && !e.shiftKey) {\n                    e.preventDefault();\n                    this.handleSendChat();\n                }\n            });\n        }\n        \n        // Privacy select change\n        const privacySelect = document.getElementById('partyPrivacy');\n        const durationSelect = document.getElementById('partyDuration');\n        if (privacySelect && durationSelect) {\n            privacySelect.addEventListener('change', (e) => {\n                const ongoingOption = durationSelect.querySelector('option[value=\"ongoing\"]');\n                if (!ongoingOption) return;\n                \n                if (e.target.value === 'public') {\n                    ongoingOption.style.display = 'none';\n                    if (durationSelect.value === 'ongoing') {\n                        durationSelect.value = '24h';\n                    }\n                } else {\n                    ongoingOption.style.display = '';\n                }\n            });\n        }\n    }\n\n    // Handle create party\n    async handleCreateParty() {\n        // Check authentication first\n        if (!getCurrentUser()) {\n            showNotification('Please sign in to create a party', 'error');\n            return;\n        }\n        \n        const nameInput = document.getElementById('partyName');\n        const privacySelect = document.getElementById('partyPrivacy');\n        const durationSelect = document.getElementById('partyDuration');\n        const addressInput = document.getElementById('partyAddress');\n        \n        if (!nameInput?.value.trim()) {\n            showNotification('Please enter a party name', 'error');\n            return;\n        }\n        \n        const options = {\n            privacy: privacySelect?.value || 'private',\n            duration: durationSelect?.value || '24h',\n            address: addressInput?.value || ''\n        };\n        \n        try {\n            const result = await Parties.createParty(nameInput.value.trim(), options);\n            if (result.success) {\n                showNotification(`Party created! Code: ${result.code}`, 'success');\n                nameInput.value = '';\n                if (addressInput) addressInput.value = '';\n                updatePartyDisplay();\n            } else {\n                showNotification(result.error || 'Failed to create party', 'error');\n            }\n        } catch (error) {\n            console.error('Create party error:', error);\n            showNotification('Failed to create party', 'error');\n        }\n    }\n\n    // Handle join party\n    async handleJoinParty() {\n        // Check authentication first\n        if (!getCurrentUser()) {\n            showNotification('Please sign in to join a party', 'error');\n            return;\n        }\n        \n        const codeInput = document.getElementById('joinPartyCode');\n        if (!codeInput?.value.trim()) {\n            showNotification('Please enter a party code', 'error');\n            return;\n        }\n        \n        const code = codeInput.value.trim().toUpperCase();\n        \n        try {\n            // Preview party first\n            showNotification('Checking party...', 'info');\n            const party = await Parties.getPartyByCode(code);\n            \n            if (!party) {\n                showNotification('Invalid party code', 'error');\n                return;\n            }\n            \n            // Show confirmation dialog\n            const memberCount = Object.keys(party.members || {}).length;\n            const confirmMsg = `Join \"${party.name}\"?\\n` +\n                `👥 ${memberCount} members\\n` +\n                `🔒 Privacy: ${party.privacy || 'Unknown'}\\n` +\n                `📍 ${party.address || 'No location set'}\\n` +\n                `⏱️ ${party.duration === '24h' ? '24 hour party' : 'Ongoing party'}`;\n            \n            if (!confirm(confirmMsg)) return;\n            \n            const result = await Parties.joinParty(code);\n            if (result.success) {\n                if (result.pending) {\n                    showNotification('Join request sent! Waiting for approval.', 'info');\n                } else if (result.alreadyMember) {\n                    showNotification('Rejoined party!', 'success');\n                } else {\n                    showNotification('Joined party!', 'success');\n                }\n                codeInput.value = '';\n                updatePartyDisplay();\n            } else {\n                showNotification(result.error || 'Failed to join party', 'error');\n            }\n        } catch (error) {\n            console.error('Join party error:', error);\n            showNotification('Failed to join party', 'error');\n        }\n    }\n\n    // Handle leave party\n    async handleLeaveParty() {\n        const currentParty = Parties.currentParty;\n        const currentUser = getCurrentUser();\n        \n        if (!currentParty) return;\n        \n        const isCreator = currentUser && currentParty.creatorId === currentUser.uid;\n        const confirmMsg = isCreator \n            ? 'Delete this party? This will remove all members.' \n            : 'Leave this party?';\n        \n        if (!confirm(confirmMsg)) return;\n        \n        try {\n            const result = isCreator \n                ? await Parties.deleteParty()\n                : await Parties.leaveParty();\n                \n            if (result.success) {\n                showNotification(isCreator ? 'Party deleted' : 'Left party', 'info');\n                updatePartyDisplay();\n            } else {\n                showNotification(result.error || 'Operation failed', 'error');\n            }\n        } catch (error) {\n            console.error('Leave/delete party error:', error);\n            showNotification('Operation failed', 'error');\n        }\n    }\n\n    // Handle send chat\n    async handleSendChat() {\n        const input = document.getElementById('partyChatInput');\n        if (!input?.value.trim()) return;\n        \n        try {\n            const result = await Parties.sendPartyMessage(input.value.trim());\n            if (result.success) {\n                input.value = '';\n            }\n        } catch (error) {\n            console.error('Send chat error:', error);\n            showNotification('Failed to send message', 'error');\n        }\n    }\n\n    // Handle refresh public parties\n    async handleRefreshParties() {\n        const listEl = document.getElementById('publicPartiesList');\n        if (!listEl) return;\n        \n        listEl.innerHTML = '<p style=\"opacity: 0.7;\">Loading parties...</p>';\n        \n        try {\n            const publicParties = await Parties.getNearbyParties();\n            \n            if (publicParties.length === 0) {\n                listEl.innerHTML = '<p style=\"opacity: 0.7;\">No public parties found. Create one!</p>';\n                return;\n            }\n            \n            listEl.innerHTML = publicParties.map(party => `\n                <div class=\"friend-item\" style=\"margin-bottom: 15px;\">\n                    <div class=\"friend-info\">\n                        <div class=\"friend-avatar-small\">🎉</div>\n                        <div class=\"friend-details\">\n                            <h4>${party.name}</h4>\n                            <p style=\"opacity: 0.7;\">\n                                👥 ${party.memberCount} members\n                                ${party.address ? `• 📍 ${party.address}` : ''}\n                                ${party.duration === '24h' ? '• ⏰ 24h party' : ''}\n                            </p>\n                        </div>\n                    </div>\n                    <button class=\"btn btn-primary\" data-action=\"join-public-party\" data-party-code=\"${party.code}\">\n                        Join\n                    </button>\n                </div>\n            `).join('');\n        } catch (error) {\n            console.error('Refresh parties error:', error);\n            listEl.innerHTML = '<p style=\"opacity: 0.7;\">Failed to load parties</p>';\n        }\n    }\n\n    // Handle refresh friends' parties\n    async handleRefreshFriendsParties() {\n        const listEl = document.getElementById('friendsPartiesList');\n        if (!listEl) return;\n        \n        listEl.innerHTML = '<p style=\"opacity: 0.7;\">Loading friends\\' parties...</p>';\n        \n        try {\n            const parties = await Parties.getFriendsParties();\n            \n            if (parties.length === 0) {\n                listEl.innerHTML = '<p style=\"opacity: 0.7;\">No friends\\' parties found.</p>';\n                return;\n            }\n            \n            listEl.innerHTML = parties.map(party => `\n                <div class=\"friend-item\" style=\"margin-bottom: 15px;\">\n                    <div class=\"friend-info\">\n                        <div class=\"friend-avatar-small\">🎉</div>\n                        <div class=\"friend-details\">\n                            <h4>${party.name}</h4>\n                            <p style=\"opacity: 0.7;\">\n                                👤 by ${party.creatorName} • \n                                👥 ${party.memberCount} members\n                                ${party.address ? ` • 📍 ${party.address}` : ''}\n                                ${party.duration === '24h' ? ' • ⏰ 24h party' : ''}\n                            </p>\n                        </div>\n                    </div>\n                    <button class=\"btn btn-primary\" data-action=\"join-public-party\" data-party-code=\"${party.code}\">\n                        Join\n                    </button>\n                </div>\n            `).join('');\n        } catch (error) {\n            console.error('Refresh friends parties error:', error);\n            listEl.innerHTML = '<p style=\"opacity: 0.7;\">Failed to load friends\\' parties</p>';\n        }\n    }\n\n    // Handle join public party\n    async handleJoinPublicParty(code) {\n        if (!code) return;\n        \n        try {\n            const result = await Parties.joinParty(code, true);\n            if (result.success) {\n                showNotification('Joined party!', 'success');\n                updatePartyDisplay();\n                // Refresh the list\n                await this.handleRefreshParties();\n            } else {\n                showNotification(result.error || 'Failed to join party', 'error');\n            }\n        } catch (error) {\n            console.error('Join public party error:', error);\n            showNotification('Failed to join party', 'error');\n        }\n    }\n\n    // Clean up event handlers\n    destroy() {\n        if (this.delegationHandler) {\n            document.removeEventListener('click', this.delegationHandler);\n        }\n        this.handlers.clear();\n        this.initialized = false;\n    }\n}\n\n// Create global instance\nconst partyEventManager = new PartyEventManager();\n\n// ========================================\n// INITIALIZE APP\n// ========================================\ndocument.addEventListener('DOMContentLoaded', async () => {\n    console.log('🚀 Starting BoozeLens app initialization...');\n    \n    try {\n        // Step 1: Initialize Firebase FIRST\n        const firebaseReady = initializeFirebase();\n        if (!firebaseReady) {\n            console.error('Firebase failed to initialize!');\n            showNotification('❌ Failed to connect to Firebase', 'error');\n            return;\n        }\n        console.log('✅ Firebase initialized');\n        \n        // Step 2: Set up party module references\n        Parties = PartiesModule;\n        window.Parties = PartiesModule;\n        console.log('✅ Party module references set');\n        \n        // Step 3: Expose all functions globally\n        exposeGlobalFunctions();\n        console.log('✅ Global functions exposed');\n        \n        // Step 4: Initialize the party event manager\n        await partyEventManager.init().catch(err => {\n            console.error('Failed to initialize party event manager:', err);\n            showNotification('Party features may not work properly', 'warning');\n        });\n        console.log('✅ Party event manager initialized');\n        \n        // Step 5: Handle service workers (non-critical)\n        if ('serviceWorker' in navigator) {\n            navigator.serviceWorker.getRegistrations().then(registrations => {\n                if (registrations.length > 0) {\n                    registrations.forEach(registration => {\n                        registration.unregister();\n                        console.log('Unregistered old service worker:', registration.scope);\n                    });\n                    // Reload after unregistering to ensure clean state\n                    setTimeout(() => {\n                        window.location.reload();\n                    }, 1000);\n                    return;\n                }\n            });\n        }\n        \n        // Step 6: Initialize PWA features (non-critical)\n        try {\n            if (registerServiceWorker) {\n                registerServiceWorker().catch(err => {\n                    console.warn('Service worker registration failed:', err);\n                });\n            }\n            if (initializePWA) {\n                initializePWA();\n            }\n            if (initializeOfflineStorage) {\n                initializeOfflineStorage();\n            }\n        } catch (pwaError) {\n            console.warn('PWA initialization error (non-critical):', pwaError);\n        }\n    \n    // Setup auth form\n    const authForm = document.getElementById('authForm');\n    if (authForm) {\n        authForm.addEventListener('submit', handleAuthSubmit);\n    }\n    \n    // Setup auth listener\n    setupAuthListener(onUserAuthenticated);\n    \n    // Initialize particles\n    createParticles();\n    \n    // Start visualizer\n    setInterval(() => {\n        updateVisualizer();\n    }, 500);\n    \n    // Load drink history from localStorage\n    Drinks.loadDrinkHistory();\n    \n    // Setup drink type selection\n    const drinkTypeSelect = document.getElementById('drinkType');\n    if (drinkTypeSelect) {\n        drinkTypeSelect.addEventListener('change', function() {\n            const preset = DRINK_PRESETS[this.value];\n            document.getElementById('drinkAmount').value = preset.amount;\n            document.getElementById('alcoholPercent').value = preset.alcohol;\n        });\n    }\n    \n    // Setup toggle switches\n    document.querySelectorAll('.toggle-switch input').forEach(input => {\n        input.addEventListener('change', function() {\n            const toggle = this.closest('.toggle-switch');\n            if (this.checked) {\n                toggle.classList.add('active');\n            } else {\n                toggle.classList.remove('active');\n            }\n        });\n    });\n    \n    // Hydration reminders\n    setInterval(() => {\n        const minutes = new Date().getMinutes();\n        if (minutes % 15 === 0) {\n            AllFunctions.showHydrationReminder();\n        }\n    }, 60000);\n    \n    // Window click handlers\n    window.onclick = (event) => {\n        if (event.target.className === 'modal show') {\n            closeModal();\n        }\n        if (event.target.className === 'game-overlay show') {\n            Games.closeGame();\n        }\n    };\n    \n    // Save data and cleanup before unload\n    window.addEventListener('beforeunload', () => {\n        Drinks.saveDrinkHistory();\n        partyEventManager.destroy();\n    });\n    \n    // Error recovery\n    window.addEventListener('unhandledrejection', event => {\n        console.error('Unhandled promise rejection:', event.reason);\n        if (event.reason && event.reason.code && event.reason.code.includes('auth')) {\n            showNotification('⚠️ Authentication issue. Try refreshing.', 'error');\n        }\n    });\n    \n    // Add scroll effect to navigation\n    let lastScroll = 0;\n    window.addEventListener('scroll', () => {\n        const nav = document.querySelector('nav');\n        const currentScroll = window.pageYOffset;\n        \n        if (nav) {\n            if (currentScroll > 50) {\n                nav.classList.add('scrolled');\n            } else {\n                nav.classList.remove('scrolled');\n            }\n        }\n        \n        lastScroll = currentScroll;\n    });\n    \n        console.log('✅ App initialization complete!');\n        \n    } catch (error) {\n        console.error('❌ App initialization failed:', error);\n        showNotification('Failed to initialize app', 'error');\n    }\n});\n\n// ========================================\n// USER AUTHENTICATED\n// ========================================\nasync function onUserAuthenticated(user) {\n    console.log('User authenticated:', user.email);\n    \n    try {\n        // Hide auth screen\n        hideAuthScreen();\n        \n        // Load user data\n        await loadUserData(user);\n        \n        // Initialize features\n        initializeDevices();\n        \n        // Initialize photos module\n        Photos.initializePhotos();\n        \n        // Load achievements\n        Achievements.loadAchievements();\n        \n        // Setup Firebase listeners\n        setupFirebaseListeners();\n        \n        // Load user settings\n        loadUserSettings();\n        \n        // Track first timer achievement\n        Achievements.onFirstLogin();\n        \n        // Clean up old BAC data on login\n        cleanupOldBACData();\n        \n        // Initialize UI\n        updateUI();\n        \n        // Load and display parties\n        await Parties.loadUserParties();\n        updatePartyDisplay();\n        \n        // Set up periodic cleanup (every hour)\n        setInterval(cleanupOldBACData, 60 * 60 * 1000);\n        \n        const userData = getAppState().userData;\n        const displayName = userData.username || user.email.split('@')[0];\n        showNotification(`🎉 Welcome, ${displayName}!`, 'success');\n        \n        // Log UID for developer setup\n        console.log('🔑 Your Firebase UID:', user.uid);\n        if (isDeveloper(user.uid)) {\n            console.log('✅ You have developer rights!');\n            showNotification('🛠️ Developer mode active', 'info');\n            // Enable chat input\n            updateChatUIForDeveloper(true);\n        } else {\n            console.log('💡 To get developer rights, add this UID to DEVELOPER_UIDS in constants.js');\n            // Disable chat input\n            updateChatUIForDeveloper(false);\n        }\n        \n    } catch (error) {\n        console.error('Error during authentication:', error);\n        showNotification('⚠️ Error loading profile', 'error');\n    }\n}\n\n// ========================================\n// FIREBASE LISTENERS\n// ========================================\nfunction setupFirebaseListeners() {\n    const database = getFirebaseDatabase();\n    const currentUser = getCurrentUser();\n    if (!database || !currentUser) return;\n    \n    // Listen for friends\n    onValue(ref(database, 'users/' + currentUser.uid + '/friends'), (snapshot) => {\n        const friendsData = snapshot.val() || {};\n        setStateValue('friendsData', friendsData);\n        AllFunctions.updateFriendsList();\n        document.getElementById('friendCount').textContent = Object.keys(friendsData).length;\n        \n        // Listen to friends' data\n        Object.keys(friendsData).forEach(friendId => {\n            listenToFriend(friendId);\n        });\n    });\n    \n    // Listen for friend requests\n    onValue(ref(database, 'friendRequests/' + currentUser.uid), (snapshot) => {\n        const requests = snapshot.val() || {};\n        const friendRequests = Object.entries(requests).map(([id, data]) => ({\n            id,\n            ...data\n        }));\n        setStateValue('friendRequests', friendRequests);\n        AllFunctions.updateFriendRequests();\n    });\n    \n    // Connection status\n    onValue(ref(database, '.info/connected'), (snapshot) => {\n        const connected = snapshot.val();\n        updateConnectionStatus(connected);\n    });\n    \n    // Listen for main chat messages\n    onValue(ref(database, 'chat'), (snapshot) => {\n        const chatMessages = document.getElementById('chatMessages');\n        if (!chatMessages) return;\n        \n        // Clear current messages except system message\n        chatMessages.innerHTML = `\n            <div class=\"chat-message\">\n                <div class=\"chat-author\">System</div>\n                <div>Welcome to BoozeLens Chat! Stay safe and have fun! 🎉</div>\n            </div>\n        `;\n        \n        if (snapshot.exists()) {\n            const messages = [];\n            snapshot.forEach((child) => {\n                messages.push({ id: child.key, ...child.val() });\n            });\n            \n            // Sort by timestamp and take last 50 messages\n            messages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));\n            const recentMessages = messages.slice(-50);\n            \n            recentMessages.forEach(msg => {\n                const messageDiv = document.createElement('div');\n                messageDiv.className = 'chat-message';\n                messageDiv.style.position = 'relative';\n                const devBadge = msg.isDeveloper ? ' <span style=\"color: #00ff88;\">🛠️</span>' : '';\n                \n                // Add delete button for developers\n                const deleteBtn = isDeveloper(currentUser.uid) ? \n                    `<button onclick=\"deleteMessage('${msg.id}')\" style=\"position: absolute; right: 10px; top: 5px; background: rgba(255,68,68,0.2); border: 1px solid rgba(255,68,68,0.5); color: #ff4444; padding: 2px 8px; border-radius: 5px; cursor: pointer; font-size: 0.8em;\">×</button>` : '';\n                \n                messageDiv.innerHTML = `\n                    ${deleteBtn}\n                    <div class=\"chat-author\">${msg.username || 'Anonymous'}${devBadge}</div>\n                    <div>${escapeHtml(msg.message || '')}</div>\n                `;\n                chatMessages.appendChild(messageDiv);\n            });\n            \n            chatMessages.scrollTop = chatMessages.scrollHeight;\n        }\n    });\n}\n\n// Helper function to escape HTML\nfunction escapeHtml(unsafe) {\n    return unsafe\n        .replace(/&/g, \"&amp;\")\n        .replace(/</g, \"&lt;\")\n        .replace(/>/g, \"&gt;\")\n        .replace(/\"/g, \"&quot;\")\n        .replace(/'/g, \"&#039;\");\n}\n\n// Listen to friend's data\nfunction listenToFriend(friendId) {\n    const database = getFirebaseDatabase();\n    const friendsData = getAppState().friendsData;\n    const permission = friendsData[friendId]?.permission || 'observer';\n    \n    if (permission !== 'none') {\n        onValue(ref(database, 'users/' + friendId), (snapshot) => {\n            const friendData = snapshot.val();\n            if (friendData) {\n                processFriendData(friendId, friendData);\n            }\n        });\n    }\n}\n\n// Process friend data\nfunction processFriendData(friendId, friendData) {\n    const friendsData = getAppState().friendsData;\n    const permission = friendsData[friendId]?.permission || 'observer';\n    \n    // Get friend's device data based on permission\n    if (permission === 'guardian' || permission === 'buddy') {\n        // Can see BAC data\n        Object.keys(friendData.devices || {}).forEach(deviceId => {\n            let partyData = getAppState().partyData;\n            if (!partyData[deviceId]) {\n                partyData[deviceId] = {\n                    name: friendData.username,\n                    bac: 0,\n                    lastUpdate: Date.now(),\n                    location: 'Unknown',\n                    trend: 'steady',\n                    history: [],\n                    isFriend: true,\n                    friendId: friendId,\n                    permission: permission\n                };\n                setStateValue('partyData', partyData);\n            }\n            \n            // Listen to their device readings\n            listenToDevice(deviceId);\n        });\n    }\n}\n\n// Clean up old BAC data\nfunction cleanupOldBACData() {\n    const partyData = getAppState().partyData || {};\n    const cleaned = {};\n    \n    Object.entries(partyData).forEach(([deviceId, data]) => {\n        // Only keep data from last 24 hours\n        if (Date.now() - data.lastUpdate < 24 * 60 * 60 * 1000) {\n            cleaned[deviceId] = data;\n        }\n    });\n    \n    setStateValue('partyData', cleaned);\n}\n\n// Listen to device\nfunction listenToDevice(deviceId) {\n    const database = getFirebaseDatabase();\n    onValue(ref(database, 'readings/' + deviceId), (snapshot) => {\n        const reading = snapshot.val();\n        if (reading) {\n            processDeviceReading(deviceId, reading);\n        }\n    });\n}\n\n// Process device reading\nfunction processDeviceReading(deviceId, reading) {\n    let partyData = getAppState().partyData || {};\n    const userData = getAppState().userData;\n    \n    if (!partyData[deviceId]) {\n        partyData[deviceId] = {\n            name: userData.username || 'You',\n            bac: 0,\n            lastUpdate: Date.now(),\n            location: 'Party',\n            trend: 'steady',\n            history: [],\n            isOwn: true\n        };\n    }\n    \n    const oldBac = partyData[deviceId].bac;\n    partyData[deviceId].bac = reading.bac || 0;\n    partyData[deviceId].lastUpdate = Date.now();\n    partyData[deviceId].trend = reading.bac > oldBac ? 'up' : reading.bac < oldBac ? 'down' : 'steady';\n    \n    // Add to history\n    partyData[deviceId].history.push({\n        time: Date.now(),\n        value: reading.bac\n    });\n    \n    // Keep history reasonable\n    if (partyData[deviceId].history.length > 50) {\n        partyData[deviceId].history.shift();\n    }\n    \n    setStateValue('partyData', partyData);\n    updateUI();\n    \n    // Check for alerts only if reading is less than 24 hours old\n    const isRecent = Date.now() - partyData[deviceId].lastUpdate < 24 * 60 * 60 * 1000;\n    if (isRecent && reading.bac >= 0.08) {\n        showNotification(`⚠️ Your BAC is too high: ${reading.bac.toFixed(3)}‰`, 'error');\n    }\n}\n\n// ========================================\n// UI FUNCTIONS\n// ========================================\nfunction switchSection(sectionId) {\n    try {\n        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));\n        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));\n        \n        const section = document.getElementById(sectionId);\n        if (section) {\n            section.classList.add('active');\n        }\n        \n        // Find and activate the correct nav item\n        const navItems = document.querySelectorAll('.nav-item');\n        navItems.forEach(item => {\n            if (item.onclick && item.onclick.toString().includes(sectionId)) {\n                item.classList.add('active');\n            }\n        });\n        \n        // Close mobile menu\n        const navMenu = document.getElementById('navMenu');\n        if (navMenu) {\n            navMenu.classList.remove('show');\n        }\n        \n        // Section-specific initializations\n        if (sectionId === 'achievements') {\n            Achievements.updateAchievements();\n        } else if (sectionId === 'drinks') {\n            Drinks.updateDrinkStats();\n            Drinks.updateDrinkChart();\n            Drinks.updateDrinkHistory();\n            Drinks.updateEmergencySummary();\n        } else if (sectionId === 'friends') {\n            AllFunctions.updateFriendsList();\n        } else if (sectionId === 'photos') {\n            // Photos feed updates automatically via listener\n            Photos.refreshPhotoFeed();\n        } else if (sectionId === 'settings') {\n            AllFunctions.updateToggleSwitches();\n        } else if (sectionId === 'parties') {\n            updatePartyDisplay();\n            // Refresh public parties\n            document.querySelector('button[onclick*=\"refreshPublicParties\"]')?.click();\n        }\n    } catch (error) {\n        console.error('Section switch failed:', error);\n    }\n}\n\nfunction toggleMobileMenu() {\n    const navMenu = document.getElementById('navMenu');\n    if (navMenu) {\n        navMenu.classList.toggle('show');\n    }\n}\n\nfunction createParticles() {\n    try {\n        const particlesContainer = document.getElementById('particles');\n        if (!particlesContainer) return;\n        \n        for (let i = 0; i < 50; i++) {\n            const particle = document.createElement('div');\n            particle.className = 'particle';\n            particle.style.left = Math.random() * 100 + '%';\n            particle.style.animationDelay = Math.random() * 20 + 's';\n            particle.style.animationDuration = (15 + Math.random() * 10) + 's';\n            particlesContainer.appendChild(particle);\n        }\n    } catch (error) {\n        console.error('Particle creation failed:', error);\n    }\n}\n\nfunction updateVisualizer() {\n    const visualizer = document.getElementById('visualizer');\n    if (!visualizer || !document.getElementById('dashboard').classList.contains('active')) return;\n    \n    if (visualizer.children.length === 0) {\n        for (let i = 0; i < 20; i++) {\n            const bar = document.createElement('div');\n            bar.className = 'bar';\n            visualizer.appendChild(bar);\n        }\n    }\n    \n    visualizer.querySelectorAll('.bar').forEach(bar => {\n        const height = Math.random() * 150 + 20;\n        bar.style.height = height + 'px';\n    });\n}\n\nfunction updateConnectionStatus(connected) {\n    const statusElement = document.getElementById('connectionStatus');\n    const dotElement = document.querySelector('.status-dot');\n    \n    if (statusElement && dotElement) {\n        if (connected) {\n            statusElement.textContent = 'Connected';\n            dotElement.style.background = '#00ff88';\n        } else {\n            statusElement.textContent = 'Offline';\n            dotElement.style.background = '#ff4444';\n        }\n    }\n}\n\n// ========================================\n// MODAL FUNCTIONS\n// ========================================\nasync function showModal(type, data = null) {\n    const modal = document.getElementById('modal');\n    const modalBody = document.getElementById('modalBody');\n    \n    let content = '';\n    \n    switch(type) {\n        case 'pair-device':\n            const deviceData = getAppState().deviceData || {};\n            const hasDevices = Object.keys(deviceData).length > 0;\n            \n            content = `\n                <h2>📱 Pair New Device</h2>\n                <p>After setting up your breathalyzer, enter the Device ID shown on its screen:</p>\n                \n                <div class=\"form-group\" style=\"margin: 20px 0;\">\n                    <input type=\"text\" id=\"modalDeviceId\" placeholder=\"Enter Device ID (e.g., HSG_abc123)\" style=\"text-transform: uppercase;\">\n                </div>\n                \n                <button class=\"btn btn-primary\" onclick=\"pairDeviceFromModal()\">\n                    <i class=\"fas fa-link\"></i> Pair Device\n                </button>\n                <button class=\"btn\" onclick=\"closeModal()\">Cancel</button>\n                \n                <div class=\"info-box\" style=\"margin-top: 20px;\">\n                    <p><strong>Can't find your Device ID?</strong></p>\n                    <ol>\n                        <li>Power on your device</li>\n                        <li>Double-flip the switch for setup mode</li>\n                        <li>Connect to the device's WiFi</li>\n                        <li>Complete setup to see your Device ID</li>\n                    </ol>\n                </div>\n                \n                ${hasDevices ? `\n                    <div class=\"paired-devices\" style=\"margin-top: 30px;\">\n                        <h3>My Paired Devices</h3>\n                        <div id=\"modalDeviceList\">\n                            ${Object.entries(deviceData).map(([deviceId, device]) => {\n                                const partyData = getAppState().partyData || {};\n                                const lastReading = partyData[deviceId];\n                                return `\n                                    <div class=\"device-item\" style=\"padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;\">\n                                        <div style=\"display: flex; justify-content: space-between; align-items: center; gap: 15px;\">\n                                            <div style=\"flex: 1;\">\n                                                <h4 style=\"margin: 0 0 5px 0;\">${device.name || 'My Breathalyzer'}</h4>\n                                                <p style=\"margin: 0; opacity: 0.7; font-size: 0.9em;\">ID: ${deviceId}</p>\n                                                <p style=\"margin: 0; opacity: 0.7; font-size: 0.9em;\">Last Reading: ${lastReading ? lastReading.bac.toFixed(3) + '‰' : 'No data'}</p>\n                                            </div>\n                                            <div style=\"display: flex; gap: 8px;\">\n                                                <button class=\"btn\" onclick=\"renameDevice('${deviceId}')\" title=\"Rename\">\n                                                    <i class=\"fas fa-edit\"></i>\n                                                </button>\n                                                <button class=\"btn btn-danger\" onclick=\"unpairDevice('${deviceId}')\" title=\"Unpair\">\n                                                    <i class=\"fas fa-unlink\"></i>\n                                                </button>\n                                            </div>\n                                        </div>\n                                    </div>\n                                `;\n                            }).join('')}\n                        </div>\n                    </div>\n                ` : ''}\n            `;\n            break;\n            \n        case 'checkin':\n            const party = Parties.currentParty;\n            \n            content = `\n                <h2>📍 Check In</h2>\n                <p>Select your current location:</p>\n                <div class=\"location-map\" id=\"locationMap\">\n                    <!-- Simulated map -->\n                </div>\n                <div style=\"margin: 20px 0;\">\n                    ${party ? `\n                        <button class=\"btn btn-primary\" style=\"width: 100%; margin: 10px 0;\" onclick=\"checkInLocation('Party: ${party.name}')\">\n                            <i class=\"fas fa-champagne-glasses\"></i> ${party.name}\n                        </button>\n                    ` : ''}\n                    ${['Dorm A - Room Party', 'Student Bar', 'Library Cafe', 'Sports Center', 'Main Campus', 'Off Campus'].map(loc => \n                        `<button class=\"btn\" style=\"width: 100%; margin: 10px 0;\" onclick=\"checkInLocation('${loc}')\">${loc}</button>`\n                    ).join('')}\n                </div>\n                <button class=\"btn\" onclick=\"closeModal()\">Cancel</button>\n            `;\n            break;\n            \n        case 'emergency':\n            content = `\n                <h2>🚨 Emergency Contacts</h2>\n                <div style=\"margin: 20px 0;\">\n                    <p><strong>Ambulance:</strong> 112</p>\n                    <p><strong>HSG Security:</strong> +41 71 224 2424</p>\n                    <p><strong>Poison Control:</strong> 145</p>\n                    <p><strong>Mental Health Crisis:</strong> 143</p>\n                </div>\n                <button class=\"btn btn-danger\" onclick=\"window.location.href='tel:112'\">\n                    <i class=\"fas fa-phone\"></i> Call 112 Now\n                </button>\n                <button class=\"btn\" onclick=\"showFirstAid()\">\n                    <i class=\"fas fa-medkit\"></i> First Aid Guide\n                </button>\n                <button class=\"btn\" onclick=\"closeModal()\">Close</button>\n            `;\n            break;\n            \n        case 'first-aid':\n            content = `\n                <h2>🏥 First Aid Guide</h2>\n                <div class=\"first-aid-card\">\n                    <h3>Signs of Alcohol Poisoning:</h3>\n                    <ul>\n                        <li>Confusion, stupor</li>\n                        <li>Vomiting</li>\n                        <li>Seizures</li>\n                        <li>Slow or irregular breathing</li>\n                        <li>Unconsciousness</li>\n                    </ul>\n                </div>\n                <div class=\"first-aid-card\">\n                    <h3>What to Do:</h3>\n                    <div class=\"first-aid-step\" data-step=\"1\">Call 112 immediately</div>\n                    <div class=\"first-aid-step\" data-step=\"2\">Keep them awake and sitting up</div>\n                    <div class=\"first-aid-step\" data-step=\"3\">Give them water if conscious</div>\n                    <div class=\"first-aid-step\" data-step=\"4\">Keep them warm</div>\n                    <div class=\"first-aid-step\" data-step=\"5\">Stay with them</div>\n                </div>\n                <button class=\"btn btn-danger\" onclick=\"window.location.href='tel:112'\">Emergency Call</button>\n                <button class=\"btn\" onclick=\"closeModal()\">Close</button>\n            `;\n            break;\n            \n        case 'buddy-system':\n            const partyData = getAppState().partyData;\n            content = `\n                <h2>👥 Buddy System</h2>\n                <p>Choose your buddy for tonight:</p>\n                <div class=\"buddy-list\">\n                    ${Object.values(partyData).map(friend => `\n                        <div class=\"buddy-card\" onclick=\"selectBuddy('${friend.name}')\">\n                            <div style=\"font-size: 2em; margin-bottom: 10px;\">${friend.isOwn ? '👤' : '👥'}</div>\n                            <div>${friend.name}</div>\n                        </div>\n                    `).join('')}\n                </div>\n                <button class=\"btn\" onclick=\"closeModal()\">Close</button>\n            `;\n            break;\n            \n        case 'safe-friends':\n            const partyDataSafe = getAppState().partyData;\n            const safeFriends = Object.values(partyDataSafe).filter(f => f.bac < 0.02);\n            content = `\n                <h2>✅ Friends Safe to Drive</h2>\n                <div style=\"margin: 20px 0;\">\n                    ${safeFriends.length > 0 ? safeFriends.map(friend => `\n                        <div class=\"buddy-card\" style=\"margin: 10px 0;\">\n                            <div>${friend.name}</div>\n                            <div>BAC: ${friend.bac.toFixed(3)}‰</div>\n                        </div>\n                    `).join('') : '<p>No friends are currently safe to drive.</p>'}\n                </div>\n                <button class=\"btn\" onclick=\"closeModal()\">Close</button>\n            `;\n            break;\n            \n        case 'locations':\n            content = `\n                <h2>📍 Active Party Locations</h2>\n                <div class=\"location-map\" style=\"height: 400px;\">\n                    ${AllFunctions.createLocationMap()}\n                </div>\n                <div style=\"margin: 20px 0;\">\n                    ${AllFunctions.getActiveLocations().map(loc => `\n                        <div class=\"buddy-card\" style=\"margin: 10px 0;\">\n                            <div><strong>${loc.name}</strong></div>\n                            <div>${loc.count} people</div>\n                            <div>Avg BAC: ${loc.avgBac.toFixed(3)}‰</div>\n                        </div>\n                    `).join('')}\n                </div>\n                <button class=\"btn\" onclick=\"closeModal()\">Close</button>\n            `;\n            break;\n    }\n    \n    modalBody.innerHTML = content;\n    modal.classList.add('show');\n    \n    // Initialize location map if needed\n    if (type === 'checkin' || type === 'locations') {\n        setTimeout(AllFunctions.initializeLocationMap, 100);\n    }\n}\n\nfunction closeModal() {\n    document.getElementById('modal').classList.remove('show');\n}\n\n// ========================================\n// LOAD USER SETTINGS\n// ========================================\nfunction loadUserSettings() {\n    const userData = getAppState().userData;\n    \n    // Load from Firebase\n    if (userData.settings) {\n        const settings = userData.settings;\n        \n        if (settings.shareLocation !== undefined) {\n            document.getElementById('shareLocation').checked = settings.shareLocation;\n        }\n        if (settings.notifications !== undefined) {\n            document.getElementById('notifications').checked = settings.notifications;\n        }\n        if (settings.publicProfile !== undefined) {\n            document.getElementById('publicProfile').checked = settings.publicProfile;\n        }\n    }\n    \n    // Load emergency info\n    if (userData.emergency) {\n        const emergency = userData.emergency;\n        \n        if (emergency.homeAddress) {\n            document.getElementById('homeAddress').value = emergency.homeAddress;\n            localStorage.setItem('homeAddress', emergency.homeAddress);\n        }\n        if (emergency.emergencyContact) {\n            document.getElementById('emergencyContact').value = emergency.emergencyContact;\n            localStorage.setItem('emergencyContact', emergency.emergencyContact);\n        }\n        if (emergency.medicalInfo) {\n            document.getElementById('medicalInfo').value = emergency.medicalInfo;\n            localStorage.setItem('medicalInfo', emergency.medicalInfo);\n        }\n        if (emergency.safetyNotes) {\n            document.getElementById('safetyNotes').value = emergency.safetyNotes;\n            localStorage.setItem('safetyNotes', emergency.safetyNotes);\n        }\n    }\n    \n    // Update toggle switches visual state\n    AllFunctions.updateToggleSwitches();\n}\n\n// ENHANCED party display update\nfunction updatePartyDisplay() {\n    // Delegate to the safe implementation\n    safeUpdatePartyDisplay(Parties);\n}\n\n// Update party chat\nfunction updatePartyChat(messages) {\n    const chatEl = document.getElementById('partyChat');\n    if (!chatEl) return;\n    \n    chatEl.innerHTML = messages.map(msg => `\n        <div style=\"margin-bottom: 10px;\">\n            <strong style=\"color: #00ff88;\">${msg.userName}:</strong>\n            <span>${msg.message}</span>\n            <span style=\"opacity: 0.5; font-size: 0.8em; margin-left: 10px;\">\n                ${new Date(msg.timestamp).toLocaleTimeString()}\n            </span>\n        </div>\n    `).join('');\n    \n    // Scroll to bottom\n    chatEl.scrollTop = chatEl.scrollHeight;\n}\n\n// Update party leaderboard\nasync function updatePartyLeaderboard() {\n    const leaderboardEl = document.getElementById('partyLeaderboard');\n    if (!leaderboardEl || !Parties || !Parties.currentParty) return;\n    \n    leaderboardEl.innerHTML = '<p style=\"opacity: 0.7;\">Loading leaderboard...</p>';\n    \n    const leaderboard = await Parties.getPartyLeaderboard();\n    \n    if (leaderboard.length === 0) {\n        leaderboardEl.innerHTML = '<p style=\"opacity: 0.7;\">No BAC data yet</p>';\n        return;\n    }\n    \n    leaderboardEl.innerHTML = leaderboard.map((member, index) => {\n        const position = index + 1;\n        let badge = '';\n        if (position === 1) badge = '🥇';\n        else if (position === 2) badge = '🥈';\n        else if (position === 3) badge = '🥉';\n        \n        return `\n            <div class=\"friend-item\" style=\"margin-bottom: 10px;\">\n                <div class=\"friend-info\">\n                    <div style=\"font-size: 2em; margin-right: 15px;\">${badge || position}</div>\n                    <div class=\"friend-avatar-small\">${member.role === 'creator' ? '👑' : '👤'}</div>\n                    <div class=\"friend-details\">\n                        <h4>${member.name}</h4>\n                        <p style=\"opacity: 0.7;\">BAC: ${member.bac.toFixed(3)}‰</p>\n                    </div>\n                </div>\n            </div>\n        `;\n    }).join('');\n}\n\n// Handle party join request\nasync function handlePartyRequest(userId, approve) {\n    const result = await Parties.handleJoinRequest(userId, approve);\n    if (result.success) {\n        showNotification(approve ? 'Request approved!' : 'Request declined', 'success');\n        updatePartyDisplay();\n    } else {\n        showNotification(result.error || 'Failed to handle request', 'error');\n    }\n}\n\n// Kick member from party\nasync function kickMemberFromParty(memberId, memberName) {\n    const confirmMsg = `Kick ${memberName} from the party?`;\n    if (!confirm(confirmMsg)) return;\n    \n    const reason = prompt('Reason for kick (optional):') || '';\n    \n    const result = await Parties.kickMember(memberId, reason);\n    if (result.success) {\n        showNotification(`${memberName} has been removed from the party`, 'info');\n        updatePartyDisplay();\n    } else {\n        showNotification(result.error || 'Failed to kick member', 'error');\n    }\n}\n\n// Toggle party lock UI\nasync function togglePartyLockUI() {\n    if (!Parties.currentParty) return;\n    \n    const isLocked = Parties.currentParty.locked;\n    const confirmMsg = isLocked \n        ? 'Unlock the party? New members will be able to join.' \n        : 'Lock the party? No new members will be able to join.';\n    \n    if (!confirm(confirmMsg)) return;\n    \n    const result = await Parties.togglePartyLock(!isLocked);\n    if (result.success) {\n        showNotification(result.locked ? 'Party locked' : 'Party unlocked', 'info');\n        updatePartyDisplay();\n    } else {\n        showNotification(result.error || 'Failed to update party lock', 'error');\n    }\n}\n\n// Edit party settings UI\nfunction editPartySettings() {\n    const party = Parties.currentParty;\n    if (!party) return;\n    \n    const newName = prompt('Party name:', party.name);\n    if (newName && newName !== party.name) {\n        Parties.updatePartySettings({ name: newName }).then(result => {\n            if (result.success) {\n                showNotification('Party name updated', 'success');\n                updatePartyDisplay();\n            } else {\n                showNotification(result.error || 'Failed to update', 'error');\n            }\n        });\n    }\n}\n\n\n// Update chat UI based on developer status\nfunction updateChatUIForDeveloper(isDev) {\n    const chatInput = document.getElementById('chatInput');\n    const sendButton = document.querySelector('.chat-input button');\n    \n    if (chatInput && sendButton) {\n        if (isDev) {\n            chatInput.placeholder = \"Type a message... (Dev mode 🛠️)\";\n            chatInput.disabled = false;\n            sendButton.disabled = false;\n            chatInput.style.opacity = '1';\n            sendButton.style.opacity = '1';\n        } else {\n            chatInput.placeholder = \"Chat is read-only (Developers only)\";\n            chatInput.disabled = true;\n            sendButton.disabled = true;\n            chatInput.style.opacity = '0.5';\n            sendButton.style.opacity = '0.5';\n        }\n    }\n}\n\n// Delete chat message (developers only)\nasync function deleteMessage(messageId) {\n    const currentUser = getCurrentUser();\n    if (!currentUser || !isDeveloper(currentUser.uid)) {\n        showNotification('Not authorized', 'error');\n        return;\n    }\n    \n    const database = getFirebaseDatabase();\n    if (!database) return;\n    \n    try {\n        await remove(ref(database, `chat/${messageId}`));\n        showNotification('Message deleted', 'info');\n    } catch (error) {\n        console.error('Delete message error:', error);\n        showNotification('Failed to delete message', 'error');\n    }\n}\n\n// Expose globally\nwindow.updatePartyDisplay = updatePartyDisplay;\nwindow.updatePartyChat = updatePartyChat;\nwindow.updatePartyLeaderboard = updatePartyLeaderboard;\nwindow.handlePartyRequest = handlePartyRequest;\nwindow.kickMemberFromParty = kickMemberFromParty;\nwindow.updateChatUIForDeveloper = updateChatUIForDeveloper;\nwindow.deleteMessage = deleteMessage;\n\n// Developer function to delete any party\nasync function deletePartyAsDev(partyId) {\n    const currentUser = getCurrentUser();\n    if (!currentUser || !isDeveloper(currentUser.uid)) {\n        showNotification('Not authorized', 'error');\n        return;\n    }\n    \n    if (!confirm('Developer action: Delete this party permanently?')) {\n        return;\n    }\n    \n    try {\n        const result = await Parties.deleteParty(partyId);\n        if (result.success) {\n            showNotification('Party deleted', 'success');\n            // Refresh the public parties list\n            if (window.refreshPublicParties) {\n                window.refreshPublicParties();\n            }\n        } else {\n            showNotification(result.error || 'Failed to delete party', 'error');\n        }\n    } catch (error) {\n        showNotification('Failed to delete party', 'error');\n    }\n}\nwindow.deletePartyAsDev = deletePartyAsDev;\nwindow.switchToParty = (partyId) => {\n    if (Parties && Parties.switchToParty) {\n        Parties.switchToParty(partyId);\n    }\n};\n\n// Add party switcher UI\nfunction addPartySwitcher() {\n    const userParties = Parties.userParties || [];\n    const currentParty = Parties.currentParty;\n    \n    // Remove old switcher if exists\n    const oldSwitcher = document.getElementById('partySwitcher');\n    if (oldSwitcher) {\n        oldSwitcher.remove();\n    }\n    \n    // Create new switcher\n    const switcher = document.createElement('div');\n    switcher.id = 'partySwitcher';\n    switcher.style.cssText = 'position: fixed; top: 80px; right: 20px; background: rgba(0,0,0,0.95); border: 2px solid #00ff88; border-radius: 10px; padding: 15px; z-index: 1000; max-width: 250px; box-shadow: 0 4px 20px rgba(0,255,136,0.3); max-height: 400px; overflow-y: auto;';\n    \n    document.body.appendChild(switcher);\n    \n    // Update switcher content\n    switcher.innerHTML = `\n        <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;\">\n            <h4 style=\"margin: 0; color: #00ff88;\">My Parties (${userParties.length})</h4>\n            <button onclick=\"document.getElementById('partySwitcher').remove()\" \n                    style=\"background: none; border: none; color: #fff; cursor: pointer; font-size: 20px;\">×</button>\n        </div>\n        ${userParties.map(party => {\n            const memberCount = party.members ? Object.keys(party.members).length : 0;\n            const isActive = currentParty && currentParty.id === party.id;\n            return `\n                <button class=\"btn ${isActive ? 'btn-primary' : ''}\" \n                        style=\"display: block; width: 100%; margin: 5px 0; text-align: left; padding: 10px;\"\n                        onclick=\"switchToParty('${party.id}')\">\n                    <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n                        <span>🎉 ${party.name}</span>\n                        <span style=\"font-size: 0.8em; opacity: 0.7;\">${memberCount} 👥</span>\n                    </div>\n                    ${isActive ? '<small style=\"color: #00ff88;\">Currently viewing</small>' : ''}\n                </button>\n            `;\n        }).join('')}\n    `;\n}\nwindow.togglePartyLockUI = togglePartyLockUI;\nwindow.editPartySettings = editPartySettings;"],"file":"assets/index-BHS5ZQeh.js"}