<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSG Party Tracker ðŸŽ‰ | Live BAC Monitor</title>
    
    <!-- Firebase SDK v9 -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-gradient: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460);
            --accent-gradient: linear-gradient(45deg, #00ff88, #00d4ff, #ff00ff);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --error-bg: rgba(255, 68, 68, 0.9);
            --success-bg: rgba(0, 255, 136, 0.9);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Animated background */
        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            z-index: -2;
            animation: gradient 15s ease infinite;
            background-size: 400% 400%;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Floating particles */
        .particles {
            position: fixed;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }
        
        @keyframes float {
            from {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            to {
                transform: translateY(-100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* Navigation Menu */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            z-index: 1000;
            padding: 15px 0;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .logo {
            font-size: 1.5em;
            font-weight: bold;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-menu {
            display: flex;
            gap: 30px;
            list-style: none;
        }
        
        .nav-item {
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: none;
            background: transparent;
            color: white;
            font-size: 1em;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--accent-gradient);
            transition: left 0.3s ease;
            z-index: -1;
        }
        
        .nav-item:hover::before {
            left: 0;
        }
        
        .nav-item:hover {
            color: #000;
            transform: translateY(-2px);
        }
        
        .nav-item.active {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
        }
        
        /* Mobile menu toggle - make it visible */
        .mobile-menu-toggle {
            display: none;
            font-size: 1.5em;
            cursor: pointer;
            color: white;
            background: none;
            border: none;
        }
        
        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 10px 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            z-index: 100;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ff88;
        }
        
        /* User Profile Widget */
        .user-profile {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 15px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            font-size: 0.9em;
            z-index: 100;
            min-width: 200px;
        }
        
        .user-profile h4 {
            margin-bottom: 10px;
            color: #00ff88;
        }
        
        .user-profile p {
            margin: 5px 0;
            opacity: 0.8;
        }
        
        .user-profile button {
            margin-top: 10px;
            width: 100%;
        }
        
        /* Alert Banner */
        .alert-banner {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            background: rgba(255, 68, 68, 0.9);
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 999;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        
        .alert-banner.show {
            transform: translateY(0);
        }
        
        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 20px 20px;
        }
        
        /* Header */
        header {
            text-align: center;
            padding: 40px 0;
            position: relative;
        }
        
        h1 {
            font-size: 4em;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: glow 2s ease-in-out infinite alternate;
            margin-bottom: 10px;
        }
        
        @keyframes glow {
            from { filter: drop-shadow(0 0 20px rgba(0, 255, 136, 0.5)); }
            to { filter: drop-shadow(0 0 30px rgba(0, 212, 255, 0.8)); }
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.8;
            margin-bottom: 30px;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 40px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 30px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #00ff88, #00d4ff);
            color: #000;
            font-weight: bold;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff4444, #ff0088);
        }
        
        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Dashboard Grid */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        /* Cards */
        .card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 255, 136, 0.5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--accent-gradient);
            border-radius: 20px;
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s ease;
        }
        
        .card:hover::before {
            opacity: 0.3;
        }
        
        /* Friend Cards with Animation */
        .friend-card {
            cursor: pointer;
            position: relative;
        }
        
        .friend-card.pulse {
            animation: cardPulse 0.5s ease;
        }
        
        @keyframes cardPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .friend-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            margin-bottom: 15px;
        }
        
        .friend-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .bac-value {
            font-size: 3em;
            font-weight: bold;
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
            display: flex;
            align-items: baseline;
            gap: 10px;
        }
        
        .bac-trend {
            font-size: 0.5em;
        }
        
        .trend-up { color: #ff4444; }
        .trend-down { color: #00ff88; }
        
        .bac-safe { color: #00ff88; }
        .bac-caution { color: #ffcc00; }
        .bac-danger { color: #ff4444; }
        .bac-critical { 
            color: #ff0088;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            50% { opacity: 0.5; }
        }
        
        .friend-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .location-tag {
            font-size: 0.9em;
            opacity: 0.7;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Party Stats */
        .party-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .stat-card {
            background: var(--glass-bg);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .stat-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        /* Games Section */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .game-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .game-card:hover {
            transform: translateY(-10px) rotateZ(-2deg);
            box-shadow: 0 20px 40px rgba(0, 255, 136, 0.3);
        }
        
        .game-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .game-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .game-players {
            opacity: 0.7;
            font-size: 0.9em;
        }
        
        /* Achievements */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 40px 0;
        }
        
        .achievement {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .achievement.unlocked {
            background: rgba(0, 255, 136, 0.1);
            border-color: rgba(0, 255, 136, 0.5);
            animation: achievementUnlock 0.5s ease;
        }
        
        @keyframes achievementUnlock {
            0% { transform: scale(0) rotate(180deg); }
            50% { transform: scale(1.2) rotate(360deg); }
            100% { transform: scale(1) rotate(360deg); }
        }
        
        .achievement-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
            filter: grayscale(1);
            transition: filter 0.3s ease;
        }
        
        .achievement.unlocked .achievement-icon {
            filter: grayscale(0);
        }
        
        .achievement-name {
            font-size: 0.9em;
            font-weight: bold;
        }
        
        /* Music Visualizer */
        .visualizer {
            height: 200px;
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            gap: 5px;
        }
        
        .bar {
            width: 100%;
            background: var(--accent-gradient);
            border-radius: 5px 5px 0 0;
            transition: height 0.1s ease;
        }
        
        /* Chat Section */
        .chat-container {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 20px;
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
        }
        
        .chat-message {
            margin-bottom: 15px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            animation: slideIn 0.3s ease;
        }
        
        .chat-message.own {
            background: rgba(0, 255, 136, 0.2);
            text-align: right;
        }
        
        .chat-author {
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .chat-input {
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid var(--glass-border);
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1em;
        }
        
        /* Emergency Section */
        .emergency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .emergency-card {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .emergency-card:hover {
            transform: scale(1.05);
            background: rgba(255, 68, 68, 0.2);
            box-shadow: 0 10px 30px rgba(255, 68, 68, 0.3);
        }
        
        .emergency-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        /* Leaderboard */
        .leaderboard {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 40px;
        }
        
        .leaderboard h2 {
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(10px);
        }
        
        .rank {
            font-size: 1.5em;
            font-weight: bold;
            width: 50px;
        }
        
        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            animation: modalIn 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(0, 255, 136, 0.9);
            color: #000;
            padding: 15px 25px;
            border-radius: 10px;
            animation: slideInRight 0.3s ease;
            z-index: 3000;
            cursor: pointer;
            max-width: 300px;
        }
        
        .notification.error {
            background: var(--error-bg);
            color: white;
        }
        
        .notification.success {
            background: var(--success-bg);
            color: #000;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }
        
        /* Auth Container */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
        }
        
        .auth-box {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            animation: modalIn 0.5s ease;
        }
        
        .auth-box h2 {
            text-align: center;
            margin-bottom: 30px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 20px;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1em;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.2);
        }
        
        .auth-error {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid rgba(255, 68, 68, 0.5);
            color: #ff4444;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
            display: none;
        }
        
        .auth-error.show {
            display: block;
            animation: shake 0.5s ease;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            opacity: 0.8;
        }
        
        .auth-toggle a {
            color: #00ff88;
            text-decoration: none;
            cursor: pointer;
        }
        
        .auth-toggle a:hover {
            text-decoration: underline;
        }
        
        /* Loading state */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00ff88;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .auth-loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .auth-loading.show {
            display: block;
        }
        
        /* Device Management */
        .device-list {
            display: grid;
            gap: 15px;
            margin: 20px 0;
        }
        
        .device-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .device-info h4 {
            margin-bottom: 5px;
            color: #00ff88;
        }
        
        .device-info p {
            opacity: 0.7;
            font-size: 0.9em;
        }
        
        .pairing-code-display {
            background: rgba(0, 255, 136, 0.1);
            border: 2px dashed rgba(0, 255, 136, 0.5);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
        }
        
        .pairing-code {
            font-size: 2.5em;
            font-weight: bold;
            font-family: monospace;
            letter-spacing: 0.2em;
            color: #00ff88;
            margin: 20px 0;
        }
        
        /* Friends System */
        .friends-search {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .search-input {
            flex: 1;
            padding: 15px 25px;
            border: 2px solid var(--glass-border);
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #00ff88;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }
        
        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        .friend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .friend-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(5px);
        }
        
        .friend-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .friend-avatar-small {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }
        
        .friend-details h4 {
            margin-bottom: 5px;
        }
        
        .friend-details p {
            opacity: 0.7;
            font-size: 0.9em;
        }
        
        .friend-actions {
            display: flex;
            gap: 10px;
        }
        
        .permission-select {
            padding: 8px 15px;
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 0.9em;
            cursor: pointer;
        }
        
        .friend-permission {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-left: 10px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .permission-observer { color: #ffcc00; }
        .permission-buddy { color: #00d4ff; }
        .permission-guardian { color: #00ff88; }
        
        /* Friend Request */
        .friend-request {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            padding: 15px;
            border-radius: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Collapsible Chart Container */
        .chart-container {
            position: relative;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .chart-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 5px 15px;
            cursor: pointer;
            font-size: 0.9em;
            z-index: 10;
        }
        
        .chart-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .chart-wrapper {
            height: 250px;
            transition: height 0.3s ease;
            overflow: hidden;
        }
        
        .chart-wrapper.collapsed {
            height: 0;
        }
        
        /* Info Box */
        .info-box {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 212, 255, 0.1));
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .info-box h3 {
            margin-bottom: 15px;
            color: #00ff88;
        }
        
        .info-box p {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .info-box code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        /* Settings/Profile Section */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 40px;
            padding: 30px;
            background: var(--glass-bg);
            border-radius: 20px;
            border: 1px solid var(--glass-border);
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .profile-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }
        
        .profile-info h2 {
            margin-bottom: 10px;
            font-size: 2em;
        }
        
        .profile-info p {
            opacity: 0.8;
            margin: 5px 0;
        }
        
        .settings-grid {
            display: grid;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .settings-section {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
        }
        
        .settings-section h3 {
            margin-bottom: 20px;
            color: #00ff88;
            font-size: 1.5em;
        }
        
        .settings-form {
            display: grid;
            gap: 20px;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            opacity: 0.9;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 20px;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #00ff88;
            background: rgba(255, 255, 255, 0.08);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .toggle-group:last-child {
            border-bottom: none;
        }
        
        .toggle-label {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .toggle-label span {
            font-weight: 600;
        }
        
        .toggle-label small {
            opacity: 0.7;
            font-size: 0.9em;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .toggle-switch input:checked + .toggle-slider {
            transform: translateX(30px);
        }
        
        .toggle-switch input:checked ~ .toggle-switch {
            background: #00ff88;
        }
        
        .toggle-switch.active {
            background: #00ff88;
        }
        
        .linked-accounts {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }
        
        .account-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .account-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .account-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }
        
        .phone-icon { background: rgba(0, 255, 136, 0.2); }
        .email-icon { background: rgba(0, 212, 255, 0.2); }
        
        /* Mobile-First Responsive Design */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
            
            .nav-menu {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: rgba(0, 0, 0, 0.95);
                flex-direction: column;
                padding: 20px;
                gap: 10px;
                border-radius: 0 0 20px 20px;
            }
            
            .nav-menu.show {
                display: flex;
            }
            
            .user-profile {
                position: static;
                margin: 20px auto;
                max-width: 300px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .party-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .games-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .achievements-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .emergency-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .friend-card {
                padding: 20px;
            }
            
            .bac-value {
                font-size: 2em;
            }
            
            .stat-value {
                font-size: 1.5em;
            }
            
            .modal-content {
                margin: 20px;
                padding: 20px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .game-container {
                padding: 20px;
            }
            
            .timer-display {
                font-size: 3em;
            }
            
            .question-card {
                font-size: 1.2em;
                padding: 20px;
            }
            
            .leaderboard h2 {
                font-size: 1.5em;
            }
            
            /* Fix drink section on mobile */
            #drinks .card {
                padding: 15px;
            }
            
            #drinkType, #drinkAmount, #alcoholPercent {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .container {
                padding: 80px 10px 20px;
            }
            
            /* Fix overlapping elements */
            .connection-status {
                bottom: 80px;
                font-size: 0.8em;
            }
            
            /* Better touch targets */
            .nav-item, .btn, .card {
                min-height: 44px;
                display: flex;
                align-items: center;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-avatar {
                width: 100px;
                height: 100px;
                font-size: 2.5em;
            }
        }
        
        /* Tablet adjustments */
        @media (min-width: 769px) and (max-width: 1024px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .games-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* Prevent horizontal scroll on mobile */
        html, body {
            overflow-x: hidden;
            max-width: 100%;
        }
        
        /* Fix iOS button styles */
        input, select, button {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        /* Better mobile form inputs */
        input[type="number"],
        input[type="text"],
        input[type="tel"],
        input[type="email"],
        input[type="password"],
        select {
            font-size: 16px;
            padding: 12px;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Loading state */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Error state */
        .error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            color: #ff4444;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00ff88;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Game Overlay */
        .game-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .game-overlay.show {
            display: flex;
        }
        
        .game-container {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: gameIn 0.5s ease;
        }
        
        @keyframes gameIn {
            from {
                opacity: 0;
                transform: scale(0.8) rotateX(30deg);
            }
            to {
                opacity: 1;
                transform: scale(1) rotateX(0);
            }
        }
        
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .game-title {
            font-size: 2em;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .close-game {
            font-size: 2em;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s ease;
        }
        
        .close-game:hover {
            opacity: 1;
            transform: rotate(90deg);
        }
        
        /* Timer Display */
        .timer-display {
            font-size: 4em;
            font-weight: bold;
            text-align: center;
            margin: 30px 0;
            font-variant-numeric: tabular-nums;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Score Display */
        .score-display {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
        }
        
        .team-score {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            min-width: 150px;
        }
        
        .team-name {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.8;
        }
        
        .team-points {
            font-size: 3em;
            font-weight: bold;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Question Card */
        .question-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            margin: 30px 0;
            text-align: center;
            font-size: 1.5em;
            line-height: 1.6;
            animation: questionIn 0.5s ease;
        }
        
        @keyframes questionIn {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Location Map */
        .location-map {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            height: 300px;
            position: relative;
            overflow: hidden;
        }
        
        .location-dot {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--accent-gradient);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        /* First Aid Card */
        .first-aid-card {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
        }
        
        .first-aid-step {
            margin: 15px 0;
            padding-left: 30px;
            position: relative;
        }
        
        .first-aid-step::before {
            content: attr(data-step);
            position: absolute;
            left: 0;
            top: 0;
            width: 25px;
            height: 25px;
            background: var(--accent-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
        }
        
        /* Buddy System */
        .buddy-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .buddy-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .buddy-card:hover {
            transform: translateY(-5px);
            border-color: rgba(0, 255, 136, 0.5);
        }
        
        .buddy-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .buddy-status.online {
            background: #00ff88;
            animation: pulse 2s infinite;
        }
        
        .buddy-status.offline {
            background: #666;
        }
        
        /* Settings Saved Animation */
        @keyframes settingsSaved {
            0% {
                transform: scale(0) rotate(180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(360deg);
                opacity: 1;
            }
            100% {
                transform: scale(1) rotate(360deg);
                opacity: 1;
            }
        }
        
        .settings-saved {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5em;
            animation: settingsSaved 0.5s ease;
            z-index: 4000;
        }
        
        /* Advanced Stats */
        .advanced-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .stat-chart {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            height: 250px;
        }
        
        /* Prediction Engine */
        .prediction-card {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 212, 255, 0.1));
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
        }
        
        .prediction-value {
            font-size: 2em;
            font-weight: bold;
            margin: 20px 0;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .phone-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .country-code {
            width: 100px;
            padding: 12px;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1em;
        }
        
        .phone-number {
            flex: 1;
        }
        
        /* Verification code input */
        .verification-input {
            text-align: center;
            font-size: 1.5em;
            letter-spacing: 0.5em;
            font-family: monospace;
        }
        
        /* Phone verification info */
        .verification-info {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="background"></div>
    <div class="particles" id="particles"></div>
    
    <!-- Auth Container (Login/Signup) -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <h2 id="authTitle">Welcome to HSG Party Tracker</h2>
            
            <div class="auth-error" id="authError"></div>
            
            <div class="auth-loading" id="authLoading">
                <div class="loading-spinner"></div>
                <p>Please wait...</p>
            </div>
            
            <form id="authForm" autocomplete="on">
                <div class="form-group">
                    <label for="authEmail">Email</label>
                    <input type="email" id="authEmail" required autocomplete="email" placeholder="your.email@hsg.ch">
                </div>
                <div class="form-group">
                    <label for="authPassword">Password</label>
                    <input type="password" id="authPassword" required autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div class="form-group" id="usernameGroup" style="display: none;">
                    <label for="authUsername">Username</label>
                    <input type="text" id="authUsername" autocomplete="username" placeholder="Choose a unique username">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="authSubmitBtn">
                    <span id="authButton">Login</span>
                </button>
            </form>
            <div class="auth-toggle">
                <span id="authToggleText">Don't have an account?</span>
                <a onclick="toggleAuthMode()" id="authToggleLink">Sign up</a>
            </div>
        </div>
    </div>
    
    <!-- Alert Banner -->
    <div class="alert-banner" id="alertBanner">
        <span id="alertText"></span>
    </div>
    
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-beer"></i>
                HSG Party Tracker
            </div>
            <ul class="nav-menu" id="navMenu">
                <li><button class="nav-item active" onclick="switchSection('dashboard')" type="button">
                    <i class="fas fa-home"></i> Dashboard
                </button></li>
                <li><button class="nav-item" onclick="switchSection('devices')" type="button">
                    <i class="fas fa-microchip"></i> Devices
                </button></li>
                <li><button class="nav-item" onclick="switchSection('friends')" type="button">
                    <i class="fas fa-users"></i> Friends
                </button></li>
                <li><button class="nav-item" onclick="switchSection('games')" type="button">
                    <i class="fas fa-gamepad"></i> Games
                </button></li>
                <li><button class="nav-item" onclick="switchSection('achievements')" type="button">
                    <i class="fas fa-trophy"></i> Achievements
                </button></li>
                <li><button class="nav-item" onclick="switchSection('drinks')" type="button">
                    <i class="fas fa-beer"></i> Drinks
                </button></li>
                <li><button class="nav-item" onclick="switchSection('emergency')" type="button">
                    <i class="fas fa-ambulance"></i> Emergency
                </button></li>
                <li><button class="nav-item" onclick="switchSection('settings')" type="button">
                    <i class="fas fa-cog"></i> Settings
                </button></li>
            </ul>
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" type="button">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>
    
    <!-- User Profile Widget -->
    <div class="user-profile" id="userProfile" style="display: none;">
        <h4 id="profileName">Loading...</h4>
        <p id="profileEmail">...</p>
        <p>Devices: <span id="deviceCount">0</span></p>
        <p>Friends: <span id="friendCount">0</span></p>
        <button class="btn" onclick="signOut()">
            <i class="fas fa-sign-out-alt"></i> Sign Out
        </button>
    </div>
    
    <!-- Connection Status -->
    <div class="connection-status">
        <span class="status-dot"></span>
        <span id="connectionStatus">Connecting...</span>
    </div>
    
    <div class="container">
        <header>
            <h1>ðŸŽ‰ HSG Party Central ðŸŽ‰</h1>
            <p class="subtitle">Where memories are made and safety comes first!</p>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="showModal('pair-device')">
                    <i class="fas fa-link"></i> Pair Device
                </button>
                <button class="btn" onclick="showModal('checkin')">
                    <i class="fas fa-location-dot"></i> Check In
                </button>
                <button class="btn" onclick="callUber()">
                    <i class="fas fa-taxi"></i> Call Uber
                </button>
                <button class="btn btn-danger" onclick="showModal('emergency')">
                    <i class="fas fa-exclamation-triangle"></i> Emergency
                </button>
            </div>
        </header>
        
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <div class="party-stats">
                <div class="stat-card" onclick="showNotification('Party statistics!')">
                    <div class="stat-icon">ðŸŽŠ</div>
                    <div class="stat-value" id="partyAverage">0.00â€°</div>
                    <div class="stat-label">Party Average</div>
                </div>
                <div class="stat-card" onclick="showModal('safe-friends')">
                    <div class="stat-icon">âœ…</div>
                    <div class="stat-value" id="safeFriends">0</div>
                    <div class="stat-label">Safe to Drive</div>
                </div>
                <div class="stat-card" onclick="showModal('locations')">
                    <div class="stat-icon">ðŸ“</div>
                    <div class="stat-value" id="activeLocations">3</div>
                    <div class="stat-label">Party Spots</div>
                </div>
                <div class="stat-card" onclick="showHydrationReminder()">
                    <div class="stat-icon">ðŸ’§</div>
                    <div class="stat-value" id="hydrationTime">15m</div>
                    <div class="stat-label">Until Water Break</div>
                </div>
            </div>
            
            <div class="visualizer" id="visualizer">
                <!-- Music visualizer bars will be generated here -->
            </div>
            
            <div class="dashboard" id="friendsGrid">
                <!-- Friend cards will be dynamically inserted here -->
            </div>
            
            <div class="leaderboard">
                <h2>ðŸ† Tonight's Champions ðŸ†</h2>
                <div id="leaderboardList">
                    <!-- Leaderboard items will be inserted here -->
                </div>
            </div>
            
            <div class="info-box">
                <h3>ðŸ”Œ How to Connect Your Breathalyzer</h3>
                <p><strong>For Arduino/ESP32 Devices:</strong></p>
                <ol style="margin-left: 20px;">
                    <li>Power on your device and connect to its WiFi hotspot</li>
                    <li>Complete the setup and note your unique Device ID</li>
                    <li>Click "Pair Device" and enter your Device ID</li>
                    <li>Your BAC readings will update in real-time</li>
                </ol>
            </div>
            
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message">
                        <div class="chat-author">System</div>
                        <div>Welcome to HSG Party Chat! Stay safe and have fun! ðŸŽ‰</div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="handleChatEnter(event)">
                    <button class="btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </section>
        
        <!-- Devices Section -->
        <section id="devices" class="section">
            <h2>ðŸ“± My Devices</h2>
            
            <div class="card">
                <h3>Pair New Device</h3>
                <p>After setting up your breathalyzer via its WiFi hotspot, enter the Device ID shown on the device:</p>
                
                <div class="form-group" style="margin: 20px 0;">
                    <input type="text" id="deviceIdInput" placeholder="Enter Device ID (e.g., HSG_abc123)" style="text-transform: uppercase;">
                </div>
                
                <button class="btn btn-primary" onclick="pairDeviceById()">
                    <i class="fas fa-link"></i> Pair Device
                </button>
                
                <div class="info-box" style="margin-top: 20px;">
                    <h4>Setup Instructions:</h4>
                    <ol>
                        <li>Power on your breathalyzer device</li>
                        <li>Double-flip the switch to enter setup mode</li>
                        <li>Connect to the device's WiFi network</li>
                        <li>Complete the setup in your browser</li>
                        <li>Note the Device ID shown on the screen</li>
                        <li>Enter the Device ID above to pair</li>
                    </ol>
                </div>
            </div>
            
            <div class="device-list" id="deviceList">
                <!-- Devices will be populated here -->
            </div>
        </section>
        
        <!-- Friends Section -->
        <section id="friends" class="section">
            <h2>ðŸ‘¥ Friends</h2>
            
            <div class="friends-search">
                <input type="text" class="search-input" id="friendSearchInput" placeholder="Search for friends by username or email...">
                <button class="btn btn-primary" onclick="searchFriends()">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
            
            <div id="searchResults" style="margin-bottom: 30px;">
                <!-- Search results will appear here -->
            </div>
            
            <div class="card">
                <h3>Friend Requests</h3>
                <div id="friendRequests">
                    <!-- Friend requests will be shown here -->
                </div>
            </div>
            
            <div class="card">
                <h3>My Friends</h3>
                <div id="friendsList">
                    <!-- Friends list will be populated here -->
                </div>
            </div>
        </section>
        
        <!-- Games Section -->
        <section id="games" class="section">
            <h2>ðŸŽ® Party Games ðŸŽ®</h2>
            <div class="games-grid">
                <div class="game-card" onclick="startGame('never-have-i-ever')">
                    <div class="game-icon">ðŸ™Š</div>
                    <div class="game-title">Never Have I Ever</div>
                    <div class="game-players">2-20 players</div>
                </div>
                <div class="game-card" onclick="startGame('truth-or-dare')">
                    <div class="game-icon">ðŸŽ¯</div>
                    <div class="game-title">Truth or Dare</div>
                    <div class="game-players">3-10 players</div>
                </div>
                <div class="game-card" onclick="startGame('kings-cup')">
                    <div class="game-icon">ðŸ‘‘</div>
                    <div class="game-title">King's Cup</div>
                    <div class="game-players">4-12 players</div>
                </div>
                <div class="game-card" onclick="startGame('beer-pong')">
                    <div class="game-icon">ðŸ“</div>
                    <div class="game-title">Beer Pong Tracker</div>
                    <div class="game-players">2v2</div>
                </div>
                <div class="game-card" onclick="startGame('flip-cup')">
                    <div class="game-icon">ðŸ¥¤</div>
                    <div class="game-title">Flip Cup Timer</div>
                    <div class="game-players">Teams</div>
                </div>
                <div class="game-card" onclick="startGame('trivia')">
                    <div class="game-icon">ðŸ§ </div>
                    <div class="game-title">HSG Trivia</div>
                    <div class="game-players">Unlimited</div>
                </div>
            </div>
        </section>
        
        <!-- Achievements Section -->
        <section id="achievements" class="section">
            <h2>ðŸ… Party Achievements ðŸ…</h2>
            <div class="achievements-grid">
                <div class="achievement unlocked" title="Joined your first party!">
                    <div class="achievement-icon">ðŸŽ‰</div>
                    <div class="achievement-name">First Timer</div>
                </div>
                <div class="achievement unlocked" title="Stayed safe all night">
                    <div class="achievement-icon">ðŸ˜‡</div>
                    <div class="achievement-name">Responsible</div>
                </div>
                <div class="achievement" title="Win 5 party games">
                    <div class="achievement-icon">ðŸ†</div>
                    <div class="achievement-name">Game Master</div>
                </div>
                <div class="achievement" title="Check in at 10 parties">
                    <div class="achievement-icon">ðŸ“</div>
                    <div class="achievement-name">Party Animal</div>
                </div>
                <div class="achievement" title="Help a friend get home safe">
                    <div class="achievement-icon">ðŸ¦¸</div>
                    <div class="achievement-name">Guardian Angel</div>
                </div>
                <div class="achievement" title="Stay hydrated for 3 hours">
                    <div class="achievement-icon">ðŸ’§</div>
                    <div class="achievement-name">Hydro Homie</div>
                </div>
                <div class="achievement" title="Dance for 30 minutes straight">
                    <div class="achievement-icon">ðŸ•º</div>
                    <div class="achievement-name">Dance Machine</div>
                </div>
                <div class="achievement" title="Make it to sunrise">
                    <div class="achievement-icon">ðŸŒ…</div>
                    <div class="achievement-name">Sunrise Warrior</div>
                </div>
            </div>
        </section>
        
        <!-- Drinks Section -->
        <section id="drinks" class="section">
            <h2>ðŸ» Drink Tracker ðŸ»</h2>
            
            <div class="card" style="margin-bottom: 30px;">
                <h3>Log a Drink</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
                    <div>
                        <label style="display: block; margin-bottom: 10px;">Drink Type:</label>
                        <select id="drinkType" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white;">
                            <option value="beer">ðŸº Beer</option>
                            <option value="wine">ðŸ· Wine</option>
                            <option value="shot">ðŸ¥ƒ Shot</option>
                            <option value="cocktail">ðŸ¸ Cocktail</option>
                            <option value="mixed">ðŸ¥¤ Mixed Drink</option>
                            <option value="champagne">ðŸ¥‚ Champagne</option>
                            <option value="water">ðŸ’§ Water</option>
                            <option value="other">ðŸ¹ Other</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 10px;">Amount (ml):</label>
                        <input type="number" id="drinkAmount" placeholder="330" value="330" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 10px;">Alcohol %:</label>
                        <input type="number" id="alcoholPercent" placeholder="5" value="5" step="0.1" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white;">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="logDrink()">
                    <i class="fas fa-plus"></i> Add Drink
                </button>
            </div>
            
            <div class="party-stats">
                <div class="stat-card">
                    <div class="stat-icon">ðŸº</div>
                    <div class="stat-value" id="totalDrinks">0</div>
                    <div class="stat-label">Total Drinks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ðŸ¥ƒ</div>
                    <div class="stat-value" id="totalAlcohol">0ml</div>
                    <div class="stat-label">Pure Alcohol</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">ðŸ’§</div>
                    <div class="stat-value" id="totalWater">0</div>
                    <div class="stat-label">Waters</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">âš¡</div>
                    <div class="stat-value" id="drinkRate">0</div>
                    <div class="stat-label">Drinks/Hour</div>
                </div>
            </div>
            
            <div class="card chart-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3>ðŸ“Š Drink Distribution</h3>
                    <button class="chart-toggle" onclick="toggleChart()">
                        <span id="chartToggleText">Hide Chart</span>
                    </button>
                </div>
                <div class="chart-wrapper" id="chartWrapper">
                    <canvas id="drinkChart" width="400" height="250"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h3>ðŸ“œ Drink History</h3>
                <div id="drinkHistory" style="max-height: 400px; overflow-y: auto;">
                    <!-- Drink history will be populated here -->
                </div>
            </div>
            
            <div class="card" style="background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.3);">
                <h3>ðŸš¨ Emergency Information</h3>
                <div id="emergencyDrinkInfo" style="margin: 20px 0;">
                    <p><strong>For First Responders:</strong></p>
                    <div id="emergencySummary">
                        <!-- Emergency summary will be populated here -->
                    </div>
                </div>
                <button class="btn btn-danger" onclick="showEmergencyReport()">
                    <i class="fas fa-file-medical"></i> Generate Emergency Report
                </button>
            </div>
        </section>
        
        <!-- Emergency Section -->
        <section id="emergency" class="section">
            <h2>ðŸš¨ Emergency Services ðŸš¨</h2>
            <div class="emergency-grid">
                <div class="emergency-card" onclick="callEmergency('ambulance')">
                    <div class="emergency-icon">ðŸš‘</div>
                    <div class="game-title">Call Ambulance</div>
                    <div class="game-players">Emergency: 112</div>
                </div>
                <div class="emergency-card" onclick="callEmergency('campus-security')">
                    <div class="emergency-icon">ðŸ‘®</div>
                    <div class="game-title">Campus Security</div>
                    <div class="game-players">HSG: +41 71 224 2424</div>
                </div>
                <div class="emergency-card" onclick="callEmergency('taxi')">
                    <div class="emergency-icon">ðŸš•</div>
                    <div class="game-title">Safe Ride Home</div>
                    <div class="game-players">Multiple Options</div>
                </div>
                <div class="emergency-card" onclick="showModal('first-aid')">
                    <div class="emergency-icon">ðŸ¥</div>
                    <div class="game-title">First Aid Guide</div>
                    <div class="game-players">Quick Help</div>
                </div>
                <div class="emergency-card" onclick="showModal('buddy-system')">
                    <div class="emergency-icon">ðŸ‘¥</div>
                    <div class="game-title">Find My Buddy</div>
                    <div class="game-players">Location Sharing</div>
                </div>
                <div class="emergency-card" onclick="showModal('sober-friend')">
                    <div class="emergency-icon">ðŸ¤</div>
                    <div class="game-title">Call Sober Friend</div>
                    <div class="game-players">Designated Helpers</div>
                </div>
            </div>
        </section>
        
        <!-- Settings Section -->
        <section id="settings" class="section">
            <div class="profile-header">
                <div class="profile-avatar" onclick="showNotification('Profile picture upload coming soon!')">
                    <span id="profileInitial">?</span>
                </div>
                <div class="profile-info">
                    <h2 id="settingsUsername">Loading...</h2>
                    <p id="settingsEmail">...</p>
                    <p id="settingsPhone" style="display: none;">...</p>
                </div>
            </div>
            
            <div class="settings-grid">
                <div class="settings-section">
                    <h3>ðŸ‘¤ Profile Information</h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="username" placeholder="Enter your username">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="emailDisplay" disabled style="opacity: 0.7;">
                        </div>
                        <button class="btn btn-primary" onclick="updateProfile()">Update Profile</button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>ðŸ”’ Account Security</h3>
                    <div class="linked-accounts">
                        <div class="account-item">
                            <div class="account-info">
                                <div class="account-icon email-icon">
                                    <i class="fas fa-envelope"></i>
                                </div>
                                <div>
                                    <strong>Email</strong>
                                    <p id="linkedEmail" style="margin: 0; opacity: 0.7;">...</p>
                                </div>
                            </div>
                            <span style="color: #00ff88;">âœ“ Linked</span>
                        </div>
                    </div>
                    <button class="btn" onclick="changePassword()" style="margin-top: 20px; width: 100%;">
                        <i class="fas fa-key"></i> Change Password
                    </button>
                </div>
                
                <div class="settings-section">
                    <h3>ðŸš¨ Emergency Information</h3>
                    <div class="settings-form">
                        <div class="form-group">
                            <label>Home Address</label>
                            <textarea id="homeAddress" placeholder="Enter your home address for quick Uber rides"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Emergency Contact</label>
                            <input type="tel" id="emergencyContact" placeholder="+41 XX XXX XX XX">
                        </div>
                        <div class="form-group">
                            <label>Medical Information</label>
                            <textarea id="medicalInfo" placeholder="Allergies, conditions, medications..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Safety Notes</label>
                            <textarea id="safetyNotes" placeholder="Any other important information"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="saveEmergencyInfo()">Save Emergency Info</button>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>ðŸ”” Privacy & Notifications</h3>
                    <div class="toggle-group">
                        <div class="toggle-label">
                            <span>Share Location with Friends</span>
                            <small>Allow friends to see your party location</small>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="shareLocation">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-group">
                        <div class="toggle-label">
                            <span>Enable Notifications</span>
                            <small>Get alerts for friend requests and safety reminders</small>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notifications" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="toggle-group">
                        <div class="toggle-label">
                            <span>Public Profile</span>
                            <small>Allow others to find you by username</small>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="publicProfile" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="savePrivacySettings()" style="margin-top: 20px; width: 100%;">Save Privacy Settings</button>
                </div>
                
                <div class="settings-section">
                    <h3>ðŸ’¾ Data Management</h3>
                    <div style="display: grid; gap: 10px;">
                        <button class="btn" onclick="exportData()">
                            <i class="fas fa-download"></i> Export All Data
                        </button>
                        <button class="btn" onclick="clearDrinkHistory()">
                            <i class="fas fa-trash"></i> Clear Drink History
                        </button>
                        <button class="btn btn-danger" onclick="deleteAccount()">
                            <i class="fas fa-user-times"></i> Delete Account
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </div>
    
    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div id="modalBody"></div>
        </div>
    </div>
    
    <script>
        // ========================================
        // FIREBASE CONFIGURATION
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCuOjiHa8C0jgAte40E774CRJROTWTUdmg",
            authDomain: "hsg-party-tracker.firebaseapp.com",
            databaseURL: "https://hsg-party-tracker-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "hsg-party-tracker",
            storageBucket: "hsg-party-tracker.firebasestorage.app",
            messagingSenderId: "1047483086606",
            appId: "1:1047483086606:web:a02d77baacd21166fb095f",
            measurementId: "G-VFS4W30Z7P"
        };
        
        // ========================================
        // GLOBAL VARIABLES AND DATA
        // ========================================
        let auth = null;
        let database = null;
        let currentUser = null;
        let userData = {};
        let partyData = {};
        let deviceData = {};
        let friendsData = {};
        let friendRequests = [];
        let currentGame = null;
        let gameScores = { team1: 0, team2: 0 };
        let partyStartTime = Date.now();
        let achievements = {
            firstTimer: true,
            responsible: false,
            gameMaster: false,
            partyAnimal: false,
            guardianAngel: false,
            hydroHomie: false,
            danceMachine: false,
            sunriseWarrior: false
        };
        let locationHistory = [];
        let drinkHistory = [];
        let drinkChart = null;
        let chartVisible = true;
        let isSignUp = false;
        let isInitialized = false;
        
        // Drink presets
        const drinkPresets = {
            beer: { amount: 330, alcohol: 5, emoji: 'ðŸº' },
            wine: { amount: 150, alcohol: 12, emoji: 'ðŸ·' },
            shot: { amount: 40, alcohol: 40, emoji: 'ðŸ¥ƒ' },
            cocktail: { amount: 200, alcohol: 15, emoji: 'ðŸ¸' },
            mixed: { amount: 250, alcohol: 10, emoji: 'ðŸ¥¤' },
            champagne: { amount: 150, alcohol: 12, emoji: 'ðŸ¥‚' },
            water: { amount: 250, alcohol: 0, emoji: 'ðŸ’§' },
            other: { amount: 200, alcohol: 5, emoji: 'ðŸ¹' }
        };
        
        // ========================================
        // FIREBASE INITIALIZATION
        // ========================================
        function initializeFirebase() {
            if (isInitialized) return;
            
            try {
                // Initialize Firebase
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                database = firebase.database();
                auth = firebase.auth();
                
                // Setup auth state listener
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = user;
                        onUserAuthenticated();
                    } else {
                        currentUser = null;
                        showAuthScreen();
                    }
                });
                
                isInitialized = true;
                console.log('Firebase initialized successfully');
                updateConnectionStatus(true);
                
            } catch (error) {
                console.error('Firebase initialization error:', error);
                showNotification('âŒ Firebase connection failed. Please refresh the page.', 'error');
                updateConnectionStatus(false);
            }
        }
        
        // ========================================
        // AUTHENTICATION FUNCTIONS
        // ========================================
        function showAuthScreen() {
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('userProfile').style.display = 'none';
            document.querySelector('.container').style.display = 'none';
        }
        
        function hideAuthScreen() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('userProfile').style.display = 'block';
            document.querySelector('.container').style.display = 'block';
        }
        
        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            
            // Hide loading
            hideAuthLoading();
            
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }
        
        function showAuthLoading() {
            document.getElementById('authLoading').classList.add('show');
            document.getElementById('authSubmitBtn').disabled = true;
        }
        
        function hideAuthLoading() {
            document.getElementById('authLoading').classList.remove('show');
            document.getElementById('authSubmitBtn').disabled = false;
        }
        
        function toggleAuthMode() {
            isSignUp = !isSignUp;
            
            if (isSignUp) {
                // Switch to signup
                document.getElementById('authTitle').textContent = 'Create Your Account';
                document.getElementById('authButton').textContent = 'Sign Up';
                document.getElementById('usernameGroup').style.display = 'block';
                document.getElementById('authToggleText').textContent = 'Already have an account?';
                document.getElementById('authToggleLink').textContent = 'Login';
            } else {
                // Switch to login
                document.getElementById('authTitle').textContent = 'Welcome Back';
                document.getElementById('authButton').textContent = 'Login';
                document.getElementById('usernameGroup').style.display = 'none';
                document.getElementById('authToggleText').textContent = "Don't have an account?";
                document.getElementById('authToggleLink').textContent = 'Sign up';
            }
        }
        
        // Handle auth form submission
        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value;
            const username = document.getElementById('authUsername').value.trim();
            
            // Validation
            if (!email || !password) {
                showAuthError('Please fill in all fields');
                return;
            }
            
            if (password.length < 6) {
                showAuthError('Password must be at least 6 characters');
                return;
            }
            
            showAuthLoading();
            
            try {
                if (!isSignUp) {
                    // Login
                    await auth.signInWithEmailAndPassword(email, password);
                    showNotification('âœ… Welcome back!', 'success');
                } else {
                    // Signup
                    if (!username || username.length < 3) {
                        showAuthError('Username must be at least 3 characters');
                        hideAuthLoading();
                        return;
                    }
                    
                    // Check if username is taken
                    const usernameCheck = await database.ref('usernames/' + username.toLowerCase()).once('value');
                    if (usernameCheck.exists()) {
                        showAuthError('Username already taken');
                        hideAuthLoading();
                        return;
                    }
                    
                    // Create account
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    // Save user data
                    await database.ref('users/' + user.uid).set({
                        username: username,
                        email: email,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        devices: {},
                        friends: {},
                        achievements: {},
                        settings: {
                            notifications: true,
                            shareLocation: false,
                            publicProfile: true
                        }
                    });
                    
                    // Reserve username
                    await database.ref('usernames/' + username.toLowerCase()).set(user.uid);
                    
                    showNotification('âœ… Account created successfully!', 'success');
                }
                
                hideAuthLoading();
                
            } catch (error) {
                console.error('Auth error:', error);
                hideAuthLoading();
                
                let errorMessage = 'Authentication failed';
                
                switch(error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No account found with this email';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password';
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = 'Email already registered';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'Password should be at least 6 characters';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = 'Network error. Please check your connection';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many attempts. Please try again later';
                        break;
                    default:
                        errorMessage = error.message;
                }
                
                showAuthError(errorMessage);
            }
        });
        
        async function signOut() {
            try {
                await auth.signOut();
                showNotification('ðŸ‘‹ Signed out successfully');
                location.reload();
            } catch (error) {
                console.error('Sign out error:', error);
                showNotification('âŒ Error signing out', 'error');
            }
        }
        
        // ========================================
        // USER AUTHENTICATED - SETUP
        // ========================================
        async function onUserAuthenticated() {
            hideAuthScreen();
            
            // Load user data
            try {
                const userRef = database.ref('users/' + currentUser.uid);
                const snapshot = await userRef.once('value');
                userData = snapshot.val() || {};
                
                // Update profile displays
                const displayName = userData.username || currentUser.email.split('@')[0];
                document.getElementById('profileName').textContent = displayName;
                document.getElementById('profileEmail').textContent = currentUser.email;
                
                // Update settings page
                document.getElementById('settingsUsername').textContent = displayName;
                document.getElementById('settingsEmail').textContent = currentUser.email;
                document.getElementById('username').value = userData.username || '';
                document.getElementById('emailDisplay').value = currentUser.email;
                document.getElementById('linkedEmail').textContent = currentUser.email;
                
                // Update profile initial
                const initial = displayName.charAt(0).toUpperCase();
                document.getElementById('profileInitial').textContent = initial;
                
                // Setup listeners
                setupFirebaseListeners();
                
                // Load saved settings
                loadUserSettings();
                
                // Initialize UI
                updateUI();
                
                showNotification(`ðŸŽ‰ Welcome, ${displayName}!`, 'success');
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('âš ï¸ Error loading profile. Some features may not work.', 'error');
            }
        }
        
        // Setup Firebase listeners for authenticated user
        function setupFirebaseListeners() {
            if (!database || !currentUser) return;
            
            // Listen for user's devices
            database.ref('users/' + currentUser.uid + '/devices').on('value', (snapshot) => {
                deviceData = snapshot.val() || {};
                updateDeviceList();
                document.getElementById('deviceCount').textContent = Object.keys(deviceData).length;
                
                // Start listening to each device
                Object.keys(deviceData).forEach(deviceId => {
                    listenToDevice(deviceId);
                });
            });
            
            // Listen for friends
            database.ref('users/' + currentUser.uid + '/friends').on('value', (snapshot) => {
                friendsData = snapshot.val() || {};
                updateFriendsList();
                document.getElementById('friendCount').textContent = Object.keys(friendsData).length;
                
                // Listen to friends' data
                Object.keys(friendsData).forEach(friendId => {
                    listenToFriend(friendId);
                });
            });
            
            // Listen for friend requests
            database.ref('friendRequests/' + currentUser.uid).on('value', (snapshot) => {
                const requests = snapshot.val() || {};
                friendRequests = Object.entries(requests).map(([id, data]) => ({
                    id,
                    ...data
                }));
                updateFriendRequests();
            });
            
            // Connection status
            database.ref('.info/connected').on('value', (snapshot) => {
                const connected = snapshot.val();
                updateConnectionStatus(connected);
            });
        }
        
        // Listen to specific device
        function listenToDevice(deviceId) {
            database.ref('readings/' + deviceId).on('value', (snapshot) => {
                const reading = snapshot.val();
                if (reading) {
                    processDeviceReading(deviceId, reading);
                }
            });
        }
        
        // Listen to friend's data
        function listenToFriend(friendId) {
            const permission = friendsData[friendId]?.permission || 'observer';
            
            if (permission !== 'none') {
                database.ref('users/' + friendId).on('value', (snapshot) => {
                    const friendData = snapshot.val();
                    if (friendData) {
                        processFriendData(friendId, friendData);
                    }
                });
            }
        }
        
        // ========================================
        // DEVICE PAIRING SYSTEM
        // ========================================
        async function pairDeviceById() {
            const deviceId = document.getElementById('deviceIdInput').value.trim().toUpperCase();
            
            if (!deviceId) {
                showNotification('âŒ Please enter a Device ID', 'error');
                return;
            }
            
            try {
                // Check if device exists in readings
                const deviceSnapshot = await database.ref('readings/' + deviceId).once('value');
                
                if (!deviceSnapshot.exists()) {
                    showNotification('âŒ Device not found. Make sure it\'s connected.', 'error');
                    return;
                }
                
                // Check if already paired
                if (deviceData[deviceId]) {
                    showNotification('â„¹ï¸ Device already paired');
                    return;
                }
                
                // Add device to user
                await database.ref('users/' + currentUser.uid + '/devices/' + deviceId).set({
                    pairedAt: firebase.database.ServerValue.TIMESTAMP,
                    name: 'My Breathalyzer'
                });
                
                // Clear input
                document.getElementById('deviceIdInput').value = '';
                
                showNotification('âœ… Device paired successfully!', 'success');
                
                // Start listening to this device
                listenToDevice(deviceId);
                
            } catch (error) {
                console.error('Pairing error:', error);
                showNotification('âŒ Pairing failed', 'error');
            }
        }
        
        // Update device list display
        function updateDeviceList() {
            const deviceList = document.getElementById('deviceList');
            deviceList.innerHTML = '';
            
            if (Object.keys(deviceData).length === 0) {
                deviceList.innerHTML = '<p style="text-align: center; opacity: 0.7;">No devices paired yet</p>';
                return;
            }
            
            Object.entries(deviceData).forEach(([deviceId, device]) => {
                const lastReading = partyData[deviceId];
                const item = document.createElement('div');
                item.className = 'device-item';
                item.innerHTML = `
                    <div class="device-info">
                        <h4>${device.name || 'Breathalyzer'}</h4>
                        <p>ID: ${deviceId}</p>
                        <p>Last Reading: ${lastReading ? lastReading.bac.toFixed(3) + 'â€°' : 'No data'}</p>
                    </div>
                    <div>
                        <button class="btn" onclick="renameDevice('${deviceId}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="unpairDevice('${deviceId}')">
                            <i class="fas fa-unlink"></i>
                        </button>
                    </div>
                `;
                deviceList.appendChild(item);
            });
        }
        
        async function unpairDevice(deviceId) {
            if (confirm('Unpair this device?')) {
                await database.ref('users/' + currentUser.uid + '/devices/' + deviceId).remove();
                showNotification('ðŸ”“ Device unpaired');
            }
        }
        
        async function renameDevice(deviceId) {
            const newName = prompt('Enter new name for device:', deviceData[deviceId]?.name || 'My Breathalyzer');
            if (newName) {
                await database.ref('users/' + currentUser.uid + '/devices/' + deviceId + '/name').set(newName);
                showNotification('âœï¸ Device renamed');
            }
        }
        
        // Process device reading
        function processDeviceReading(deviceId, reading) {
            if (!partyData[deviceId]) {
                partyData[deviceId] = {
                    name: userData.username || 'You',
                    bac: 0,
                    lastUpdate: Date.now(),
                    location: 'Party',
                    trend: 'steady',
                    history: [],
                    isOwn: true
                };
            }
            
            const oldBac = partyData[deviceId].bac;
            partyData[deviceId].bac = reading.bac || 0;
            partyData[deviceId].lastUpdate = Date.now();
            partyData[deviceId].trend = reading.bac > oldBac ? 'up' : reading.bac < oldBac ? 'down' : 'steady';
            
            // Add to history
            partyData[deviceId].history.push({
                time: Date.now(),
                value: reading.bac
            });
            
            // Keep history reasonable
            if (partyData[deviceId].history.length > 50) {
                partyData[deviceId].history.shift();
            }
            
            updateUI();
            
            // Check for alerts
            if (reading.bac >= 0.08) {
                showNotification(`âš ï¸ Your BAC is too high: ${reading.bac.toFixed(3)}â€°`, 'error');
            }
        }
        
        // ========================================
        // FRIENDS SYSTEM
        // ========================================
        async function searchFriends() {
            const searchTerm = document.getElementById('friendSearchInput').value.trim().toLowerCase();
            
            if (!searchTerm || searchTerm.length < 3) {
                showNotification('âŒ Please enter at least 3 characters', 'error');
                return;
            }
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<p>Searching...</p>';
            
            try {
                // Search by username
                const usersSnapshot = await database.ref('users').once('value');
                const users = usersSnapshot.val() || {};
                
                const results = [];
                Object.entries(users).forEach(([uid, user]) => {
                    if (uid !== currentUser.uid && 
                        user.settings?.publicProfile !== false &&
                        (user.username?.toLowerCase().includes(searchTerm) || 
                         user.email?.toLowerCase().includes(searchTerm))) {
                        results.push({ uid, ...user });
                    }
                });
                
                if (results.length === 0) {
                    resultsDiv.innerHTML = '<p style="text-align: center; opacity: 0.7;">No users found</p>';
                } else {
                    resultsDiv.innerHTML = '<h4>Search Results:</h4>' + results.map(user => `
                        <div class="friend-item">
                            <div class="friend-info">
                                <div class="friend-avatar-small">
                                    ${(user.username || user.email).charAt(0).toUpperCase()}
                                </div>
                                <div class="friend-details">
                                    <h4>${user.username || 'User'}</h4>
                                    <p>${user.email || 'Phone user'}</p>
                                </div>
                            </div>
                            <div class="friend-actions">
                                ${friendsData[user.uid] ? 
                                    '<span style="color: #00ff88;">âœ“ Friends</span>' : 
                                    `<button class="btn btn-primary" onclick="sendFriendRequest('${user.uid}')">
                                        <i class="fas fa-user-plus"></i> Add Friend
                                    </button>`
                                }
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = '<p style="color: #ff4444;">Search failed. Try again.</p>';
            }
        }
        
        async function sendFriendRequest(friendId) {
            try {
                // Check if already friends
                if (friendsData[friendId]) {
                    showNotification('â„¹ï¸ Already friends');
                    return;
                }
                
                // Send friend request
                await database.ref('friendRequests/' + friendId + '/' + currentUser.uid).set({
                    from: userData.username || currentUser.email,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                showNotification('ðŸ“¤ Friend request sent!', 'success');
                
                // Update UI
                searchFriends();
                
            } catch (error) {
                console.error('Friend request error:', error);
                showNotification('âŒ Failed to send request', 'error');
            }
        }
        
        // Update friend requests display
        function updateFriendRequests() {
            const container = document.getElementById('friendRequests');
            
            if (friendRequests.length === 0) {
                container.innerHTML = '<p style="opacity: 0.7;">No pending requests</p>';
                return;
            }
            
            container.innerHTML = friendRequests.map(request => `
                <div class="friend-request">
                    <div>
                        <strong>${request.from}</strong>
                        <small style="opacity: 0.7; margin-left: 10px;">
                            ${getTimeSince(request.timestamp)}
                        </small>
                    </div>
                    <div>
                        <button class="btn" onclick="acceptFriendRequest('${request.id}')">
                            <i class="fas fa-check"></i> Accept
                        </button>
                        <button class="btn btn-danger" onclick="declineFriendRequest('${request.id}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        async function acceptFriendRequest(friendId) {
            try {
                // Show permission selection modal
                const permission = await selectFriendPermission();
                if (!permission) return;
                
                // Add friend to both users
                await database.ref('users/' + currentUser.uid + '/friends/' + friendId).set({
                    permission: permission,
                    addedAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                await database.ref('users/' + friendId + '/friends/' + currentUser.uid).set({
                    permission: permission,
                    addedAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Remove request
                await database.ref('friendRequests/' + currentUser.uid + '/' + friendId).remove();
                
                showNotification('âœ… Friend added!', 'success');
                
            } catch (error) {
                console.error('Accept friend error:', error);
                showNotification('âŒ Failed to accept request', 'error');
            }
        }
        
        async function selectFriendPermission() {
            return new Promise((resolve) => {
                const modalContent = `
                    <h2>Set Friend Permissions</h2>
                    <p>Choose what this friend can see:</p>
                    <div style="margin: 20px 0;">
                        <div class="friend-item" style="cursor: pointer; margin: 10px 0;" onclick="resolvePermission('observer')">
                            <div>
                                <h4>ðŸ‘€ Observer</h4>
                                <p>Can see if you're at a party (no BAC data)</p>
                            </div>
                        </div>
                        <div class="friend-item" style="cursor: pointer; margin: 10px 0;" onclick="resolvePermission('buddy')">
                            <div>
                                <h4>ðŸ¤ Buddy</h4>
                                <p>Can see your BAC and get notifications</p>
                            </div>
                        </div>
                        <div class="friend-item" style="cursor: pointer; margin: 10px 0;" onclick="resolvePermission('guardian')">
                            <div>
                                <h4>ðŸ›¡ï¸ Guardian</h4>
                                <p>Full access including emergency info</p>
                            </div>
                        </div>
                    </div>
                    <button class="btn" onclick="resolvePermission(null)">Cancel</button>
                `;
                
                document.getElementById('modalBody').innerHTML = modalContent;
                document.getElementById('modal').classList.add('show');
                
                window.resolvePermission = (permission) => {
                    closeModal();
                    resolve(permission);
                };
            });
        }
        
        async function declineFriendRequest(friendId) {
            await database.ref('friendRequests/' + currentUser.uid + '/' + friendId).remove();
            showNotification('âŒ Request declined');
        }
        
        // Process friend data
        function processFriendData(friendId, friendData) {
            const permission = friendsData[friendId]?.permission || 'observer';
            
            // Get friend's device data based on permission
            if (permission === 'guardian' || permission === 'buddy') {
                // Can see BAC data
                Object.keys(friendData.devices || {}).forEach(deviceId => {
                    if (!partyData[deviceId]) {
                        partyData[deviceId] = {
                            name: friendData.username,
                            bac: 0,
                            lastUpdate: Date.now(),
                            location: 'Unknown',
                            trend: 'steady',
                            history: [],
                            isFriend: true,
                            friendId: friendId,
                            permission: permission
                        };
                    }
                    
                    // Listen to their device readings
                    listenToDevice(deviceId);
                });
            }
        }
        
        // Update friends list display
        function updateFriendsList() {
            const friendsList = document.getElementById('friendsList');
            friendsList.innerHTML = '';
            
            if (Object.keys(friendsData).length === 0) {
                friendsList.innerHTML = '<p style="text-align: center; opacity: 0.7;">No friends added yet</p>';
                return;
            }
            
            // Load friend details
            Object.entries(friendsData).forEach(async ([friendId, friend]) => {
                const friendSnapshot = await database.ref('users/' + friendId).once('value');
                const friendInfo = friendSnapshot.val();
                
                if (friendInfo) {
                    const friendDiv = document.createElement('div');
                    friendDiv.className = 'friend-item';
                    friendDiv.innerHTML = `
                        <div class="friend-info">
                            <div class="friend-avatar-small">
                                ${(friendInfo.username || friendInfo.email || 'U').charAt(0).toUpperCase()}
                            </div>
                            <div class="friend-details">
                                <h4>${friendInfo.username || 'Friend'}</h4>
                                <p>${friendInfo.email || 'Phone user'}</p>
                            </div>
                        </div>
                        <div class="friend-actions">
                            <select class="permission-select" onchange="updateFriendPermission('${friendId}', this.value)">
                                <option value="observer" ${friend.permission === 'observer' ? 'selected' : ''}>Observer</option>
                                <option value="buddy" ${friend.permission === 'buddy' ? 'selected' : ''}>Buddy</option>
                                <option value="guardian" ${friend.permission === 'guardian' ? 'selected' : ''}>Guardian</option>
                            </select>
                            <button class="btn btn-danger" onclick="removeFriend('${friendId}')">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        </div>
                    `;
                    friendsList.appendChild(friendDiv);
                }
            });
        }
        
        async function updateFriendPermission(friendId, newPermission) {
            try {
                await database.ref('users/' + currentUser.uid + '/friends/' + friendId + '/permission').set(newPermission);
                await database.ref('users/' + friendId + '/friends/' + currentUser.uid + '/permission').set(newPermission);
                showNotification('âœ… Permission updated', 'success');
            } catch (error) {
                console.error('Update permission error:', error);
                showNotification('âŒ Failed to update permission', 'error');
            }
        }
        
        async function removeFriend(friendId) {
            if (confirm('Remove this friend?')) {
                await database.ref('users/' + currentUser.uid + '/friends/' + friendId).remove();
                await database.ref('users/' + friendId + '/friends/' + currentUser.uid).remove();
                showNotification('ðŸ‘‹ Friend removed');
            }
        }
        
        // ========================================
        // SETTINGS FUNCTIONS
        // ========================================
        async function updateProfile() {
            const username = document.getElementById('username').value.trim();
            
            if (!username || username.length < 3) {
                showNotification('âŒ Username must be at least 3 characters', 'error');
                return;
            }
            
            try {
                // Check if username changed
                if (username.toLowerCase() !== userData.username?.toLowerCase()) {
                    // Check if new username is available
                    const usernameCheck = await database.ref('usernames/' + username.toLowerCase()).once('value');
                    if (usernameCheck.exists() && usernameCheck.val() !== currentUser.uid) {
                        showNotification('âŒ Username already taken', 'error');
                        return;
                    }
                    
                    // Remove old username
                    if (userData.username) {
                        await database.ref('usernames/' + userData.username.toLowerCase()).remove();
                    }
                    
                    // Reserve new username
                    await database.ref('usernames/' + username.toLowerCase()).set(currentUser.uid);
                }
                
                // Update user data
                await database.ref('users/' + currentUser.uid + '/username').set(username);
                
                showNotification('âœ… Profile updated!', 'success');
                
                // Update UI
                userData.username = username;
                document.getElementById('profileName').textContent = username;
                document.getElementById('settingsUsername').textContent = username;
                document.getElementById('profileInitial').textContent = username.charAt(0).toUpperCase();
                
            } catch (error) {
                console.error('Update profile error:', error);
                showNotification('âŒ Failed to update profile', 'error');
            }
        }
        
        async function changePassword() {
            const newPassword = prompt('Enter new password (min 6 characters):');
            if (newPassword && newPassword.length >= 6) {
                try {
                    await currentUser.updatePassword(newPassword);
                    showNotification('âœ… Password changed successfully', 'success');
                } catch (error) {
                    console.error('Password change error:', error);
                    if (error.code === 'auth/requires-recent-login') {
                        showNotification('âŒ Please sign out and sign in again before changing password', 'error');
                    } else {
                        showNotification('âŒ Failed to change password', 'error');
                    }
                }
            }
        }
        
        async function saveEmergencyInfo() {
            const homeAddress = document.getElementById('homeAddress').value;
            const emergencyContact = document.getElementById('emergencyContact').value;
            const medicalInfo = document.getElementById('medicalInfo').value;
            const safetyNotes = document.getElementById('safetyNotes').value;
            
            try {
                await database.ref('users/' + currentUser.uid + '/emergency').set({
                    homeAddress,
                    emergencyContact,
                    medicalInfo,
                    safetyNotes,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Also save locally for offline access
                localStorage.setItem('homeAddress', homeAddress);
                localStorage.setItem('emergencyContact', emergencyContact);
                localStorage.setItem('medicalInfo', medicalInfo);
                localStorage.setItem('safetyNotes', safetyNotes);
                
                showNotification('âœ… Emergency information saved', 'success');
                showSettingsSaved();
            } catch (error) {
                console.error('Save emergency info error:', error);
                showNotification('âŒ Failed to save emergency info', 'error');
            }
        }
        
        async function savePrivacySettings() {
            const shareLocation = document.getElementById('shareLocation').checked;
            const notifications = document.getElementById('notifications').checked;
            const publicProfile = document.getElementById('publicProfile').checked;
            
            try {
                await database.ref('users/' + currentUser.uid + '/settings').update({
                    shareLocation,
                    notifications,
                    publicProfile
                });
                
                localStorage.setItem('shareLocation', shareLocation);
                localStorage.setItem('notifications', notifications);
                
                showNotification('âœ… Privacy settings saved', 'success');
                showSettingsSaved();
            } catch (error) {
                console.error('Save privacy settings error:', error);
                showNotification('âŒ Failed to save settings', 'error');
            }
        }
        
        function showSettingsSaved() {
            const savedIcon = document.createElement('div');
            savedIcon.className = 'settings-saved';
            savedIcon.innerHTML = 'âœ…';
            document.body.appendChild(savedIcon);
            
            setTimeout(() => savedIcon.remove(), 1000);
        }
        
        async function deleteAccount() {
            if (!confirm('Delete your account? This cannot be undone!')) return;
            if (!confirm('Are you absolutely sure? All your data will be permanently deleted.')) return;
            
            try {
                // Delete user data
                await database.ref('users/' + currentUser.uid).remove();
                
                // Remove username
                if (userData.username) {
                    await database.ref('usernames/' + userData.username.toLowerCase()).remove();
                }
                
                // Remove friend connections
                if (friendsData) {
                    for (const friendId in friendsData) {
                        await database.ref('users/' + friendId + '/friends/' + currentUser.uid).remove();
                    }
                }
                
                // Delete auth account
                await currentUser.delete();
                
                showNotification('Account deleted. Goodbye!');
                location.reload();
            } catch (error) {
                console.error('Delete account error:', error);
                if (error.code === 'auth/requires-recent-login') {
                    showNotification('âŒ Please sign out and sign in again before deleting account', 'error');
                } else {
                    showNotification('âŒ Failed to delete account', 'error');
                }
            }
        }
        
        function loadUserSettings() {
            // Load from Firebase
            if (userData.settings) {
                const settings = userData.settings;
                
                if (settings.shareLocation !== undefined) {
                    document.getElementById('shareLocation').checked = settings.shareLocation;
                }
                if (settings.notifications !== undefined) {
                    document.getElementById('notifications').checked = settings.notifications;
                }
                if (settings.publicProfile !== undefined) {
                    document.getElementById('publicProfile').checked = settings.publicProfile;
                }
            }
            
            // Load emergency info
            if (userData.emergency) {
                const emergency = userData.emergency;
                
                if (emergency.homeAddress) {
                    document.getElementById('homeAddress').value = emergency.homeAddress;
                    localStorage.setItem('homeAddress', emergency.homeAddress);
                }
                if (emergency.emergencyContact) {
                    document.getElementById('emergencyContact').value = emergency.emergencyContact;
                    localStorage.setItem('emergencyContact', emergency.emergencyContact);
                }
                if (emergency.medicalInfo) {
                    document.getElementById('medicalInfo').value = emergency.medicalInfo;
                    localStorage.setItem('medicalInfo', emergency.medicalInfo);
                }
                if (emergency.safetyNotes) {
                    document.getElementById('safetyNotes').value = emergency.safetyNotes;
                    localStorage.setItem('safetyNotes', emergency.safetyNotes);
                }
            }
            
            // Update toggle switches visual state
            updateToggleSwitches();
            
            // Load local data as fallback
            loadDrinkHistory();
            
            // Load achievements
            Object.keys(achievements).forEach(key => {
                if (localStorage.getItem(`achievement_${key}`)) {
                    achievements[key] = true;
                }
            });
        }
        
        function updateToggleSwitches() {
            document.querySelectorAll('.toggle-switch').forEach(toggle => {
                const input = toggle.querySelector('input');
                if (input && input.checked) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
            });
        }
        
        // Add event listeners for toggle switches
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.toggle-switch input').forEach(input => {
                input.addEventListener('change', function() {
                    const toggle = this.closest('.toggle-switch');
                    if (this.checked) {
                        toggle.classList.add('active');
                    } else {
                        toggle.classList.remove('active');
                    }
                });
            });
        });
        
        // ========================================
        // UI UPDATE FUNCTIONS
        // ========================================
        function updateUI() {
            try {
                updateFriendsGrid();
                updateStats();
                updateLeaderboard();
                updateVisualizer();
                checkForAlerts();
            } catch (error) {
                console.error('UI update failed:', error);
            }
        }
        
        // Update connection status
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const dotElement = document.querySelector('.status-dot');
            
            if (statusElement && dotElement) {
                if (connected) {
                    statusElement.textContent = 'Connected';
                    dotElement.style.background = '#00ff88';
                } else {
                    statusElement.textContent = 'Offline';
                    dotElement.style.background = '#ff4444';
                }
            }
        }
        
        // Get BAC status
        function getBACStatus(bac) {
            if (bac < 0.02) return { class: 'bac-safe', text: 'Sober', emoji: 'ðŸ˜Š' };
            if (bac < 0.05) return { class: 'bac-caution', text: 'Buzzed', emoji: 'ðŸ˜Ž' };
            if (bac < 0.08) return { class: 'bac-danger', text: 'No Driving!', emoji: 'ðŸš«' };
            return { class: 'bac-critical', text: 'Too Much!', emoji: 'ðŸ¤¢' };
        }
        
        // Update friends grid
        function updateFriendsGrid() {
            const grid = document.getElementById('friendsGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            Object.entries(partyData).forEach(([deviceId, data]) => {
                const status = getBACStatus(data.bac);
                const timeSince = getTimeSince(data.lastUpdate);
                
                const card = document.createElement('div');
                card.className = 'card friend-card';
                card.onclick = () => showFriendDetails(data);
                
                const trendIcon = data.trend === 'up' ? 'ðŸ“ˆ' : data.trend === 'down' ? 'ðŸ“‰' : 'âž¡ï¸';
                const trendClass = data.trend === 'up' ? 'trend-up' : data.trend === 'down' ? 'trend-down' : '';
                
                const emoji = data.isOwn ? 'ðŸ‘¤' : data.permission === 'guardian' ? 'ðŸ›¡ï¸' : 'ðŸ‘¥';
                
                card.innerHTML = `
                    <div class="friend-avatar">${emoji}</div>
                    <div class="friend-name">${data.name}</div>
                    <div class="bac-value ${status.class}">
                        ${data.bac.toFixed(3)}â€°
                        <span class="bac-trend ${trendClass}">${trendIcon}</span>
                    </div>
                    <div class="friend-status">
                        <span class="status-badge">${status.emoji} ${status.text}</span>
                    </div>
                    <div class="location-tag">
                        <i class="fas fa-map-marker-alt"></i> ${data.location}
                    </div>
                    <div class="last-update" style="margin-top: 10px; opacity: 0.7; font-size: 0.9em;">
                        Updated ${timeSince}
                    </div>
                `;
                
                // Add pulse animation for high BAC
                if (data.bac >= 0.08) {
                    card.classList.add('pulse');
                }
                
                grid.appendChild(card);
            });
        }
        
        // Update stats
        function updateStats() {
            const friends = Object.values(partyData);
            
            // Average BAC
            const avgBac = friends.reduce((sum, f) => sum + f.bac, 0) / friends.length || 0;
            const avgElement = document.getElementById('partyAverage');
            if (avgElement) avgElement.textContent = avgBac.toFixed(3) + 'â€°';
            
            // Safe friends
            const safeCount = friends.filter(f => f.bac < 0.02).length;
            const safeElement = document.getElementById('safeFriends');
            if (safeElement) safeElement.textContent = safeCount;
            
            // Update hydration timer
            const hydrationMinutes = 15 - (Date.now() % (15 * 60 * 1000)) / 60000;
            const hydrationElement = document.getElementById('hydrationTime');
            if (hydrationElement) hydrationElement.textContent = Math.floor(hydrationMinutes) + 'm';
            
            // Check achievements
            checkAchievements(friends);
        }
        
        // Update leaderboard
        function updateLeaderboard() {
            const leaderboard = document.getElementById('leaderboardList');
            if (!leaderboard) return;
            
            leaderboard.innerHTML = '';
            
            const sorted = Object.values(partyData)
                .sort((a, b) => a.bac - b.bac)
                .slice(0, 5);
            
            sorted.forEach((friend, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.onclick = () => {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                    showNotification(`${friend.name} is winning! ðŸ†`);
                };
                
                item.innerHTML = `
                    <span class="rank rank-${index + 1}">#${index + 1}</span>
                    <span>${friend.name}</span>
                    <span>${friend.bac.toFixed(3)}â€°</span>
                `;
                leaderboard.appendChild(item);
            });
        }
        
        // Music visualizer
        function updateVisualizer() {
            const visualizer = document.getElementById('visualizer');
            if (!visualizer) return;
            
            if (visualizer.children.length === 0) {
                for (let i = 0; i < 20; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    visualizer.appendChild(bar);
                }
            }
            
            visualizer.querySelectorAll('.bar').forEach(bar => {
                const height = Math.random() * 150 + 20;
                bar.style.height = height + 'px';
            });
        }
        
        // Alert system
        function checkForAlerts() {
            const criticalFriends = Object.values(partyData).filter(f => f.bac >= 0.08);
            
            if (criticalFriends.length > 0) {
                const alertBanner = document.getElementById('alertBanner');
                const alertText = document.getElementById('alertText');
                
                if (alertBanner && alertText) {
                    const names = criticalFriends.map(f => f.name).join(', ');
                    alertText.textContent = `âš ï¸ ${names} need${criticalFriends.length > 1 ? '' : 's'} attention! BAC too high!`;
                    
                    if (!alertBanner.classList.contains('show')) {
                        alertBanner.classList.add('show');
                        playSound('alert');
                    }
                }
            } else {
                const alertBanner = document.getElementById('alertBanner');
                if (alertBanner) {
                    alertBanner.classList.remove('show');
                }
            }
        }
        
        // ========================================
        // EXISTING FUNCTIONS (Chat, Games, etc.)
        // ========================================
        
        // Initialize particles
        function createParticles() {
            try {
                const particlesContainer = document.getElementById('particles');
                if (!particlesContainer) return;
                
                for (let i = 0; i < 50; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDelay = Math.random() * 20 + 's';
                    particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                    particlesContainer.appendChild(particle);
                }
            } catch (error) {
                console.error('Particle creation failed:', error);
            }
        }
        
        // Navigation
        function switchSection(sectionId) {
            try {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.add('active');
                }
                
                // Find and activate the correct nav item
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    if (item.onclick && item.onclick.toString().includes(sectionId)) {
                        item.classList.add('active');
                    }
                });
                
                // Close mobile menu
                const navMenu = document.getElementById('navMenu');
                if (navMenu) {
                    navMenu.classList.remove('show');
                }
                
                // Section-specific initializations
                if (sectionId === 'achievements') {
                    updateAchievements();
                } else if (sectionId === 'drinks') {
                    updateDrinkStats();
                    updateDrinkChart();
                } else if (sectionId === 'devices') {
                    updateDeviceList();
                } else if (sectionId === 'friends') {
                    updateFriendsList();
                } else if (sectionId === 'settings') {
                    updateToggleSwitches();
                }
            } catch (error) {
                console.error('Section switch failed:', error);
            }
        }
        
        function toggleMobileMenu() {
            const navMenu = document.getElementById('navMenu');
            if (navMenu) {
                navMenu.classList.toggle('show');
            }
        }
        
        // Chat functionality
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message own';
                messageDiv.innerHTML = `
                    <div class="chat-author">${userData.username || 'You'}</div>
                    <div>${escapeHtml(message)}</div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                input.value = '';
                
                // Save to Firebase
                if (database && currentUser) {
                    database.ref('chat').push({
                        uid: currentUser.uid,
                        username: userData.username,
                        message: message,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            }
        }
        
        function handleChatEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // Hydration reminder
        function showHydrationReminder() {
            showNotification('ðŸ’§ Time for a water break! Stay hydrated!');
            confetti({
                particleCount: 50,
                spread: 60,
                colors: ['#00d4ff', '#0099ff', '#0066ff'],
                origin: { y: 0.6 }
            });
            
            // Achievement check
            const hydrationCount = parseInt(localStorage.getItem('hydrationCount') || '0') + 1;
            localStorage.setItem('hydrationCount', hydrationCount);
            
            if (hydrationCount >= 12) { // 3 hours worth
                achievements.hydroHomie = true;
                showAchievementUnlocked('Hydro Homie');
            }
        }
        
        // Show friend details
        function showFriendDetails(friend) {
            showModal('friend-details');
            setTimeout(() => {
                const content = document.getElementById('friendDetailsContent');
                if (!content) return;
                
                const status = getBACStatus(friend.bac);
                
                content.innerHTML = `
                    <div style="text-align: center; margin: 20px 0;">
                        <div class="friend-avatar" style="width: 100px; height: 100px; font-size: 3em; margin: 0 auto 20px;">
                            ${friend.isOwn ? 'ðŸ‘¤' : 'ðŸ‘¥'}
                        </div>
                        <h3>${friend.name}</h3>
                        <div class="bac-value ${status.class}" style="font-size: 2em; margin: 20px 0;">
                            ${friend.bac.toFixed(3)}â€°
                        </div>
                        <p><i class="fas fa-map-marker-alt"></i> ${friend.location}</p>
                        <div style="margin: 20px 0;">
                            <canvas id="friendChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                `;
                
                // Draw friend's BAC chart
                drawFriendChart(friend);
            }, 100);
        }
        
        // Draw friend's BAC chart
        function drawFriendChart(friend) {
            const canvas = document.getElementById('friendChart');
            if (!canvas || !friend.history || friend.history.length === 0) return;
            
            const ctx = canvas.getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: friend.history.map((_, i) => i),
                    datasets: [{
                        label: 'BAC Level',
                        data: friend.history.map(h => h.value),
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 0.15
                        }
                    }
                }
            });
        }
        
        // Modal functions
        function showModal(type, data = null) {
            const modal = document.getElementById('modal');
            const modalBody = document.getElementById('modalBody');
            
            let content = '';
            
            switch(type) {
                case 'pair-device':
                    content = `
                        <h2>ðŸ“± Pair New Device</h2>
                        <p>After setting up your breathalyzer, enter the Device ID shown on its screen:</p>
                        
                        <div class="form-group" style="margin: 20px 0;">
                            <input type="text" id="modalDeviceId" placeholder="Enter Device ID (e.g., HSG_abc123)" style="text-transform: uppercase;">
                        </div>
                        
                        <button class="btn btn-primary" onclick="pairDeviceFromModal()">
                            <i class="fas fa-link"></i> Pair Device
                        </button>
                        <button class="btn" onclick="closeModal()">Cancel</button>
                        
                        <div class="info-box" style="margin-top: 20px;">
                            <p><strong>Can't find your Device ID?</strong></p>
                            <ol>
                                <li>Power on your device</li>
                                <li>Double-flip the switch for setup mode</li>
                                <li>Connect to the device's WiFi</li>
                                <li>Complete setup to see your Device ID</li>
                            </ol>
                        </div>
                    `;
                    break;
                    
                case 'checkin':
                    content = `
                        <h2>ðŸ“ Check In</h2>
                        <p>Select your current location:</p>
                        <div class="location-map" id="locationMap">
                            <!-- Simulated map -->
                        </div>
                        <div style="margin: 20px 0;">
                            ${['Dorm A - Room Party', 'Student Bar', 'Library Cafe', 'Sports Center', 'Main Campus', 'Off Campus'].map(loc => 
                                `<button class="btn" style="width: 100%; margin: 10px 0;" onclick="checkInLocation('${loc}')">${loc}</button>`
                            ).join('')}
                        </div>
                        <button class="btn" onclick="closeModal()">Cancel</button>
                    `;
                    break;
                    
                case 'emergency':
                    content = `
                        <h2>ðŸš¨ Emergency Contacts</h2>
                        <div style="margin: 20px 0;">
                            <p><strong>Ambulance:</strong> 112</p>
                            <p><strong>HSG Security:</strong> +41 71 224 2424</p>
                            <p><strong>Poison Control:</strong> 145</p>
                            <p><strong>Mental Health Crisis:</strong> 143</p>
                        </div>
                        <button class="btn btn-danger" onclick="window.location.href='tel:112'">
                            <i class="fas fa-phone"></i> Call 112 Now
                        </button>
                        <button class="btn" onclick="showFirstAid()">
                            <i class="fas fa-medkit"></i> First Aid Guide
                        </button>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
                    
                case 'first-aid':
                    content = `
                        <h2>ðŸ¥ First Aid Guide</h2>
                        <div class="first-aid-card">
                            <h3>Signs of Alcohol Poisoning:</h3>
                            <ul>
                                <li>Confusion, stupor</li>
                                <li>Vomiting</li>
                                <li>Seizures</li>
                                <li>Slow or irregular breathing</li>
                                <li>Unconsciousness</li>
                            </ul>
                        </div>
                        <div class="first-aid-card">
                            <h3>What to Do:</h3>
                            <div class="first-aid-step" data-step="1">Call 112 immediately</div>
                            <div class="first-aid-step" data-step="2">Keep them awake and sitting up</div>
                            <div class="first-aid-step" data-step="3">Give them water if conscious</div>
                            <div class="first-aid-step" data-step="4">Keep them warm</div>
                            <div class="first-aid-step" data-step="5">Stay with them</div>
                        </div>
                        <button class="btn btn-danger" onclick="window.location.href='tel:112'">Emergency Call</button>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
                    
                case 'friend-details':
                    content = `
                        <h2>Friend Details</h2>
                        <div id="friendDetailsContent"></div>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
                    
                case 'buddy-system':
                    content = `
                        <h2>ðŸ‘¥ Buddy System</h2>
                        <p>Choose your buddy for tonight:</p>
                        <div class="buddy-list">
                            ${Object.values(partyData).map(friend => `
                                <div class="buddy-card" onclick="selectBuddy('${friend.name}')">
                                    <div style="font-size: 2em; margin-bottom: 10px;">${friend.isOwn ? 'ðŸ‘¤' : 'ðŸ‘¥'}</div>
                                    <div>${friend.name}</div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
                    
                case 'safe-friends':
                    const safeFriends = Object.values(partyData).filter(f => f.bac < 0.02);
                    content = `
                        <h2>âœ… Friends Safe to Drive</h2>
                        <div style="margin: 20px 0;">
                            ${safeFriends.length > 0 ? safeFriends.map(friend => `
                                <div class="buddy-card" style="margin: 10px 0;">
                                    <div>${friend.name}</div>
                                    <div>BAC: ${friend.bac.toFixed(3)}â€°</div>
                                </div>
                            `).join('') : '<p>No friends are currently safe to drive.</p>'}
                        </div>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
                    
                case 'locations':
                    content = `
                        <h2>ðŸ“ Active Party Locations</h2>
                        <div class="location-map" style="height: 400px;">
                            ${createLocationMap()}
                        </div>
                        <div style="margin: 20px 0;">
                            ${getActiveLocations().map(loc => `
                                <div class="buddy-card" style="margin: 10px 0;">
                                    <div><strong>${loc.name}</strong></div>
                                    <div>${loc.count} people</div>
                                    <div>Avg BAC: ${loc.avgBac.toFixed(3)}â€°</div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="btn" onclick="closeModal()">Close</button>
                    `;
                    break;
            }
            
            modalBody.innerHTML = content;
            modal.classList.add('show');
            
            // Initialize location map if needed
            if (type === 'checkin' || type === 'locations') {
                setTimeout(initializeLocationMap, 100);
            }
        }
        
        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }
        
        async function pairDeviceFromModal() {
            const deviceId = document.getElementById('modalDeviceId').value.trim().toUpperCase();
            
            if (!deviceId) {
                showNotification('âŒ Please enter a Device ID', 'error');
                return;
            }
            
            try {
                // Check if device exists in readings
                const deviceSnapshot = await database.ref('readings/' + deviceId).once('value');
                
                if (!deviceSnapshot.exists()) {
                    showNotification('âŒ Device not found. Make sure it\'s connected.', 'error');
                    return;
                }
                
                // Check if already paired
                if (deviceData[deviceId]) {
                    showNotification('â„¹ï¸ Device already paired');
                    closeModal();
                    return;
                }
                
                // Add device to user
                await database.ref('users/' + currentUser.uid + '/devices/' + deviceId).set({
                    pairedAt: firebase.database.ServerValue.TIMESTAMP,
                    name: 'My Breathalyzer'
                });
                
                showNotification('âœ… Device paired successfully!', 'success');
                closeModal();
                
                // Start listening to this device
                listenToDevice(deviceId);
                
            } catch (error) {
                console.error('Pairing error:', error);
                showNotification('âŒ Pairing failed', 'error');
            }
        }
        
        // Location functions
        function checkInLocation(location) {
            locationHistory.push({
                location: location,
                time: Date.now(),
                user: userData.username
            });
            
            showNotification(`ðŸ“ Checked in at ${location}!`);
            
            // Update achievement
            if (locationHistory.length >= 10) {
                achievements.partyAnimal = true;
                showAchievementUnlocked('Party Animal');
            }
            
            closeModal();
        }
        
        function createLocationMap() {
            // Simulated map with dots
            const locations = getActiveLocations();
            let mapHtml = '<div style="position: relative; width: 100%; height: 100%; background: rgba(255,255,255,0.05); border-radius: 20px;">';
            
            locations.forEach((loc, index) => {
                const x = 20 + (index % 3) * 30;
                const y = 20 + Math.floor(index / 3) * 30;
                mapHtml += `
                    <div class="location-dot" style="left: ${x}%; top: ${y}%;" title="${loc.name}: ${loc.count} people">
                        <span style="position: absolute; top: -20px; left: -20px; font-size: 0.8em; white-space: nowrap;">${loc.name}</span>
                    </div>
                `;
            });
            
            mapHtml += '</div>';
            return mapHtml;
        }
        
        function initializeLocationMap() {
            // Add interactive features to location map
            const dots = document.querySelectorAll('.location-dot');
            dots.forEach(dot => {
                dot.addEventListener('click', function() {
                    const location = this.getAttribute('title');
                    showNotification(`ðŸ“ ${location}`);
                });
            });
        }
        
        function getActiveLocations() {
            const locationCounts = {};
            
            Object.values(partyData).forEach(friend => {
                if (!locationCounts[friend.location]) {
                    locationCounts[friend.location] = { count: 0, totalBac: 0 };
                }
                locationCounts[friend.location].count++;
                locationCounts[friend.location].totalBac += friend.bac;
            });
            
            return Object.entries(locationCounts).map(([name, data]) => ({
                name,
                count: data.count,
                avgBac: data.totalBac / data.count
            }));
        }
        
        function selectBuddy(buddyName) {
            localStorage.setItem('buddy', buddyName);
            showNotification(`ðŸ‘¥ ${buddyName} is now your buddy!`);
            
            // Achievement check
            achievements.guardianAngel = true;
            showAchievementUnlocked('Guardian Angel');
            
            closeModal();
        }
        
        function showFirstAid() {
            showModal('first-aid');
        }
        
        // Emergency functions
        function callEmergency(type) {
            switch(type) {
                case 'ambulance':
                    if (confirm('Call emergency services (112)?')) {
                        window.location.href = 'tel:112';
                    }
                    break;
                case 'campus-security':
                    if (confirm('Call HSG Campus Security?')) {
                        window.location.href = 'tel:+41712242424';
                    }
                    break;
                case 'taxi':
                    showNotification('ðŸš• Opening taxi options...');
                    setTimeout(() => {
                        showTaxiOptions();
                    }, 500);
                    break;
            }
        }
        
        function callUber() {
            const address = localStorage.getItem('homeAddress');
            
            if (address) {
                // Try to open Uber app with pre-filled destination
                const encodedAddress = encodeURIComponent(address);
                showNotification('ðŸš• Opening Uber with your home address...');
                
                // Copy address to clipboard
                navigator.clipboard.writeText(address)
                    .then(() => showNotification('ðŸ“‹ Home address copied to clipboard!'))
                    .catch(() => {});
                
                // Open Uber
                window.open(`https://m.uber.com/ul/?action=setPickup&pickup=my_location&dropoff[formatted_address]=${encodedAddress}`, '_blank');
            } else {
                showNotification('ðŸš• Opening Uber app...');
                window.open('https://m.uber.com/ul/', '_blank');
            }
        }
        
        function showTaxiOptions() {
            const address = localStorage.getItem('homeAddress') || '';
            const options = `
                <h2>ðŸš• Ride Options</h2>
                ${address ? `<div style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                    <p><strong>Your Home Address:</strong></p>
                    <p>${escapeHtml(address)}</p>
                    <button class="btn" style="margin-top: 10px;" onclick="navigator.clipboard.writeText('${escapeHtml(address)}').then(() => showNotification('ðŸ“‹ Address copied!'))">
                        <i class="fas fa-copy"></i> Copy Address
                    </button>
                </div>` : ''}
                <div style="margin: 20px 0;">
                    <button class="btn" style="width: 100%; margin: 10px 0;" onclick="callUber()">
                        <i class="fab fa-uber"></i> Uber
                    </button>
                    <button class="btn" style="width: 100%; margin: 10px 0;" onclick="window.location.href='tel:+41712222222'">
                        <i class="fas fa-taxi"></i> Local Taxi
                    </button>
                    <button class="btn" style="width: 100%; margin: 10px 0;" onclick="callSoberFriend()">
                        <i class="fas fa-user-friends"></i> Call Sober Friend
                    </button>
                </div>
                <button class="btn" onclick="closeModal()">Cancel</button>
            `;
            
            document.getElementById('modalBody').innerHTML = options;
            document.getElementById('modal').classList.add('show');
        }
        
        function callSoberFriend() {
            const soberFriends = Object.values(partyData).filter(f => f.bac < 0.02);
            if (soberFriends.length > 0) {
                const friend = soberFriends[0];
                showNotification(`ðŸ“ž Calling ${friend.name}...`);
            } else {
                showNotification('âŒ No sober friends available right now');
            }
        }
        
        // Game functions
        function startGame(gameType) {
            currentGame = gameType;
            
            const gameOverlay = document.createElement('div');
            gameOverlay.className = 'game-overlay';
            gameOverlay.id = 'gameOverlay';
            
            let gameContent = '';
            
            switch(gameType) {
                case 'never-have-i-ever':
                    gameContent = createNeverHaveIEverGame();
                    break;
                case 'truth-or-dare':
                    gameContent = createTruthOrDareGame();
                    break;
                case 'kings-cup':
                    gameContent = createKingsCupGame();
                    break;
                case 'beer-pong':
                    gameContent = createBeerPongGame();
                    break;
                case 'flip-cup':
                    gameContent = createFlipCupGame();
                    break;
                case 'trivia':
                    gameContent = createTriviaGame();
                    break;
            }
            
            gameOverlay.innerHTML = `
                <div class="game-container">
                    <div class="game-header">
                        <div class="game-title">${getGameTitle(gameType)}</div>
                        <div class="close-game" onclick="closeGame()">Ã—</div>
                    </div>
                    ${gameContent}
                </div>
            `;
            
            document.body.appendChild(gameOverlay);
            setTimeout(() => gameOverlay.classList.add('show'), 10);
            
            // Initialize game
            initializeGame(gameType);
            
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }
        
        function closeGame() {
            const overlay = document.getElementById('gameOverlay');
            if (overlay) {
                overlay.classList.remove('show');
                setTimeout(() => overlay.remove(), 500);
            }
            currentGame = null;
        }
        
        // Game creators
        function createNeverHaveIEverGame() {
            const questions = [
                "Never have I ever skipped a lecture for a party",
                "Never have I ever kissed someone at a HSG party",
                "Never have I ever failed an exam because of partying",
                "Never have I ever woken up in the library",
                "Never have I ever used ChatGPT for an assignment",
                "Never have I ever been to a professor's office hours drunk",
                "Never have I ever stolen food from a dorm kitchen",
                "Never have I ever dated someone from my study group"
            ];
            
            return `
                <div class="question-card" id="gameQuestion">
                    Click "Next Question" to start!
                </div>
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" onclick="nextNeverHaveIEver()">
                        <i class="fas fa-arrow-right"></i> Next Question
                    </button>
                </div>
                <div style="text-align: center; opacity: 0.7;">
                    <p>Drink if you've done it! ðŸ»</p>
                </div>
            `;
        }
        
        function createTruthOrDareGame() {
            return `
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" style="margin: 10px;" onclick="showTruth()">
                        <i class="fas fa-comment"></i> Truth
                    </button>
                    <button class="btn btn-danger" style="margin: 10px;" onclick="showDare()">
                        <i class="fas fa-fire"></i> Dare
                    </button>
                </div>
                <div class="question-card" id="gameQuestion">
                    Choose Truth or Dare!
                </div>
                <div id="playerName" style="text-align: center; font-size: 1.5em; margin-top: 20px;"></div>
            `;
        }
        
        function createKingsCupGame() {
            const rules = {
                'A': 'ðŸ‰ Waterfall - Everyone drinks!',
                '2': 'ðŸ‘‰ You - Choose someone to drink',
                '3': 'ðŸ‘ˆ Me - You drink!',
                '4': 'ðŸ‘¯ Floor - Last to touch floor drinks',
                '5': 'ðŸ™‹ Guys - All guys drink',
                '6': 'ðŸ’ƒ Chicks - All girls drink',
                '7': 'ðŸŒˆ Heaven - Last to raise hand drinks',
                '8': 'ðŸ¤ Mate - Choose a drinking buddy',
                '9': 'ðŸŽµ Rhyme - Say a word, others rhyme',
                '10': 'ðŸ“ Categories - Name things in category',
                'J': 'ðŸ‘‘ Make a Rule',
                'Q': 'â“ Questions - Ask questions only',
                'K': 'ðŸ† King\'s Cup - Pour into center cup'
            };
            
            return `
                <div style="text-align: center;">
                    <div style="font-size: 6em; margin: 20px 0;" id="currentCard">ðŸŽ´</div>
                    <button class="btn btn-primary" onclick="drawCard()">
                        <i class="fas fa-clone"></i> Draw Card
                    </button>
                </div>
                <div class="question-card" id="gameQuestion">
                    Click "Draw Card" to start!
                </div>
            `;
        }
        
        function createBeerPongGame() {
            return `
                <div class="score-display">
                    <div class="team-score">
                        <div class="team-name">Team 1</div>
                        <div class="team-points" id="team1Score">0</div>
                        <button class="btn" onclick="addScore('team1')">+1</button>
                    </div>
                    <div class="team-score">
                        <div class="team-name">Team 2</div>
                        <div class="team-points" id="team2Score">0</div>
                        <button class="btn" onclick="addScore('team2')">+1</button>
                    </div>
                </div>
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" onclick="resetBeerPong()">
                        <i class="fas fa-redo"></i> New Game
                    </button>
                </div>
                <div id="gameStatus" style="text-align: center; font-size: 1.5em; margin-top: 20px;"></div>
            `;
        }
        
        function createFlipCupGame() {
            return `
                <div class="timer-display" id="flipTimer">00:00</div>
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" id="timerBtn" onclick="toggleFlipTimer()">
                        <i class="fas fa-play"></i> Start Timer
                    </button>
                    <button class="btn" onclick="resetFlipTimer()">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
                <div id="bestTime" style="text-align: center; font-size: 1.2em; margin-top: 20px;">
                    Best Time: --:--
                </div>
            `;
        }
        
        function createTriviaGame() {
            return `
                <div class="question-card" id="gameQuestion">
                    Click "Next Question" to start HSG Trivia!
                </div>
                <div id="triviaOptions" style="margin: 20px 0;"></div>
                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-primary" onclick="nextTrivia()">
                        <i class="fas fa-arrow-right"></i> Next Question
                    </button>
                </div>
                <div class="score-display">
                    <div class="team-score">
                        <div class="team-name">Score</div>
                        <div class="team-points" id="triviaScore">0</div>
                    </div>
                </div>
            `;
        }
        
        // Game logic
        let gameData = {
            neverHaveIEver: [
                "Never have I ever skipped a lecture for a party",
                "Never have I ever kissed someone at a HSG party",
                "Never have I ever failed an exam because of partying",
                "Never have I ever woken up in the library",
                "Never have I ever used ChatGPT for an assignment",
                "Never have I ever been to a professor's office hours drunk",
                "Never have I ever stolen food from a dorm kitchen",
                "Never have I ever dated someone from my study group",
                "Never have I ever fallen asleep during a presentation",
                "Never have I ever pretended to be sick to avoid a group project"
            ],
            truths: [
                "What's your most embarrassing HSG moment?",
                "Who's your secret crush on campus?",
                "What's the worst grade you've ever gotten?",
                "Have you ever cheated on an exam?",
                "What's your biggest fear about graduation?",
                "Which professor do you have a crush on?",
                "What's the craziest thing you've done at HSG?"
            ],
            dares: [
                "Text your crush right now!",
                "Do 20 pushups",
                "Sing the HSG anthem",
                "Call a random contact and say 'I love you'",
                "Post an embarrassing photo on Instagram",
                "Dance without music for 1 minute",
                "Let someone go through your phone for 30 seconds"
            ],
            trivia: [
                {
                    question: "When was HSG founded?",
                    options: ["1898", "1923", "1945", "1967"],
                    correct: 0
                },
                {
                    question: "What does HSG stand for?",
                    options: ["High School Gymnasium", "Hochschule St. Gallen", "Higher Studies Group", "Helvetic Study Group"],
                    correct: 1
                },
                {
                    question: "How many students attend HSG?",
                    options: ["5,000", "9,000", "12,000", "15,000"],
                    correct: 1
                },
                {
                    question: "What's the most popular major at HSG?",
                    options: ["Law", "Business Administration", "Computer Science", "International Affairs"],
                    correct: 1
                }
            ]
        };
        
        let gameState = {
            flipTimer: null,
            flipTime: 0,
            bestFlipTime: null,
            triviaScore: 0,
            currentTriviaIndex: 0
        };
        
        function initializeGame(gameType) {
            switch(gameType) {
                case 'beer-pong':
                    gameScores = { team1: 0, team2: 0 };
                    updateBeerPongScore();
                    break;
                case 'trivia':
                    gameState.triviaScore = 0;
                    gameState.currentTriviaIndex = 0;
                    document.getElementById('triviaScore').textContent = '0';
                    break;
            }
        }
        
        function nextNeverHaveIEver() {
            const questions = gameData.neverHaveIEver;
            const random = Math.floor(Math.random() * questions.length);
            document.getElementById('gameQuestion').textContent = questions[random];
        }
        
        function showTruth() {
            const truths = gameData.truths;
            const random = Math.floor(Math.random() * truths.length);
            document.getElementById('gameQuestion').textContent = truths[random];
            selectRandomPlayer();
        }
        
        function showDare() {
            const dares = gameData.dares;
            const random = Math.floor(Math.random() * dares.length);
            document.getElementById('gameQuestion').textContent = dares[random];
            selectRandomPlayer();
        }
        
        function selectRandomPlayer() {
            const players = Object.values(partyData).map(p => p.name);
            if (players.length === 0) players.push('You');
            const random = Math.floor(Math.random() * players.length);
            const player = players[random];
            document.getElementById('playerName').textContent = `${player}'s turn!`;
        }
        
        function drawCard() {
            const cards = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
            const suits = ['â™ ï¸', 'â™¥ï¸', 'â™¦ï¸', 'â™£ï¸'];
            const randomCard = cards[Math.floor(Math.random() * cards.length)];
            const randomSuit = suits[Math.floor(Math.random() * suits.length)];
            
            document.getElementById('currentCard').textContent = randomCard + randomSuit;
            
            const rules = {
                'A': 'ðŸ‰ Waterfall - Everyone drinks!',
                '2': 'ðŸ‘‰ You - Choose someone to drink',
                '3': 'ðŸ‘ˆ Me - You drink!',
                '4': 'ðŸ‘¯ Floor - Last to touch floor drinks',
                '5': 'ðŸ™‹ Guys - All guys drink',
                '6': 'ðŸ’ƒ Chicks - All girls drink',
                '7': 'ðŸŒˆ Heaven - Last to raise hand drinks',
                '8': 'ðŸ¤ Mate - Choose a drinking buddy',
                '9': 'ðŸŽµ Rhyme - Say a word, others rhyme',
                '10': 'ðŸ“ Categories - Name things in category',
                'J': 'ðŸ‘‘ Make a Rule',
                'Q': 'â“ Questions - Ask questions only',
                'K': 'ðŸ† King\'s Cup - Pour into center cup'
            };
            
            document.getElementById('gameQuestion').textContent = rules[randomCard];
        }
        
        function addScore(team) {
            gameScores[team]++;
            updateBeerPongScore();
            
            if (gameScores[team] >= 10) {
                document.getElementById('gameStatus').textContent = `${team === 'team1' ? 'Team 1' : 'Team 2'} Wins! ðŸ†`;
                confetti({
                    particleCount: 200,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }
        
        function updateBeerPongScore() {
            document.getElementById('team1Score').textContent = gameScores.team1;
            document.getElementById('team2Score').textContent = gameScores.team2;
        }
        
        function resetBeerPong() {
            gameScores = { team1: 0, team2: 0 };
            updateBeerPongScore();
            document.getElementById('gameStatus').textContent = '';
        }
        
        function toggleFlipTimer() {
            const btn = document.getElementById('timerBtn');
            
            if (gameState.flipTimer) {
                clearInterval(gameState.flipTimer);
                gameState.flipTimer = null;
                btn.innerHTML = '<i class="fas fa-play"></i> Start Timer';
                
                if (!gameState.bestFlipTime || gameState.flipTime < gameState.bestFlipTime) {
                    gameState.bestFlipTime = gameState.flipTime;
                    document.getElementById('bestTime').textContent = `Best Time: ${formatTime(gameState.bestFlipTime)}`;
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }
            } else {
                gameState.flipTime = 0;
                gameState.flipTimer = setInterval(() => {
                    gameState.flipTime++;
                    document.getElementById('flipTimer').textContent = formatTime(gameState.flipTime);
                }, 10);
                btn.innerHTML = '<i class="fas fa-pause"></i> Stop Timer';
            }
        }
        
        function resetFlipTimer() {
            if (gameState.flipTimer) {
                clearInterval(gameState.flipTimer);
                gameState.flipTimer = null;
            }
            gameState.flipTime = 0;
            document.getElementById('flipTimer').textContent = '00:00';
            document.getElementById('timerBtn').innerHTML = '<i class="fas fa-play"></i> Start Timer';
        }
        
        function formatTime(centiseconds) {
            const minutes = Math.floor(centiseconds / 6000);
            const seconds = Math.floor((centiseconds % 6000) / 100);
            const cs = centiseconds % 100;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${cs.toString().padStart(2, '0')}`;
        }
        
        function nextTrivia() {
            const trivia = gameData.trivia;
            const current = trivia[gameState.currentTriviaIndex % trivia.length];
            
            document.getElementById('gameQuestion').textContent = current.question;
            
            const optionsHtml = current.options.map((option, index) => 
                `<button class="btn" style="width: 100%; margin: 10px 0;" onclick="answerTrivia(${index}, ${current.correct})">${option}</button>`
            ).join('');
            
            document.getElementById('triviaOptions').innerHTML = optionsHtml;
            gameState.currentTriviaIndex++;
        }
        
        function answerTrivia(selected, correct) {
            const buttons = document.getElementById('triviaOptions').querySelectorAll('button');
            
            if (selected === correct) {
                gameState.triviaScore++;
                document.getElementById('triviaScore').textContent = gameState.triviaScore;
                buttons[selected].style.background = 'linear-gradient(45deg, #00ff88, #00d4ff)';
                showNotification('âœ… Correct! +1 point');
            } else {
                buttons[selected].style.background = 'linear-gradient(45deg, #ff4444, #ff0088)';
                buttons[correct].style.background = 'linear-gradient(45deg, #00ff88, #00d4ff)';
                showNotification('âŒ Wrong answer!');
            }
            
            // Disable all buttons
            buttons.forEach(btn => btn.disabled = true);
            
            // Auto next question after 2 seconds
            setTimeout(nextTrivia, 2000);
        }
        
        function getGameTitle(gameType) {
            const titles = {
                'never-have-i-ever': 'ðŸ™Š Never Have I Ever',
                'truth-or-dare': 'ðŸŽ¯ Truth or Dare',
                'kings-cup': 'ðŸ‘‘ King\'s Cup',
                'beer-pong': 'ðŸ“ Beer Pong',
                'flip-cup': 'ðŸ¥¤ Flip Cup',
                'trivia': 'ðŸ§  HSG Trivia'
            };
            return titles[gameType] || 'Party Game';
        }
        
        // Achievements
        function updateAchievements() {
            const achievementElements = document.querySelectorAll('.achievement');
            
            Object.entries(achievements).forEach(([key, unlocked]) => {
                if (unlocked) {
                    const element = document.querySelector(`.achievement[data-achievement="${key}"]`);
                    if (element && !element.classList.contains('unlocked')) {
                        element.classList.add('unlocked');
                    }
                }
            });
        }
        
        function checkAchievements(friends) {
            // Responsible - stayed safe all night
            if (friends.every(f => f.bac < 0.05) && Date.now() - partyStartTime > 3600000) {
                achievements.responsible = true;
                showAchievementUnlocked('Responsible');
            }
            
            // Sunrise Warrior - party for 6+ hours
            if (Date.now() - partyStartTime > 21600000) {
                achievements.sunriseWarrior = true;
                showAchievementUnlocked('Sunrise Warrior');
            }
        }
        
        function showAchievementUnlocked(name) {
            if (!localStorage.getItem(`achievement_${name}`)) {
                localStorage.setItem(`achievement_${name}`, 'true');
                
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
                
                showNotification(`ðŸ† Achievement Unlocked: ${name}!`);
            }
        }
        
        // Toggle chart visibility
        function toggleChart() {
            chartVisible = !chartVisible;
            const wrapper = document.getElementById('chartWrapper');
            const toggleText = document.getElementById('chartToggleText');
            
            if (chartVisible) {
                wrapper.classList.remove('collapsed');
                toggleText.textContent = 'Hide Chart';
            } else {
                wrapper.classList.add('collapsed');
                toggleText.textContent = 'Show Chart';
            }
        }
        
        // Drink tracking functions
        function logDrink() {
            try {
                const type = document.getElementById('drinkType').value;
                const amount = parseInt(document.getElementById('drinkAmount').value) || 0;
                const alcoholPercent = parseFloat(document.getElementById('alcoholPercent').value) || 0;
                
                if (amount <= 0) {
                    showNotification('âŒ Please enter a valid amount', 'error');
                    return;
                }
                
                const drink = {
                    id: Date.now(),
                    type: type,
                    amount: amount,
                    alcoholPercent: alcoholPercent,
                    pureAlcohol: (amount * alcoholPercent / 100).toFixed(1),
                    time: new Date(),
                    emoji: drinkPresets[type].emoji
                };
                
                drinkHistory.unshift(drink);
                
                // Save to localStorage
                saveDrinkHistory();
                
                // Update UI
                updateDrinkStats();
                updateDrinkHistory();
                updateDrinkChart();
                updateEmergencySummary();
                
                // Send to Firebase if connected
                if (database && currentUser) {
                    database.ref('users/' + currentUser.uid + '/drinks/' + drink.id).set({
                        ...drink,
                        time: drink.time.toISOString()
                    });
                }
                
                // Confetti for water!
                if (type === 'water') {
                    confetti({
                        particleCount: 50,
                        spread: 60,
                        colors: ['#00d4ff', '#0099ff', '#0066ff'],
                        origin: { y: 0.6 }
                    });
                    showNotification('ðŸ’§ Great job staying hydrated!', 'success');
                } else {
                    showNotification(`${drink.emoji} Drink logged!`);
                }
                
                // Reset form to defaults
                document.getElementById('drinkAmount').value = drinkPresets[type].amount;
                document.getElementById('alcoholPercent').value = drinkPresets[type].alcohol;
            } catch (error) {
                console.error('Error logging drink:', error);
                showNotification('âŒ Failed to log drink', 'error');
            }
        }
        
        function updateDrinkStats() {
            try {
                const now = Date.now();
                const oneHourAgo = now - 3600000;
                
                // Calculate totals
                const totalDrinks = drinkHistory.filter(d => d.type !== 'water').length;
                const totalWater = drinkHistory.filter(d => d.type === 'water').length;
                const totalAlcohol = drinkHistory.reduce((sum, d) => sum + parseFloat(d.pureAlcohol || 0), 0);
                const recentDrinks = drinkHistory.filter(d => new Date(d.time).getTime() > oneHourAgo && d.type !== 'water').length;
                
                // Update display
                const totalDrinksEl = document.getElementById('totalDrinks');
                if (totalDrinksEl) totalDrinksEl.textContent = totalDrinks;
                
                const totalWaterEl = document.getElementById('totalWater');
                if (totalWaterEl) totalWaterEl.textContent = totalWater;
                
                const totalAlcoholEl = document.getElementById('totalAlcohol');
                if (totalAlcoholEl) totalAlcoholEl.textContent = totalAlcohol.toFixed(0) + 'ml';
                
                const drinkRateEl = document.getElementById('drinkRate');
                if (drinkRateEl) drinkRateEl.textContent = recentDrinks + '/hr';
            } catch (error) {
                console.error('Error updating drink stats:', error);
            }
        }
        
        function updateDrinkHistory() {
            try {
                const historyContainer = document.getElementById('drinkHistory');
                if (!historyContainer) return;
                
                if (drinkHistory.length === 0) {
                    historyContainer.innerHTML = '<p style="text-align: center; opacity: 0.7;">No drinks logged yet</p>';
                    return;
                }
                
                historyContainer.innerHTML = drinkHistory.slice(0, 20).map(drink => `
                    <div class="buddy-card" style="margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="font-size: 2em;">${drink.emoji}</div>
                                <div>
                                    <div style="font-weight: bold;">${drink.type.charAt(0).toUpperCase() + drink.type.slice(1)}</div>
                                    <div style="opacity: 0.7; font-size: 0.9em;">
                                        ${drink.amount}ml â€¢ ${drink.alcoholPercent}% â€¢ ${drink.pureAlcohol}ml pure
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.9em;">${formatDrinkTime(drink.time)}</div>
                                <button class="btn" style="padding: 5px 10px; margin-top: 5px;" onclick="removeDrink(${drink.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error updating drink history:', error);
            }
        }
        
        function updateDrinkChart() {
            try {
                const ctx = document.getElementById('drinkChart');
                if (!ctx || !chartVisible) return;
                
                // Count drinks by type
                const drinkCounts = {};
                drinkHistory.forEach(drink => {
                    if (!drinkCounts[drink.type]) {
                        drinkCounts[drink.type] = 0;
                    }
                    drinkCounts[drink.type]++;
                });
                
                if (Object.keys(drinkCounts).length === 0) {
                    // No data yet
                    if (drinkChart) {
                        drinkChart.destroy();
                        drinkChart = null;
                    }
                    return;
                }
                
                const labels = Object.keys(drinkCounts);
                const data = Object.values(drinkCounts);
                const emojis = labels.map(type => drinkPresets[type]?.emoji || 'ðŸ¹');
                
                if (drinkChart) {
                    // Update existing chart
                    drinkChart.data.labels = labels.map((label, i) => `${emojis[i]} ${label}`);
                    drinkChart.data.datasets[0].data = data;
                    drinkChart.update();
                } else {
                    // Create new chart
                    drinkChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels.map((label, i) => `${emojis[i]} ${label}`),
                            datasets: [{
                                data: data,
                                backgroundColor: [
                                    '#00ff88',
                                    '#00d4ff',
                                    '#ff00ff',
                                    '#ffcc00',
                                    '#ff4444',
                                    '#0099ff',
                                    '#00ccff',
                                    '#ff0088'
                                ],
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: '#fff',
                                        padding: 10,
                                        font: {
                                            size: window.innerWidth < 768 ? 10 : 12
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error updating drink chart:', error);
            }
        }
        
        function updateEmergencySummary() {
            const summary = document.getElementById('emergencySummary');
            if (!summary) return;
            
            const totalAlcohol = drinkHistory.reduce((sum, d) => sum + parseFloat(d.pureAlcohol), 0);
            const timeSpan = drinkHistory.length > 0 ? 
                ((Date.now() - drinkHistory[drinkHistory.length - 1].time) / 3600000).toFixed(1) : 0;
            
            const drinkTypes = {};
            drinkHistory.forEach(d => {
                if (!drinkTypes[d.type]) drinkTypes[d.type] = 0;
                drinkTypes[d.type]++;
            });
            
            const medicalInfo = localStorage.getItem('medicalInfo') || 'None provided';
            const safetyNotes = localStorage.getItem('safetyNotes') || 'None provided';
            
            summary.innerHTML = `
                <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; margin: 10px 0;">
                    <p><strong>Time Period:</strong> ${timeSpan} hours</p>
                    <p><strong>Total Pure Alcohol:</strong> ${totalAlcohol.toFixed(0)}ml</p>
                    <p><strong>Drink Breakdown:</strong></p>
                    <ul style="margin-left: 20px;">
                        ${Object.entries(drinkTypes).map(([type, count]) => 
                            `<li>${drinkPresets[type].emoji} ${type}: ${count}</li>`
                        ).join('')}
                    </ul>
                    <p><strong>Last Drink:</strong> ${drinkHistory.length > 0 ? 
                        formatDrinkTime(drinkHistory[0].time) : 'None'}</p>
                    <p><strong>Estimated BAC:</strong> ${estimateBAC().toFixed(3)}â€°</p>
                    <p><strong>Medical Info:</strong> ${escapeHtml(medicalInfo)}</p>
                    <p><strong>Safety Notes:</strong> ${escapeHtml(safetyNotes)}</p>
                </div>
            `;
        }
        
        function removeDrink(drinkId) {
            drinkHistory = drinkHistory.filter(d => d.id !== drinkId);
            saveDrinkHistory();
            updateDrinkStats();
            updateDrinkHistory();
            updateDrinkChart();
            updateEmergencySummary();
            showNotification('ðŸ—‘ï¸ Drink removed');
        }
        
        function saveDrinkHistory() {
            localStorage.setItem('drinkHistory', JSON.stringify(drinkHistory));
        }
        
        function loadDrinkHistory() {
            const saved = localStorage.getItem('drinkHistory');
            if (saved) {
                try {
                    drinkHistory = JSON.parse(saved);
                    // Convert time strings back to Date objects
                    drinkHistory.forEach(d => {
                        d.time = new Date(d.time);
                    });
                } catch (error) {
                    console.error('Failed to load drink history:', error);
                }
            }
        }
        
        function formatDrinkTime(time) {
            const now = new Date();
            const drinkTime = new Date(time);
            const diffMinutes = Math.floor((now - drinkTime) / 60000);
            
            if (diffMinutes < 1) return 'Just now';
            if (diffMinutes < 60) return `${diffMinutes}m ago`;
            if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}h ago`;
            return drinkTime.toLocaleDateString();
        }
        
        function estimateBAC() {
            // Widmark formula estimation (simplified)
            const weight = 70; // kg (average)
            const gender = 0.68; // male average (0.55 for female)
            const totalAlcohol = drinkHistory.reduce((sum, d) => sum + parseFloat(d.pureAlcohol), 0);
            const hoursSinceFirst = drinkHistory.length > 0 ? 
                ((Date.now() - drinkHistory[drinkHistory.length - 1].time) / 3600000) : 0;
            
            // BAC = (alcohol in grams / (weight * gender factor)) - (0.015 * hours)
            const alcoholGrams = totalAlcohol * 0.789; // ml to grams
            const bac = Math.max(0, (alcoholGrams / (weight * 1000 * gender)) * 100 - (0.015 * hoursSinceFirst));
            
            return bac;
        }
        
        function showEmergencyReport() {
            try {
                const report = {
                    timestamp: new Date().toISOString(),
                    estimatedBAC: estimateBAC().toFixed(3),
                    drinkHistory: drinkHistory,
                    totalAlcohol: drinkHistory.reduce((sum, d) => sum + parseFloat(d.pureAlcohol || 0), 0),
                    userData: {
                        name: userData.username || currentUser?.email || 'Unknown',
                        address: localStorage.getItem('homeAddress') || 'Not provided',
                        emergencyContact: localStorage.getItem('emergencyContact') || 'Not provided',
                        medicalInfo: localStorage.getItem('medicalInfo') || 'None',
                        safetyNotes: localStorage.getItem('safetyNotes') || 'None'
                    }
                };
                
                const reportText = `EMERGENCY MEDICAL REPORT
========================
Generated: ${new Date().toLocaleString()}
Patient: ${report.userData.name}
Address: ${report.userData.address}
Emergency Contact: ${report.userData.emergencyContact}

MEDICAL INFORMATION
-------------------
${report.userData.medicalInfo}

SAFETY NOTES
------------
${report.userData.safetyNotes}

ALCOHOL CONSUMPTION SUMMARY
---------------------------
Estimated BAC: ${report.estimatedBAC}â€°
Total Pure Alcohol: ${report.totalAlcohol.toFixed(0)}ml
Number of Drinks: ${drinkHistory.filter(d => d.type !== 'water').length}
Water Consumed: ${drinkHistory.filter(d => d.type === 'water').length} glasses

DETAILED DRINK LOG
------------------
${drinkHistory.map(d => 
    `${formatDrinkTime(d.time)}: ${d.emoji} ${d.type} - ${d.amount}ml @ ${d.alcoholPercent}%`
).join('\n')}

MEDICAL NOTES
-------------
- Monitor for signs of alcohol poisoning
- Ensure airway remains clear
- Check vitals regularly
- Consider IV fluids if dehydrated`;
                
                // Create modal with report
                const modalContent = `
                    <h2>ðŸš¨ Emergency Medical Report</h2>
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 15px; margin: 20px 0; max-height: 400px; overflow-y: auto;">
                        <pre style="white-space: pre-wrap; font-family: monospace; font-size: 0.9em;">${escapeHtml(reportText)}</pre>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="copyEmergencyReport()">
                            <i class="fas fa-copy"></i> Copy Report
                        </button>
                        <button class="btn btn-primary" onclick="downloadEmergencyReport()">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button class="btn btn-danger" onclick="shareEmergencyReport()">
                            <i class="fas fa-share"></i> Share
                        </button>
                        <button class="btn" onclick="closeModal()">Close</button>
                    </div>
                `;
                
                // Store report in window for other functions
                window.currentEmergencyReport = reportText;
                
                document.getElementById('modalBody').innerHTML = modalContent;
                document.getElementById('modal').classList.add('show');
            } catch (error) {
                console.error('Error generating emergency report:', error);
                showNotification('âŒ Error generating report', 'error');
            }
        }
        
        function copyEmergencyReport() {
            if (window.currentEmergencyReport) {
                navigator.clipboard.writeText(window.currentEmergencyReport)
                    .then(() => showNotification('ðŸ“‹ Report copied to clipboard!', 'success'))
                    .catch(() => {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = window.currentEmergencyReport;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showNotification('ðŸ“‹ Report copied!', 'success');
                    });
            }
        }
        
        function downloadEmergencyReport() {
            try {
                const blob = new Blob([window.currentEmergencyReport], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `emergency_report_${new Date().toISOString().slice(0,10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                showNotification('ðŸ“¥ Report downloaded!', 'success');
            } catch (error) {
                console.error('Download error:', error);
                showNotification('âŒ Download failed - use copy instead', 'error');
            }
        }
        
        function shareEmergencyReport() {
            if (navigator.share && window.currentEmergencyReport) {
                navigator.share({
                    title: 'Emergency Medical Report',
                    text: window.currentEmergencyReport
                })
                .then(() => showNotification('ðŸ“¤ Report shared!', 'success'))
                .catch(() => showNotification('âŒ Sharing cancelled'));
            } else {
                // Fallback - copy to clipboard
                copyEmergencyReport();
                showNotification('ðŸ“‹ Report copied - share manually');
            }
        }
        
        // Export data
        function exportData() {
            const data = {
                user: {
                    email: currentUser?.email,
                    username: userData.username
                },
                settings: userData.settings,
                emergency: userData.emergency,
                devices: deviceData,
                friends: friendsData,
                drinkHistory: drinkHistory,
                achievements: achievements,
                partyData: partyData
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hsg_party_tracker_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('ðŸ“¥ Data exported successfully!', 'success');
        }
        
        // Clear drink history
        function clearDrinkHistory() {
            if (confirm('Clear all drink history? This cannot be undone!')) {
                drinkHistory = [];
                saveDrinkHistory();
                updateDrinkStats();
                updateDrinkHistory();
                updateDrinkChart();
                updateEmergencySummary();
                
                // Clear from Firebase
                if (database && currentUser) {
                    database.ref('users/' + currentUser.uid + '/drinks').remove();
                }
                
                showNotification('ðŸ—‘ï¸ Drink history cleared');
            }
        }
        
        // Sound effects (placeholder)
        function playSound(soundName) {
            // In real implementation, would play actual sound files
            console.log(`Playing sound: ${soundName}`);
        }
        
        // Utility functions
        function getTimeSince(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            return `${Math.floor(seconds / 3600)}h ago`;
        }
        
        function showNotification(message, type = 'success') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.innerHTML = escapeHtml(message);
            notif.onclick = () => notif.remove();
            document.body.appendChild(notif);
            
            setTimeout(() => {
                if (notif.parentNode) {
                    notif.remove();
                }
            }, 4000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Error boundary
        window.addEventListener('error', (e) => {
            console.error('Application error:', e);
            // Don't show error notifications for minor issues
            if (e.message && !e.message.includes('ResizeObserver')) {
                showNotification('âš ï¸ Something went wrong. Refreshing might help.', 'error');
            }
        });
        
        // Window events
        window.onclick = (event) => {
            if (event.target.className === 'modal show') {
                closeModal();
            }
            if (event.target.className === 'game-overlay show') {
                closeGame();
            }
        };
        
        window.addEventListener('beforeunload', () => {
            saveDrinkHistory();
        });
        
        // Error recovery
        window.addEventListener('unhandledrejection', event => {
            console.error('Unhandled promise rejection:', event.reason);
            // Only show notification for serious errors
            if (event.reason && event.reason.code && event.reason.code.includes('auth')) {
                showNotification('âš ï¸ Authentication issue. Try refreshing.', 'error');
            }
        });
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                // Update drink type selection to auto-fill amounts
                const drinkTypeSelect = document.getElementById('drinkType');
                if (drinkTypeSelect) {
                    drinkTypeSelect.addEventListener('change', function() {
                        const preset = drinkPresets[this.value];
                        document.getElementById('drinkAmount').value = preset.amount;
                        document.getElementById('alcoholPercent').value = preset.alcohol;
                    });
                }
                
                // Initialize particles
                createParticles();
                
                // Initialize Firebase
                initializeFirebase();
                
                // Update intervals
                setInterval(updateVisualizer, 500);
                
                // Hydration reminders
                setInterval(() => {
                    const minutes = new Date().getMinutes();
                    if (minutes % 15 === 0) {
                        showHydrationReminder();
                    }
                }, 60000);
            });
        } else {
            // DOM already loaded
            createParticles();
            initializeFirebase();
            setInterval(updateVisualizer, 500);
        }
    </script>
</body>
</html>